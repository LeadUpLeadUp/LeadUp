<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>××¢×¨×›×ª CRM ×¤× ×™××™×ª â€“ ×¡×•×›× ×•×ª ×‘×™×˜×•×—</title>

<style>
:root{
  --bg:#0b0b0b;
  --panel:#111;
  --gold:#d4af37;
  --gold2:#f3e7b7;
  --line:rgba(255,255,255,.14);
  --radius:16px;
  --red:#ff4d4d;
  --green:#2ecc71;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui;
  background:radial-gradient(900px 600px at 20% -10%, rgba(212,175,55,.18), transparent 60%),var(--bg);
  color:#fff;
}

/* ---------- AUTH STATES ---------- */
body.locked{
  overflow:hidden; /* ××™×Ÿ ×’×œ×™×œ×” ×‘××¡×š ×”×ª×—×‘×¨×•×ª */
}
body.locked #appView{
  display:none !important; /* ×”××¢×¨×›×ª ×œ× ××•×¦×’×ª ×‘×›×œ×œ */
}
body.authed #loginOverlay{
  display:none !important;
}
body.authed #appView{
  display:grid !important;
}

/* ---------- LOGIN OVERLAY ---------- */
#loginOverlay{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:18px;
  background:
    radial-gradient(900px 600px at 30% 10%, rgba(212,175,55,.20), transparent 60%),
    rgba(0,0,0,.72);
  backdrop-filter: blur(8px);
}
#loginCard{
  width:min(440px, 100%);
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:0 30px 80px rgba(0,0,0,.55);
}
#loginCard h3{
  margin:0 0 12px 0;
}
.loginHint{
  font-size:12px;
  opacity:.75;
  margin-top:10px;
}

/* ---------- COMMON ---------- */
.hidden{display:none}
.btn{
  border:none;border-radius:12px;
  padding:10px 14px;font-weight:800;cursor:pointer
}
.btnGold{background:linear-gradient(180deg,var(--gold2),var(--gold));color:#111}
.btnDark{background:rgba(255,255,255,.1);color:#fff;border:1px solid var(--line)}
.input,select,textarea{
  width:100%;border-radius:10px;padding:10px;border:1px solid #ccc
}

/* ---------- APP LAYOUT ---------- */
.wrap{
  display:grid;
  grid-template-columns:260px 1fr 420px;
  gap:12px;
  padding:12px;
  min-height:100vh;
  align-items:start;
}
.card,.sidebar,.right{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
}
.sidebar button{width:100%;margin-bottom:8px;text-align:right}

.row{
  display:grid;
  grid-template-columns:1fr 1fr .8fr .8fr;
  padding:8px;
  border-bottom:1px dashed rgba(255,255,255,.12);
  cursor:pointer
}
.row:hover{background:rgba(212,175,55,.12)}
.row.overdue{background:rgba(255,0,0,.15)}
.badge{padding:2px 8px;border-radius:999px;font-size:12px}
.badge.red{background:rgba(255,77,77,.2)}
.badge.gold{background:rgba(212,175,55,.25)}
.noteList{max-height:200px;overflow:auto;border:1px solid #ddd;border-radius:10px;padding:6px;background:#fff;color:#111}
.noteItem{border-bottom:1px dashed #ccc;padding:6px 0}
.noteItem:last-child{border-bottom:none}
.small{font-size:12px;opacity:.7}
hr{border:none;height:1px;background:rgba(255,255,255,.15);margin:10px 0}

/* ---------- MOBILE ---------- */
@media (max-width: 980px){
  .wrap{grid-template-columns:1fr}
  .row{grid-template-columns:1fr 1fr}
  .row > div:nth-child(3),
  .row > div:nth-child(4){display:none}
}
</style>
</head>

<body class="locked">

<!-- LOGIN OVERLAY (×§×‘×•×¢ ×¢×œ ×›×œ ×”××¡×š) -->
<div id="loginOverlay">
  <div id="loginCard">
    <h3>ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</h3>
    <input id="inUser" class="input" placeholder="×©× ××©×ª××©" autocomplete="username">
    <br><br>
    <input id="inPin" type="password" class="input" placeholder="×§×•×“" autocomplete="current-password">
    <br><br>

    <button class="btn btnGold" id="btnLogin">×”×ª×—×‘×¨</button>
    <button class="btn btnDark" id="btnClearToken" style="margin-right:8px">××™×¤×•×¡ ×”×ª×—×‘×¨×•×ª</button>

    <div class="loginHint">×× ××ª×” ×¨×•××” "doGet ×œ× × ××¦×" ×‘Ö¾WebApp â€” ×–×” ×ª×§×™×Ÿ. ×”××¢×¨×›×ª ×¢×•×‘×“×ª ×‘Ö¾POST.</div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="wrap" style="display:none">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3>ğŸ“Š ×ª×¤×¨×™×˜</h3>
    <button class="btn btnGold" id="btnTakeNext">âš¡ ×§×— ××ª ×”×‘×</button>
    <button class="btn btnDark" id="btnRefresh">ğŸ”„ ×¨×¢× ×Ÿ</button>
    <button class="btn btnDark" id="btnLogout">ğŸšª ×™×¦×™××”</button>
    <hr>
    <div class="small">×”×ª×¨××•×ª / SLA / ×ª×–××•× ×™× ×¢×•×‘×“×™× ××•×˜×•××˜×™×ª</div>
  </div>

  <!-- MAIN -->
  <div class="card">
    <h3>ğŸ“‹ ×œ×™×“×™×</h3>
    <input id="q" class="input" placeholder="×—×™×¤×•×©">
    <div class="row" style="font-weight:700;opacity:.7">
      <div>×©×</div><div>×˜×œ×¤×•×Ÿ</div><div>×¡×˜×˜×•×¡</div><div>×“×—×™×¤×•×ª</div>
    </div>
    <div id="leadRows"></div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div id="noFocus">×‘×—×¨ ×œ×™×“</div>

    <div id="focusBox" class="hidden">
      <div class="card" style="background:#fff;color:#111">
        <b id="fName"></b><br>
        ğŸ“ <span id="fPhone"></span><br>
        ××•×¦×¨: <span id="fProd"></span>
        <div style="margin-top:6px">
          <button class="btn btnGold" id="btnCall">×—×™×™×’</button>
        </div>
      </div>

      <div class="card" style="background:#fff;color:#111">
        <label><b>×¡×˜×˜×•×¡</b></label>
        <select id="fStatus" class="input">
          <option>NEW</option>
          <option>CONTACTING</option>
          <option>SOLD</option>
          <option>LOST</option>
        </select>

        <label style="margin-top:6px"><b>×ª×™×¢×•×“ ×—×•×‘×”</b></label>
        <textarea id="actionNote" class="input"></textarea>

        <button class="btn btnGold" style="margin-top:8px" id="btnSave">ğŸ’¾ ×©××•×¨</button>
      </div>

      <!-- Scheduling -->
      <div class="card" style="background:#fff;color:#111">
        <h4>â±ï¸ ×ª×–××•×Ÿ</h4>
        <input id="schAt" type="datetime-local" class="input">
        <select id="schType" class="input" style="margin-top:6px">
          <option value="call">ğŸ“ ×©×™×—×”</option>
          <option value="whatsapp">ğŸ’¬ ×•×•××˜×¡××¤</option>
          <option value="docs">ğŸ“„ ××¡××›×™×</option>
          <option value="renewal">â™»ï¸ ×—×™×“×•×©</option>
        </select>
        <input id="schNote" class="input" placeholder="×”×¢×¨×”" style="margin-top:6px">
        <button class="btn btnGold" style="margin-top:8px" id="btnAddSchedule">â• ×”×•×¡×£ ×ª×–××•×Ÿ</button>
      </div>

      <!-- Schedules -->
      <div class="card" style="background:#fff;color:#111">
        <b>ğŸ“… ×ª×–××•× ×™×</b>
        <div id="schList" class="noteList">â€”</div>
      </div>

      <!-- Notes -->
      <div class="card" style="background:#fff;color:#111">
        <b>ğŸ“ ×ª×™×¢×•×“</b>
        <div id="notesBox" class="noteList">â€”</div>
      </div>

    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */


const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqNiWXKxI1PqXVzWVeJdqMI4pEJLKlNfxeW1Pbym8qZmpLvta1GgpqJbtpTJxYmnRw/exec";
const API_KEY = "LeadUp";  
/* ========================================= */

const $=id=>document.getElementById(id);
let token = localStorage.getItem("crm_token") || "";
let leads=[], focused=null;

/* ---------- API ---------- */
async function api(action,payload={}){
  const body={action, apiKey:API_KEY, token, ...payload};
  const r = await fetch(SCRIPT_URL,{
    method:"POST",
    headers: {"Content-Type":"text/plain;charset=utf-8"},
    body: JSON.stringify(body)
  });
  const data = await r.json().catch(()=>({ok:false, error:"Bad JSON"}));
  return data;
}

/* ---------- AUTH ---------- */
async function doLogin(){
  const username = $("inUser").value.trim();
  const pin      = $("inPin").value.trim();
  if(!username || !pin) return alert("× × ×œ××œ× ×©× ××©×ª××© ×•×§×•×“");

  $("btnLogin").disabled = true;
  $("btnLogin").textContent = "××ª×—×‘×¨...";

  const r = await api("login",{username, pin}).catch(()=>({ok:false}));
  $("btnLogin").disabled = false;
  $("btnLogin").textContent = "×”×ª×—×‘×¨";

  if(!r.ok) return alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª");

  token = r.token;
  localStorage.setItem("crm_token",token);
  setAuthedUI(true);
  refreshLeads();
}

function doLogout(){
  localStorage.removeItem("crm_token");
  token = "";
  location.reload();
}

function clearToken(){
  localStorage.removeItem("crm_token");
  token = "";
  alert("××•×¤×¡, ××™×¤×¡×ª×™ ×”×ª×—×‘×¨×•×ª. ×¢×›×©×™×• ×ª×ª×—×‘×¨ ××—×“×©.");
  location.reload();
}

/* ---------- UI STATE ---------- */
function setAuthedUI(isAuthed){
  document.body.classList.toggle("authed", isAuthed);
  document.body.classList.toggle("locked", !isAuthed);
}

/* ---------- UI ---------- */
function renderLeads(){
  const box=$("leadRows"); box.innerHTML="";
  leads.forEach(l=>{
    const overdue = l.followUpAt && new Date(l.followUpAt) < new Date();
    const d=document.createElement("div");
    d.className="row"+(overdue?" overdue":"");
    d.innerHTML=`
      <div>${escapeHtml(l.name||"")}</div>
      <div>${escapeHtml(l.phone||"")}</div>
      <div>${escapeHtml(l.status||"")}</div>
      <div>${overdue?'<span class="badge red">××™×—×•×¨</span>':'<span class="badge gold">×ª×§×™×Ÿ</span>'}</div>
    `;
    d.onclick=()=>setFocus(l);
    box.appendChild(d);
  });
}

async function setFocus(l){
  focused=l;
  $("noFocus").classList.add("hidden");
  $("focusBox").classList.remove("hidden");
  $("fName").textContent=l.name||"";
  $("fPhone").textContent=l.phone||"";
  $("fProd").textContent=l.productType||"";
  $("fStatus").value=l.status||"NEW";
  loadNotes();
  loadSchedules();
}

/* ---------- LOADERS ---------- */
async function refreshLeads(){
  const r=await api("listleads",{q:$("q").value});
  if(r.ok){
    leads=r.leads||[];
    renderLeads();
  } else {
    // ×× ×”×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ â€“ ×ª×—×–×•×¨ ×œ××¡×š ×”×ª×—×‘×¨×•×ª
    if(r.error && String(r.error).toLowerCase().includes("token")){
      localStorage.removeItem("crm_token");
      setAuthedUI(false);
    }
  }
}

async function loadNotes(){
  if(!focused) return;
  const r=await api("readlead",{leadId:focused.id});
  if(!r.ok) return;
  const notes=(r.lead && r.lead.notes) ? r.lead.notes : [];
  $("notesBox").innerHTML = notes.length
    ? notes.map(n=>`<div class="noteItem">${escapeHtml(n.ts||"")} â€¢ ${escapeHtml(n.by||"")}<br>${escapeHtml(n.text||"")}</div>`).join("")
    : "××™×Ÿ ×ª×™×¢×•×“";
}

async function loadSchedules(){
  if(!focused) return;
  const r=await api("listschedules",{leadId:focused.id});
  if(!r.ok) return;
  const arr=r.schedules||[];
  $("schList").innerHTML = arr.length
    ? arr.map(s=>`<div class="noteItem">â° ${escapeHtml(s.at||"")}<br>${escapeHtml(s.type||"")} â€” ${escapeHtml(s.note||"")}</div>`).join("")
    : "××™×Ÿ ×ª×–××•× ×™×";
}

/* ---------- ACTIONS ---------- */
async function saveLead(){
  if(!focused) return;
  if(!$("actionNote").value.trim()) return alert("×—×•×‘×” ×ª×™×¢×•×“");
  const r=await api("updatelead",{
    leadId:focused.id,
    patch:{
      status:$("fStatus").value,
      actionNote:$("actionNote").value
    }
  });
  if(r.ok){
    $("actionNote").value="";
    refreshLeads();
    loadNotes();
  }
}

async function addSchedule(){
  if(!focused) return;
  if(!$("actionNote").value.trim()) return alert("×—×•×‘×” ×ª×™×¢×•×“ ×œ×¤× ×™ ×ª×–××•×Ÿ");
  if(!$("schAt").value) return alert("×‘×—×¨ ×ª××¨×™×š ×•×©×¢×” ×œ×ª×–××•×Ÿ");

  const iso = new Date($("schAt").value).toISOString();
  const r = await api("addschedule",{
    leadId:focused.id,
    at:iso,
    type:$("schType").value,
    note:$("schNote").value,
    actionNote:$("actionNote").value
  });
  if(r.ok){
    $("schNote").value="";
    $("actionNote").value="";
    loadSchedules();
  }
}

function callLead(){
  if(!focused?.phone) return;
  window.location.href="tel:"+String(focused.phone).replace(/\D/g,"");
}

/* ---------- HELPERS ---------- */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, s => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[s]));
}

/* ---------- EVENTS ---------- */
$("btnLogin").onclick=doLogin;
$("btnLogout").onclick=doLogout;
$("btnRefresh").onclick=refreshLeads;
$("btnSave").onclick=saveLead;
$("btnAddSchedule").onclick=addSchedule;
$("btnCall").onclick=callLead;
$("btnClearToken").onclick=clearToken;

$("btnTakeNext").onclick=async ()=>{
  const r=await api("takenext",{});
  if(r.leadId) refreshLeads();
};

$("q").addEventListener("input", ()=>{
  // ×¨×¢× ×•×Ÿ ×§×˜×Ÿ ××—×¨×™ ×”×§×œ×“×”
  clearTimeout(window.__qT);
  window.__qT = setTimeout(refreshLeads, 250);
});

$("inPin").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") doLogin();
});

/* ---------- BOOT ---------- */
(function boot(){
  // ×× ×™×© ×˜×•×§×Ÿ â€“ × × ×¡×” ×œ×”×™×›× ×¡ ×™×©×¨ ×œ××¢×¨×›×ª
  if(token){
    setAuthedUI(true);
    refreshLeads();
  }else{
    setAuthedUI(false);
  }
})();
</script>

</body>
</html>
