<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>××¢×¨×›×ª CRM ×¤× ×™××™×ª â€“ ×¡×•×›× ×•×ª ×‘×™×˜×•×—</title>

  <style>
    :root{
      --bg:#0b0b0b;
      --panel:#111;
      --gold:#d4af37;
      --gold2:#f3e7b7;
      --line:rgba(255,255,255,.14);
      --radius:16px;
      --red:#ff4d4d;
      --green:#2ecc71;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui, -apple-system, Segoe UI, Arial;
      color:#fff;
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(212,175,55,.18), transparent 60%),
        radial-gradient(700px 500px at 110% 10%, rgba(212,175,55,.10), transparent 55%),
        var(--bg);
      overflow-x:hidden;
    }

    .hidden{display:none !important}

    .btn{
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:800;
      cursor:pointer;
      transition:transform .08s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:active{transform:scale(.98)}
    .btnGold{background:linear-gradient(180deg,var(--gold2),var(--gold));color:#111}
    .btnDark{background:rgba(255,255,255,.10);color:#fff;border:1px solid var(--line)}
    .btnSmall{padding:8px 10px;border-radius:10px;font-weight:800}

    .input,select,textarea{
      width:100%;
      border-radius:10px;
      padding:10px 10px;
      border:1px solid rgba(0,0,0,.15);
      outline:none;
      font-size:14px;
    }

    .glass{
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    /* ---------- LOGIN (FULLSCREEN) ---------- */
    .loginPage{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }
    .loginCard{
      width:min(440px, 100%);
      position:relative;
      overflow:hidden;
    }
    .loginCard::before{
      content:"";
      position:absolute; inset:-40px;
      background:radial-gradient(circle at 30% 20%, rgba(212,175,55,.25), transparent 45%);
      filter: blur(10px);
      pointer-events:none;
    }
    .loginInner{position:relative}
    .loginTitle{
      display:flex; align-items:center; justify-content:space-between;
      margin:0 0 10px 0;
      font-size:20px;
      font-weight:900;
      letter-spacing:.2px;
    }
    .loginHint{
      margin-top:10px;
      font-size:12px;
      opacity:.75;
      line-height:1.35;
    }
    .loginActions{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      margin-top:12px;
    }

    /* ---------- APP LAYOUT ---------- */
    .appGrid{
      display:grid;
      grid-template-columns:260px 1fr 420px;
      gap:12px;
      padding:12px;
      min-height:100vh;
    }

    .sidebar button{width:100%;margin-bottom:8px;text-align:right}

    .row{
      display:grid;
      grid-template-columns:1fr 1fr .8fr .8fr;
      padding:10px 8px;
      border-bottom:1px dashed rgba(255,255,255,.12);
      cursor:pointer;
    }
    .row:hover{background:rgba(212,175,55,.12)}
    .row.overdue{background:rgba(255,0,0,.15)}
    .badge{padding:2px 8px;border-radius:999px;font-size:12px;font-weight:800;display:inline-block}
    .badge.red{background:rgba(255,77,77,.20)}
    .badge.gold{background:rgba(212,175,55,.25)}

    .noteList{
      max-height:220px;
      overflow:auto;
      border:1px solid rgba(0,0,0,.12);
      border-radius:10px;
      padding:8px;
      background:#fff;
      color:#111;
    }
    .noteItem{border-bottom:1px dashed #ccc;padding:8px 0}
    .noteItem:last-child{border-bottom:none}
    .small{font-size:12px;opacity:.75}
    hr{border:none;height:1px;background:rgba(255,255,255,.15);margin:10px 0}

    .whiteCard{
      background:#fff;
      color:#111;
      border-radius:var(--radius);
      padding:12px;
      border:1px solid rgba(0,0,0,.10);
    }

    .topRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      flex-wrap:wrap;
    }

    /* ---------- MOBILE ---------- */
    @media (max-width: 1100px){
      .appGrid{grid-template-columns:240px 1fr}
      .right{grid-column:1/-1}
    }
    @media (max-width: 820px){
      .appGrid{grid-template-columns:1fr}
      .sidebar{order:1}
      .main{order:2}
      .right{order:3}
      .row{grid-template-columns:1.2fr 1fr .9fr .8fr; font-size:13px}
    }
  </style>
</head>

<body>

  <!-- LOGIN -->
  <div id="loginView" class="loginPage">
    <div class="glass loginCard">
      <div class="loginInner">
        <div class="loginTitle">
          <span>ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</span>
          <span style="opacity:.85">ğŸ”’</span>
        </div>

        <input id="inUser" class="input" placeholder="×©× ××©×ª××©" autocomplete="username">
        <div style="height:10px"></div>
        <input id="inPin" type="password" class="input" placeholder="×§×•×“" autocomplete="current-password">

        <div class="loginActions">
          <button class="btn btnDark btnSmall" id="btnClear">××™×¤×•×¡</button>
          <button class="btn btnGold" id="btnLogin">×”×ª×—×‘×¨</button>
        </div>

        <div class="loginHint">
          ×× ××ª×” ×¨×•××” ×©×’×™××ª <b>doGet ×œ× × ××¦×</b> ×‘Ö¾WebApp â€“ ×–×” ×ª×§×™×Ÿ. ×”××¢×¨×›×ª ×¢×•×‘×“×ª ×‘Ö¾POST.<br>
          ×”×ª×—×‘×¨×•×ª ×¨××©×•× ×” ×œ×¨×•×‘: <b>admin</b> / <b>1234</b>
        </div>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appView" class="appGrid hidden">

    <!-- SIDEBAR -->
    <div class="glass sidebar">
      <h3 style="margin:0 0 10px 0">ğŸ“Š ×ª×¤×¨×™×˜</h3>
      <button class="btn btnGold" id="btnTakeNext">âš¡ ×§×— ××ª ×”×‘×</button>
      <button class="btn btnDark" id="btnRefresh">ğŸ”„ ×¨×¢× ×Ÿ</button>
      <button class="btn btnDark" id="btnLogout">ğŸšª ×™×¦×™××”</button>
      <hr>
      <div class="small">×”×ª×¨××•×ª / SLA / ×ª×–××•× ×™× ×¢×•×‘×“×™× ××•×˜×•××˜×™×ª</div>
    </div>

    <!-- MAIN -->
    <div class="glass main">
      <div class="topRow">
        <h3 style="margin:0">ğŸ“‹ ×œ×™×“×™×</h3>
        <div style="display:flex;gap:10px;align-items:center;flex:1;justify-content:flex-end;min-width:260px">
          <input id="q" class="input" placeholder="×—×™×¤×•×© (×©×/×˜×œ×¤×•×Ÿ/×¡×˜×˜×•×¡)" style="max-width:380px">
          <button class="btn btnDark btnSmall" id="btnSearch">×—×¤×©</button>
        </div>
      </div>

      <div class="row" style="font-weight:900;opacity:.75;cursor:default">
        <div>×©×</div><div>×˜×œ×¤×•×Ÿ</div><div>×¡×˜×˜×•×¡</div><div>×“×—×™×¤×•×ª</div>
      </div>
      <div id="leadRows"></div>
    </div>

    <!-- RIGHT -->
    <div class="glass right">
      <div id="noFocus" class="small">×‘×—×¨ ×œ×™×“ ×›×“×™ ×œ×¨××•×ª ×¤×¨×˜×™×</div>

      <div id="focusBox" class="hidden">

        <div class="whiteCard">
          <b id="fName"></b><br>
          ğŸ“ <span id="fPhone"></span><br>
          ××•×¦×¨: <span id="fProd"></span>
          <div style="margin-top:8px;display:flex;gap:10px;justify-content:flex-end">
            <button class="btn btnGold btnSmall" id="btnCall">×—×™×™×’</button>
          </div>
        </div>

        <div style="height:10px"></div>

        <div class="whiteCard">
          <label><b>×¡×˜×˜×•×¡</b></label>
          <select id="fStatus" class="input">
            <option>NEW</option>
            <option>CONTACTING</option>
            <option>SOLD</option>
            <option>LOST</option>
          </select>

          <div style="height:8px"></div>

          <label><b>×ª×™×¢×•×“ ×—×•×‘×”</b></label>
          <textarea id="actionNote" class="input" rows="3" placeholder="××” ×¢×©×™×ª? ××” × ×××¨? ××” ×”×¦×¢×“ ×”×‘×?"></textarea>

          <button class="btn btnGold" style="margin-top:10px;width:100%" id="btnSave">ğŸ’¾ ×©××•×¨</button>
        </div>

        <div style="height:10px"></div>

        <div class="whiteCard">
          <h4 style="margin:0 0 10px 0">â±ï¸ ×ª×–××•×Ÿ</h4>
          <input id="schAt" type="datetime-local" class="input">
          <div style="height:8px"></div>
          <select id="schType" class="input">
            <option value="call">ğŸ“ ×©×™×—×”</option>
            <option value="whatsapp">ğŸ’¬ ×•×•××˜×¡××¤</option>
            <option value="docs">ğŸ“„ ××¡××›×™×</option>
            <option value="renewal">â™»ï¸ ×—×™×“×•×©</option>
          </select>
          <div style="height:8px"></div>
          <input id="schNote" class="input" placeholder="×”×¢×¨×”">
          <button class="btn btnGold" style="margin-top:10px;width:100%" id="btnAddSchedule">â• ×”×•×¡×£ ×ª×–××•×Ÿ</button>
        </div>

        <div style="height:10px"></div>

        <div class="whiteCard">
          <b>ğŸ“… ×ª×–××•× ×™×</b>
          <div style="height:8px"></div>
          <div id="schList" class="noteList">â€”</div>
        </div>

        <div style="height:10px"></div>

        <div class="whiteCard">
          <b>ğŸ“ ×ª×™×¢×•×“</b>
          <div style="height:8px"></div>
          <div id="notesBox" class="noteList">â€”</div>
        </div>

      </div>
    </div>

  </div>

  <script>
    /* ================= CONFIG ================= */
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqNiWXKxI1PqXVzWVeJdqMI4pEJLKlNfxeW1Pbym8qZQmIpLvta1GgpqJbtpTJxYmnRw/exec";
    const API_KEY = "LeadUp";
    /* ========================================= */

    const $ = (id) => document.getElementById(id);

    let token = localStorage.getItem("crm_token") || "";
    let leads = [];
    let focused = null;

    /* ---------- API ---------- */
    async function api(action, payload = {}) {
      const body = { action, apiKey: API_KEY, token, ...payload };

      let res, data;
      try {
        res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" }, // Apps Script friendly
          body: JSON.stringify(body),
        });
        data = await res.json();
      } catch (e) {
        console.error(e);
        return { ok: false, error: "NETWORK_OR_PARSE_ERROR" };
      }
      return data;
    }

    /* ---------- AUTH ---------- */
    async function doLogin() {
      const username = $("inUser").value.trim();
      const pin = $("inPin").value.trim();

      if (!username || !pin) return alert("× × ×œ××œ× ×©× ××©×ª××© ×•×§×•×“");

      const r = await api("login", { username, pin });

      if (!r || !r.ok) {
        console.log("login response:", r);
        return alert("×œ× ×”×ª×—×‘×¨. ×‘×“×•×§ ×©× ××©×ª××©/×§×•×“ ××• ×”×ª×××ª API_KEY.");
      }

      token = r.token;
      localStorage.setItem("crm_token", token);
      showApp();
    }

    function doLogout() {
      localStorage.removeItem("crm_token");
      token = "";
      focused = null;
      leads = [];
      showLogin();
    }

    function showApp() {
      $("loginView").classList.add("hidden");
      $("appView").classList.remove("hidden");
      refreshLeads();
    }

    function showLogin() {
      $("appView").classList.add("hidden");
      $("loginView").classList.remove("hidden");
      $("inPin").value = "";
    }

    /* ---------- UI ---------- */
    function renderLeads() {
      const box = $("leadRows");
      box.innerHTML = "";

      if (!leads.length) {
        box.innerHTML = `<div class="small" style="padding:10px;opacity:.8">××™×Ÿ ×œ×™×“×™× ×œ×”×¦×’×”</div>`;
        return;
      }

      leads.forEach((l) => {
        const overdue = l.followUpAt && new Date(l.followUpAt) < new Date();
        const d = document.createElement("div");
        d.className = "row" + (overdue ? " overdue" : "");
        d.innerHTML = `
          <div>${escapeHtml(l.name || "")}</div>
          <div>${escapeHtml(l.phone || "")}</div>
          <div>${escapeHtml(l.status || "")}</div>
          <div>${overdue ? '<span class="badge red">××™×—×•×¨</span>' : '<span class="badge gold">×ª×§×™×Ÿ</span>'}</div>
        `;
        d.onclick = () => setFocus(l);
        box.appendChild(d);
      });
    }

    async function setFocus(l) {
      focused = l;

      $("noFocus").classList.add("hidden");
      $("focusBox").classList.remove("hidden");

      $("fName").textContent = l.name || "";
      $("fPhone").textContent = l.phone || "";
      $("fProd").textContent = l.productType || "";
      $("fStatus").value = l.status || "NEW";

      await loadNotes();
      await loadSchedules();
    }

    /* ---------- LOADERS ---------- */
    async function refreshLeads() {
      const r = await api("listleads", { q: $("q").value || "" });

      if (!r || !r.ok) {
        console.log("listleads response:", r);
        // ×× ×™×© ×˜×•×§×Ÿ ×œ× ×ª×§×™×Ÿ â€“ × ×—×–×™×¨ ×œ××¡×š ×”×ª×—×‘×¨×•×ª
        if (r && (r.error === "UNAUTH" || r.error === "BAD_TOKEN")) {
          doLogout();
          return;
        }
        return alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×™×“×™×");
      }

      leads = r.leads || [];
      renderLeads();
    }

    async function loadNotes() {
      if (!focused) return;

      const r = await api("readlead", { leadId: focused.id });
      if (!r || !r.ok) {
        console.log("readlead response:", r);
        $("notesBox").textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×™×¢×•×“";
        return;
      }

      const notes = (r.lead && r.lead.notes) ? r.lead.notes : [];
      $("notesBox").innerHTML = notes.length
        ? notes.map(n => `<div class="noteItem">${escapeHtml(n.ts || "")} â€¢ ${escapeHtml(n.by || "")}<br>${escapeHtml(n.text || "")}</div>`).join("")
        : "××™×Ÿ ×ª×™×¢×•×“";
    }

    async function loadSchedules() {
      if (!focused) return;

      const r = await api("listschedules", { leadId: focused.id });
      if (!r || !r.ok) {
        console.log("listschedules response:", r);
        $("schList").textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×–××•× ×™×";
        return;
      }

      const arr = r.schedules || [];
      $("schList").innerHTML = arr.length
        ? arr.map(s => `<div class="noteItem">â° ${escapeHtml(s.at || "")}<br>${escapeHtml(s.type || "")} â€” ${escapeHtml(s.note || "")}</div>`).join("")
        : "××™×Ÿ ×ª×–××•× ×™×";
    }

    /* ---------- ACTIONS ---------- */
    async function saveLead() {
      if (!focused) return;

      const note = $("actionNote").value.trim();
      if (!note) return alert("×—×•×‘×” ×ª×™×¢×•×“");

      const r = await api("updatelead", {
        leadId: focused.id,
        patch: {
          status: $("fStatus").value,
          actionNote: note
        }
      });

      if (!r || !r.ok) {
        console.log("updatelead response:", r);
        return alert("×©×’×™××” ×‘×©××™×¨×”");
      }

      $("actionNote").value = "";
      await refreshLeads();
      await loadNotes();
    }

    async function addSchedule() {
      if (!focused) return;

      const note = $("actionNote").value.trim();
      if (!note) return alert("×—×•×‘×” ×ª×™×¢×•×“ ×œ×¤× ×™ ×ª×–××•×Ÿ");

      const dt = $("schAt").value;
      if (!dt) return alert("×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”");

      const iso = new Date(dt).toISOString();

      const r = await api("addschedule", {
        leadId: focused.id,
        at: iso,
        type: $("schType").value,
        note: $("schNote").value || "",
        actionNote: note
      });

      if (!r || !r.ok) {
        console.log("addschedule response:", r);
        return alert("×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×–××•×Ÿ");
      }

      $("schNote").value = "";
      $("actionNote").value = "";
      await loadSchedules();
      await loadNotes();
    }

    function callLead() {
      if (!focused?.phone) return;
      window.location.href = "tel:" + String(focused.phone).replace(/\D/g, "");
    }

    /* ---------- HELPERS ---------- */
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* ---------- EVENTS ---------- */
    $("btnLogin").onclick = doLogin;
    $("btnLogout").onclick = doLogout;
    $("btnRefresh").onclick = refreshLeads;
    $("btnSave").onclick = saveLead;
    $("btnAddSchedule").onclick = addSchedule;
    $("btnCall").onclick = callLead;
    $("btnSearch").onclick = refreshLeads;

    $("btnTakeNext").onclick = async () => {
      const r = await api("takenext", {});
      if (!r || !r.ok) {
        console.log("takenext response:", r);
        return alert("×©×’×™××” ×‘'×§×— ××ª ×”×‘×'");
      }
      await refreshLeads();
      if (r.leadId) {
        const found = leads.find(x => x.id === r.leadId);
        if (found) setFocus(found);
      }
    };

    $("btnClear").onclick = () => {
      $("inUser").value = "";
      $("inPin").value = "";
      localStorage.removeItem("crm_token");
      token = "";
    };

    // Enter to login
    $("inPin").addEventListener("keydown", (e) => {
      if (e.key === "Enter") doLogin();
    });

    // simple debounce search
    let t = null;
    $("q").addEventListener("input", () => {
      clearTimeout(t);
      t = setTimeout(refreshLeads, 250);
    });

    /* ---------- BOOT ---------- */
    // ×œ× ××¦×™×’×™× ××¢×¨×›×ª ×¨×§ ×‘×’×œ×œ ×©×™×© token ×©××•×¨ â€” ×§×•×“× × × ×¡×” ×œ×˜×¢×•×Ÿ ×œ×™×“×™×.
    (async function boot(){
      if (!token) return showLogin();

      // × ×¡×™×•×Ÿ "×©×§×˜" ×œ×˜×¢×•×Ÿ ×œ×™×“×™× ×¢× ×”×˜×•×§×Ÿ (×× ×œ× ×ª×§×™×Ÿ × ×—×–×•×¨ ×œ××¡×š ×”×ª×—×‘×¨×•×ª)
      const r = await api("listleads", { q: "" });
      if (r && r.ok) {
        showApp();
      } else {
        localStorage.removeItem("crm_token");
        token = "";
        showLogin();
      }
    })();
  </script>
</body>
</html>

