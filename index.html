

<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  
  

<script>
/* ===== Auth bootstrap (pre-paint) =====
   Always start in locked state to prevent any flash of the app.
   We unlock only after successful password in this tab/session.
*/
(function(){
  document.documentElement.classList.add("authPending");
})();
</script>

<script>
  // Theme bootstrap: default to LIGHT so the UI won't "flip to black" unexpectedly.
  (function(){
    try{
      const key = "leadup_theme";
      const saved = localStorage.getItem(key);
      const theme = (saved === "dark" || saved === "light") ? saved : "light";
      document.documentElement.setAttribute("data-theme", theme);
      if(saved !== theme) localStorage.setItem(key, theme);
    }catch(e){
      document.documentElement.setAttribute("data-theme", "light");
    }
  })();
  </script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LEADUP • מערכת ניהול לידים</title>
  <meta name="theme-color" content="#ffffff"/>
  <style>
    :root{
      --bg:#07070a;
      --panel:#0c0c12;
      --panel2:#10101a;
      --line:rgba(255,255,255,.10);
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --gold:#d6b25e;
      --gold2:#f2d27c;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --shadow2:0 12px 30px rgba(0,0,0,.40);
      --r:18px;
      --r2:22px;
      --focus: 0 0 0 3px rgba(214,178,94,.22);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans Hebrew", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.10), transparent 55%),
        radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.06), transparent 60%),
        linear-gradient(180deg, #06060a, #050509);
      color:var(--text);
      font-family:var(--font);
      overflow:hidden;
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      height:100vh;
    }

    /* Sidebar */
    .side{
      border-left:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:18px 16px;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 16px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(242,210,124,.45), transparent 55%),
        linear-gradient(145deg, rgba(214,178,94,.50), rgba(214,178,94,.08));
      box-shadow:0 12px 30px rgba(214,178,94,.12);
      border:1px solid rgba(214,178,94,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.6px;
    }
    .brand .sub{
      margin-top:2px;
      color:var(--muted2);
      font-size:12px;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:right;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:.18s ease;
    }
    .nav button:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .nav button.active{
      background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.04));
      border-color:rgba(214,178,94,.35);
      box-shadow:0 14px 32px rgba(214,178,94,.08);
    }
    .nav .k{
      display:flex;align-items:center;gap:10px;
      font-weight:650;
    }
    .pill{
      font-size:12px;
      color:rgba(255,255,255,.85);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
    }
    .pill.gold{border-color:rgba(214,178,94,.35); color:rgba(242,210,124,.95)}
    .sideFooter{
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--line);
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .sideFooter .hint{
      margin-top:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,94,.18);
      border-radius:14px;
      background:rgba(214,178,94,.06);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(214,178,94,.30);
      background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.08));
      color:rgba(242,210,124,.95);
      font-size:12px;
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--gold2);box-shadow:0 0 0 4px rgba(242,210,124,.18)}
    .topbar .title{
      display:flex; flex-direction:column;
    }
    .topbar .title b{font-size:16px}
    .topbar .title span{color:var(--muted2);font-size:12px;margin-top:2px}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:650;
    }
    /* Fix: keep 'ליד חדש' button on one line */
    #btnAddLead{white-space:nowrap; flex-shrink:0; min-width:120px; justify-content:center;}

    .btn:hover{transform:translateY(-1px); border-color:rgba(214,178,94,.25)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.gold{
      background:linear-gradient(180deg, rgba(214,178,94,.26), rgba(255,255,255,.05));
      border-color:rgba(214,178,94,.35);
      color:rgba(242,210,124,.98);
    }
    .btn.danger{
      border-color:rgba(255,107,107,.28);
      background:rgba(255,107,107,.08);
    }
    .search{
      position:relative;
      min-width:320px;
      max-width:520px;
      width:38vw;
    }
    .search input{
      width:100%;
      padding:12px 40px 12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
    }
    .search input:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .search .icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:rgba(255,255,255,.55);
      font-size:14px;
      pointer-events:none;
    }
    .content{
      padding:16px 18px 22px;
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.55fr 0.45fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1060px){
      .app{grid-template-columns: 1fr}
      .side{display:none}
      .grid{grid-template-columns: 1fr}
      body{overflow:auto}
      .main{height:auto}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .card .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.09);
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .card .body{padding:12px 14px 14px}
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset:-80px -60px auto auto;
      width:160px;height:160px;border-radius:50%;
      background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.08));
      filter:blur(2px);
    }
    .stat .k{color:var(--muted2); font-size:12px}
    .stat .v{margin-top:6px; font-size:20px; font-weight:800}
    .stat .mini{margin-top:3px; font-size:12px; color:rgba(242,210,124,.86)}
    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width:920px;
    }
    thead th{
      text-align:right;
      padding:12px 10px;
      color:rgba(255,255,255,.72);
      font-weight:700;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align:middle;
      color:rgba(255,255,255,.92);
    }
    tbody tr:hover td{background:rgba(214,178,94,.05)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.hot{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.08); color:rgba(255,204,102,.95)}
    .tag.ok{border-color:rgba(46,229,157,.30); background:rgba(46,229,157,.08); color:rgba(46,229,157,.95)}
    .tag.cold{border-color:rgba(255,255,255,.14); background:rgba(255,255,255,.03); color:rgba(255,255,255,.78)}
    .score{
      display:flex; align-items:center; gap:10px;
    }
    .bar{
      width:120px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      background:linear-gradient(90deg, rgba(214,178,94,.25), rgba(242,210,124,.65));
      width:50%;
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-start;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:.16s ease;
    }
    .iconBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .iconBtn.gold{border-color:rgba(214,178,94,.30); background:rgba(214,178,94,.10)}
    .muted{color:var(--muted2)}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){ .row{grid-template-columns:1fr} table{min-width:800px} }
    label{display:block; font-size:12px; color:rgba(255,255,255,.70); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
      font-family:inherit;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .help{
      margin-top:8px;
      color:rgba(255,255,255,.62);
      font-size:12px;
      line-height:1.4;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    
      opacity:0;
      transition: opacity .18s ease;
    }
    .modalBack.show{ opacity:1; }
    .modalBack.closing{ opacity:0; }

    .modal{
      width:min(980px, 100%);
  max-height:min(86vh, 900px);
  overflow:auto;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.14);
      background:
     radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.10), transparent 55%),
    linear-gradient(180deg, rgba(10,10,18,.98), rgba(6,6,12,.96));
      box-shadow:0 30px 90px rgba(0,0,0,.85);
      position:relative;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:2;
    }
    .modalHeader b{font-size:14px}
    .modalBody{padding:14px 16px 16px}
    .closeX{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      color:var(--text);
    }
    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(520px, calc(100vw - 36px));
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }
    .miniCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:18px;
      padding:12px;
    }
    .miniCard h3{margin:0 0 10px 0; font-size:13px}
    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height:500px; overflow:auto; padding-left:4px;
    }
    .event{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px 10px;
    }
    .event .t{font-size:12px; color:rgba(255,255,255,.75)}
    .event .d{margin-top:4px; font-size:13px}
    .kbd{
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      border-bottom-color:rgba(255,255,255,.24);
      padding:2px 8px;
      border-radius:10px;
      color:rgba(255,255,255,.85);
    }
    .small{font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.10); margin:12px 0}

    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){ .twoCols{grid-template-columns:1fr} }

    .frame{
      width:100%;
      height:460px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .frame iframe{width:100%;height:100%;border:0}
  
/* =======================
   Light Cream Theme (override)
   ======================= */
:root{
  --bg:#fbf7ef;
  --panel:#ffffff;
  --panel2:#f6f0e4;
  --line:rgba(20,20,30,.10);
  --text:#121218;
  --muted:rgba(18,18,24,.70);
  --muted2:rgba(18,18,24,.52);
  --shadow:0 20px 60px rgba(20,20,30,.14);
  --shadow2:0 12px 30px rgba(20,20,30,.12);
  --focus: 0 0 0 3px rgba(214,178,94,.28);
}
body{
  background:
    radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.14), transparent 55%),
    radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.10), transparent 60%),
    linear-gradient(180deg, #fffdf8, #f4efe4);
  color:var(--text);
}
/* Layout surfaces */
.side{
  border-left:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.55));
}
.topbar{
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.78);
  color:var(--text);
}
/* Cards */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
  border:1px solid var(--line);
  box-shadow:var(--shadow2);
}
.card .head{
  border-bottom:1px solid var(--line);
}
/* Inputs */
.search input,
input, select, textarea{
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.86);
  color:var(--text);
}
.search .icon{color:rgba(18,18,24,.45)}
/* Buttons */
.btn, .iconBtn, .closeX{
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.70);
  color:var(--text);
}
.btn:hover, .iconBtn:hover{border-color:rgba(214,178,94,.40)}
.btn.gold{
  background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.70));
  border-color:rgba(214,178,94,.45);
  color:#5b4514;
}
.btn.danger{
  border-color:rgba(255,107,107,.35);
  background:rgba(255,107,107,.10);
}
.badge{
  border:1.2px solid rgba(214,178,94,.55);
  background:rgba(214,178,94,.14);
  color:#5b4514;
}
/* Typography muted */
.muted{color:var(--muted2)!important}
.help, .brand .sub, .sideFooter{color:var(--muted2)!important}
.stat .k{color:var(--muted2)!important}
/* Tables */
thead th{
  color:rgba(18,18,24,.68)!important;
  border-bottom:1px solid var(--line)!important;
  background:rgba(255,255,255,.78)!important;
}
tbody td{
  color:rgba(18,18,24,.92)!important;
  border-bottom:1px solid rgba(20,20,30,.08)!important;
}
tbody tr:hover td{background:rgba(214,178,94,.10)!important}
/* Pills / tags */
.pill{
  border:1px solid rgba(20,20,30,.12);
  background:rgba(255,255,255,.72);
  color:rgba(18,18,24,.80);
}
.pill.gold{border-color:rgba(214,178,94,.45); color:#5b4514; background:rgba(214,178,94,.10)}
.tag{
  border:1px solid rgba(20,20,30,.12);
  background:rgba(255,255,255,.72);
  color:rgba(18,18,24,.85);
}
.tag.hot{border-color:rgba(255,204,102,.55); background:rgba(255,204,102,.18); color:#7a4f00}
.tag.ok{border-color:rgba(46,229,157,.45); background:rgba(46,229,157,.14); color:#0b5b3d}
.tag.cold{border-color:rgba(20,20,30,.14); background:rgba(255,255,255,.60); color:rgba(18,18,24,.70)}
/* Stat blocks / mini cards */
.stat, .miniCard, .event{
  border:1px solid rgba(20,20,30,.10);
  background:rgba(255,255,255,.72);
}
/* Modal + overlay */
.modalBack{background:rgba(20,20,30,.35)}
.modal{
  border:1px solid rgba(20,20,30,.14);
  background:
    radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.12), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.94), rgba(245,239,228,.94));
  box-shadow:0 30px 90px rgba(20,20,30,.25);
}
.modalHeader{
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.80);
}
.toast{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(20,20,30,.14);
  color:rgba(18,18,24,.92);
}


/* ===== Gold Boost ===== */
:root{
  --gold:#c9a441;
  --gold2:#f5d77a;
}

.btn.gold{
  background:linear-gradient(180deg, rgba(201,164,65,.38), rgba(255,255,255,.65));
  border-color:rgba(201,164,65,.65);
  color:#5a3f00;
  box-shadow:0 6px 18px rgba(201,164,65,.25);
}

.pill.gold{
  background:rgba(201,164,65,.22);
  border-color:rgba(201,164,65,.65);
  color:#5a3f00;
}

.badge{
  background:linear-gradient(180deg, rgba(201,164,65,.30), rgba(201,164,65,.12));
  border-color:rgba(201,164,65,.70);
  color:#5a3f00;
}

.tag.hot{
  background:rgba(245,215,122,.28);
  border-color:rgba(201,164,65,.75);
  color:#5a3f00;
}

.nav button.active{
  background:linear-gradient(180deg, rgba(201,164,65,.30), rgba(255,255,255,.55));
  border-color:rgba(201,164,65,.65);
  box-shadow:0 10px 26px rgba(201,164,65,.28);
}

.logo{
  box-shadow:0 14px 36px rgba(201,164,65,.35);
  border:1px solid rgba(201,164,65,.55);
}


/* =======================
   Premium Dark Gold + Glow
   ======================= */
:root{
  --gold:#9f7a19;        /* dark luxury gold */
  --gold2:#e6c15a;       /* highlight gold */
}

/* Premium buttons */
.btn.premium{
  background:linear-gradient(180deg, rgba(159,122,25,.55), rgba(120,90,10,.45));
  border-color:rgba(159,122,25,.85);
  color:#fff3c9;
  box-shadow:
    0 10px 26px rgba(159,122,25,.45),
    inset 0 1px 0 rgba(255,255,255,.25);
  letter-spacing:.3px;
}
.btn.premium:hover{
  transform:translateY(-2px) scale(1.01);
  box-shadow:
    0 14px 34px rgba(159,122,25,.60),
    inset 0 1px 0 rgba(255,255,255,.35);
}

/* Dark gold for standard gold buttons */
.btn.gold{
  background:linear-gradient(180deg, rgba(159,122,25,.40), rgba(255,255,255,.70));
  border-color:rgba(159,122,25,.70);
  color:#4b3600;
}

/* Glow animation on click */
.btn:active,
.iconBtn:active{
  animation: goldGlow .45s ease-out;
}

@keyframes goldGlow{
  0%{
    box-shadow:0 0 0 0 rgba(159,122,25,.0);
  }
  40%{
    box-shadow:0 0 18px 6px rgba(159,122,25,.55);
  }
  100%{
    box-shadow:0 0 0 0 rgba(159,122,25,.0);
  }
}

/* Premium navigation highlight */
.nav button.active{
  background:linear-gradient(180deg, rgba(159,122,25,.38), rgba(255,255,255,.60));
  border-color:rgba(159,122,25,.75);
  box-shadow:0 12px 28px rgba(159,122,25,.45);
}

/* Logo luxury glow */
.logo{
  box-shadow:
    0 18px 42px rgba(159,122,25,.55),
    inset 0 0 12px rgba(255,215,120,.25);
}

/* Premium badge */
.badge{
  background:linear-gradient(180deg, rgba(159,122,25,.35), rgba(159,122,25,.18));
  border-color:rgba(159,122,25,.85);
  color:#4b3600;
}


/* =======================
   Micro-interactions + Theme toggle + Premium loader
   ======================= */
body, .topbar, .side, .card, .miniCard, .stat, .event, thead th, tbody td,
.btn, .iconBtn, input, select, textarea, .pill, .tag{
  transition: background .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .25s ease, opacity .25s ease;
}

/* Dynamic card hover */
.card:hover{
  transform: translateY(-2px);
  box-shadow: 0 16px 38px rgba(20,20,30,.16);
}
.card:has(.tableWrap):hover{ /* keep table cards calmer */
  transform:none;
}

/* Subtle screen transition */
.viewPanel{
  animation: viewIn .22s ease-out;
}
@keyframes viewIn{
  from{ opacity:0; transform:translateY(6px); }
  to{ opacity:1; transform:translateY(0); }
}

/* Premium loader overlay */
.loader{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(20,20,30,.18);
  backdrop-filter: blur(4px);
  z-index:80;
}
.loader.show{ display:flex; }
.loaderCard{
  width:min(360px, calc(100vw - 36px));
  border-radius:18px;
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.92);
  box-shadow: 0 20px 60px rgba(20,20,30,.18);
  padding:16px 16px 14px;
  display:flex;
  align-items:center;
  gap:12px;
}
.loaderRing{
  width:34px;height:34px;border-radius:50%;
  border:3px solid rgba(159,122,25,.22);
  border-top-color: rgba(159,122,25,.85);
  animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
.loaderText{
  font-weight:800;
  color:rgba(18,18,24,.86);
  white-space:nowrap;
}
.loaderBar{
  flex:1;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(20,20,30,.12);
  background:rgba(245,239,228,.9);
  overflow:hidden;
}
.loaderBar i{
  display:block; height:100%;
  width:42%;
  background:linear-gradient(90deg, rgba(159,122,25,.20), rgba(230,193,90,.75), rgba(159,122,25,.25));
  animation: bar 1.05s ease-in-out infinite;
}
@keyframes bar{
  0%{ transform:translateX(-35%); }
  50%{ transform:translateX(85%); }
  100%{ transform:translateX(-35%); }
}

/* Dark mode */
html[data-theme="dark"]{
  color-scheme: dark;
}
html[data-theme="dark"] body{
  background:
    radial-gradient(1200px 700px at 80% 10%, rgba(159,122,25,.20), transparent 55%),
    radial-gradient(900px 600px at 10% 80%, rgba(230,193,90,.10), transparent 60%),
    linear-gradient(180deg, #0a0a10, #07070b);
  color:#ffffff;
}
html[data-theme="dark"] :root{
  /* variables are already set; we override via selectors below */
}
html[data-theme="dark"] .side{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border-left:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] .topbar{
  background:rgba(0,0,0,.22);
  border-bottom:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] .card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] thead th{
  background:rgba(0,0,0,.22)!important;
  color:rgba(255,255,255,.72)!important;
  border-bottom:1px solid rgba(255,255,255,.10)!important;
}
html[data-theme="dark"] tbody td{
  color:rgba(255,255,255,.92)!important;
  border-bottom:1px solid rgba(255,255,255,.07)!important;
}
html[data-theme="dark"] .btn, 
html[data-theme="dark"] .iconBtn,
html[data-theme="dark"] .closeX{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.12);
  color:#ffffff;
}
html[data-theme="dark"] .btn.gold{
  background:linear-gradient(180deg, rgba(159,122,25,.32), rgba(255,255,255,.05));
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .btn.premium{
  background:linear-gradient(180deg, rgba(159,122,25,.52), rgba(25,20,10,.70));
  border-color:rgba(159,122,25,.70);
  color:#fff3c9;
}
html[data-theme="dark"] input,
html[data-theme="dark"] select,
html[data-theme="dark"] textarea,
html[data-theme="dark"] .search input{
  background:rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.10);
  color:#ffffff;
}
html[data-theme="dark"] .pill,
html[data-theme="dark"] .tag{
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(255,255,255,.88);
}
html[data-theme="dark"] .pill.gold{
  background:rgba(159,122,25,.14);
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .badge{
  background:rgba(159,122,25,.12);
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .loaderCard{
  background:rgba(10,10,18,.95);
  border:1px solid rgba(255,255,255,.14);
}
html[data-theme="dark"] .loaderText{ color:rgba(255,255,255,.90); }
html[data-theme="dark"] .loaderBar{
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
}


/* =======================
   Soft Gold+White smear button
   ======================= */
.btn.goldSoft{
  border-color:rgba(159,122,25,.55);
  color:#4b3600;
  background:
    radial-gradient(140px 70px at 20% 25%, rgba(230,193,90,.45), transparent 60%),
    radial-gradient(180px 90px at 85% 10%, rgba(255,255,255,.85), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.78), rgba(245,239,228,.72));
  box-shadow:
    0 10px 22px rgba(159,122,25,.16),
    inset 0 1px 0 rgba(255,255,255,.45);
}
.btn.goldSoft:hover{
  border-color:rgba(159,122,25,.70);
  transform:translateY(-2px);
  box-shadow:
    0 14px 30px rgba(159,122,25,.22),
    inset 0 1px 0 rgba(255,255,255,.55);
}


/* =======================
   Premium polish pack (safe)
   ======================= */

/* (5) Live gold gradient shimmer (very subtle) */
@keyframes goldShimmer{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 100% 50%; }
}
/* shimmer on accents */
.btn.goldSoft{ position:relative; overflow:hidden; }
.btn.goldSoft::after{
  content:"";
  position:absolute; inset:0;
  border-radius:inherit;
  background-image: linear-gradient(90deg,
    rgba(159,122,25,.20),
    rgba(230,193,90,.55),
    rgba(255,255,255,.55),
    rgba(159,122,25,.20)
  );
  background-size: 220% 100%;
  opacity:.38;
  mix-blend-mode: multiply;
  pointer-events:none;
  animation: goldShimmer 7.5s ease-in-out infinite;
}
html[data-theme="dark"] .btn.goldSoft::after{
  opacity:.30;
  mix-blend-mode: screen;
}
.logo, .pill.gold, .badge{
  background-size: 220% 100%;
  animation: goldShimmer 8.5s ease-in-out infinite;
}

/* (1) Active view highlight */
.activeView{
  position:relative;
  border-color: rgba(159,122,25,.38) !important;
  box-shadow:
    0 18px 44px rgba(159,122,25,.14),
    0 10px 30px rgba(20,20,30,.10) !important;
}
.activeView::before{
  content:"";
  position:absolute;
  inset:10px auto 10px 10px;
  width:3px;
  border-radius:999px;
  background: linear-gradient(180deg, rgba(159,122,25,.0), rgba(230,193,90,.95), rgba(159,122,25,.0));
  opacity:.75;
}
html[dir="rtl"] .activeView::before{
  inset:10px 10px 10px auto;
}

/* (7) Smart toast variants */
.toast{ display:none; }
.toast.show{ display:block; }
.toast.success{
  border-color: rgba(46,229,157,.30);
  background: rgba(46,229,157,.10);
}
.toast.warn{
  border-color: rgba(230,193,90,.40);
  background: rgba(230,193,90,.12);
}
.toast.error{
  border-color: rgba(255,107,107,.40);
  background: rgba(255,107,107,.12);
}

/* (4) Micro-interactions */
.btn, .iconBtn{ will-change: transform; }
.btn:active, .iconBtn:active{ transform: translateY(0) scale(.99); }
.iconBtn:focus-visible, .btn:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
  outline:none;
  box-shadow:var(--focus);
}

/* tooltip for icon buttons */
[data-tip]{ position:relative; }
[data-tip]:hover::after{
  content: attr(data-tip);
  position:absolute;
  top:-38px;
  left:50%;
  transform:translateX(-50%);
  padding:6px 10px;
  border-radius:12px;
  background: rgba(20,20,30,.92);
  color: rgba(255,255,255,.92);
  font-size:12px;
  white-space:nowrap;
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
  z-index:30;
}
html[dir="rtl"] [data-tip]:hover::after{ left:auto; right:50%; transform: translateX(50%); }
html[data-theme="dark"] [data-tip]:hover::after{ background: rgba(0,0,0,.72); }


/* Hide topbar quick button (moved to sidebar) */
.hideTopQuick{ display:none !important; }


/* Nav micro-bounce for My Flows */
#navMyFlows:hover{ transform: translateY(-1px); }
#navMyFlows:active{ transform: translateY(0) scale(.99); }


/* =======================
   Premium Circle Logo
   ======================= */
.logo{
  width:44px;
  height:44px;
  border-radius:999px;
  display:grid;
  place-items:center;
  font-weight:900;
  letter-spacing:.6px;
  font-size:16px;
  color:#fff6dd;
  border:1px solid rgba(159,122,25,.75);
  background:
    radial-gradient(18px 18px at 30% 28%, rgba(255,255,255,.55), transparent 60%),
    radial-gradient(26px 26px at 70% 68%, rgba(230,193,90,.35), transparent 65%),
    linear-gradient(180deg, rgba(120,90,10,.95), rgba(159,122,25,.85), rgba(230,193,90,.55));
  box-shadow:
    0 18px 42px rgba(159,122,25,.45),
    inset 0 1px 0 rgba(255,255,255,.28);
  position:relative;
  overflow:hidden;
}
.logo::after{
  content:"";
  position:absolute; inset:-30%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
  transform: rotate(20deg);
  animation: logoSweep 6.8s ease-in-out infinite;
  opacity:.65;
}
@keyframes logoSweep{
  0%{ transform: translateX(-45%) rotate(20deg); }
  45%{ transform: translateX(45%) rotate(20deg); }
  100%{ transform: translateX(-45%) rotate(20deg); }
}
.brand .sub{
  margin-top:2px;
  font-size:11px;
  letter-spacing:.6px;
  text-transform:uppercase;
  color: rgba(159,122,25,.85);
}
html[data-theme="dark"] .brand .sub{
  color: rgba(230,193,90,.88);
}


/* ===== Proposal Builder Modal ===== */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modalOverlay.show{display:flex}
.modalCard{width:min(1100px,92vw);height:min(78vh,760px);background:var(--panel);border:1px solid var(--line);border-radius:18px;box-shadow:0 22px 70px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
.modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0))}
.modalHead .title{font-weight:800}
.modalHead .sub{color:var(--muted);font-size:12px;margin-top:2px}
.modalBody{display:flex;gap:14px;padding:14px 16px;flex:1;overflow:hidden}
.modalLeft{width:340px;max-width:40%;min-width:260px;display:flex;flex-direction:column;gap:10px}
.companyList{display:grid;grid-template-columns:1fr;gap:10px;overflow:auto;padding-right:2px}
.companyBtn{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 12px;border:1px solid var(--line);border-radius:14px;background:var(--panel2);cursor:pointer;transition:transform .12s ease, border-color .12s ease}
.companyBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.45)}
.companyBtn .name{font-weight:800}
.companyBtn .hint{font-size:12px;color:var(--muted)}
.modalRight{flex:1;min-width:0;display:flex;flex-direction:column;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--panel2)}
.proposalTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
.proposalTop .crumb{font-size:12px;color:var(--muted)}
.proposalFrame{flex:1;min-height:0}
.proposalFrame iframe{width:100%;height:100%;border:0;background:#fff}
.modalFoot{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line);background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.06))}
.btnGhost{background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btnGold{background:linear-gradient(135deg, var(--gold), var(--gold2));color:#111;padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
@media (max-width: 820px){
  .modalBody{flex-direction:column}
  .modalLeft{width:100%;max-width:100%}
}


/* ===== Top Bar Cream Background ===== */
.topBar, header, .header, .appHeader {
  background: #fff7e6 !important;
}


/* ===== Top Controls Cream Background ===== */
.topControls, .top-actions, .toolbar, .headerBar, .controlsRow {
  background: #fff4dd !important;
}


/* ===== Top Bar Gold Divider + Depth ===== */
.topBar, header, .header, .appHeader,
.topControls, .top-actions, .toolbar, .headerBar, .controlsRow {
  border-bottom: 1.5px solid rgba(214,178,94,0.55) !important; /* gold line */
  box-shadow: 0 4px 14px rgba(0,0,0,0.08) !important;          /* subtle depth */
}


/* ===== Mirror Client (Real View) ===== */
.mirrorGrid{display:grid;grid-template-columns:360px 1fr;gap:14px;flex:1;min-height:0}
.mirrorPanel{border:1px solid var(--line);background:var(--panel2);border-radius:16px;padding:12px;overflow:auto}
.mirrorPanel h4{margin:0 0 10px;font-size:14px}
.mirrorField{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.mirrorField label{font-size:12px;color:var(--muted)}
.mirrorField input,.mirrorField select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);outline:none}
.mirrorCard{border:1px solid var(--line);border-radius:14px;padding:10px;background:var(--panel)}
.mirrorKV{display:grid;grid-template-columns:92px 1fr;gap:8px;font-size:13px}
.mirrorKV div:nth-child(odd){color:var(--muted)}
.mirrorKV div:nth-child(even){font-weight:700}
.mirrorActions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.mirrorActions .btnGhost,.mirrorActions .btnGold{white-space:nowrap}
.mirrorPreview{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--panel2);display:flex;flex-direction:column;min-height:0}
.mirrorPreviewHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
.mirrorPreviewHead .ttl{font-weight:900}
.mirrorPreviewHead .meta{font-size:12px;color:var(--muted)}
.mirrorPreviewBody{flex:1;min-height:0}
.mirrorPreviewBody iframe{width:100%;height:100%;border:0;background:#fff}
.mirrorNotice{font-size:12px;color:var(--muted);line-height:1.6}
@media (max-width: 920px){
  .mirrorGrid{grid-template-columns:1fr}
}
.mirrorOnly body{overflow:hidden}
.mirrorStandalone{position:fixed;inset:0;background:#fff;z-index:100000;display:none}
.mirrorStandalone.show{display:block}
.mirrorStandaloneInner{position:absolute;inset:0;display:flex;flex-direction:column}
.mirrorStandaloneTop{padding:12px 16px;border-bottom:1px solid rgba(214,178,94,0.55);box-shadow:0 4px 14px rgba(0,0,0,0.08)}
.mirrorStandaloneTop .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.mirrorStandaloneTop .row .title{font-weight:1000}
.mirrorStandaloneTop .row .sub{font-size:12px;color:#555}
.mirrorStandaloneMain{flex:1;min-height:0;padding:14px 16px;background:#fff7e6}
.mirrorStandaloneMain .wrap{height:100%;max-width:1200px;margin:0 auto}


/* ===== Fix: Modal labels contrast on Light/Cream UI ===== */
html[data-theme="light"] label{
  color: rgba(12,12,18,.82) !important;
}
html[data-theme="light"] .modalBody label{
  color: rgba(12,12,18,.90) !important;
  font-weight: 800 !important;
}
html[data-theme="light"] .modalBody .muted,
html[data-theme="light"] .modalBody .small,
html[data-theme="light"] .modalBody .hint{
  color: rgba(12,12,18,.62) !important;
}
html[data-theme="light"] .modalBody input::placeholder,
html[data-theme="light"] .modalBody textarea::placeholder{
  color: rgba(12,12,18,.45) !important;
  opacity: 1 !important;
}


/* ==== FIX: Lead form labels visibility (ליד חדש / עריכת ליד) ==== */
#modalBody #leadForm label{
  color: rgba(20,20,25,.72) !important;
  opacity: 1 !important;
}
#modalBody #leadForm .help,
#modalBody #leadForm .hint,
#modalBody #leadForm small{
  color: rgba(20,20,25,.58) !important;
  opacity: 1 !important;
}
#modalBody #leadForm input::placeholder,
#modalBody #leadForm textarea::placeholder{
  color: rgba(20,20,25,.45) !important;
  opacity: 1 !important;
}


/* ==== Mirror Client: wider modal + steps template ==== */
#mirrorModal .modalCard.wide{
  width:min(1320px, 98vw);
  height:min(88vh, 860px);
  display:flex;
  flex-direction:column;
}
#mirrorModal .modalBody{flex:1; min-height:0;}
#mirrorModal .modalCard.wide .mirrorGrid{grid-template-columns:420px 1fr;}
#mirrorModal .mirrorPanel{min-height:0;}
#mirrorModal .mirrorPreview{min-height:520px;}
#mirrorModal .mirrorPanel h4{margin:0 0 6px}

.mirrorSteps{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:14px;
  background: rgba(214,178,94,.06);
  padding:10px 10px;
}
.mirrorSteps > summary{
  cursor:pointer;
  font-weight:800;
  color: var(--text);
  list-style:none;
}
.mirrorSteps > summary::-webkit-details-marker{display:none;}
.mirrorStepsBody{margin-top:8px; display:flex; flex-direction:column; gap:10px;}
.mirrorStepsGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
@media (max-width: 880px){
  #mirrorModal .modalCard.wide .mirrorGrid{grid-template-columns:1fr;}
  .mirrorStepsGrid{grid-template-columns:1fr;}
}


/* ==== Layout tweak: widen leads list, slightly shrink control center ==== */
#viewRight{ min-width: 320px; }
#viewLeads{ min-width: 0; }
#viewLeads .tableWrap{ overflow:auto; }


/* ==== Leads table: more "air" without breaking layout ==== */
#viewLeads table{
  min-width: 1120px;
  border-spacing: 0 10px; /* vertical breathing room */
}
#viewLeads thead th{
  padding: 12px 14px;
  font-size: 13px;
}
#viewLeads tbody td{
  padding: 14px 14px;
  font-size: 13.5px;
}
#viewLeads tbody tr{
  height: 64px;
}
#viewLeads th:nth-child(1), #viewLeads td:nth-child(1){ min-width: 200px; } /* שם */
#viewLeads th:nth-child(2), #viewLeads td:nth-child(2){ min-width: 150px; } /* טלפון */
#viewLeads th:nth-child(3), #viewLeads td:nth-child(3){ min-width: 120px; } /* סטטוס */
#viewLeads th:nth-child(4), #viewLeads td:nth-child(4){ min-width: 110px; } /* מקור */
#viewLeads th:nth-child(5), #viewLeads td:nth-child(5){ min-width: 150px; } /* חום */
#viewLeads th:nth-child(6), #viewLeads td:nth-child(6){ min-width: 170px; } /* מעקב הבא */
#viewLeads th:nth-child(7), #viewLeads td:nth-child(7){ min-width: 170px; } /* פעולות */


/* ==== Leads table: pro alignment for actions column ==== */
#viewLeads td .actions{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* RTL: start = right */
  gap:10px;
  flex-wrap:nowrap;
}
#viewLeads td:last-child{ white-space:nowrap; }
#viewLeads .iconBtn{
  width:36px;
  height:36px;
  border-radius:12px;
  font-size:16px;
  line-height:1;
}


/* ==== Ensure leads table fits viewport without horizontal scroll ==== */
#viewLeads{
  overflow-x: hidden;
}

#viewLeads .tableWrap{
  overflow-x: hidden;
}

#viewLeads table{
  width:100%;
  min-width:0; /* allow table to shrink to container */
  table-layout: fixed;
}

#viewLeads th, 
#viewLeads td{
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

/* rebalance column widths so everything fits */
#viewLeads th:nth-child(1), #viewLeads td:nth-child(1){ width: 22%; } /* שם */
#viewLeads th:nth-child(2), #viewLeads td:nth-child(2){ width: 18%; } /* טלפון */
#viewLeads th:nth-child(3), #viewLeads td:nth-child(3){ width: 14%; } /* סטטוס */
#viewLeads th:nth-child(4), #viewLeads td:nth-child(4){ width: 14%; } /* מקור */
#viewLeads th:nth-child(5), #viewLeads td:nth-child(5){ width: 14%; } /* חום */
#viewLeads th:nth-child(6), #viewLeads td:nth-child(6){ width: 18%; } /* פעולות */


/* ==== E-Sign: wide clean modal + options ==== */
#esignModal .modalCard.wide{
  width:min(1320px, 98vw);
  height:min(88vh, 860px);
  display:flex;
  flex-direction:column;
}
#esignModal .modalBody{flex:1;min-height:0;}
#esignModal .mirrorGrid{gap:14px;}
#esignModal .mirrorPanel, #esignModal .mirrorPreview{min-height:0;}
#esignModal .mirrorPreview{border:1px solid var(--line);border-radius:18px;background:rgba(214,178,94,.06);}
#esignModal .field .cap{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
#esignModal input, #esignModal textarea{
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: var(--panel);
  color: var(--text);
  outline:none;
}
#esignModal input:focus, #esignModal textarea:focus{
  border-color: rgba(214,178,94,.55);
  box-shadow: 0 0 0 3px rgba(214,178,94,.18);
}
.esignOptions{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
.esignOptionBtn{
  text-align:right;
  padding:12px 14px;
  border-radius:16px;
}
.esignOptionBtn.active{
  border-color: rgba(214,178,94,.75) !important;
  box-shadow: 0 0 0 3px rgba(214,178,94,.18);
  background: rgba(214,178,94,.10);
}
.esignMsg{
  width:100%;
  height:100%;
  min-height:180px;
  resize:none;
  line-height:1.65;
  font-size:14px;
}
@media (max-width: 920px){
  #esignModal .mirrorGrid{grid-template-columns:1fr !important;}
  #esignModal .modalCard.wide{height:min(92vh, 900px);}
}


/* ==== E-Sign: channel selector chips ==== */
#esignModal .chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background: var(--panel);
  color: var(--text);
  font-weight:700;
  user-select:none;
}
#esignModal .chip input{ accent-color: #d6b25e; }


/* ==== E-Sign: PRO layout fix (wider + clearer + no overlaps) ==== */
#esignModal .modalCard.wide{
  width:min(1500px, 99vw);
  height:min(92vh, 920px);
}

#esignModal .modalBody{
  padding: 14px 16px 18px;
}

#esignModal .esignGrid{
  display:grid;
  grid-template-columns: 1fr 460px; /* left details / right templates (RTL feels natural) */
  gap:14px;
  height:100%;
  min-height:0;
}

#esignModal .mirrorPanel{
  background: rgba(214,178,94,.06);
  border:1px solid var(--line);
  border-radius:18px;
  padding:14px;
  overflow:auto;
}

#esignModal .esignPreview{
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  min-height:0;
  overflow:auto;
  border:1px solid var(--line);
  border-radius:18px;
  background: rgba(214,178,94,.06);
}

#esignModal .field{display:block}
#esignModal .field .cap{font-size:12px;color:var(--muted);margin:0 0 6px;display:block}
#esignModal input, #esignModal textarea{
  width:100%;
  box-sizing:border-box;
}

#esignModal .row{align-items:center}

#esignModal .esignChip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background: var(--panel);
  color: var(--text);
  font-weight:800;
  user-select:none;
}
#esignModal .esignChip input{ accent-color: #d6b25e; margin:0 0 0 6px; }

/* Buttons in templates column */
#esignModal .esignOptions{display:grid;grid-template-columns:1fr;gap:10px;margin-top:10px}
#esignModal .esignOptionBtn{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  padding:14px 14px;
  border-radius:16px;
}
#esignModal .esignOptionBtn.active{
  border-color: rgba(214,178,94,.75) !important;
  box-shadow: 0 0 0 3px rgba(214,178,94,.18);
  background: rgba(214,178,94,.10);
}

/* Textarea always visible */
#esignModal .esignMsg{
  min-height:200px;
  height:240px;
  resize:vertical;
}

/* Mobile */
@media (max-width: 980px){
  #esignModal .modalCard.wide{height:min(94vh, 980px)}
  #esignModal .esignGrid{grid-template-columns:1fr}
  #esignModal .mirrorPanel, #esignModal .esignPreview{max-height:none}
}


/* ============================
   INTERNAL FULLSCREEN WORKSPACE
   (Proposal modal as internal page — no dark overlay)
   ============================ */

/* Remove overlay darkness completely */
.modalOverlay{
  background: transparent !important;
  backdrop-filter: none !important;
}

/* Make proposal modal cover the app workspace */
#proposalModal{
  position: absolute !important;
  inset: 0 !important;
  padding: 0 !important;
  z-index: 20;
  display: none;
}
#proposalModal.show{
  display: flex !important;
}

/* Fullscreen internal card */
#proposalModal .modalCard{
  width: 100% !important;
  height: 100% !important;
  max-width: none !important;
  max-height: none !important;
  border-radius: 0 !important;
  box-shadow: none !important;
  margin: 0 !important;
  border: 0 !important;
  display: flex;
  flex-direction: column;
  background: var(--panel);
}

/* Body fills height */
#proposalModal .modalBody{
  flex: 1;
  min-height: 0;
  overflow: hidden;
  display: flex;
}

/* Company list column */
#proposalModal .modalLeft{
  width: 380px;
  max-width: 32%;
  overflow-y: auto;
  border-left: 1px solid var(--line);
}

/* Preview column */
#proposalModal .modalRight{
  flex: 1;
  min-width: 0;
  overflow: hidden;
}

/* iframe fills */
#proposalModal iframe{
  width: 100%;
  height: 100%;
  border: 0;
}


/* =====================================
   WIDER LEADS LIST (safe, no UI break)
   ===================================== */

/* 1) Give more space to leads list and shrink control center */
.grid{
  grid-template-columns: 1.85fr 0.35fr !important; /* more room to leads */
  gap: 12px !important;
}

/* 2) Control center: keep it usable but narrower */
#viewRight{
  width: 100%;
  min-width: 260px !important;
  max-width: 360px !important;
}

/* 3) Leads list: use full available width */
#viewLeads{
  width: 100%;
  min-width: 0 !important;
}

/* 4) Reduce internal padding a bit so table feels wider */
#viewLeads .head,
#viewLeads .body{
  padding-left: 12px !important;
  padding-right: 12px !important;
}

/* 5) Let the table show more content comfortably */
#viewLeads .tableWrap{
  overflow-x: auto !important; /* if screen is narrow, allow smooth scroll */
}

/* Optional: slightly smaller header so more fits without changing design */
#viewLeads thead th{
  padding: 10px 12px !important;
  font-size: 12.8px !important;
}
#viewLeads tbody td{
  padding: 12px 12px !important;
  font-size: 13.2px !important;
}

/* =====================================
   TALLER LEADS TABLE (less scrolling)
   ===================================== */

/* Make the main content stretch full height */
.main{
  height: 100vh;
}

/* Content area uses available height */
.content{
  height: calc(100vh - 92px); /* minus topbar */
  display: flex;
  flex-direction: column;
}

/* Grid stretches vertically */
.grid{
  flex: 1;
  min-height: 0;
}

/* Leads card fills available height */
#viewLeads{
  display: flex;
  flex-direction: column;
  min-height: 0;
}

/* Table wrapper gets the scrolling instead of whole page */
#viewLeads .tableWrap{
  flex: 1;
  min-height: 0;
  overflow-y: auto;
}



/* =====================================
   EXTRA WIDE LEADS (v2)
   ===================================== */
.grid{
  grid-template-columns: 2.25fr 0.25fr !important; /* even more room to leads */
  gap: 10px !important;
}
#viewRight{
  min-width: 220px !important;
  max-width: 300px !important;
}
.content{
  padding-left: 14px !important;
  padding-right: 14px !important;
}


/* =====================================
   CLIENT DOSSIER (internal fullscreen)
   ===================================== */

/* Make row actions handle a full button nicely */
.actions{
  display:flex;
  align-items:center;
  gap:8px;
  flex-wrap:wrap;
}
.openClientBtn{
  padding:10px 14px;
  border-radius:14px;
  font-weight:800;
  white-space:nowrap;
}

/* Dossier tabs */
.clientTabs{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,0));
  overflow:auto;
}
.clientTabs .tabBtn{
  border:1px solid var(--line);
  background:rgba(255,255,255,.55);
  color:var(--text);
  padding:10px 12px;
  border-radius:999px;
  cursor:pointer;
  font-weight:800;
  white-space:nowrap;
  transition:.18s ease;
}
.clientTabs .tabBtn:hover{ transform:translateY(-1px); border-color:rgba(214,178,94,.35); }
.clientTabs .tabBtn.active{
  border-color:rgba(214,178,94,.55);
  background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.55));
}

/* Sections */
.clientSection{
  display:none;
  padding:14px;
  overflow:auto;
}
.clientSection.show{ display:block; }

.clientGrid{
  display:grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap:12px;
}
.clientField{
  border:1px solid var(--line);
  background:rgba(255,255,255,.55);
  border-radius:16px;
  padding:12px 12px;
}
.clientField .lbl{ font-size:12px; color:var(--muted2); font-weight:800; }
.clientField .val{ margin-top:6px; font-size:14px; font-weight:900; }

/* Timeline list inside dossier */
.clientList{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.clientItem{
  border:1px solid var(--line);
  background:rgba(255,255,255,.55);
  border-radius:16px;
  padding:12px 12px;
}
.clientItem .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
.clientItem .t{ font-weight:900; }
.clientItem .m{ margin-top:6px; color:var(--muted); }

/* Internal fullscreen for dossier modal (no overlay) */
#clientDossierModal{
  position:absolute !important;
  inset:0 !important;
  padding:0 !important;
  z-index:21;
  display:none;
}
#clientDossierModal.show{ display:flex !important; }
#clientDossierModal .modalCard{
  width:100% !important;
  height:100% !important;
  max-width:none !important;
  max-height:none !important;
  border-radius:0 !important;
  margin:0 !important;
  border:0 !important;
  box-shadow:none !important;
  background:var(--panel);
  display:flex;
  flex-direction:column;
}
#clientDossierModal .modalBody{
  flex:1;
  min-height:0;
  overflow:hidden;
  padding:0 !important;
}

/* ===== Mirror Find (Search) ===== */
.mirrorSearchRow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.mirrorSearchRow input{flex:1; min-width:180px}
.seg{display:inline-flex; background:var(--panel2); border:1px solid var(--line); border-radius:12px; overflow:hidden}
.segBtn{border:0; background:transparent; color:var(--text); padding:10px 12px; cursor:pointer; font-weight:800}
.segBtn.active{background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(214,178,94,.10)); color:var(--gold)}


/* ===== Mirror Checklist ===== */
.mirrorChecklist{margin-top:14px; padding-top:12px; border-top:1px solid var(--line)}
.mirrorChecklistTop{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; flex-wrap:wrap}
.mirrorProgress{display:flex; align-items:center; gap:10px}
.mirrorProgress .bar{width:220px; height:10px; background:var(--panel2); border:1px solid var(--line); border-radius:999px; overflow:hidden}
.mirrorProgress .fill{height:100%; background:linear-gradient(90deg, var(--gold), var(--gold2))}
.mirrorProgress .pct{min-width:48px; text-align:left; color:var(--muted); font-weight:800}
.mirrorStepCard{margin-top:10px; padding:12px; border:1px solid var(--line); border-radius:16px; background:linear-gradient(180deg, rgba(214,178,94,.08), rgba(255,255,255,0))}
.mirrorStepHead{display:flex; align-items:center; gap:12px; justify-content:space-between; flex-wrap:wrap}
.mirrorStepHead .num{width:34px; height:34px; border-radius:12px; display:grid; place-items:center; background:rgba(214,178,94,.18); border:1.2px solid rgba(214,178,94,.48); font-weight:900}
.mirrorStepHead .ttl{flex:1; font-weight:900}
.chk{display:flex; align-items:center; gap:8px; color:var(--muted); font-weight:800}
.mirrorScript{width:100%; margin-top:10px; border-radius:14px; border:1px solid var(--line); background:var(--panel); color:var(--text); padding:12px; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
.mirrorStepNav{display:flex; gap:10px; justify-content:space-between; margin-top:10px}


/* ===== Mirror layout ordering ===== */
.mirrorContainer{
  display:flex;
  flex-direction:column;
  gap:18px;
}
.mirrorSearch{order:1;}
.mirrorDocSelect{order:2;}
.mirrorChecklist{order:3;}
.mirrorCard{
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:14px;
  padding:14px;
}
.mirrorCard h3{
  margin:0 0 10px;
  font-size:15px;
  color:var(--gold);
}


/* ============================
   MIRROR (Agent) FULLSCREEN + WIZARD
   ============================ */
body.mirrorFS .side{display:none !important;}
body.mirrorFS .app{grid-template-columns:1fr !important;}
body.mirrorFS .topbar{display:none !important;}
body.mirrorFS .content{display:none !important;} /* remove distractions */

#mirrorModal{
  position:absolute !important;
  inset:0 !important;
  padding:0 !important;
  z-index:30;
  display:none;
}
#mirrorModal.show{display:flex !important;}
#mirrorModal .modalCard{
  width:100% !important;
  height:100% !important;
  max-width:none !important;
  max-height:none !important;
  border-radius:0 !important;
  margin:0 !important;
  border:0 !important;
  box-shadow:none !important;
  background:#fff7e6; /* clean cream */
  display:flex;
  flex-direction:column;
}
#mirrorModal .modalHead{
  position:sticky;
  top:0;
  z-index:2;
  background:#fff7e6;
  border-bottom:1.5px solid rgba(214,178,94,0.55);
  box-shadow:0 4px 14px rgba(0,0,0,0.08);
}
#mirrorModal .modalBody{flex:1;min-height:0;overflow:hidden;padding:0 !important;}

#mirrorModal .mirrorGrid{
  height:100%;
  grid-template-columns: 480px 1fr;
  gap:14px;
  padding:14px 16px;
}

#mirrorModal .mirrorPanel{
  background:rgba(255,255,255,.70);
  border-radius:18px;
  padding:14px;
}

.mwStepper{
  display:flex;
  align-items:center;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:12px;
}
.mwStepPill{
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  border:1px solid rgba(214,178,94,0.45);
  border-radius:999px;
  background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.08));
  font-weight:900;
}
.mwStepPill .n{
  width:28px;height:28px;border-radius:12px;
  display:grid;place-items:center;
  background:rgba(214,178,94,.22);
  border:1.2px solid rgba(214,178,94,.55);
}
.mwStepPill.active{background:linear-gradient(180deg, rgba(214,178,94,.25), rgba(214,178,94,.10));}
.mwStepPill.done{opacity:.9;}
.mwBar{
  flex:1;
  min-width:160px;
  height:10px;
  border-radius:999px;
  overflow:hidden;
  border:1.2px solid rgba(214,178,94,.48);
  background:rgba(255,255,255,.65);
}
.mwBar .fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg, var(--gold), var(--gold2));
}

.mwStep{
  display:none;
}
.mwStep.show{display:block;}

.mwNav{
  display:flex;
  gap:10px;
  justify-content:space-between;
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid rgba(214,178,94,0.35);
}

.mwHint{
  font-size:12px;
  color:rgba(12,12,18,.62);
  line-height:1.6;
  margin-top:8px;
}

#mirrorModal.readingMode .mirrorPanel{background:rgba(255,255,255,.78);}
#mirrorModal.readingMode .mirrorField label{font-size:14px !important;font-weight:1000 !important;}
#mirrorModal.readingMode .mirrorField input,
#mirrorModal.readingMode .mirrorField select{padding:14px !important;font-size:16px !important;font-weight:900;}
#mirrorModal.readingMode .mirrorStepCard{font-size:16px;line-height:1.85;}
#mirrorModal.readingMode .mirrorScript{font-size:16px;line-height:1.9;}
#mirrorModal.readingMode .btnGhost,#mirrorModal.readingMode .btnGold,#mirrorModal.readingMode .btn{
  padding:12px 14px !important;
  border-radius:14px !important;
  font-weight:1000 !important;
}

@media (max-width: 980px){
  #mirrorModal .mirrorGrid{grid-template-columns:1fr;}
}


/* ============================
   MIRROR (Agent) PRO UI polish
   ============================ */
#mirrorModal .modalHead .title{font-size:18px;font-weight:1000;letter-spacing:.2px}
#mirrorModal .modalHead .sub{font-size:12.5px;color:rgba(12,12,18,.62);font-weight:800}

#mirrorModal .mirrorPanel{
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;
  height:100%;
  box-shadow: 0 10px 30px rgba(0,0,0,0.05);
}
#mirrorModal .mirrorPanel h4{
  margin:0;
  padding:10px 12px;
  border-radius:14px;
  background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.08));
  border:1px solid rgba(214,178,94,.20);
  color:#1a1a1f;
  font-weight:1000;
}

#mirrorModal .mwStepper{
  background:rgba(255,255,255,.70);
  border:1px solid rgba(214,178,94,.18);
  border-radius:18px;
  padding:10px 12px;
}
#mirrorModal .mwStepPill{
  padding:9px 10px;
  border-radius:999px;
  border:1px solid rgba(214,178,94,.28);
  background:rgba(214,178,94,.08);
  color:#1a1a1f;
}
#mirrorModal .mwStepPill.active{
  border-color: rgba(214,178,94,.55);
  background: linear-gradient(180deg, rgba(214,178,94,.20), rgba(214,178,94,.08));
}
#mirrorModal .mwStepPill.done{opacity:1; filter:saturate(.9)}
#mirrorModal .mwStepPill .n{
  background:rgba(214,178,94,.20);
  border-color:rgba(214,178,94,.35);
  color:#1a1a1f;
}

#mirrorModal .mirrorField{
  margin-bottom:0;
  padding:10px 10px;
  border:1px solid rgba(214,178,94,.16);
  background:rgba(255,255,255,.68);
  border-radius:16px;
}
#mirrorModal .mirrorField label{
  color:rgba(12,12,18,.78) !important;
  font-weight:900 !important;
}
#mirrorModal .mirrorSearchRow{gap:10px}
#mirrorModal .seg{background:rgba(255,255,255,.7)}
#mirrorModal .segBtn{color:#1a1a1f}
#mirrorModal .segBtn.active{color:#1a1a1f;background:rgba(214,178,94,.18)}

#mirrorModal .mwHint{
  background:rgba(255,255,255,.55);
  border:1px dashed rgba(214,178,94,.35);
  border-radius:14px;
  padding:10px 10px;
}

#mirrorModal .mwNav{
  position:sticky;
  bottom:0;
  background:rgba(255,247,230,.92);
  backdrop-filter: blur(6px);
  border-top:1px solid rgba(214,178,94,.35);
  padding:12px 12px;
  border-radius:16px;
  box-shadow: 0 -10px 24px rgba(0,0,0,0.06);
}
#mirrorModal .mwNav .mwNavRight{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
  justify-content:flex-end;
}
#mirrorModal .mwNav .mwNavLeft{
  display:flex;
  gap:10px;
  align-items:center;
}

#mirrorModal .mwActionsBar{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:wrap;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(214,178,94,.18);
  background:rgba(255,255,255,.68);
}
#mirrorModal .mwActionsBar .ttl{
  font-weight:1000;
  color:#1a1a1f;
}
#mirrorModal .mwActionsBar .btnRow{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  justify-content:flex-end;
}
#mirrorModal .mwActionsBar .btnRow .btnGhost,
#mirrorModal .mwActionsBar .btnRow .btnGold{
  padding:10px 12px;
  border-radius:14px;
  font-weight:1000;
}

#mirrorModal .mirrorNotice{
  background:rgba(255,255,255,.55);
  border:1px solid rgba(214,178,94,.18);
  border-radius:16px;
  padding:10px 10px;
  color:rgba(12,12,18,.62);
}

#mirrorModal .mirrorStepCard{
  border-radius:18px;
  background:rgba(255,255,255,.68);
  border:1px solid rgba(214,178,94,.18);
}

#mirrorModal .mirrorProgress .bar{width:260px}
@media (max-width: 980px){
  #mirrorModal .mirrorGrid{padding:12px}
  #mirrorModal .mirrorProgress .bar{width:200px}
}


/* ============================
   MIRROR PRO (Rebuild) — CRM layout
   ============================ */
#mirrorModal .modalCard.mirrorPro{background:#fff7e6}
#mirrorModal .mirrorProBody{padding:0 !important; overflow:hidden}
#mirrorModal .mirrorProGrid{
  height:100%;
  display:grid;
  grid-template-columns: 520px 1fr;
  gap:14px;
  padding:14px 16px;
  min-height:0;
}
#mirrorModal .mirrorProLeft, #mirrorModal .mirrorProRight{min-height:0}
#mirrorModal .mirrorProLeft{display:flex; flex-direction:column; gap:12px; min-height:0}
#mirrorModal .mirrorProRight{min-height:0}

#mirrorModal .mirrorProHead{
  background:#fff7e6;
  border-bottom:1.5px solid rgba(214,178,94,0.55);
  box-shadow:0 4px 14px rgba(0,0,0,0.08);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
}
#mirrorModal .mirrorProHead .mhRight{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
#mirrorModal .mirrorProHead .chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(214,178,94,.28);
  background:rgba(255,255,255,.7);
  color:#1a1a1f;
  font-weight:900;
}

.stepperCard{
  border:1px solid rgba(214,178,94,.18);
  border-radius:18px;
  background:rgba(255,255,255,.72);
  padding:12px;
}
.stepperTop{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
.stepperTitle{font-weight:1000; color:#1a1a1f}
.stepperBar{flex:1; height:10px; border-radius:999px; overflow:hidden; border:1px solid rgba(214,178,94,.25); background:rgba(214,178,94,.06)}
.stepperBar .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--gold), var(--gold2))}
.stepperList{display:flex; flex-direction:column; gap:10px}
.stepItem{
  width:100%;
  text-align:right;
  display:grid;
  grid-template-columns: 34px 1fr;
  grid-template-rows: auto auto;
  column-gap:10px;
  row-gap:2px;
  padding:12px 12px;
  border-radius:16px;
  border:1px solid rgba(214,178,94,.18);
  background:rgba(214,178,94,.06);
  cursor:pointer;
}
.stepItem .n{
  grid-row:1 / span 2;
  width:34px;height:34px;border-radius:12px;
  display:grid;place-items:center;
  background:rgba(214,178,94,.20);
  border:1.2px solid rgba(214,178,94,.48);
  font-weight:1000;
  color:#1a1a1f;
}
.stepItem .t{font-weight:1000;color:#1a1a1f}
.stepItem .s{font-size:12px;color:rgba(12,12,18,.62);font-weight:800}
.stepItem.active{background:linear-gradient(180deg, rgba(214,178,94,.20), rgba(214,178,94,.08)); border-color:rgba(214,178,94,.45)}
.stepItem.done{opacity:1; filter:saturate(.9)}

.workCard{
  flex:1;
  min-height:0;
  overflow:auto;
  border:1px solid rgba(214,178,94,.18);
  border-radius:18px;
  background:rgba(255,255,255,.72);
  padding:12px;
  display:flex;
  flex-direction:column;
  gap:12px;
}
.cardTitle{font-weight:1000;color:#1a1a1f;margin:0 0 4px}
.mwStep{display:none}
.mwStep.show{display:block}

.rowBtns{display:flex; gap:10px; flex-wrap:wrap}
.rowBtns .btnGold, .rowBtns .btnGhost{border-radius:14px; font-weight:1000}
.softHint{margin-top:10px; font-size:12px; color:rgba(12,12,18,.62); font-weight:800}

.checkTop{display:flex; align-items:flex-end; justify-content:space-between; gap:10px; flex-wrap:wrap}
.miniTitle{font-size:12px; font-weight:1000; color:rgba(12,12,18,.70); margin-bottom:6px}
#mirrorModal .mirrorProgress .bar{width:260px}

.navBar{
  margin-top:auto;
  position:sticky;
  bottom:0;
  background:rgba(255,247,230,.92);
  backdrop-filter: blur(6px);
  border-top:1px solid rgba(214,178,94,.35);
  padding:12px;
  border-radius:16px;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}

.previewCard{
  height:100%;
  min-height:0;
  border:1px solid rgba(214,178,94,.18);
  border-radius:18px;
  background:rgba(255,255,255,.72);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
.previewHead{
  padding:12px 12px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  border-bottom:1px solid rgba(214,178,94,.18);
  background:rgba(214,178,94,.06);
}
.previewHead .ttl{font-weight:1000;color:#1a1a1f}
.previewHead .meta{font-size:12px;color:rgba(12,12,18,.62);font-weight:800}
.previewHead .rightBtns{display:flex; gap:10px; flex-wrap:wrap}

.previewSplit{
  flex:1;
  min-height:0;
  display:grid;
  grid-template-rows: 240px 1fr;
  gap:12px;
  padding:12px;
}
.clientCard,.docCard{
  border:1px solid rgba(214,178,94,.18);
  border-radius:16px;
  background:rgba(255,255,255,.75);
  padding:10px;
  min-height:0;
}
.frameWrap{
  height:100%;
  min-height:0;
  border-radius:14px;
  overflow:hidden;
  border:1px solid rgba(214,178,94,.18);
}
#mirrorFrame{width:100%;height:100%;border:0;background:#fff}

#mirrorModal.readingMode .workCard{background:rgba(255,255,255,.82)}
#mirrorModal.readingMode .mirrorField label{font-size:14px !important;font-weight:1000 !important;}
#mirrorModal.readingMode .mirrorField input{padding:14px !important;font-size:16px !important;font-weight:900;}
#mirrorModal.readingMode .btnGold,#mirrorModal.readingMode .btnGhost{padding:12px 14px !important;font-weight:1000 !important;}

@media (max-width: 1100px){
  #mirrorModal .mirrorProGrid{grid-template-columns:1fr; }
  .previewSplit{grid-template-rows: 190px 1fr}
}


/* ===== Mirror: Client details (clear + full) ===== */
#mirrorModal .clientCard{
  display:flex;
  flex-direction:column;
  min-height:0;
}
#mirrorModal .clientCard .mirrorCard{
  flex:1;
  min-height:0;
  overflow:auto;
  padding:12px;
  border-radius:16px;
}
#mirrorModal .mirrorKV{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:10px 14px;
  font-size:13.5px;
  line-height:1.35;
}
#mirrorModal .mirrorKV .kvItem{
  border:1px solid rgba(214,178,94,.16);
  background:rgba(255,255,255,.78);
  border-radius:14px;
  padding:10px 10px;
}
#mirrorModal .mirrorKV .kvLbl{
  font-size:11.5px;
  color:rgba(12,12,18,.62);
  font-weight:900;
}
#mirrorModal .mirrorKV .kvVal{
  margin-top:6px;
  font-size:14px;
  color:#1a1a1f;
  font-weight:1000;
  word-break:break-word;
}
@media (max-width: 1100px){
  #mirrorModal .mirrorKV{grid-template-columns:1fr;}
}


/* ===== E-Sign: Client fetch (safe, non-breaking) ===== */
#esignModal .esignFetch{
  border:1px solid rgba(214,178,94,.18);
  background:rgba(214,178,94,.06);
  border-radius:16px;
  padding:10px 10px;
  margin-top:10px;
}
#esignModal .esignFetch .cap{
  font-size:12px;
  font-weight:1000;
  color:rgba(12,12,18,.72);
  margin-bottom:8px;
}
#esignModal .esignFetchRow{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:wrap;
}
#esignModal .esignFetchRow input{
  flex:1;
  min-width:170px;
}
#esignModal .esignFetchRow .seg{
  padding:4px;
  border-radius:999px;
  border:1px solid rgba(214,178,94,.20);
  background:rgba(255,255,255,.75);
}
#esignModal .esignFetchRow .segBtn{
  padding:8px 10px;
  border-radius:999px;
  font-weight:1000;
}
#esignModal .esignFetchRow .segBtn.active{
  background:rgba(214,178,94,.18);
}
#esignModal .esignFetchSelected{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:999px;
  border:1px solid rgba(214,178,94,.22);
  background:rgba(255,255,255,.78);
  font-weight:1000;
}


/* ===== AuthPending: hide app before login ===== */
html.authPending .app{ visibility:hidden !important; }
html.authPending .loginGate{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:22px;

  /* Soft Cream-Gold Elegant Background */
  background:
    /* very gentle vignette */
    radial-gradient(120% 120% at 50% 50%, rgba(255,255,255,.0), rgba(214,178,94,.08)),

    /* soft gold glow */
    radial-gradient(900px 420px at 85% 15%, rgba(214,178,94,.22), transparent 62%),
    radial-gradient(720px 360px at 15% 85%, rgba(214,178,94,.18), transparent 64%),

    /* silky light cream base */
    linear-gradient(180deg, #ffffff 0%, #fffdf7 35%, #fff7ea 70%, #ffffff 100%),

    /* ultra subtle silk texture */
    repeating-linear-gradient(
      0deg,
      rgba(214,178,94,.012) 0px,
      rgba(214,178,94,.012) 1px,
      transparent 1px,
      transparent 36px
    ),
    repeating-linear-gradient(
      90deg,
      rgba(214,178,94,.010) 0px,
      rgba(214,178,94,.010) 1px,
      transparent 1px,
      transparent 36px
    );
}


.loginGate::before{
  content:"";
  position:absolute;
  inset:0;
  background:linear-gradient(180deg, rgba(0,0,0,.04), transparent 40%);
  pointer-events:none;
}

.loginCard{
  position:relative;
  width:380px;
  max-width:100%;
  background:linear-gradient(180deg, rgba(255,255,255,.94), rgba(255,245,223,.90));
  border-radius:22px;
  border:1px solid rgba(214,178,94,.28);
  box-shadow:0 24px 70px rgba(0,0,0,.14);
  padding:26px 22px 22px;
  text-align:center;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transform: translateY(6px);
  animation: loginPop .28s ease-out forwards;
}

@keyframes loginPop{
  from{opacity:0; transform: translateY(14px) scale(.985);}
  to{opacity:1; transform: translateY(0) scale(1);}
}


.loginAccent{
  position:absolute;
  top:0; left:0; right:0;
  height:8px;
  border-radius:22px 22px 16px 16px;
  background: linear-gradient(90deg, rgba(214,178,94,.15), rgba(214,178,94,.70), rgba(214,178,94,.15));
  box-shadow: 0 10px 26px rgba(214,178,94,.22);
}

.loginBrand{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  margin-bottom:14px;
}

.loginLogo{
  width:42px;
  height:42px;
  border-radius:16px;
  position:relative;
  background: linear-gradient(180deg, rgba(214,178,94,.35), rgba(180,145,55,.18));
  border:1.2px solid rgba(214,178,94,.48);
  box-shadow: 0 10px 24px rgba(0,0,0,.08);
}

.loginLogo .dot{
  position:absolute;
  width:10px;height:10px;
  border-radius:999px;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  background: linear-gradient(180deg, #f5d889, #caa24a);
}

.loginLogo .ring{
  position:absolute;
  inset:10px;
  border-radius:14px;
  border:1.2px solid rgba(214,178,94,.55);
}

.loginBrandTxt{ text-align:right; }
.loginBrandName{
  font-weight:1000;
  letter-spacing:.6px;
  font-size:16px;
  color:#1a1a1f;
}
.loginBrandTag{
  margin-top:2px;
  font-size:12px;
  font-weight:900;
  color:rgba(12,12,18,.60);
}

.loginTitle{
  font-size:18px;
  font-weight:1000;
  margin:0 0 6px;
  color:#1a1a1f;
}
.loginSub{
  font-size:13px;
  color:rgba(12,12,18,.62);
  margin:0 0 16px;
  font-weight:800;
}

.loginForm{ display:flex; flex-direction:column; gap:10px; }
.loginLbl{
  text-align:right;
  font-size:12px;
  font-weight:1000;
  color:rgba(12,12,18,.70);
}

.loginInputWrap{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 10px;
  border-radius:16px;
  border:1.2px solid rgba(214,178,94,.28);
  background:rgba(255,255,255,.90);
}

#loginPassword{
  border:0;
  outline:none;
  background:transparent;
  width:100%;
  font-size:15px;
  font-weight:900;
  color:#1a1a1f;
}

.loginEye{
  border:1px solid rgba(214,178,94,.22);
  background:linear-gradient(180deg, rgba(214,178,94,.16), rgba(214,178,94,.08));
  border-radius:14px;
  padding:8px 10px;
  cursor:pointer;
  font-weight:1000;
}

.loginBtn.btnGold{
  background: linear-gradient(180deg, #f5d889, #caa24a);
  border: 1px solid rgba(160,120,40,.35);
  box-shadow: 0 16px 34px rgba(160,120,40,.20);
}

.loginBtn{
  padding:12px 14px;
  border-radius:16px;
  font-weight:1000;
}


.loginCard::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius:22px;
  pointer-events:none;
  background:
    radial-gradient(420px 220px at 30% 10%, rgba(214,178,94,.22), transparent 60%),
    radial-gradient(380px 200px at 80% 30%, rgba(240,205,120,.16), transparent 62%);
  mix-blend-mode: multiply;
  opacity:.65;
}


/* Bottom gold accent (match top accent style) */
.loginCard::before{
  content:"";
  position:absolute;
  left:0;
  right:0;
  bottom:0;
  height:8px;
  border-radius:16px 16px 22px 22px;
  background: linear-gradient(90deg,
    rgba(214,178,94,.15),
    rgba(214,178,94,.70),
    rgba(214,178,94,.15)
  );
  box-shadow: 0 -10px 26px rgba(214,178,94,.22);
  opacity:.95;
  pointer-events:none;
}

.loginError{
  color:#d33;
  font-size:13px;
  min-height:18px;
  margin-top:2px;
  font-weight:900;
}

.loginFoot{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  flex-wrap:wrap;
  margin-top:4px;
}
.loginFoot .pill{
  font-size:11.5px;
  font-weight:900;
  color:rgba(12,12,18,.62);
  border:1px solid rgba(214,178,94,.18);
  background:rgba(255,255,255,.75);
  padding:7px 10px;
  border-radius:999px;
}

html.authPending .app{ visibility:hidden !important; }
html.authPending .loginGate{ display:flex !important; }

/* ===== Login Gate Center Fix ===== */
.loginGate{
  position:fixed !important;
  inset:0 !important;
  align-items:center !important;
  justify-content:center !important;
  text-align:center;
}
/* NOTE: do NOT force display with !important so JS can hide it */
.loginCard{ margin:0 auto !important; }

/* ===== Luxury Shine Animations ===== */
@keyframes goldShine{
  0%{ transform: translateX(-120%); opacity:0; }
  18%{ opacity:.65; }
  50%{ opacity:.95; }
  82%{ opacity:.65; }
  100%{ transform: translateX(120%); opacity:0; }
}
@keyframes goldPulse{
  0%,100%{ filter:saturate(1) brightness(1); }
  50%{ filter:saturate(1.12) brightness(1.06); }
}

/* strengthen gold sheen a touch */
.loginAccent{
  animation: goldPulse 3.6s ease-in-out infinite;
}
.loginCard::before{
  animation: goldPulse 3.6s ease-in-out infinite;
}

/* moving shine stripe overlay (top + bottom) */
.loginAccent::after{
  content:"";
  position:absolute;
  top:-3px; bottom:-3px;
  left:0; width:35%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.52), transparent);
  transform: translateX(-120%);
  animation: goldShine 5.2s ease-in-out infinite;
  border-radius: inherit;
  pointer-events:none;
  mix-blend-mode: overlay;
}
.loginCard::before{
  overflow:hidden;
}
.loginCard::before{
  /* already defined; keep as base */
}
.loginCard::before{
  position:absolute;
}
.loginCard::before::after{ /* not valid; we'll use .loginCard .bottomShine */
}

/* bottom shine stripe via a helper element */
.bottomShine{
  position:absolute;
  left:0; right:0; bottom:0;
  height:8px;
  border-radius:16px 16px 22px 22px;
  pointer-events:none;
  overflow:hidden;
}
.bottomShine::after{
  content:"";
  position:absolute;
  top:-3px; bottom:-3px;
  left:0; width:35%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,.52), transparent);
  transform: translateX(-120%);
  animation: goldShine 5.2s ease-in-out infinite;
  border-radius: inherit;
  mix-blend-mode: overlay;
}

/* dynamic color shift + glow on focus */
.loginInputWrap{
  transition: border-color .18s ease, box-shadow .18s ease, transform .18s ease, background .18s ease;
}
.loginInputWrap:focus-within{
  border-color: rgba(214,178,94,.55) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,245,223,.92));
  box-shadow: 0 10px 26px rgba(214,178,94,.18), 0 0 0 3px rgba(214,178,94,.14);
  transform: translateY(-1px);
}
.loginInputWrap:focus-within .loginEye{
  border-color: rgba(214,178,94,.50);
  background: linear-gradient(180deg, rgba(214,178,94,.22), rgba(214,178,94,.10));
}


/* ===== CRM Typography Pack (Hebrew) ===== */
:root{
  --font-crm: "Noto Sans Hebrew", system-ui, -apple-system, "Segoe UI", Arial, sans-serif;
  --text-strong: #131318;
  --text-soft: rgba(12,12,18,.72);
}

html, body{
  font-family: var(--font-crm);
  letter-spacing: .1px;
  text-rendering: geometricPrecision;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1,.h1{ font-size: 22px; font-weight: 800; color: var(--text-strong); letter-spacing: .2px; }
h2,.h2{ font-size: 18px; font-weight: 800; color: var(--text-strong); }
h3,.h3{ font-size: 15px; font-weight: 800; color: var(--text-strong); }

p, .text{ font-size: 14px; font-weight: 400; color: rgba(12,12,18,.68); line-height: 1.55; }
small, .muted{ font-size: 12px; font-weight: 500; color: rgba(12,12,18,.52); }

label, .cap, .miniTitle, .kvLbl{
  font-size: 12px;
  font-weight: 600;
  letter-spacing: .12px;
}

.kvVal{
  font-size: 14px;
  font-weight: 800;
  color: var(--text-strong);
}

button, .btnGold, .btnGhost, .segBtn{
  font-family: var(--font-crm);
  font-weight: 800;
  letter-spacing: .15px;
}

input, select, textarea{
  font-family: var(--font-crm);
  font-weight: 600;
  letter-spacing: .08px;
}

.loginTitle{ font-size: 19px; font-weight: 800; letter-spacing: .3px; }
.loginSub{ font-weight: 800; }
.loginBrandName{ font-weight: 800; letter-spacing: 1.2px; }


/* ===== Global Readability Upgrade ===== */

/* Base text */
p, .text{
  font-size: 15.5px !important;
  line-height: 1.65 !important;
}

/* Small text */
small, .muted{
  font-size: 13.5px !important;
}

/* Labels / captions */
label, .cap, .miniTitle, .kvLbl{
  font-size: 13.5px !important;
}

/* Values / important text */
.kvVal{
  font-size: 16px !important;
}

/* Buttons */
button, .btnGold, .btnGhost, .segBtn{
  font-size: 15px !important;
}

/* Inputs */
input, select, textarea{
  font-size: 15.5px !important;
  padding-top: 11px;
  padding-bottom: 11px;
}

/* Headings */
h1,.h1{ font-size: 24px !important; }
h2,.h2{ font-size: 20px !important; }
h3,.h3{ font-size: 17px !important; }

/* Login emphasis */
.loginTitle{ font-size: 22px !important; }
.loginSub{ font-size: 14.5px !important; }
.loginBrandName{ font-size: 18px !important; }


/* ===== Text Sharpness Boost ===== */
html, body{
  -webkit-font-smoothing: subpixel-antialiased !important;
  text-rendering: optimizeLegibility !important;
}

*{
  text-shadow: none !important;
}

/* Slight contrast boost for clarity */
body{
  color: #101015;
}

/* Inputs and buttons sharper */
input, select, textarea, button{
  -webkit-font-smoothing: subpixel-antialiased !important;
}

</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Hebrew:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">


<style>
/* ===== Mirror Preview Full Area ===== */
#mirrorModal .mirrorGrid{
  height: 100%;
  min-height: 0;
}
#mirrorModal .mirrorPreview{
  flex: 1 1 auto;
  min-height: 0;
  height: 100%;
}
#mirrorModal .mirrorPreviewBody{
  flex: 1 1 auto;
  min-height: 0;
}
#mirrorModal .mirrorPreviewBody iframe,
#mirrorModal #mirrorFrame{
  width: 100% !important;
  height: 100% !important;
  min-height: 100% !important;
}
#mirrorModal .modalCard.wide,
#mirrorModal .modalBody{
  height: 100% !important;
}
</style>

<style>
#mirrorApply{pointer-events:auto !important; opacity:1 !important;}
</style>
</head>

<body>

<!-- ===== Simple Login Gate ===== -->
<div id="loginGate" class="loginGate">
  <div class="loginCard">
    <div class="loginAccent" aria-hidden="true"></div>
    <div class="bottomShine" aria-hidden="true"></div>
    <div class="loginBrand">
      <div class="loginLogo" aria-hidden="true">
        <span class="dot"></span>
        <span class="ring"></span>
      </div>
      <div class="loginBrandTxt">
        <div class="loginBrandName">LEADUP</div>
        <div class="loginBrandTag">Premium CRM</div>
      </div>
    </div>

    <div class="loginTitle">כניסה למערכת</div>
    <div class="loginSub">הזן סיסמה כדי להמשיך</div>

    <div class="loginForm">
      <label class="loginLbl" for="loginPassword">סיסמה</label>
      <div class="loginInputWrap">
        <input id="loginPassword" type="password" placeholder="••••••••" autocomplete="current-password" />
        <button id="loginToggle" class="loginEye" type="button" aria-label="הצג/הסתר סיסמה">👁️</button>
      </div>

      <button id="loginBtn" class="btnGold loginBtn" type="button">כניסה</button>
      <div id="loginError" class="loginError" aria-live="polite"></div>

      <div class="loginFoot">
        <span class="pill">🔒 מוגן בסיסמה</span>
        <span class="pill">✨ UI תואם מערכת</span>
      </div>
    </div>
</div>
  </div>
</div>

<div class="app">
  <aside class="side">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>LEADUP</h1>
        <div class="sub">Premium CRM</div>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-view="leads">
        <span class="k">📌 לידים</span>
        <span class="pill gold" id="navCount">0</span>
      </button>

      <button type="button" id="navMyFlows" data-view="myflows">
        <span class="k">⚙️ התהליכים שלי</span>
      </button>

      <button data-view="tasks">
        <span class="k">⏰ משימות</span>
        <span class="pill" id="navTasks">0</span>
      </button>
      <button data-view="proposal">
        <span class="k">🧾 יצירת הצעה</span>
        <span class="pill" id="navEvents">0</span>
      </button>

      <button type="button" id="navESign" data-view="esign">
        <span class="k">✍️ שליחה לחתימת לקוח</span>
      </button>

      <button type="button" id="navMirror" data-view="mirror">
        <span class="k">🪞 צ'ק ליסט שיקוף עסקה</span>
      </button>


      <button data-view="settings">
        <span class="k">⚙️ הגדרות</span>
        <span class="pill">Local</span>
      </button>
    </div>

    <div class="sideFooter">
      <div><b>טיפ:</b> כל פעולה נפתחת בתוך חלון במערכת (מודאל) — לא נפתח חלון חיצוני.</div>
      <div class="hint">
        בקרוב נחבר ל-Google Sheets דרך Apps Script (רק תתן לי את כתובת ה-URL ומזהה הפריסה).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <span class="badge"><span class="dot"></span> מצב מערכת: פעיל</span>
        <span class="badge" id="greetingBadge">שלום 👋</span>
        <div class="title">
          <b id="viewTitle">לידים</b>
          <span id="viewSub">ניהול לידים, סטטוסים, פעולות ומעקב</span>
        </div>
      </div>

      <div class="search">
        <span class="icon">⌕</span>
        <input id="q" placeholder="חיפוש לקוח לפי שם / טלפון / אימייל / הערה…" autocomplete="off"/>
      </div>

      <div class="right">
        <button class="btn goldSoft" id="btnAddLead">➕ ליד חדש</button>
        <button class="btn goldSoft hideTopQuick" id="btnQuickTask">⚙️ התהליכים שלי</button>
        
      </div>
    </div>

    <div class="content">
      <div class="card" style="margin-bottom:14px">
        <div class="head">
          <h2>דשבורד</h2>
</div>
        <div class="body">
          <div class="stats">
            <div class="stat">
              <div class="k">סה״כ לידים</div>
              <div class="v" id="stTotal">0</div>
              <div class="mini">במאגר</div>
            </div>
            <div class="stat">
              <div class="k">חמים</div>
              <div class="v" id="stHot">0</div>
              <div class="mini">Lead Score גבוה</div>
            </div>
            <div class="stat">
              <div class="k">מעקב היום</div>
              <div class="v" id="stToday">0</div>
              <div class="mini">Next Follow-up</div>
            </div>
            <div class="stat">
              <div class="k">משימות פתוחות</div>
              <div class="v" id="stTasks">0</div>
              <div class="mini">תזכורות</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card" id="viewLeads">
          <div class="head">
            <h2>רשימת לידים</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <select id="fStatus" title="פילטר סטטוס" style="width:170px">
                <option value="">כל הסטטוסים</option>
                <option>חדש</option>
                <option>נוצר קשר</option>
                <option>מתעניין</option>
                <option>הצעת מחיר</option>
                <option>נסגר</option>
                <option>לא רלוונטי</option>
              </select>
              <select id="fSource" title="פילטר מקור" style="width:170px">
                <option value="">כל המקורות</option>
                <option>פייסבוק</option>
                <option>גוגל</option>
                <option>הפניה</option>
                <option>טלפון</option>
                <option>אתר</option>
                <option>אחר</option>
              </select>
              <select id="sortBy" title="מיון" style="width:170px">
                <option value="hot">מיון: הכי חם</option>
                <option value="next">מיון: תאריך מעקב הבא</option>
                <option value="newest">מיון: הכי חדש</option>
                <option value="oldest">מיון: הכי ישן</option>
              </select>
            </div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>שם</th>
                    <th>טלפון</th>
                    <th>סטטוס</th>
                    <th>מקור</th>
                    <th>חום (Score)</th>
                    <th>מעקב הבא</th>
                    <th>פעולות</th>
                  </tr>
                </thead>
                <tbody id="leadsTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyLeads" style="display:none">
              אין עדיין לידים. לחץ על <b>“ליד חדש”</b> כדי להתחיל.
            </div>
          </div>
        </section>

        <aside class="card" id="viewRight">
          <div class="head">
            <h2>מרכז שליטה</h2>
            <div class="pill gold">LEADUP</div>
          </div>
          <div class="body">
            <div class="miniCard" style="margin-bottom:10px">
              <h3>מה יש במערכת</h3>
              <div class="small muted">
                • לידים + סטטוסים + הערות<br/>
                • משימות ותזכורות לכל ליד<br/>
                • היסטוריית פעילות (Timeline)<br/>
                • חיפוש/פילטרים/מיון<br/>
                • Lead Score (1–100)<br/>
                • וואטסאפ / התקשרות / מייל (במודאל)
              </div>
            </div>

            <div class="miniCard">
              <h3>פעולה מהירה</h3>
              <button class="btn premium" style="width:100%" id="btnOpenInsights">📊 סטטיסטיקות</button>
              <div class="sep"></div>
              <button class="btn" style="width:100%" id="btnSeed">✨ צור דוגמאות לידים</button>
              <div class="help">הכל נשמר מקומית בדפדפן (LocalStorage) עד שנחבר ל-Google Sheets.</div>
            </div>
          </div>
        </aside>

        <!-- Tasks view -->
        <section class="card" id="viewTasks" style="display:none">
          <div class="head">
            <h2>משימות</h2>
            <div class="muted small">תזכורות + עדיפות + שייכות לליד</div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table style="min-width:860px">
                <thead>
                  <tr>
                    <th>מתי</th>
                    <th>עדיפות</th>
                    <th>ליד</th>
                    <th>תיאור</th>
                    <th>סטטוס</th>
                    <th>פעולות</th>
                  </tr>
                </thead>
                <tbody id="tasksTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyTasks" style="display:none">אין משימות פתוחות.</div>
          </div>
        
        <!-- My Flows view -->
        <section class="card" id="viewMyFlows" style="display:none">
          <div class="head">
            <h2>התהליכים שלי</h2>
            <div class="muted small">תבניות טיפול מהירות ללקוח: שיחה, הצעה, מסמכים ומעקב</div>
          </div>
          <div class="body">
            <div class="grid2" style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px">
              <div class="card mini" style="border:1px solid var(--line); border-radius:14px; padding:12px">
                <div class="muted small" style="margin-bottom:6px">פעולות מהירות</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px">
                  <button class="btn" id="flowCall">📞 שיחה</button>
                  <button class="btn" id="flowWhatsApp">💬 וואטסאפ</button>
                  <button class="btn" id="flowEmail">✉️ מייל</button>
                  <button class="btn" id="flowNote">📝 הערה</button>
                </div>
                <div class="muted2 small" style="margin-top:10px">הפעולות משתמשות בלקוח שנבחר כרגע (כמו שאר המערכת).</div>
              </div>

              <div class="card mini" style="border:1px solid var(--line); border-radius:14px; padding:12px">
                <div class="muted small" style="margin-bottom:6px">תהליך טיפול</div>
                <div class="muted2 small" style="margin-bottom:10px">בחר שלב והמערכת תעדכן סטטוס/תיצור משימה/תוסיף אירוע ליצירת הצעה.</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px">
                  <button class="btn ghost" data-flow-step="נוצר קשר">✅ נוצר קשר</button>
                  <button class="btn ghost" data-flow-step="מתעניין">🔥 מתעניין</button>
                  <button class="btn ghost" data-flow-step="הצעת מחיר">💰 הצעת מחיר</button>
                  <button class="btn ghost" data-flow-step="נסגר">🏁 נסגר</button>
                </div>
              </div>
            </div>

            <div class="hr" style="margin:14px 0"></div>

            <div class="muted2 small">
              טיפ: אם תרצה, אפשר לחבר כל כפתור כאן ליצירת משימה אוטומטית (SLA), פתיחת מודאל מייל פנימי, או “תזכורת עוד X ימים”.
            </div>
          </div>
        </section>

</section>

        <!-- Timeline view -->
        <section class="card" id="viewTimeline" style="display:none">
          <div class="head">
            <h2>היסטוריית פעילות</h2>
            <div class="muted small">כל שינוי נשמר: מי/מתי/מה השתנה</div>
          </div>
          <div class="body">
            <div class="timeline" id="timelineList"></div>
            <div class="help" id="emptyTimeline" style="display:none">אין עדיין אירועים.</div>
          </div>
        </section>

        <!-- Settings view -->
        <section class="card" id="viewSettings" style="display:none">
          <div class="head">
            <h2>הגדרות</h2>
            <div class="muted small">חיבור Google Sheets ייכנס כאן</div>
          </div>
          <div class="body">
            <div class="miniCard">
              <h3>שמירה/איפוס</h3>
              <div class="row">
                <button class="btn" id="btnBackup" type="button">💾 יצא גיבוי JSON</button>
                <button class="btn danger" id="btnReset" type="button">🧨 איפוס כל הנתונים</button>
              </div>
              <div class="sep"></div>
              <h3>Google Sheets (בקרוב)</h3>
              <div class="small muted">
                כדי לחבר לסנכרון, נצטרך:
                <ul>
                  <li>URL של ה-Web App</li>
                  <li>ID של הפריסה (Deployment)</li>
                  <li>שם גיליון / טאב</li>
                </ul>
                ברגע שתשלח לי — אוסיף לך בקוד את החיבור, עם Fetch, והכל יעבוד דרך השיט.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">כותרת</b>
      <button class="closeX" id="modalClose" title="סגור">✕</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>


<div class="loader" id="loader" aria-hidden="true">
  <div class="loaderCard">
    <div class="loaderRing"></div>
    <div class="loaderText">טוען…</div>
    <div class="loaderBar"><i></i></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   LEADUP • Local CRM
   ======================= */

const LS_KEY = "leadup_v1";

const el = (id)=>document.getElementById(id);
const nowISO = () => new Date().toISOString();
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDT(iso){
  if(!iso) return "—";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "—";
  return d.toLocaleString("he-IL", { dateStyle:"medium", timeStyle:"short" });
}
function todayKey(){
  return new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
}
function toLocalDT(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const pad = (x)=>String(x).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromLocalDT(local){
  if(!local) return "";
  const d = new Date(local);
  if(Number.isNaN(d.getTime())) return "";
  return d.toISOString();
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultState(){
  return {
    user: { name: "מנהל", role: "Admin" },
    leads: [],
    tasks: [],
    events: []
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return { ...defaultState(), ...parsed };
  }catch(e){
    return defaultState();
  }
}
const appState = loadState();
// Expose state for modules that rely on it (mirror/esign etc.)
window.appState = appState;

function saveState(){
  window.appState = appState;
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
  showLoader(220);
  renderAll();
}

/* ===== Activity Timeline ===== */
function addEvent(type, text, meta={}){
  appState.events.unshift({
    id: uid("ev"),
    at: nowISO(),
    who: appState.user?.name || "משתמש",
    type, text, meta
  });
  appState.events = appState.events.slice(0, 800);
}

/* ===== Lead Score ===== */
function sourceWeight(source){
  const s = (source||"").toLowerCase();
  if(["הפניה","ref","referral"].some(x=>s.includes(x))) return 22;
  if(s.includes("טלפון")) return 18;
  if(s.includes("גוגל")) return 16;
  if(s.includes("אתר")) return 14;
  if(s.includes("פייסבוק")) return 12;
  return 10;
}
function statusWeight(status){
  switch(status){
    case "חדש": return 10;
    case "נוצר קשר": return 18;
    case "מתעניין": return 26;
    case "הצעת מחיר": return 34;
    case "נסגר": return 40;
    case "לא רלוונטי": return 2;
    default: return 10;
  }
}
function computeScore(lead){
  const talks = clamp(Number(lead.contactCount||0), 0, 20);
  const talkScore = talks * 2.2; // max 44

  const base = 18;
  const src = sourceWeight(lead.source);
  const st = statusWeight(lead.status);

  const refDate = lead.lastContactAt || lead.createdAt || nowISO();
  const days = Math.floor((Date.now() - new Date(refDate).getTime()) / (1000*60*60*24));
  const recencyPenalty = clamp(days * 1.6, 0, 40);

  let score = base + src + st + talkScore - recencyPenalty;

  if(lead.status === "נסגר") score += 10;
  if(lead.status === "לא רלוונטי") score = Math.min(score, 15);

  return clamp(Math.round(score), 1, 100);
}
function heatTag(score){
  if(score >= 75) return { cls:"hot", label:"חם" };
  if(score >= 45) return { cls:"ok", label:"בינוני" };
  return { cls:"cold", label:"קר" };
}


function openMirrorModal(){
  const mm = document.getElementById("mirrorModal");
  if(!mm) { alert("מסך שיקוף לא נטען"); return; }
  mm.classList.add("show");
  // mark nav active
  document.querySelectorAll(".nav button[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view==="mirror"));
  // keep title consistent
  try{
    if(window.el && el("viewTitle")) el("viewTitle").textContent = "צ'ק ליסט שיקוף עסקה";
    if(window.el && el("viewSub")) el("viewSub").textContent = "בחירת לקוח • בחירת חברת ביטוח • שלבים נעולים";
  }catch(e){}
}
function closeMirrorModal(){
  const mm = document.getElementById("mirrorModal");
  if(mm) mm.classList.remove("show");
  // return nav to leads
  document.querySelectorAll(".nav button[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view==="leads"));
  try{ setView("leads"); }catch(e){}
}
document.addEventListener("click",(e)=>{
  const mm = document.getElementById("mirrorModal");
  if(!mm) return;
  if(e.target && e.target.id === "mirrorClose") closeMirrorModal();
  if(e.target === mm) closeMirrorModal(); // click outside card
});
/* ===== Views ===== */
const nav = el("nav");
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  setView(btn.dataset.view);
});
function setView(view){
  // "mirror" / "esign" / "proposal" are modal flows (not full pages)
  if(view === "mirror") { openMirrorModal(); return; }
  if(view === "esign")  { openESignModal && openESignModal(); return; }
  if(view === "proposal"){ openProposalModal && openProposalModal(); return; }
  if(!["leads","myflows","tasks","timeline","settings"].includes(view)) view="leads";
  document.querySelectorAll(".nav button[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view===view));

  el("viewLeads").style.display = (view==="leads") ? "" : "none";
  el("viewRight").style.display = (view==="leads") ? "" : "none";
  el("viewMyFlows").style.display = (view==="myflows") ? "" : "none";
  el("viewTasks").style.display = (view==="tasks") ? "" : "none";
  el("viewTimeline").style.display = (view==="timeline") ? "" : "none";
  el("viewSettings").style.display = (view==="settings") ? "" : "none";

  const titles = {
    leads: ["לידים", "ניהול לידים, סטטוסים, פעולות ומעקב"],
    myflows: ["התהליכים שלי", "פעולות ותהליכי טיפול מהירים ללקוח הנבחר"],
    tasks: ["משימות", "תזכורות עם תאריך/שעה + עדיפות + שיוך לליד"],
    timeline: ["יצירת הצעה", "Timeline של כל פעולה ושינוי במערכת"],
    settings: ["הגדרות", "גיבוי/איפוס וחיבור ל-Google Sheets"]
  };
  el("viewTitle").textContent = titles[view][0];
  el("viewSub").textContent = titles[view][1];

  // active view highlight (cards currently visible)
  ["viewLeads","viewRight","viewMyFlows","viewTasks","viewTimeline","viewSettings"].forEach(id=>{
    const node = el(id);
    if(!node) return;
    node.classList.remove("activeView");
  });
  if(view==="leads"){ el("viewLeads")?.classList.add("activeView"); el("viewRight")?.classList.add("activeView"); }
  if(view==="myflows") el("viewMyFlows")?.classList.add("activeView");
  if(view==="tasks") el("viewTasks")?.classList.add("activeView");
  if(view==="timeline") el("viewTimeline")?.classList.add("activeView");
  if(view==="settings") el("viewSettings")?.classList.add("activeView");



  showLoader(260);
  // add subtle entrance animation to visible panels
  ["viewLeads","viewRight","viewMyFlows","viewTasks","viewTimeline","viewSettings"].forEach(id=>{
    const node = el(id);
    if(!node) return;
    node.classList.remove("viewPanel");
    if(node.style.display !== "none"){
      // trigger reflow then add
      void node.offsetWidth;
      node.classList.add("viewPanel");
    }
  });

  renderAll();
}

/* ===== Modal ===== */
function openModal(title, html){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = html;
  const back = el("modalBack");
  back.classList.remove("closing");
  back.style.display = "flex";
  requestAnimationFrame(()=> back.classList.add("show"));
}
function closeModal(){
  const back = el("modalBack");
  // Smooth close
  back.classList.add("closing");
  back.classList.remove("show");
  setTimeout(()=>{
    back.style.display = "none";
    back.classList.remove("closing");
    el("modalBody").innerHTML = "";
  }, 180);
}
el("modalClose").addEventListener("click", closeModal);
el("modalBack").addEventListener("click", (e)=>{
  if(e.target === el("modalBack")) closeModal();
});


/* ===== Toast ===== */
let toastTimer=null;
function toast(msg, type){
  const t = el("toast");
  if(!t) return;
  const m = String(msg ?? "");
  const guess = (()=>{
    if(type) return type;
    const s = m.toLowerCase();
    if(s.includes("שגיאה") || s.includes("לא ניתן") || s.includes("לא תקין") || s.includes("נכשל")) return "error";
    if(s.includes("אזהרה") || s.includes("שים לב") || s.includes("⚠")) return "warn";
    return "success";
  })();
  t.classList.remove("success","warn","error","show");
  t.classList.add(guess);
  t.textContent = m;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.classList.remove("show"), 2600);
}


/* ===== Filters/Search/Sort ===== */
el("q").addEventListener("input", renderLeads);
el("fStatus").addEventListener("change", renderLeads);
el("fSource").addEventListener("change", renderLeads);
el("sortBy").addEventListener("change", renderLeads);

/* ===== Buttons ===== */
el("btnAddLead").addEventListener("click", ()=>openLeadForm());
const _btnQuickTask = el("btnQuickTask"); if(_btnQuickTask) _btnQuickTask.addEventListener("click", ()=> openTaskForm());
el("btnOpenInsights").addEventListener("click", ()=> openInsights());
el("btnSeed").addEventListener("click", seedSample);
const _btnExport = el("btnExport"); if(_btnExport) _btnExport.addEventListener("click", exportJSON);
const _btnImport = el("btnImport"); if(_btnImport) _btnImport.addEventListener("click", importJSON);
el("btnBackup").addEventListener("click", exportJSON);
el("btnReset").addEventListener("click", ()=>{
  if(confirm("לאפס את כל הנתונים? פעולה בלתי הפיכה.")){
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
});

/* ===== Shortcuts ===== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeModal();
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement?.tagName||"")){
    e.preventDefault();
    el("q").focus();
  }
  const modalOpen = (el("modalBack").style.display === "flex");
  if((e.key==="n" || e.key==="N") && !modalOpen){
    openLeadForm();
  }
});

function exportJSON(){
  const blob = new Blob([JSON.stringify(appState, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "leadup-backup.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("גיבוי ירד למחשב ✅");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const f = inp.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || typeof parsed !== "object") throw new Error("bad");
        appState.user = parsed.user || appState.user;
        appState.leads = Array.isArray(parsed.leads) ? parsed.leads : appState.leads;
        appState.tasks = Array.isArray(parsed.tasks) ? parsed.tasks : appState.tasks;
        appState.events = Array.isArray(parsed.events) ? parsed.events : appState.events;
        addEvent("import", "ייבוא נתונים בוצע");
        try{
      saveState();
    }catch(err){
      console.error("saveState failed", err);
    }
    toast("ליד נשמר בהצלחה ✅", "success");
    // close even if render has minor errors
    setTimeout(()=>{ try{ closeModal(); }catch(e){} }, 520);
toast("ייבוא הצליח ✅");
      }catch(e){
        alert("קובץ לא תקין");
      }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* =======================
   Leads CRUD
   ======================= */
function openLeadForm(leadId=null){
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;
  const isEdit = !!lead;

  const data = lead || {
    id: uid("lead"),
    name:"",
    phone:"",
    email:"",
    status:"חדש",
    source:"אחר",
    owner:"מנהל",
    note:"",
    createdAt: nowISO(),
    lastContactAt:"",
    nextFollowUpAt:"",
    contactCount: 0
  };

  openModal(isEdit ? "עריכת ליד" : "ליד חדש", `
    <div class="split">
      <div>
        <form id="leadForm">
          <div class="row">
            <div>
              <label>שם מלא</label>
              <input name="name" value="${escapeHTML(data.name)}" placeholder="לדוגמה: ישראל ישראלי" required/>
            </div>
            <div>
              <label>טלפון</label>
              <input name="phone" value="${escapeHTML(data.phone)}" placeholder="05X-XXXXXXX" inputmode="tel"/>
            
              <input name="tz" value="${escapeHTML(data.tz||data.idNumber||"")}" placeholder="תעודת זהות" inputmode="numeric"/>
</div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>אימייל</label>
              <input name="email" value="${escapeHTML(data.email)}" placeholder="name@email.com" inputmode="email"/>
            </div>
            <div>
              <label>בעלים (נציג)</label>
              <input name="owner" value="${escapeHTML(data.owner||"מנהל")}" placeholder="שם נציג"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>סטטוס</label>
              <select name="status">
                ${["חדש","נוצר קשר","מתעניין","הצעת מחיר","נסגר","לא רלוונטי"].map(s=>`
                  <option ${s===data.status?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
            <div>
              <label>מקור</label>
              <select name="source">
                ${["פייסבוק","גוגל","הפניה","טלפון","אתר","אחר"].map(s=>`
                  <option ${s===data.source?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>מעקב הבא (תאריך/שעה)</label>
              <input name="nextFollowUpAt" value="${escapeHTML(toLocalDT(data.nextFollowUpAt))}" type="datetime-local"/>
            </div>
            <div>
              <label>עדכון "דיברנו" (מעלה score)</label>
              <button type="button" class="btn" id="btnTouch" style="width:100%">☎️ סימון שיחה/מענה</button>
              <div class="help">מעלה Contact Count + מעדכן Last Contact.</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>הערה</label>
            <textarea name="note" placeholder="רשום פרטים חשובים…">${escapeHTML(data.note||"")}</textarea>
          </div>

          <div class="sep"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start">
            <button class="btn gold" type="submit">💾 שמירה</button>
            <button class="btn" type="button" id="btnCreateTask">⏰ צור משימה לליד</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteLead">🗑️ מחיקה</button>` : ""}
            <button class="btn" type="button" id="btnOpenContact">📲 פעולות קשר</button>
          </div>

          <div class="help">
            Lead Score מתחשב בסטטוס, מקור, כמות שיחות וזמן שעבר.
          </div>
        </form>
      </div>

      <div>
        <div class="miniCard">
          <h3>תצוגה מהירה</h3>
          <div class="small muted">נוצר: ${fmtDT(data.createdAt)}</div>
          <div class="small muted">שיחה אחרונה: ${data.lastContactAt ? fmtDT(data.lastContactAt) : "—"}</div>
          <div class="small muted">שיחות/מענים: ${Number(data.contactCount||0)}</div>
          <div class="sep"></div>
          <div class="score">
            <div class="tag ${heatTag(computeScore(data)).cls}">🔥 ${heatTag(computeScore(data)).label}</div>
            <div style="font-weight:800">${computeScore(data)}/100</div>
          </div>
          <div class="bar" style="margin-top:10px"><i style="width:${computeScore(data)}%"></i></div>
          <div class="help">ככל שהציון גבוה יותר—הליד “חם” יותר.</div>
        </div>

        <div class="miniCard" style="margin-top:10px">
          <h3>פעולות מהירות</h3>
          <div class="actions">
            <button type="button" class="iconBtn gold" title="וואטסאפ" id="qaWA">💬</button>
            <button type="button" class="iconBtn" title="התקשר" id="qaCall">📞</button>
            <button type="button" class="iconBtn" title="אימייל" id="qaMail">✉️</button>
            <button type="button" class="iconBtn" title="העתק טלפון" id="qaCopy">📋</button>
          </div>
          <div class="help">כאן הכל בתוך מודאל (לא נפתח חלון חדש).</div>
        </div>
      </div>
    </div>
  `);

  const form = document.getElementById("leadForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.nextFollowUpAt = fromLocalDT(updated.nextFollowUpAt);
    updated.createdAt = data.createdAt || nowISO();

    const idx = appState.leads.findIndex(l=>l.id===updated.id);
    if(idx>=0){
      appState.leads[idx] = updated;
      addEvent("lead_update", `עודכן ליד: ${updated.name}`, {leadId: updated.id});
      toast("ליד עודכן ✅");
    }else{
      appState.leads.unshift(updated);
      addEvent("lead_create", `נוצר ליד חדש: ${updated.name}`, {leadId: updated.id});
      toast("ליד נוסף ✅");
    }
    try{ saveState(); }catch(err){ console.error("saveState failed", err); }
    try{ renderAll(); }catch(err){ console.error("renderAll failed", err); }
    toast("ליד נשמר בהצלחה ✅", "success");
    setTimeout(()=>{
      try{ closeModal(); }catch(e){}
      // Hard fallback (in case another script reopened/blocked)
      const mb = document.getElementById("modalBack");
      if(mb){ mb.classList.remove("show","closing"); mb.style.display="none"; }
      const body = document.getElementById("modalBody");
      if(body) body.innerHTML="";
    }, 550);
  });

  document.getElementById("btnTouch").addEventListener("click", ()=>{
    data.contactCount = Number(data.contactCount||0) + 1;
    data.lastContactAt = nowISO();
    addEvent("contact", `שיחה/מענה סומן לליד: ${data.name||"(ללא שם)"}`, {leadId:data.id});
    toast("סומן שיחה ✅");
    const idx = appState.leads.findIndex(l=>l.id===data.id);
    if(idx>=0) appState.leads[idx] = data;
    else appState.leads.unshift(data);
    saveState();
    openLeadForm(data.id);
  });

  if(isEdit){
    document.getElementById("btnDeleteLead").addEventListener("click", ()=>{
      if(!confirm("למחוק את הליד?")) return;
      appState.leads = appState.leads.filter(l=>l.id!==leadId);
      appState.tasks = appState.tasks.filter(t=>t.leadId!==leadId);
      addEvent("lead_delete", `נמחק ליד: ${lead.name}`, {leadId});
      saveState();
      closeModal();
      toast("ליד נמחק 🗑️");
    });
  }

  document.getElementById("btnCreateTask").addEventListener("click", ()=>{
    openTaskForm({ leadId: data.id, leadName: data.name, presetDate: data.nextFollowUpAt });
  });

  document.getElementById("btnOpenContact").addEventListener("click", ()=>{
    openContactPanel(data);
  });

  document.getElementById("qaWA").addEventListener("click", ()=> openContactPanel(data, "wa"));
  document.getElementById("qaCall").addEventListener("click", ()=> openContactPanel(data, "call"));
  document.getElementById("qaMail").addEventListener("click", ()=> openContactPanel(data, "mail"));
  document.getElementById("qaCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(data.phone||"");
      toast("הטלפון הועתק 📋");
    }catch{
      toast("לא ניתן להעתיק בדפדפן הזה");
    }
  });
}

/* ===== Contact panel (in-modal) ===== */
function normalizeILPhone(phone){
  const digits = String(phone||"").replace(/[^\d]/g,"");
  if(!digits) return "";
  // if starts with 0 -> IL
  if(digits.startsWith("0")) return "972" + digits.slice(1);
  // already includes country?
  if(digits.startsWith("972")) return digits;
  // fallback
  return digits;
}

function openContactPanel(lead, focus="wa"){
  const phoneIL = normalizeILPhone(lead.phone);
  const mail = (lead.email||"").trim();
  const waWeb = phoneIL ? `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}` : "";
  const tel = (lead.phone||"").trim();
  const mailto = mail ? `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent("LEADUP - פניה")}` : "";

  openModal(`פעולות קשר • ${lead.name || "ליד"}`, `
    <div class="twoCols">
      <div class="miniCard">
        <h3>פרטי קשר</h3>
        <div class="small muted">טלפון: <b>${escapeHTML(lead.phone||"—")}</b></div>
        <div class="small muted" style="margin-top:6px">אימייל: <b>${escapeHTML(mail||"—")}</b></div>
        <div class="sep"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cWA" ${waWeb? "":"disabled"}>💬 וואטסאפ</button>
          <button class="btn" type="button" id="cCall" ${tel? "":"disabled"}>📞 התקשר</button>
          <button class="btn" type="button" id="cMail" ${mailto? "":"disabled"}>✉️ מייל</button>
          <button class="btn" type="button" id="cCopyPhone" ${tel? "":"disabled"}>📋 העתק טלפון</button>
          <button class="btn" type="button" id="cCopyMail" ${mail? "":"disabled"}>📋 העתק מייל</button>
        </div>

        <div class="help">
          הערה: “התקשר” / “מייל” לא נפתחים בתוך iframe בגלל מגבלות דפדפן,
          אבל נשארים בתוך המודאל עם כפתורי העתקה + קישור.
        </div>

        <div class="sep"></div>
        <div class="miniCard" style="margin:0; background:rgba(255,255,255,.02)">
          <h3 style="margin-bottom:8px">הודעה מהירה לוואטסאפ</h3>
          <label>טקסט</label>
          <textarea id="waText" placeholder="היי ${escapeHTML(lead.name||"")}, מדבר/ת מ-...">${escapeHTML(`היי ${lead.name||""}, מדבר/ת מ-LEADUP. אפשר לעזור?`)}</textarea>
          <button class="btn gold" type="button" id="waOpenMsg" style="margin-top:10px" ${waWeb? "":"disabled"}>🚀 פתח וואטסאפ עם ההודעה</button>
        </div>
      </div>

      <div class="miniCard">
        <h3>תצוגה בתוך המערכת</h3>
        ${waWeb ? `
          <div class="frame">
            <iframe id="waFrame" src="${escapeHTML(waWeb)}"></iframe>
          </div>
          <div class="help">אם לא התחברת ל-WhatsApp Web במחשב, תצטרך להתחבר פעם אחת.</div>
        ` : `
          <div class="help">אין טלפון לליד — הוסף מספר ואז תוכל לפתוח WhatsApp Web כאן.</div>
        `}
      </div>
    </div>
  `);

  // wire buttons
  const cWA = document.getElementById("cWA");
  const cCall = document.getElementById("cCall");
  const cMail = document.getElementById("cMail");
  const cCopyPhone = document.getElementById("cCopyPhone");
  const cCopyMail = document.getElementById("cCopyMail");

  if(cWA) cWA.addEventListener("click", ()=>{
    if(!waWeb) return;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = waWeb;
    addEvent("contact_open", `נפתח וואטסאפ לליד: ${lead.name||"—"}`, {leadId: lead.id});
    saveState();
  });

  if(cCall) cCall.addEventListener("click", async ()=>{
    // keep inside modal: show link and copy
    addEvent("call_hint", `ניסיון התקשרות (קישור Tel) לליד: ${lead.name||"—"}`, {leadId: lead.id});
    saveState();
    toast("העתקנו לך/צירפנו קישור להתקשרות בתוך המודאל");
    openModal(`התקשר • ${lead.name||"ליד"}`, `
      <div class="miniCard">
        <h3>התקשרות</h3>
        <div class="small muted">מספר: <b>${escapeHTML(tel||"—")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="ccCopy">📋 העתק מספר</button>
          <a class="btn" href="${escapeHTML(tel ? "tel:"+tel.replace(/[^\d+]/g,"") : "#")}" style="text-decoration:none; ${tel? "":"pointer-events:none;opacity:.6"}">📞 חייג (אם הדפדפן מאפשר)</a>
        </div>
        <div class="help">במחשב לפעמים Tel לא עובד — אז הכי טוב להעתיק ולהתקשר מהנייד.</div>
      </div>
    `);
    document.getElementById("ccCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(tel||""); toast("המספר הועתק 📋"); }catch{}
    });
  });

  if(cMail) cMail.addEventListener("click", ()=>{
    addEvent("mail_hint", `נפתח מייל (mailto) לליד: ${lead.name||"—"}`, {leadId: lead.id});
    saveState();
    openModal(`מייל • ${lead.name||"ליד"}`, `
      <div class="miniCard">
        <h3>שליחת מייל</h3>
        <div class="small muted">כתובת: <b>${escapeHTML(mail||"—")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cmCopy">📋 העתק מייל</button>
          <a class="btn" href="${escapeHTML(mailto)}" style="text-decoration:none; ${mailto? "":"pointer-events:none;opacity:.6"}">✉️ פתח תוכנת מייל</a>
        </div>
        <div class="help">mailto תלוי בהגדרות המחשב שלך (Gmail/Outlook וכו'). אם לא נפתח—פשוט העתק.</div>
      </div>
    `);
    document.getElementById("cmCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mail||""); toast("המייל הועתק 📋"); }catch{}
    });
  });

  if(cCopyPhone) cCopyPhone.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(tel||""); toast("הטלפון הועתק 📋"); }catch{ toast("לא ניתן להעתיק");}
  });
  if(cCopyMail) cCopyMail.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(mail||""); toast("המייל הועתק 📋"); }catch{ toast("לא ניתן להעתיק");}
  });

  document.getElementById("waOpenMsg")?.addEventListener("click", ()=>{
    if(!phoneIL) return;
    const txt = document.getElementById("waText")?.value || "";
    // WhatsApp web message param
    const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}&text=${encodeURIComponent(txt)}`;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = url;
    addEvent("wa_msg", `נפתח וואטסאפ עם הודעה לליד: ${lead.name||"—"}`, {leadId: lead.id});
    saveState();
  });

  // focus
  if(focus==="wa") cWA?.click();
}

/* =======================
   Tasks CRUD
   ======================= */
function openTaskForm(opts={}){
  // opts: { taskId, leadId, leadName, presetDate }
  const task = opts.taskId ? appState.tasks.find(t=>t.id===opts.taskId) : null;
  const isEdit = !!task;

  const leadId = opts.leadId || task?.leadId || "";
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;

  const data = task || {
    id: uid("task"),
    leadId: leadId || "",
    title: "",
    dueAt: opts.presetDate || "",
    priority: "בינונית",
    status: "פתוחה",
    createdAt: nowISO()
  };

  openModal(isEdit ? "עריכת משימה" : "משימה חדשה", `
    <form id="taskForm">
      <div class="row">
        <div>
          <label>שייך לליד</label>
          <select name="leadId">
            <option value="">ללא שיוך</option>
            ${appState.leads.map(l=>`
              <option value="${escapeHTML(l.id)}" ${l.id===data.leadId?"selected":""}>${escapeHTML(l.name || "(ללא שם)")}</option>
            `).join("")}
          </select>
          <div class="help">${lead ? `נבחר: <b>${escapeHTML(lead.name)}</b>` : "אפשר לבחור ליד או להשאיר ללא שיוך."}</div>
        </div>
        <div>
          <label>מתי (תאריך/שעה)</label>
          <input name="dueAt" type="datetime-local" value="${escapeHTML(toLocalDT(data.dueAt))}"/>
          <div class="help">אפשר גם “לחזור אליו עוד X ימים” למטה.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>עדיפות</label>
          <select name="priority">
            ${["גבוהה","בינונית","נמוכה"].map(p=>`
              <option ${p===data.priority?"selected":""}>${p}</option>
            `).join("")}
          </select>
        </div>
        <div>
          <label>סטטוס</label>
          <select name="status">
            ${["פתוחה","בוצעה"].map(s=>`
              <option ${s===data.status?"selected":""}>${s}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>תיאור</label>
        <textarea name="title" placeholder="לדוגמה: לחזור לליד ולתת הצעת מחיר…">${escapeHTML(data.title||"")}</textarea>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>לחזור אליו עוד X ימים</label>
          <div style="display:flex; gap:10px">
            <input id="xDays" type="number" min="0" placeholder="לדוגמה: 3"/>
            <button type="button" class="btn" id="btnApplyX">📅 קבע תאריך</button>
          </div>
          <div class="help">יקבע Due לפי עכשיו + X ימים.</div>
        </div>
        <div>
          <label>פעולות</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="submit">💾 שמירה</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteTask">🗑️ מחיקה</button>` : ""}
          </div>
        </div>
      </div>
    </form>
  `);

  document.getElementById("btnApplyX")?.addEventListener("click", ()=>{
    const x = Number(document.getElementById("xDays")?.value || 0);
    const d = new Date();
    d.setDate(d.getDate() + (Number.isFinite(x)? x : 0));
    const local = toLocalDT(d.toISOString());
    const due = document.querySelector('#taskForm input[name="dueAt"]');
    if(due) due.value = local;
    toast("נקבע תאריך ✅");
  });

  const form = document.getElementById("taskForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.dueAt = fromLocalDT(updated.dueAt);

    const idx = appState.tasks.findIndex(t=>t.id===updated.id);
    const leadName = updated.leadId ? (appState.leads.find(l=>l.id===updated.leadId)?.name || "ליד") : "ללא שיוך";
    if(idx>=0){
      appState.tasks[idx] = updated;
      addEvent("task_update", `עודכנה משימה (${updated.priority}) • ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("משימה עודכנה ✅");
    }else{
      appState.tasks.unshift(updated);
      addEvent("task_create", `נוצרה משימה (${updated.priority}) • ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("משימה נוספה ✅");
    }
    saveState();
    closeModal();
  });

  if(isEdit){
    document.getElementById("btnDeleteTask")?.addEventListener("click", ()=>{
      if(!confirm("למחוק את המשימה?")) return;
      appState.tasks = appState.tasks.filter(t=>t.id!==data.id);
      addEvent("task_delete", `נמחקה משימה`, {taskId: data.id, leadId: data.leadId||""});
      saveState();
      closeModal();
      toast("משימה נמחקה 🗑️");
    });
  }
}

function toggleTaskDone(taskId){
  const t = appState.tasks.find(x=>x.id===taskId);
  if(!t) return;
  t.status = (t.status==="בוצעה") ? "פתוחה" : "בוצעה";
  addEvent("task_toggle", `סטטוס משימה: ${t.status}`, {taskId: t.id, leadId: t.leadId||""});
  saveState();
}

/* =======================
   Rendering
   ======================= */

/* ===== Animated Counters (Dashboard) ===== */
function animateNumber(elm, to){
  if(!elm) return;
  const from = Number(String(elm.textContent||"0").replace(/[^\d.-]/g,"")) || 0;
  const target = Number(to) || 0;
  if(from === target){ elm.textContent = String(target); return; }
  const start = performance.now();
  const dur = 520;
  const step = (t)=>{
    const p = Math.min(1, (t-start)/dur);
    const eased = 1 - Math.pow(1-p, 3);
    const val = Math.round(from + (target-from)*eased);
    elm.textContent = String(val);
    if(p < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

function renderAll(){
  renderStats();
  renderLeads();
  renderTasks();
  renderTimeline();
  renderNavCounts();
}

function renderNavCounts(){
  el("navCount").textContent = String(appState.leads.length);
  const openTasks = appState.tasks.filter(t=>t.status!=="בוצעה").length;
  el("navTasks").textContent = String(openTasks);
  el("navEvents").textContent = String(appState.events.length);
}

function renderStats(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const hot = scores.filter(s=>s>=75).length;

  const today = todayKey();
  const todayFollow = appState.leads.filter(l=>{
    if(!l.nextFollowUpAt) return false;
    const d = new Date(l.nextFollowUpAt);
    if(Number.isNaN(d.getTime())) return false;
    const k = d.toLocaleDateString("sv-SE");
    return k === today;
  }).length;

  const openTasks = appState.tasks.filter(t=>t.status!=="בוצעה").length;

  animateNumber(el("stTotal"), total);
  animateNumber(el("stHot"), hot);
  animateNumber(el("stToday"), todayFollow);
  animateNumber(el("stTasks"), openTasks);
}

function getFilteredSortedLeads(){
  const q = (el("q").value||"").trim().toLowerCase();
  const fStatus = el("fStatus").value;
  const fSource = el("fSource").value;
  const sortBy = el("sortBy").value;

  let arr = [...appState.leads];

  if(q){
    arr = arr.filter(l=>{
      const hay = [
        l.name, l.phone, l.email, l.status, l.source, l.owner, l.note
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  if(fStatus) arr = arr.filter(l=> (l.status||"")===fStatus);
  if(fSource) arr = arr.filter(l=> (l.source||"")===fSource);

  const scoreOf = (l)=>computeScore(l);
  const nextTime = (l)=> l.nextFollowUpAt ? new Date(l.nextFollowUpAt).getTime() : Infinity;
  const createdTime = (l)=> l.createdAt ? new Date(l.createdAt).getTime() : 0;

  if(sortBy==="hot"){
    arr.sort((a,b)=> scoreOf(b)-scoreOf(a));
  }else if(sortBy==="next"){
    arr.sort((a,b)=> nextTime(a)-nextTime(b));
  }else if(sortBy==="newest"){
    arr.sort((a,b)=> createdTime(b)-createdTime(a));
  }else if(sortBy==="oldest"){
    arr.sort((a,b)=> createdTime(a)-createdTime(b));
  }
  return arr;
}

function renderLeads(){
  const tbody = el("leadsTbody");
  const leads = getFilteredSortedLeads();

  el("emptyLeads").style.display = (appState.leads.length===0) ? "" : "none";

  tbody.innerHTML = leads.map(l=>{
    const score = computeScore(l);
    const ht = heatTag(score);
    return `
      <tr>
        <td><b>${escapeHTML(l.name||"—")}</b><div class="small muted">${escapeHTML(l.owner||"")}</div></td>
        <td>${escapeHTML(l.phone||"—")}</td>
        <td><span class="tag">${escapeHTML(l.status||"—")}</span></td>
        <td><span class="tag">${escapeHTML(l.source||"—")}</span></td>
        <td>
          <div class="score">
            <span class="tag ${ht.cls}">${ht.label}</span>
            <b>${score}</b>
          </div>
          <div class="bar" style="margin-top:8px"><i style="width:${score}%"></i></div>
        </td>
        <td>${l.nextFollowUpAt ? fmtDT(l.nextFollowUpAt) : "—"}</td>
        <td>
          <div class="actions">
            <button class="btn goldSoft openClientBtn" title="פתח תיק לקוח" data-tip="פתח תיק לקוח" data-act="open" data-id="${escapeHTML(l.id)}">📂 פתח תיק לקוח</button>
            <button class="iconBtn gold" title="ערוך" data-tip="ערוך" data-act="edit" data-id="${escapeHTML(l.id)}">✎</button>
            <button class="iconBtn" title="משימה" data-tip="צור משימה" data-act="task" data-id="${escapeHTML(l.id)}">⏰</button>
            <button class="iconBtn" title="קשר" data-tip="פעולות קשר" data-act="contact" data-id="${escapeHTML(l.id)}">📲</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="open") openClientDossier(id);
      if(act==="edit") openLeadForm(id);
      if(act==="task"){
        const lead = appState.leads.find(l=>l.id===id);
        openTaskForm({ leadId:id, leadName: lead?.name || "" , presetDate: lead?.nextFollowUpAt || ""});
      }
      if(act==="contact"){
        const lead = appState.leads.find(l=>l.id===id);
        if(lead) openContactPanel(lead);
      }
    });
  });
}

function renderTasks(){
  const tbody = el("tasksTbody");
  const tasks = [...appState.tasks].sort((a,b)=>{
    const da = a.dueAt ? new Date(a.dueAt).getTime() : Infinity;
    const db = b.dueAt ? new Date(b.dueAt).getTime() : Infinity;
    return da-db;
  });

  const openTasks = tasks.filter(t=>t.status!=="בוצעה");
  el("emptyTasks").style.display = (openTasks.length===0) ? "" : "none";

  tbody.innerHTML = openTasks.map(t=>{
    const leadName = t.leadId ? (appState.leads.find(l=>l.id===t.leadId)?.name || "ליד") : "—";
    const priTag = t.priority==="גבוהה" ? "hot" : (t.priority==="בינונית" ? "ok" : "cold");
    return `
      <tr>
        <td>${t.dueAt ? fmtDT(t.dueAt) : "—"}</td>
        <td><span class="tag ${priTag}">${escapeHTML(t.priority||"")}</span></td>
        <td>${escapeHTML(leadName)}</td>
        <td>${escapeHTML(t.title||"")}</td>
        <td><span class="tag">${escapeHTML(t.status||"")}</span></td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="ערוך" data-tip="ערוך" data-act="edit" data-id="${escapeHTML(t.id)}">✎</button>
            <button class="iconBtn" title="בוצעה/פתוחה" data-act="done" data-id="${escapeHTML(t.id)}">✓</button>
            <button class="iconBtn" title="מחיקה" data-act="del" data-id="${escapeHTML(t.id)}">🗑️</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="edit") openTaskForm({ taskId:id });
      if(act==="done") toggleTaskDone(id);
      if(act==="del"){
        if(!confirm("למחוק משימה?")) return;
        appState.tasks = appState.tasks.filter(t=>t.id!==id);
        addEvent("task_delete", "נמחקה משימה", {taskId:id});
        saveState();
      }
    });
  });
}

function renderTimeline(){
  const list = el("timelineList");
  const events = appState.events.slice(0, 200);
  el("emptyTimeline").style.display = (events.length===0) ? "" : "none";

  list.innerHTML = events.map(ev=>{
    const who = ev.who || "משתמש";
    return `
      <div class="event">
        <div class="t">${fmtDT(ev.at)} • ${escapeHTML(who)} • <span class="muted">${escapeHTML(ev.type||"")}</span></div>
        <div class="d">${escapeHTML(ev.text||"")}</div>
      </div>
    `;
  }).join("");
}

/* =======================
   Insights
   ======================= */
function openInsights(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

  const byStatus = {};
  for(const l of appState.leads){
    const k = l.status || "לא מוגדר";
    byStatus[k] = (byStatus[k]||0)+1;
  }
  const bySource = {};
  for(const l of appState.leads){
    const k = l.source || "לא מוגדר";
    bySource[k] = (bySource[k]||0)+1;
  }

  const topHot = [...appState.leads]
    .sort((a,b)=>computeScore(b)-computeScore(a))
    .slice(0, 5);

  openModal("סטטיסטיקות • LEADUP", `
    <div class="twoCols">
      <div class="miniCard">
        <h3>סיכום</h3>
        <div class="small muted">סה״כ לידים: <b>${total}</b></div>
        <div class="small muted">ממוצע Score: <b>${avg}</b></div>
        <div class="sep"></div>
        <h3>Top 5 חמים</h3>
        ${topHot.length ? topHot.map(l=>`
          <div class="event">
            <div class="t">${escapeHTML(l.name||"—")} • ${escapeHTML(l.status||"")}</div>
            <div class="d"><b>${computeScore(l)}</b>/100 • ${l.nextFollowUpAt ? "מעקב: "+fmtDT(l.nextFollowUpAt) : "ללא מעקב"}</div>
          </div>
        `).join("") : `<div class="help">אין לידים.</div>`}
      </div>

      <div class="miniCard">
        <h3>התפלגות</h3>
        <div class="small muted"><b>לפי סטטוס</b></div>
        ${Object.keys(byStatus).length ? Object.entries(byStatus).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">אין נתונים.</div>`}
        <div class="sep"></div>
        <div class="small muted"><b>לפי מקור</b></div>
        ${Object.keys(bySource).length ? Object.entries(bySource).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">אין נתונים.</div>`}
      </div>
    </div>
  `);
}

/* =======================
   Seed sample data
   ======================= */
function seedSample(){
  if(appState.leads.length && !confirm("כבר יש לידים. להוסיף עוד דוגמאות?")) return;

  const mkLead = (name, phone, status, source, nextDays, talks=0)=>({
    id: uid("lead"),
    name, phone,
    email: "",
    status, source,
    owner: "מנהל",
    note: "דוגמה",
    createdAt: new Date(Date.now() - (Math.random()*8+1)*86400000).toISOString(),
    lastContactAt: talks ? new Date(Date.now() - (Math.random()*4+1)*86400000).toISOString() : "",
    nextFollowUpAt: nextDays!=null ? new Date(Date.now()+nextDays*86400000).toISOString() : "",
    contactCount: talks
  });

  const demo = [
    mkLead("איתי כהן","052-1234567","מתעניין","הפניה",1,3),
    mkLead("נועה לוי","054-9876543","נוצר קשר","פייסבוק",0,1),
    mkLead("דניאל אוחנה","050-2223344","הצעת מחיר","גוגל",2,4),
    mkLead("רועי ביטון","053-5556677","חדש","אתר",3,0),
    mkLead("שחר ממן","052-7654321","נסגר","טלפון",null,6),
  ];

  appState.leads.unshift(...demo);
  addEvent("seed", "נוצרו לידים לדוגמה");
  // גם משימות לדוגמה
  appState.tasks.unshift(
    { id: uid("task"), leadId: demo[0].id, title:"לחזור עם הצעת מחיר", dueAt: new Date(Date.now()+86400000).toISOString(), priority:"גבוהה", status:"פתוחה", createdAt: nowISO() },
    { id: uid("task"), leadId: demo[2].id, title:"בדיקת מסמכים", dueAt: new Date(Date.now()+2*86400000).toISOString(), priority:"בינונית", status:"פתוחה", createdAt: nowISO() }
  );
  addEvent("seed", "נוצרו משימות לדוגמה");
  saveState();
  toast("נוצרו דוגמאות ✅");
}

/* =======================
   Init
   ======================= */
(function init(){
  if(!appState.events.length){
    addEvent("init", "המערכת עלתה • מצב LocalStorage");
    saveState();
  }
  renderAll();
})();
/* =======================
   Transitions + Loader
   ======================= */


/* =======================
   Dynamic Greeting
   ======================= */
function updateGreeting(){
  const h = new Date().getHours();
  let txt = "שלום 👋";
  if(h >= 5 && h < 12) txt = "☀️ בוקר טוב";
  else if(h >= 12 && h < 17) txt = "🌤️ צהריים טובים";
  else if(h >= 17 && h < 21) txt = "🌆 ערב טוב";
  else txt = "🌙 לילה טוב";
  const elG = document.getElementById("greetingBadge");
  if(elG) elG.textContent = txt;
}
updateGreeting();
setInterval(updateGreeting, 60 * 1000);


/* ===== Micro-interaction: subtle haptic on mobile taps ===== */
document.addEventListener("click", (e)=>{
  const b = e.target.closest(".btn, .iconBtn");
  if(!b) return;
  if(navigator.vibrate){
    try{ navigator.vibrate(8); }catch{}
  }
}, {passive:true});


/* ===== Sidebar: My Flows (replaces Quick Task button) ===== */

;

</script>

<!-- ===== Proposal Builder Modal ===== -->
<div id="proposalModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="proposalModalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div id="proposalModalTitle" class="title">יצירת הצעה</div>
        <div class="sub">בחר חברת ביטוח — ואז נטען את טופס ההצעה בתוך חלון פנימי</div>
      </div>
      <button class="btnGhost" id="proposalCloseBtn" aria-label="סגור">✕ סגור</button>
    </div>

    <div class="modalBody">
      <div class="modalLeft">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:800">חברות ביטוח</div>
          <button class="btnGhost" id="proposalBackBtn" style="display:none">↩ חזרה לרשימה</button>
        </div>

        <div class="companyList" id="companyList">
          <!-- שנה כאן את השמות והקישורים לטפסים שלך -->
          <button class="companyBtn" data-company="הראל" data-url="https://example.com/harel-form">
            <div>
              <div class="name">הראל</div>
              <div class="hint">טופס הצעה</div>
            </div>
            <div>›</div>
          </button>

          <button class="companyBtn" data-company="מגדל" data-url="https://example.com/migdal-form">
            <div>
              <div class="name">מגדל</div>
              <div class="hint">טופס הצעה</div>
            </div>
            <div>›</div>
          </button>

          <button class="companyBtn" data-company="כלל" data-url="clal_offer.pdf">
            <div>
              <div class="name">כלל</div>
              <div class="hint">טופס הצעה (PDF)</div>
            </div>
            <div>›</div>
          </button>

          <button class="companyBtn" data-company="הפניקס" data-url="https://example.com/phoenix-form">
            <div>
              <div class="name">הפניקס</div>
              <div class="hint">טופס הצעה</div>
            </div>
            <div>›</div>
          </button>

          <button class="companyBtn" data-company="מנורה מבטחים" data-url="https://example.com/menora-form">
            <div>
              <div class="name">מנורה מבטחים</div>
              <div class="hint">טופס הצעה</div>
            </div>
            <div>›</div>
          </button>
        </div>
      </div>

      <div class="modalRight">
        <div class="proposalTop">
          <div class="crumb" id="proposalCrumb">לא נבחרה חברה</div>
          <div style="display:flex;gap:8px;align-items:center">
            <a id="proposalOpenExternal" href="#" target="_blank" rel="noopener" style="display:none;color:var(--gold2);font-weight:800;text-decoration:none">פתח בטאב חדש</a>
          </div>
        </div>

        <div class="proposalFrame">
          <iframe id="proposalFrame" title="טופס הצעה" src="about:blank"></iframe>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGhost" id="proposalClearBtn">נקה</button>
      <button class="btnGold" id="proposalDoneBtn">סגור</button>
    </div>
  </div>
</div>


<script>
/* ===== Proposal Builder Logic ===== */
(function(){
  const modal = document.getElementById('proposalModal');
  if(!modal) return;

  const frame = document.getElementById('proposalFrame');
  const crumb = document.getElementById('proposalCrumb');
  const openExternal = document.getElementById('proposalOpenExternal');
  const closeBtn = document.getElementById('proposalCloseBtn');
  const doneBtn = document.getElementById('proposalDoneBtn');
  const clearBtn = document.getElementById('proposalClearBtn');
  const backBtn = document.getElementById('proposalBackBtn');
  const companyList = document.getElementById('companyList');

  function showModal(){
    modal.classList.add('show');
    // focus close for accessibility
    setTimeout(()=> closeBtn?.focus(), 0);
  }
  function hideModal(){
    modal.classList.remove('show');
  }
  function clearFrame(){
    frame.src = 'about:blank';
    crumb.textContent = 'לא נבחרה חברה';
    openExternal.style.display = 'none';
    openExternal.href = '#';
    backBtn.style.display = 'none';
    companyList.scrollTop = 0;
  }
  function loadCompany(name, url){
    crumb.textContent = 'נבחר: ' + name;
    frame.src = url;
    openExternal.href = url;
    openExternal.style.display = 'inline';
    backBtn.style.display = 'inline-flex';
  }

  // Close actions
  closeBtn?.addEventListener('click', hideModal);
  doneBtn?.addEventListener('click', hideModal);
  clearBtn?.addEventListener('click', clearFrame);

  // Back (go to list state)
  backBtn?.addEventListener('click', clearFrame);

  // Click outside card closes
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) hideModal();
  });

  // Company selection
  modal.querySelectorAll('.companyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const name = btn.getAttribute('data-company') || 'חברה';
      const url = btn.getAttribute('data-url') || 'about:blank';
      loadCompany(name, url);
    });
  });

  // Hook into navigation:
  // If there is a nav button with data-view="proposal", open modal when user clicks it.
  const navProposal = document.querySelector('[data-view="proposal"]');
  navProposal?.addEventListener('click', (e)=>{
    // allow the normal tab behavior to mark active etc., but open our modal
    showModal();
  });

  // Also allow programmatic open if setView('proposal') is called somewhere.
  const _setView = window.setView;
  if(typeof _setView === 'function'){
    window.setView = function(view){
      const r = _setView.apply(this, arguments);
      if(view === 'proposal') showModal();
      return r;
    }
  }

  // ESC closes
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) hideModal();
  });

})();
</script>



<!-- ===== E-Sign Modal ===== -->
<div id="esignModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide">
    <div class="modalHead">
      <div>
        <div class="title">שליחה לחתימת לקוח</div>
        <div class="sub">בחר סוג מסמך, הוסף פרטים ושלח ללקוח לחתימה (דמו)</div>
      </div>
      <button class="btnGhost" id="esignClose">✕ סגור</button>
    </div>

    <div class="modalBody" style="gap:14px">
      <div class="mirrorGrid esignGrid">
        <div class="mirrorPanel">
          <h4>סוג מסמך</h4>
          <div class="help">בחר תבנית מוכנה (אפשר לערוך טקסט לפני שליחה).</div>

          <div class="esignOptions">
            <button class="btnGhost esignOptionBtn" data-doc="health">🩺 חתימה על הצהרת בריאות</button>
            <button class="btnGhost esignOptionBtn" data-doc="cancel">🧾 חתימה לבקשה לביטול פוליסה</button>
            <button class="btnGhost esignOptionBtn" data-doc="terms">✅ חתימה לאישור תנאים</button>
            <button class="btnGhost esignOptionBtn" data-doc="agent">🧑‍💼 חתימה למינוי סוכן בפוליסה</button>
          </div>

          <div class="help" style="margin-top:10px">
            טיפ: אחרי בחירה – ייטען טקסט התבנית בצד שמאל/הודעה, ותוכל להדביק קישור למסמך או PDF.
          </div>
        </div>

        <div class="mirrorPreview esignPreview">
          <h4 style="margin:0">פרטי שליחה</h4>

          <label class="field">
            <span class="cap">שם המסמך להצגה</span>
            <input id="esignDocName" type="text" placeholder="לדוגמה: הצהרת בריאות / אישור תנאים" style="width:100%">
          </label>

          <div class="esignFetch">
            <div class="cap">שליפת לקוח (ת.ז / שם / טלפון)</div>
            <div class="row esignFetchRow">
              <div class="seg" id="esignFindType">
                <button type="button" class="segBtn active" data-type="tz">ת.ז</button>
                <button type="button" class="segBtn" data-type="name">שם</button>
                <button type="button" class="segBtn" data-type="phone">טלפון</button>
              </div>
              <input id="esignFindQ" placeholder="הקלד לחיפוש…" autocomplete="off" />
              <button class="btnGold" id="esignFindBtn" type="button">שלוף</button>
            </div>
            <div class="hint" id="esignFindHint">ברגע שנמצא לקוח – נמלא אוטומטית את אימייל/טלפון ונציג “נבחר לקוח”.</div>
          </div>



          <label class="field">
            <span class="cap">אימייל הלקוח</span>
            <input id="esignEmail" type="email" placeholder="client@email.com" style="width:100%">
          </label>

          
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:-2px">
            <div class="badge" style="cursor:default">ערוץ שליחה:</div>
            <label class="esignChip" style="cursor:pointer">
              <input type="radio" name="esignChannel" value="email" checked style="margin-left:8px">
              אימייל ✉️
            </label>
            <label class="esignChip" style="cursor:pointer">
              <input type="radio" name="esignChannel" value="whatsapp" style="margin-left:8px">
              וואטסאפ 💬
            </label>
          </div>

          <label class="field" id="esignPhoneWrap" style="display:none">
            <span class="cap">טלפון וואטסאפ של הלקוח</span>
            <input id="esignPhone" type="tel" placeholder="05X-XXXXXXX" style="width:100%">
          </label>
<label class="field">
            <span class="cap">קישור למסמך / PDF לחתימה</span>
            <input id="esignLink" type="url" placeholder="https://...pdf או https://..." style="width:100%">
          </label>

          <label class="field" style="flex:1;min-height:0">
            <span class="cap">הודעה ללקוח (להדבקה/שליחה)</span>
            <textarea id="esignMsg" class="esignMsg" placeholder="טקסט שיקוף/הנחיה ללקוח…" ></textarea>
          </label>

          <div style="color:var(--muted);font-size:13px">
            בהמשך נוכל לחבר חתימה דיגיטלית אמיתית (DocuSign / PandaDoc / Google Drive / טופס חתימה).
          </div>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGhost" id="esignCancel">ביטול</button>
      <button class="btnGold" id="esignSend">שלח לחתימה</button>
    </div>
  </div>
</div>

<script>
/* ===== E-Sign Logic ===== */
(function(){
  const modal = document.getElementById('esignModal');
  if(!modal) return;

  const openBtn = document.getElementById('navESign') || document.querySelector('[data-view="esign"]');
  const closeBtn = document.getElementById('esignClose');
  const cancelBtn = document.getElementById('esignCancel');
  const sendBtn = document.getElementById('esignSend');

  const docName = document.getElementById('esignDocName');
  const emailEl = document.getElementById('esignEmail');
  const phoneEl = document.getElementById('esignPhone');
  const phoneWrap = document.getElementById('esignPhoneWrap');
  const linkEl  = document.getElementById('esignLink');
  const msgEl   = document.getElementById('esignMsg');
  const optionBtns = Array.from(document.querySelectorAll('.esignOptionBtn'));
  const channelRadios = Array.from(document.querySelectorAll('input[name="esignChannel"]'));

  // Client fetch (TZ/Name/Phone)
  const findTypeWrap = document.getElementById('esignFindType');
  const findQ = document.getElementById('esignFindQ');
  const findBtn = document.getElementById('esignFindBtn');
  const findHint = document.getElementById('esignFindHint');
  let esignFindType = 'tz';
  let esignPickedLeadId = null;

  const templates = {
    health: {
      name: "הצהרת בריאות",
      msg: (client="הלקוח") => `שלום ${client},\nמצורפת הצהרת בריאות לחתימה.\nאנא קרא/י ואשר/י שהפרטים נכונים.\nלאחר החתימה נחזור אליך להמשך תהליך.\nתודה!`
    },
    cancel: {
      name: "בקשה לביטול פוליסה",
      msg: (client="הלקוח") => `שלום ${client},\nמצורף מסמך לבקשה לביטול פוליסה לחתימה.\nלאחר החתימה נעדכן אותך בסטטוס ובאישור הביטול.\nתודה!`
    },
    terms: {
      name: "אישור תנאים",
      msg: (client="הלקוח") => `שלום ${client},\nמצורף מסמך אישור תנאים לחתימה.\nאנא אשר/י שקראת והבנת את התנאים.\nתודה!`
    },
    agent: {
      name: "מינוי סוכן בפוליסה",
      msg: (client="הלקוח") => `שלום ${client},\nמצורף מסמך מינוי סוכן בפוליסה לחתימה.\nלאחר החתימה נמשיך לעדכון מול החברה.\nתודה!`
    }
  };

  function norm(s){ return String(s||'').trim().toLowerCase(); }
  function digitsOnly(s){ return String(s||'').replace(/\D/g,''); }
  function findLead(q, type){
    const leads = (window.appState?.leads || []);
    const qq = norm(q);
    const qd = digitsOnly(q);
    if(!qq) return null;

    let best=null, bestScore=0;
    const score = (l)=>{
      if(type==='tz'){
        const v = digitsOnly(l.tz || l.idNumber || '');
        if(!qd) return 0;
        if(v===qd) return 100;
        if(v.endsWith(qd) || v.includes(qd)) return 70;
        return 0;
      }
      if(type==='phone'){
        const v = digitsOnly(l.phone || '');
        if(!qd) return 0;
        if(v===qd) return 100;
        if(v.endsWith(qd) || v.includes(qd)) return 70;
        return 0;
      }
      const v = norm(l.name || '');
      if(v===qq) return 100;
      if(v.startsWith(qq)) return 80;
      if(v.includes(qq)) return 60;
      return 0;
    };

    for(const l of leads){
      const s = score(l);
      if(s>bestScore){ bestScore=s; best=l; }
    }
    return bestScore>0 ? best : null;
  }


  function getChannel(){
    return (channelRadios.find(r=>r.checked)?.value) || "email";
  }

  
function getSelectedLead(){
    const leads = (window.appState?.leads || []);
    const sel = document.getElementById('leadSelect');
    const picked = esignPickedLeadId || window.__esignLeadId || '';
    const leadId = picked || (sel?.value || '');
    if(!leadId) return null;
    let lead = leads.find(l=> (l.id===leadId) || (l._id===leadId));
    if(!lead){
      const dig = String(leadId).replace(/\D/g,'');
      if(dig) lead = leads.find(l=> String(l.phone||'').replace(/\D/g,'') === dig);
    }
    return lead || null;
  }



  function setPickedLead(lead){
    if(!lead) return;
    esignPickedLeadId = lead.id || lead._id || null;
    window.__esignLeadId = esignPickedLeadId || null;
    try{
      if(findHint){
        findHint.innerHTML = 'נבחר לקוח: <span class="esignFetchSelected">✅ ' + (lead.name||'—') + ' • ' + (lead.phone||'') + '</span>';
      }
    }catch(e){}
    if(emailEl && lead.email && !emailEl.value) emailEl.value = lead.email;
    if(phoneEl && lead.phone && !phoneEl.value) phoneEl.value = lead.phone;
    if(docName && !docName.value) docName.value = 'מסמך לחתימה • ' + (lead.name||'');
  }

  function doFetchLead(){
    const q = findQ ? findQ.value : '';
    const lead = findLead(q, esignFindType);
    if(!lead){
      window.toast && window.toast('לא נמצא לקוח מתאים. נסה שוב.', 'warn');
      return;
    }
    setPickedLead(lead);
    window.toast && window.toast('נטען לקוח: ' + (lead.name||'—'), 'ok');
  }

  if(findTypeWrap){
    findTypeWrap.addEventListener('click', (e)=>{
      const b = e.target.closest('.segBtn');
      if(!b) return;
      [...findTypeWrap.querySelectorAll('.segBtn')].forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      esignFindType = b.dataset.type || 'tz';
      if(findQ){
        findQ.placeholder = esignFindType==='tz' ? 'הקלד ת.ז…' : (esignFindType==='phone' ? 'הקלד טלפון…' : 'הקלד שם מלא…');
        findQ.focus();
      }
    });
  }
  if(findBtn) findBtn.addEventListener('click', doFetchLead);
  if(findQ) findQ.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); doFetchLead(); } });
  function autofillFromLead(){
    const lead = getSelectedLead();
    if(!lead) return;
    if(emailEl && lead.email && !emailEl.value){
      emailEl.value = lead.email;
    }
    if(phoneEl && lead.phone && !phoneEl.value){
      phoneEl.value = lead.phone;
    }
  }

  function openModal(){
    modal.classList.add('show');
    syncChannelUI();
    try{
      const lead = getSelectedLead();
      if(lead) setPickedLead(lead);
    }catch(e){}
    autofillFromLead(); // <<< AUTO FILL HERE
  }

  function closeModal(){
    modal.classList.remove('show');
  }

  function syncChannelUI(){
    const ch = getChannel();
    if(phoneWrap){
      phoneWrap.style.display = (ch === "whatsapp") ? "" : "none";
    }
    if(ch === "whatsapp"){
      phoneEl?.focus();
    }else{
      emailEl?.focus();
    }
  }

  channelRadios.forEach(r=> r.addEventListener('change', syncChannelUI));

  // Open from sidebar button, without changing other nav behavior
  openBtn?.addEventListener('click', (e)=>{
    e.preventDefault?.();
    e.stopPropagation?.();
    openModal();
  });

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  function setActive(btn){
    optionBtns.forEach(b=>b.classList.toggle('active', b===btn));
  }

  function currentClientName(){
    const lead = getSelectedLead();
    return lead?.name || "הלקוח";
  }

  optionBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-doc');
      const t = templates[key];
      setActive(btn);
      if(t){
        if(docName && !docName.value.trim()) docName.value = t.name;
        const client = currentClientName();
        if(msgEl && (!msgEl.value.trim() || msgEl.value.includes("מצורף"))){
          msgEl.value = t.msg(client);
        }
      }
    });
  });

  function normalizeILPhone(p){
    const digits = (p||"").replace(/[^\d]/g, "");
    if(!digits) return "";
    if(digits.startsWith("0")) return "972" + digits.slice(1);
    if(digits.startsWith("972")) return digits;
    return digits;
  }

  function buildMessage(name, link, msg){
    const parts = [];
    if(name) parts.push(`מסמך לחתימה: ${name}`);
    if(msg) parts.push(msg);
    if(link) parts.push(`קישור לחתימה: ${link}`);
    return parts.join("\n\n").trim();
  }

  sendBtn?.addEventListener('click', ()=>{
    const ch = getChannel();

    const email = (emailEl?.value || "").trim();
    const phone = (phoneEl?.value || "").trim();
    const link  = (linkEl?.value || "").trim();
    const name  = (docName?.value || "").trim();
    const msg   = (msgEl?.value || "").trim();

    if(!link){
      alert("נא להוסיף קישור למסמך / PDF לחתימה");
      linkEl?.focus();
      return;
    }

    const fullMsg = buildMessage(name, link, msg);
    const subject = name ? `LEADUP • ${name} לחתימה` : "LEADUP • מסמך לחתימה";

    if(ch === "email"){
      if(!email){
        alert("נא להזין אימייל לקוח");
        emailEl?.focus();
        return;
      }
      const mailto = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(fullMsg)}`;
      window.open(mailto, "_blank", "noopener,noreferrer");
      closeModal();
      return;
    }

    const norm = normalizeILPhone(phone);
    if(!norm){
      alert("נא להזין טלפון וואטסאפ של הלקוח");
      phoneEl?.focus();
      return;
    }
    const wa = `https://wa.me/${encodeURIComponent(norm)}?text=${encodeURIComponent(fullMsg)}`;
    window.open(wa, "_blank", "noopener,noreferrer");
    closeModal();
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) closeModal();
  });
})();
</script>


<script>
/* ===== Views Patch (proposal + esign) ===== */
(function(){
  try{
    if(window.titles){
      if(!window.titles.proposal) window.titles.proposal = ["יצירת הצעה","בחירת חברה וטופס הצעה"];
      if(!window.titles.esign) window.titles.esign = ["שליחה לחתימת לקוח","שליחת מסמך לחתימה דיגיטלית"];
    }
  }catch(e){}
})();
</script>



<!-- ===== Mirror Client Modal (Real) ===== -->

<div id="mirrorModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide mirrorPro">
    <div class="modalHead mirrorProHead">
      <div class="mhLeft">
        <div class="title">🪞 שיקוף לנציג</div>
        <div class="sub">מסך הקראה מובנה • שלבים נעולים • תצוגת מסמך ללקוח</div>
      </div>
      <div class="mhRight">
        <div class="chip" id="mirrorClientChip" title="לקוח שנבחר">לקוח: <b id="mirrorClientName">—</b></div>
        <button class="btnGhost" id="mirrorClose" type="button">✕ יציאה</button>
      </div>
    </div>

    <div class="modalBody mirrorProBody">
      <div class="mirrorProGrid">

        <!-- Left: Agent workflow -->
        <aside class="mirrorProLeft">
          <div class="stepperCard">
            <div class="stepperTop">
              <div class="stepperTitle">תהליך שיקוף</div>
              <div class="stepperBar"><div class="fill" id="mwBarFill"></div></div>
            </div>
            <div class="stepperList" role="list">
              <button class="stepItem active" id="mwPill1" type="button">
                <span class="n">1</span>
                <span class="t">שליפת לקוח</span>
                <span class="s">ת.ז / שם / טלפון</span>
              </button>
              <button class="stepItem" id="mwPill2" type="button">
                <span class="n">2</span>
                <span class="t">בחירת חברת ביטוח</span>
                <span class="s">קישור PDF/דף</span>
              </button>
              <button class="stepItem" id="mwPill3" type="button">
                <span class="n">3</span>
                <span class="t">צ׳ק ליסט הקראה</span>
                <span class="s">נעילה לפי “בוצע”</span>
              </button>
            </div>
          </div>

          <div class="workCard">
            <!-- STEP 1 -->
            <div class="mwStep show" id="mwStep1">
              <div class="cardTitle">שלב 1 — שליפת לקוח</div>

              <div class="mirrorField">
                <label>חפש לקוח</label>
                <div class="mirrorSearchRow">
                  <div class="seg" id="mirrorFindType">
                    <button type="button" class="segBtn active" data-type="tz">ת.ז</button>
                    <button type="button" class="segBtn" data-type="name">שם</button>
                    <button type="button" class="segBtn" data-type="phone">טלפון</button>
                  </div>
                  <input id="mirrorFindQ" placeholder="הקלד וחפש…" autocomplete="off"/>
                  <button class="btnGold" id="mirrorFindBtn" type="button">שלוף</button>
                </div>
                <div class="hint">המערכת תטען את הלקוח למסך השיקוף ותפתח את שלב 2.</div>
              </div>

              <!-- hidden select for compatibility with existing logic -->
              <select id="mirrorLeadSelect" style="display:none">
                <option value="">—</option>
              </select>

              <div class="softHint">טיפ: אם יש כמה התאמות, כתוב יותר מדויק (למשל 3 ספרות אחרונות בטלפון).</div>
            </div>

            <!-- STEP 2 -->
            <div class="mwStep" id="mwStep2">
              <div class="cardTitle">שלב 2 — בחירת חברת ביטוח</div>

              <div class="mirrorField">
                <label>בחירת חברת ביטוח (מסמך)</label>
                <select id="mirrorCompanySelect">
                  <option value="">— בחר חברה / מסמך —</option>
                  <option value="כיסויים מנורה - יוני 2024">כיסויים מנורה - יוני 2024</option>
                  <option value="כיסויים מגדל - יוני 2024">כיסויים מגדל - יוני 2024</option>
                  <option value="כיסויים הראל - יוני 2024">כיסויים הראל - יוני 2024</option>
                  <option value="כיסויים חברת איילון - אוקטובר 2023">כיסויים חברת איילון - אוקטובר 2023</option>
                  <option value="כיסויים הפניקס - יוני 2024">כיסויים הפניקס - יוני 2024</option>
                </select>
                <div class="softHint">ברגע שבוחרים — המסמך נטען בצד ימין אוטומטית (אם הוגדר קישור או הועלה PDF).</div>
              </div>

              <div class="mirrorField">
                <label>העלאת קבצי PDF (פעם אחת) — נשמר מקומית בדפדפן</label>
                <input id="mirrorPdfUpload" type="file" accept="application/pdf" multiple />
                <div class="softHint">הקבצים נשמרים מקומית (LocalStorage). אם PDF גדול מדי — מומלץ להעלות לריפו (GitHub) ולשים URL במקום.</div>
              </div>

              <div class="mirrorField">
                <label>שם מסמך להצגה (אוטומטי / ניתן לעריכה)</label>
                <input id="mirrorOfferName" placeholder="לדוגמה: כיסויים מנורה - יוני 2024"/>
              </div>

              <div class="mirrorField">
                <input id="mirrorPdfUrl" placeholder="https://...pdf או https://..."/>
                <div class="softHint">אם העלית PDF — השדה יתמלא לבד. אפשר גם לשים כאן URL של PDF מהריפו.</div>
              </div>
<div class="rowBtns">
                <button class="btnGold" id="mirrorApply" type="button">הצג מסמך</button>
                <button class="btnGhost" id="mirrorCopyLink" type="button">העתק קישור</button>
                <button class="btnGhost" id="mirrorOpenLink" type="button">פתח קישור</button>
              </div>

              <div class="mirrorNotice">
                אם PDF חוסם טעינה בתוך חלון (iframe) — עדיין אפשר לפתוח אותו בטאב חדש.
                <a class="btnGold" id="mirrorOpenExternal" href="#" target="_blank" rel="noopener" style="display:none;text-decoration:none;margin-top:10px;align-self:flex-start">פתח מסמך בטאב</a>
              </div>
            </div>

            <!-- STEP 3 -->
            <div class="mwStep" id="mwStep3">
              <div class="cardTitle">שלב 3 — צ׳ק ליסט הקראה לנציג</div>

              <div class="checkTop">
                <div>
                  <div class="miniTitle">התקדמות</div>
                  <div class="hint">אחוזים לפי “בוצע” (נשמר לפי הלקוח)</div>
                </div>
                <div class="mirrorProgress">
                  <div class="bar"><div class="fill" id="mirrorProgFill" style="width:0%"></div></div>
                  <div class="pct" id="mirrorProgPct">0%</div>
                </div>
              </div>

              <div class="mirrorStepCard">
                <div class="mirrorStepHead">
                  <div class="num" id="mirrorStepNum">1</div>
                  <div class="ttl" id="mirrorStepTitle">—</div>
                  <label class="chk"><input type="checkbox" id="mirrorStepDone"/> בוצע</label>
                </div>

                <textarea id="mirrorStepScript" class="mirrorScript" rows="7" spellcheck="false"></textarea>

                <div class="mirrorStepNav">
                  <button class="btnGhost" id="mirrorPrevStep" type="button">◀ הקודם</button>
                  <button class="btnGhost" id="mirrorNextStep" type="button">הבא ▶</button>
                </div>
              </div>

              <div class="rowBtns">
                <button class="btnGhost" id="mirrorFull" type="button">מסך מלא</button>
                <button class="btnGold" id="mirrorScriptOpen" type="button">🗣️ טקסט הקראה</button>
              </div>
            </div>

            <div class="navBar">
              <button class="btnGhost" id="mwBack" type="button">◀ הקודם</button>
              <button class="btnGhost" id="mwReadMode" type="button">🗣️ מצב הקראה</button>
              <button class="btnGold" id="mwNext" type="button">הבא ▶</button>
            </div>
          </div>
        </aside>

        <!-- Right: Preview -->
        <section class="mirrorProRight">
          <div class="previewCard">
            <div class="previewHead">
              <div>
                <div class="ttl" id="mirrorPrevTitle">מסמך</div>
                <div class="meta" id="mirrorPrevMeta">בחר לקוח + מסמך</div>
              </div>
              <div class="rightBtns">
                <button class="btnGhost" id="mirrorDone" type="button">סיום ✔</button>
                <button class="btnGhost" id="mirrorClear" type="button">נקה</button>
              </div>
            </div>

            <div class="previewSplit">
              <div class="clientCard">
                <div class="miniTitle">פרטי לקוח</div>
                <div class="mirrorCard">
                  <div class="mirrorKV" id="mirrorKV"></div>
                </div>
              </div>

              <div class="docCard">
                <div class="miniTitle">תצוגת מסמך</div>
                <div class="frameWrap">
                  <iframe id="mirrorFrame" title="מסמך" src="about:blank"></iframe>
                </div>
              </div>
            </div>

          </div>
        </section>

      </div>
    </div>
  </div>
</div>


    <div class="modalFoot">
      <button class="btnGhost" id="mirrorClear">נקה</button>
      <button class="btnGold" id="mirrorDone">סגור</button>
    </div>
  </div>

<!-- ===== Mirror Talk Script Modal ===== -->
<div id="mirrorScriptModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide">
    <div class="modalHead">
      <div>
        <div class="title">שיקוף השיחה</div>
        <div class="sub">מסך עבודה לנציג — טקסט להקראה/שיקוף ללקוח</div>
      </div>
      <button class="btnGhost" id="mirrorScriptClose">✕ סגור</button>
    </div>

    <div class="modalBody" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;">
      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="badge" id="mirrorScriptLeadBadge">לקוח: —</div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btnGhost" id="mirrorScriptCopy">📋 העתק טקסט</button>
          <button class="btnGhost" id="mirrorScriptClear">🧹 נקה</button>
          <button class="btnGhost" id="mirrorScriptFull">⛶ מסך מלא</button>
        </div>
      </div>

      <textarea id="mirrorScriptText" class="mirrorScriptArea"
        placeholder="כאן הנציג יכתוב את שיקוף העסקה/הרכישה, ויקריא ללקוח..."></textarea>

      <div class="help" style="margin-top:2px">
        נשמר אוטומטית לפי הלקוח שנבחר (Local). אפשר להעתיק ולהדביק מחדש בכל שיחה.
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGold" id="mirrorScriptDone">סגור</button>
    </div>
  </div>
</div>

</div>

<!-- ===== Mirror Standalone (Link View) ===== -->
<div id="mirrorStandalone" class="mirrorStandalone">
  <div class="mirrorStandaloneInner">
    <div class="mirrorStandaloneTop">
      <div class="row">
        <div>
          <div class="title" id="mirrorS_Title">שיקוף ללקוח</div>
          <div class="sub" id="mirrorS_Sub">תצוגת לקוח</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btnGhost" id="mirrorS_Full">מסך מלא</button>
          <a class="btnGold" id="mirrorS_Open" href="#" target="_blank" rel="noopener" style="text-decoration:none;display:none">פתח מסמך</a>
        </div>
      </div>
    </div>
    <div class="mirrorStandaloneMain">
      <div class="wrap" style="height:100%">
        <div class="mirrorGrid" style="height:100%">
          <div class="mirrorPanel">
            <h4>פרטי לקוח</h4>
            <div class="mirrorCard">
              <div class="mirrorKV" id="mirrorS_KV"></div>
            </div>
          </div>
          <div class="mirrorPreview" style="height:100%">
            <div class="mirrorPreviewHead">
              <div>
                <div class="ttl" id="mirrorS_DocTitle">מסמך</div>
                <div class="meta" id="mirrorS_DocMeta">—</div>
              </div>
            </div>
            <div class="mirrorPreviewBody">
              <iframe id="mirrorS_Frame" title="מסמך" src="about:blank"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
/* ===== Mirror Client (Real) Logic ===== */
(function(){
  const modal = document.getElementById('mirrorModal');
  const openBtn = document.querySelector('[data-view="mirror"]');
  const closeBtn = document.getElementById('mirrorClose');
  const doneBtn  = document.getElementById('mirrorDone');
  const clearBtn = document.getElementById('mirrorClear');

  const sel = document.getElementById('mirrorLeadSelect');
  const offerName = document.getElementById('mirrorOfferName');
  const pdfUrl = document.getElementById('mirrorPdfUrl');

  const companySel = document.getElementById('mirrorCompanySelect');
  const pdfUpload  = document.getElementById('mirrorPdfUpload');

  // PDF library (stored locally in the browser)
  const PDF_LIB_KEY = "leadup_pdf_library_v1";
  function loadPdfLib(){
    try{ return JSON.parse(localStorage.getItem(PDF_LIB_KEY) || "{}") || {}; }
    catch(e){ return {}; }
  }
  function savePdfLib(lib){
    try{ localStorage.setItem(PDF_LIB_KEY, JSON.stringify(lib)); }catch(e){}
  }
  let pdfLib = loadPdfLib();

  function normalizeName(s){
    return (s||"").toString().trim()
      .replace(/\.(pdf)$/i,"")
      .replace(/[\s_]+/g," ")
      .replace(/[–—]/g,"-")
      .trim();
  }
  function matchOptionKey(baseName){
    const base = normalizeName(baseName);
    if(!companySel) return "";
    const opts = Array.from(companySel.options).map(o=>o.value).filter(Boolean);
    // try contains match in both directions
    for(const v of opts){
      const nv = normalizeName(v);
      if(!nv) continue;
      if(base.includes(nv) || nv.includes(base)) return v;
    }
    return "";
  }
  function setLibEntry(key, dataUrl){
    if(!key) return;
    pdfLib[key] = dataUrl;
    savePdfLib(pdfLib);
  }
  function getLibEntry(key){
    return (key && pdfLib && pdfLib[key]) ? pdfLib[key] : "";
  }


  const kv = document.getElementById('mirrorKV');
  const frame = document.getElementById('mirrorFrame');
  const prevTitle = document.getElementById('mirrorPrevTitle');
  const prevMeta = document.getElementById('mirrorPrevMeta');
  const openExternal = document.getElementById('mirrorOpenExternal');

  const btnApply = document.getElementById('mirrorApply');
  const btnCopy  = document.getElementById('mirrorCopyLink');
  const btnOpen  = document.getElementById('mirrorOpenLink');
  const btnFull  = document.getElementById('mirrorFull');

  function show(){ document.body.classList.add("mirrorFS");  modal.classList.add('show'); refreshLeadSelect();  mwSet(1); }
  function hide(){ document.body.classList.remove("mirrorFS");  modal.classList.remove('show');  modal.classList.remove("readingMode"); }

  /* --- Agent Mirror Wizard (1/2/3) + Reading Mode --- */
  let mwStep = 1;
  const mwP1 = document.getElementById("mwPill1");
  const mwP2 = document.getElementById("mwPill2");
  const mwP3 = document.getElementById("mwPill3");
  const mwS1 = document.getElementById("mwStep1");
  const mwS2 = document.getElementById("mwStep2");
  const mwS3 = document.getElementById("mwStep3");
  const mwBack = document.getElementById("mwBack");
  const mwNext = document.getElementById("mwNext");
  const mwFill = document.getElementById("mwBarFill");
  const mwRead = document.getElementById("mwReadMode");

  function mwValid(step){
    if(step === 1){
      return !!(currentLeadObj && (currentLeadObj.id || currentLeadObj.phone || currentLeadObj.name));
    }
    if(step === 2){
      const url = (pdfUrl?.value || "").trim();
      return url.length > 6;
    }
    return true;
  }

  function mwSet(n){
    mwStep = Math.max(1, Math.min(3, n));
    mwS1?.classList.toggle("show", mwStep === 1);
    mwS2?.classList.toggle("show", mwStep === 2);
    mwS3?.classList.toggle("show", mwStep === 3);

    mwP1?.classList.toggle("active", mwStep === 1);
    mwP2?.classList.toggle("active", mwStep === 2);
    mwP3?.classList.toggle("active", mwStep === 3);

    mwP1?.classList.toggle("done", mwStep > 1);
    mwP2?.classList.toggle("done", mwStep > 2);

    if(mwFill) mwFill.style.width = ((mwStep-1)/2*100) + "%";

    if(mwBack) mwBack.disabled = mwStep === 1;
    if(mwNext){
      mwNext.textContent = (mwStep === 3) ? "סיום ✔" : "הבא ▶";
      mwNext.disabled = !mwValid(mwStep);
    }
  }

  function mwToast(msg){
    // reuse global toast if exists, else alert
    if(window.toast){ window.toast(msg); }
    else { alert(msg); }
  }

  if(mwBack) mwBack.addEventListener("click", ()=> mwSet(mwStep-1));
  if(mwNext) mwNext.addEventListener("click", ()=>{
    if(!mwValid(mwStep)){
      mwToast(mwStep===1 ? "צריך קודם לשלוף/לבחור לקוח." : "צריך לבחור מסמך (להדביק קישור PDF/מסמך).");
      return;
    }
    if(mwStep < 3) mwSet(mwStep+1);
    else hide();
  });

  if(mwRead) mwRead.addEventListener("click", ()=>{
    modal.classList.toggle("readingMode");
    mwRead.textContent = modal.classList.contains("readingMode") ? "🔎 מצב רגיל" : "🗣️ מצב הקראה";
  });

  // re-validate step 2 when URL changes
  if(pdfUrl){
    pdfUrl.addEventListener("input", ()=>{ if(mwStep===2 && mwNext) mwNext.disabled = !mwValid(2); });
  }



  function esc(v){ return (window.escapeHTML ? window.escapeHTML(v||'') : (v||'')); }

  function refreshLeadSelect(){
    if(
  // company/document selection -> auto fill + auto preview
  if(companySel){
    companySel.addEventListener("change", ()=>{
      const key = companySel.value;
      if(key){
        if(offerName) offerName.value = key;
        const fromLib = getLibEntry(key);
        if(fromLib){
          pdfUrl.value = fromLib;
        }else{
          // keep existing URL if user already pasted one, otherwise empty
          if(!pdfUrl.value.trim()) pdfUrl.value = "";
        }
      }
      applyPreview();
      if(mwStep===2 && mwNext) mwNext.disabled = !mwValid(2);
    });
  }

  // upload PDFs and bind them to the selected option (or auto-match by filename)
  if(pdfUpload){
    pdfUpload.addEventListener("change", ()=>{
      const files = Array.from(pdfUpload.files || []);
      if(!files.length) return;

      files.forEach(file=>{
        const maxBytes = 4 * 1024 * 1024; // localStorage-friendly limit
        if(file.size > maxBytes){
          mwToast(`הקובץ "${file.name}" גדול מדי לשמירה מקומית. מומלץ להעלות לריפו ולהדביק URL במקום.`);
          return;
        }
        const reader = new FileReader();
        reader.onload = ()=>{
          const base = normalizeName(file.name);
          const matched = matchOptionKey(base);
          const key = matched || companySel?.value || base;
          setLibEntry(key, reader.result);
          mwToast(`ה‑PDF נשמר: ${key} ✅`);
          // if user is currently viewing that key – refresh preview
          if(companySel && (companySel.value === key || (!companySel.value && matched))){
            if(!companySel.value && matched) companySel.value = matched;
            if(offerName) offerName.value = companySel.value || key;
            if(pdfUrl) pdfUrl.value = reader.result;
            applyPreview();
            if(mwStep===2 && mwNext) mwNext.disabled = !mwValid(2);
          }
        };
        reader.onerror = ()=> mwToast(`לא הצלחתי לקרוא את "${file.name}". נסה שוב.`);
        reader.readAsDataURL(file);
      });

      // allow re-upload same file again
      pdfUpload.value = "";
    });
  }
!window.appState || !Array.isArray(window.appState.leads)) return;
    const leads = window.appState.leads.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    const current = sel.value;
    sel.innerHTML = '<option value="">— לחץ לבחירה —</option>' + leads.map(l=>{
      const label = `${l.name||'—'} • ${l.phone||''}`.trim();
      return `<option value="${esc(l.id)}">${esc(label)}</option>`;
    }).join('');
    if(current) sel.value = current;
  }


  /* --- Mirror Find Lead (TZ/Name/Phone) --- */
  let mirrorFindType = "tz";
  const findTypeWrap = document.getElementById("mirrorFindType");
  const findQ = document.getElementById("mirrorFindQ");
  const findBtn = document.getElementById("mirrorFindBtn");

  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function digits(s){ return String(s||"").replace(/\D/g,""); }

  function getLeadByQuery(q, type){
    // Prefer in-memory state, but if for some reason it isn't available yet (e.g. module order),
    // fall back to localStorage.
    let state = (window.appState && Array.isArray(window.appState.leads)) ? window.appState : null;
    if(!state){
      try{
        const raw = localStorage.getItem("leadup_v1");
        const parsed = raw ? JSON.parse(raw) : null;
        if(parsed && Array.isArray(parsed.leads)) state = parsed;
      }catch(e){}
    }
    if(!state || !Array.isArray(state.leads)) return null;
    const leads = state.leads;
    const qq = norm(q);
    const qd = digits(q);

    if(!qq) return null;

    // Try exact-first, then contains
    const score = (l)=>{
      if(type==="tz"){
  const v = digits(l.tz || l.idNumber || l.tzNumber || l.idnum || l.idNum || "");
  if(!qd) return 0;
  if(v === qd) return 100;
  if(v.endsWith(qd) || v.includes(qd)) return 70;
  return 0;
}
      if(type==="phone"){
  // Normalize Israeli numbers: allow matching 05X... against +9725X... and vice versa
  const vRaw = digits(l.phone || l.phoneNumber || l.mobile || l.tel || "");
  if(!qd) return 0;

  const variants = new Set([qd]);

  if(qd.startsWith("0") && qd.length >= 9){
    variants.add(qd.slice(1));
    variants.add("972"+qd.slice(1));
  }
  if(qd.startsWith("972") && qd.length >= 11){
    variants.add("0"+qd.slice(3));
  }

  const vVariants = new Set([vRaw]);
  if(vRaw.startsWith("972") && vRaw.length >= 11){
    vVariants.add("0"+vRaw.slice(3));
  }
  if(vRaw.startsWith("0") && vRaw.length >= 9){
    vVariants.add("972"+vRaw.slice(1));
    vVariants.add(vRaw.slice(1));
  }

  for(const vv of vVariants){
    for(const qq of variants){
      if(vv === qq) return 100;
    }
  }
  for(const vv of vVariants){
    for(const qq of variants){
      if(vv.endsWith(qq) || vv.includes(qq)) return 70;
    }
  }
  return 0;
}
      // name
      const v = norm(l.name || "");
      if(v === qq) return 100;
      if(v.startsWith(qq)) return 80;
      if(v.includes(qq)) return 60;
      return 0;
    };

    let best=null, bestScore=0;
    for(const l of leads){
      const s = score(l);
      if(s>bestScore){ bestScore=s; best=l; }
    }
    return (bestScore>0) ? best : null;
  }

  function applyLeadSelection(lead){
    if(!lead) return;
    // set select value if exists
    if(sel){
      sel.value = lead.id || lead._id || sel.value;
      // if we didn't find by id, try to match by name/phone in options
      if(!sel.value){
        const opt = [...sel.options].find(o => (o.textContent||"").includes(lead.phone||"") && (o.textContent||"").includes(lead.name||""));
        if(opt) sel.value = opt.value;
      }
    }
    setKV(lead);
    // auto-fill defaults if empty
    if(offerName && !offerName.value) offerName.value = `הצעה ללקוח: ${lead.name||""}`.trim();
    // load checklist for lead
    loadChecklistForLead(lead);
  }

  if(findTypeWrap){
    findTypeWrap.addEventListener("click", (e)=>{
      const b = e.target.closest(".segBtn");
      if(!b) return;
      [...findTypeWrap.querySelectorAll(".segBtn")].forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      mirrorFindType = b.dataset.type || "tz";
      if(findQ){
        findQ.placeholder = mirrorFindType==="tz" ? "הקלד ת.ז…" : (mirrorFindType==="phone" ? "הקלד טלפון…" : "הקלד שם…");
        findQ.focus();
      }
    });
  }

  function doFind(){
    const q = findQ ? findQ.value : "";
    const lead = getLeadByQuery(q, mirrorFindType);
    if(!lead){
      toast && toast("לא נמצא לקוח מתאים. נסה שוב.", "warn");
      return;
    }
    applyLeadSelection(lead);
    toast && toast(`נטען לקוח: ${lead.name||"—"}`, "ok");
  }

  if(findBtn) findBtn.addEventListener("click", doFind);
  if(findQ) findQ.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); doFind(); } });

  /* --- Mirror Checklist (rep script) --- */
  const STEPS = [
    {key:"open",   title:"פתיחה והזדהות", script:(l)=>`שלום ${l?.name||""}, מדבר/ת __ מהסוכנות.\nאני רוצה לעשות שיקוף קצר כדי לוודא שהבנתי נכון את הפרטים לפני שממשיכים.\nזה בסדר?`},
    {key:"verify", title:"אימות פרטים", script:(l)=>`רק אימות קצר:\n• שם: ${l?.name||"—"}\n• טלפון: ${l?.phone||"—"}\n• ת.ז: ${l?.tz||l?.idNumber||"—"}\nיש עוד פרט שתרצה/י לעדכן?`},
    {key:"needs",  title:"צרכים ודגשים", script:()=>`מה הכי חשוב לך בכיסוי/בפוליסה?\nיש משהו שחשוב להחריג או להדגיש?`},
    {key:"offer",  title:"הצגת ההצעה", script:()=>`אני מציג/ה עכשיו את ההצעה.\nאעבור איתך על הסעיפים המרכזיים ומה כלול ומה לא כלול.`},
    {key:"price",  title:"מחיר ותשלום", script:()=>`המחיר הוא __ לחודש/לשנה.\nאמצעי תשלום: __\nיש דמי טיפול/השתתפות עצמית/חריגים שכדאי לדעת: __`},
    {key:"confirm",title:"אישור והמשך תהליך", script:()=>`רק לוודא—הכל ברור ומאושר להמשיך?\nהשלב הבא: חתימה/שליחת מסמכים.\nאני שולח/ת לך עכשיו קישור/מסמך.`},
    {key:"close",  title:"סיכום", script:()=>`סיכום קצר: __\nאם עולה שאלה—אפשר לפנות אליי בוואטסאפ/טלפון.\nתודה רבה ושיהיה יום מצוין!`}
  ];

  const ckWrap = document.getElementById("mirrorChecklist");
  const stepNumEl = document.getElementById("mirrorStepNum");
  const stepTitleEl = document.getElementById("mirrorStepTitle");
  const stepScriptEl = document.getElementById("mirrorStepScript");
  const stepDoneEl = document.getElementById("mirrorStepDone");
  const prevStepBtn = document.getElementById("mirrorPrevStep");
  const nextStepBtn = document.getElementById("mirrorNextStep");
  const progFill = document.getElementById("mirrorProgFill");
  const progPct  = document.getElementById("mirrorProgPct");

  let currentLeadId = null;
  let currentLeadObj = null;
  let currentStep = 0;
  let checklistState = {done:{}, scripts:{}};

  function ckKey(){
    return currentLeadId ? ("mirror_checklist_" + currentLeadId) : "mirror_checklist__none";
  }

  function saveChecklist(){
    try{
      localStorage.setItem(ckKey(), JSON.stringify({step:currentStep, state:checklistState}));
    }catch(e){}
  }

  function loadChecklistForLead(lead){
    currentLeadObj = lead || null;
    currentLeadId = lead?.id || lead?._id || lead?.phone || "lead";
    checklistState = {done:{}, scripts:{}};
    currentStep = 0;

    try{
      const raw = localStorage.getItem(ckKey());
      if(raw){
        const obj = JSON.parse(raw);
        if(obj && obj.state) checklistState = obj.state;
        if(typeof obj.step === "number") currentStep = Math.max(0, Math.min(STEPS.length-1, obj.step));
      }
    }catch(e){}

    // if no script stored for a step, set default template
    STEPS.forEach((s,i)=>{
      if(typeof checklistState.scripts[s.key] !== "string"){
        checklistState.scripts[s.key] = (s.script(currentLeadObj) || "").trim();
      }
      if(typeof checklistState.done[s.key] !== "boolean") checklistState.done[s.key] = false;
    });

    renderStep();
    renderProgress();
    saveChecklist();
  }

  function renderProgress(){
    const total = STEPS.length;
    const doneCount = STEPS.filter(s => checklistState.done[s.key]).length;
    const pct = total ? Math.round((doneCount/total)*100) : 0;
    if(progFill) progFill.style.width = pct + "%";
    if(progPct) progPct.textContent = pct + "%";
  }

  function renderStep(){
    const s = STEPS[currentStep];
    if(!s) return;
    if(stepNumEl) stepNumEl.textContent = String(currentStep+1);
    if(stepTitleEl) stepTitleEl.textContent = s.title;
    if(stepDoneEl) stepDoneEl.checked = !!checklistState.done[s.key];
    if(stepScriptEl) stepScriptEl.value = checklistState.scripts[s.key] || "";
    if(prevStepBtn) prevStepBtn.disabled = currentStep===0;
    if(nextStepBtn) nextStepBtn.disabled = currentStep===STEPS.length-1;
  }

  if(stepDoneEl){
    stepDoneEl.addEventListener("change", ()=>{
      const s = STEPS[currentStep];
      checklistState.done[s.key] = !!stepDoneEl.checked;
      renderProgress();
      saveChecklist();
    });
  }

  if(stepScriptEl){
    stepScriptEl.addEventListener("input", ()=>{
      const s = STEPS[currentStep];
      checklistState.scripts[s.key] = stepScriptEl.value;
      saveChecklist();
    });
  }

  if(prevStepBtn) prevStepBtn.addEventListener("click", ()=>{ if(currentStep>0){ currentStep--; renderStep(); saveChecklist(); }});
  if(nextStepBtn) nextStepBtn.addEventListener("click", ()=>{ const s = STEPS[currentStep]; if(!checklistState.done[s.key]){ if(window.toast){window.toast('צריך לסמן "בוצע" לפני מעבר לשלב הבא.');} else {alert('צריך לסמן "בוצע" לפני מעבר לשלב הבא.');} return; } if(currentStep<STEPS.length-1){ currentStep++; renderStep(); saveChecklist(); }});



  
function setKV(lead){
    const l = lead || {};
    const map = [
      ["שם מלא", l.name],
      ['ת.ז', l.tz || l.idNumber],
      ["טלפון", l.phone],
      ["טלפון נוסף", l.phone2 || l.altPhone],
      ["אימייל", l.email],
      ["סטטוס", l.status],
      ["מקור", l.source],
      ["בעלים", l.owner],
      ["תאריך יצירה", l.createdAt],
      ["קשר אחרון", l.lastContactAt],
      ["מעקב הבא", l.nextFollowUpAt || l.nextAt],
      ["סוג ביטוח", l.insuranceType || l.policyType],
      ["חברה", l.company || l.carrier],
      ["מספר פוליסה", l.policyNumber],
      ["תאריך לידה", l.birthDate],
      ["עיר", l.city],
      ["כתובת", l.address],
      ["הערה", l.note || l.notes],
    ];

    // Add any extra fields that exist but are not in the mapping (best-effort)
    const knownKeys = new Set(["name","tz","idNumber","phone","phone2","altPhone","email","status","source","owner","createdAt","lastContactAt","nextFollowUpAt","nextAt","insuranceType","policyType","company","carrier","policyNumber","birthDate","city","address","note","notes","id","_id","contactCount","score","heat"]);
    const extras = [];
    for(const [k,v] of Object.entries(l)){
      if(knownKeys.has(k)) continue;
      if(v === null || v === undefined || v === "") continue;
      if(typeof v === "object") continue; // keep it readable
      const label = (k || "").replace(/_/g," ").trim();
      extras.push([label, v]);
    }

    const items = map
      .filter(([k,v])=> v !== undefined && v !== null && String(v).trim() !== "")
      .concat(extras.slice(0, 12)); // avoid endless list

    if(!items.length){
      kv.innerHTML = '<div class="kvItem"><div class="kvLbl">פרטים</div><div class="kvVal">—</div></div>';
    }else{
      kv.innerHTML = items.map(([k,v])=>{
        return `<div class="kvItem"><div class="kvLbl">${esc(k)}</div><div class="kvVal">${esc(v)}</div></div>`;
      }).join('');
    }

    try{
      const nm = document.getElementById("mirrorClientName");
      if(nm) nm.textContent = (l.name || "—");
    }catch(e){}
  }

  try{ const nm = document.getElementById("mirrorClientName"); if(nm) nm.textContent = (lead?.name || "—"); }catch(e){}


  function applyPreview(){
    const leadId = sel.value;
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId);
    setKV(lead);

    const name = offerName.value.trim() || 'מסמך';
    const url  = pdfUrl.value.trim();

    prevTitle.textContent = name || 'מסמך';
    prevMeta.textContent = lead?.name ? ('לקוח: ' + (lead.name||'')) : 'בחר ליד להצגה';

    if(url){
      frame.src = url;
      openExternal.href = url;
      openExternal.style.display = 'inline';
    }else{
      frame.src = 'about:blank';
      openExternal.href = '#';
      openExternal.style.display = 'none';
    }
  }

  function encodePayload(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodePayload(str){
    const json = decodeURIComponent(escape(atob(str)));
    return JSON.parse(json);
  }

  function buildMirrorLink(){
    const leadId = sel.value;
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId) || null;

    const payload = {
      v: 1,
      lead: lead ? {
        name: lead.name||'',
        phone: lead.phone||'',
        email: lead.email||'',
        status: lead.status||'',
        source: lead.source||'',
        owner: lead.owner||''
      } : null,
      offerName: offerName.value.trim() || '',
      pdfUrl: pdfUrl.value.trim() || ''
    };

    const data = encodePayload(payload);
    const base = location.origin + location.pathname;
    return base + '?mirror=1&data=' + encodeURIComponent(data);
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      if(window.toast) toast('הועתק ✅');
      else alert('הועתק ✅');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      if(window.toast) toast('הועתק ✅');
      else alert('הועתק ✅');
    }
  }

  function requestFull(el){
    const target = el || document.documentElement;
    const rfs = target.requestFullscreen || target.webkitRequestFullscreen || target.msRequestFullscreen;
    if(rfs) rfs.call(target);
  }

  // Wire events
  openBtn?.addEventListener('click', ()=>{ show(); setTimeout(()=> sel.focus(), 0); });
  closeBtn?.addEventListener('click', hide);
  doneBtn?.addEventListener('click', hide);
  clearBtn?.addEventListener('click', ()=>{
    sel.value = '';
    offerName.value = '';
    pdfUrl.value = '';
    setKV(null);
    prevTitle.textContent = 'לא נבחר מסמך';
    prevMeta.textContent = 'בחר ליד ומסמך';
    frame.src = 'about:blank';
    openExternal.style.display = 'none';
  });

  modal?.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal?.classList.contains('show')) hide(); });

  sel?.addEventListener('change', ()=> applyPreview());
  btnApply?.addEventListener('click', ()=> applyPreview());
  btnCopy?.addEventListener('click', ()=> copyText(buildMirrorLink()));
  btnOpen?.addEventListener('click', ()=> window.open(buildMirrorLink(), '_blank', 'noopener'));
  btnFull?.addEventListener('click', ()=> requestFull(document.querySelector('#mirrorModal .modalCard')));

  // Hook into setView if exists
  const _setView = window.setView;
  if(typeof _setView === 'function'){
    window.setView = function(view){
      const r = _setView.apply(this, arguments);
      if(view === 'mirror') show();
      return r;
    }
  }

  // ===== Standalone Mode (link view) =====
  const params = new URLSearchParams(location.search);
  const isMirror = params.get('mirror') === '1';
  const dataParam = params.get('data');

  const standalone = document.getElementById('mirrorStandalone');
  if(isMirror && dataParam && standalone){
    let payload = null;
    try{ payload = decodePayload(decodeURIComponent(dataParam)); }catch(e){ payload = null; }

    // hide app shell for clean view
    try{
      document.querySelector('.app')?.setAttribute('style','display:none');
      document.body.style.background = '#fff7e6';
    }catch(e){}

    standalone.classList.add('show');

    const kvEl = document.getElementById('mirrorS_KV');
    const docTitle = document.getElementById('mirrorS_DocTitle');
    const docMeta = document.getElementById('mirrorS_DocMeta');
    const sFrame = document.getElementById('mirrorS_Frame');
    const sOpen = document.getElementById('mirrorS_Open');
    const sFull = document.getElementById('mirrorS_Full');

    const lead = payload?.lead || null;
    const pairs = [
      ['שם', lead?.name || '—'],
      ['ת.ז', lead?.tz || lead?.idNumber || '—'],
      ['טלפון', lead?.phone || '—'],
      ['אימייל', lead?.email || '—'],
      ['סטטוס', lead?.status || '—'],
      ['מקור', lead?.source || '—'],
      ['בעלים', lead?.owner || '—'],
    ];
    kvEl.innerHTML = pairs.map(([k,v])=> `<div>${esc(k)}</div><div>${esc(v)}</div>`).join('');

    docTitle.textContent = payload?.offerName || 'מסמך';
    docMeta.textContent = lead?.name ? ('לקוח: ' + lead.name) : '—';

    const url = payload?.pdfUrl || '';
    if(url){
      sFrame.src = url;
      sOpen.href = url;
      sOpen.style.display = 'inline-flex';
    }else{
      sFrame.src = 'about:blank';
      sOpen.style.display = 'none';
    }

    sFull?.addEventListener('click', ()=> requestFull(standalone));
  }

})();
</script>


<script>
/* ===== Mirror Talk Script Logic ===== */
(function(){
  const modal = document.getElementById('mirrorScriptModal');
  if(!modal) return;

  const openBtn = document.getElementById('mirrorScriptOpen');
  const closeBtn = document.getElementById('mirrorScriptClose');
  const doneBtn = document.getElementById('mirrorScriptDone');

  const badge = document.getElementById('mirrorScriptLeadBadge');
  const ta = document.getElementById('mirrorScriptText');

  const btnCopy = document.getElementById('mirrorScriptCopy');
  const btnClear = document.getElementById('mirrorScriptClear');
  const btnFull = document.getElementById('mirrorScriptFull');

  const mirrorLeadSelect = document.getElementById('mirrorLeadSelect');

  function getLead(){
    const leadId = mirrorLeadSelect?.value || "";
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId) || null;
    return { leadId, lead };
  }

  function keyForLead(leadId){
    return "LEADUP_MIRROR_SCRIPT_" + (leadId || "DEFAULT");
  }

  function show(){
    const { leadId, lead } = getLead();
    badge.textContent = "לקוח: " + (lead?.name || "—");
    try{ ta.value = localStorage.getItem(keyForLead(leadId)) || ""; }catch(e){}
    modal.classList.add('show');
    setTimeout(()=> ta?.focus(), 0);
  }

  function hide(){
    modal.classList.remove('show');
  }

  function saveDraft(){
    const { leadId } = getLead();
    try{ localStorage.setItem(keyForLead(leadId), ta.value || ""); }catch(e){}
  }

  openBtn?.addEventListener('click', show);
  closeBtn?.addEventListener('click', hide);
  doneBtn?.addEventListener('click', hide);

  ta?.addEventListener('input', saveDraft);

  btnCopy?.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(ta.value || "");
      window.toast?.("הטקסט הועתק 📋");
    }catch(e){
      alert("לא ניתן להעתיק בדפדפן הזה. נסה Ctrl+C");
    }
  });

  btnClear?.addEventListener('click', ()=>{
    ta.value = "";
    saveDraft();
    window.toast?.("נוקה");
  });

  btnFull?.addEventListener('click', ()=>{
    const card = modal.querySelector('.modalCard');
    if(window.requestFull && card) window.requestFull(card);
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) hide();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) hide();
  });
})();
</script>



<script>
/* ===== Mirror Steps -> preload script templates ===== */
(function(){
  const wrap = document.getElementById('mirrorModal');
  if(!wrap) return;

  const openScriptBtn = document.getElementById('mirrorScriptOpen');
  const scriptModal = document.getElementById('mirrorScriptModal');
  const scriptText = document.getElementById('mirrorScriptText');

  function leadName(){
    const leadId = document.getElementById('mirrorLeadSelect')?.value || "";
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId);
    return lead?.name || "הלקוח";
  }

  const templates = {
    open: (n)=>`פתיחה והזדהות\n- שלום ${n}, מדבר/ת ___ מ-LEADUP.\n- אני מבצע/ת עכשיו שיקוף קצר כדי לוודא שהכל ברור לפני שמתקדמים.\n`,
    needs:(n)=>`איסוף צרכים ואימות פרטים\n- רק מאשר/ת פרטים: שם, טלפון, אימייל.\n- הצורך שלך הוא: ___\n- יש דגשים/מצבים מיוחדים שחשוב לדעת? ___\n`,
    offer:(n)=>`הצגת ההצעה ומה היא כוללת\n- ${n}, ההצעה שאנחנו מציגים כוללת: \n  1) ___\n  2) ___\n  3) ___\n- תקופת הכיסוי/תנאים עיקריים: ___\n`,
    price:(n)=>`מחיר, תשלום והחרגות\n- המחיר הוא ___ (כולל/לא כולל ___).\n- אופן תשלום: ___ (תשלומים/חיוב חודשי/שנתי).\n- החרגות/הסתייגויות עיקריות: ___\n`,
    confirm:(n)=>`אישור הלקוח והמשך תהליך\n- האם הכל ברור? יש שאלות?\n- אם מאשרים, השלב הבא הוא: ___\n- אני שולח/ת עכשיו סיכום במסמך/קישור.\n`,
    close:(n)=>`סיכום, שאלות והודעת המשך\n- לסיכום: הצעה ___, מחיר ___, תוקף עד ___.\n- אשלח לך עכשיו את המסמך להצגה/הצעה, ואם תרצה נשלים את התהליך.\n- תודה ${n}!\n`
  };

  function showScriptWith(text){
    // open modal
    if(scriptModal) scriptModal.classList.add('show');
    if(scriptText){
      scriptText.value = text;
      scriptText.dispatchEvent(new Event('input')); // trigger autosave
      setTimeout(()=> scriptText.focus(), 0);
    }
  }

  wrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.mirrorStepBtn');
    if(!btn) return;
    const step = btn.getAttribute('data-step');
    const n = leadName();
    const tmpl = templates[step] ? templates[step](n) : "";
    // if user wants to append instead of replace:
    if(scriptText && scriptText.value && scriptText.value.trim()){
      const add = "\n\n" + tmpl;
      showScriptWith(scriptText.value + add);
    }else{
      showScriptWith(tmpl);
    }
  });
})();
</script>

<!-- ===== Client Dossier (Internal Fullscreen) ===== -->
<div id="clientDossierModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="clientDossierTitle">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div id="clientDossierTitle" class="title">תיק לקוח</div>
        <div id="clientDossierSub" class="sub">פרטי לקוח, משימות, היסטוריה, מסמכים וחתימות</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <button class="btn" id="clientDossierBackBtn">⬅️ חזרה ללידים</button>
        <button class="btnGhost" id="clientDossierCloseBtn" aria-label="סגור">✕ סגור</button>
      </div>
    </div>

    <div class="clientTabs" id="clientTabs">
      <button class="tabBtn active" data-tab="details">פרטים</button>
      <button class="tabBtn" data-tab="tasks">משימות</button>
      <button class="tabBtn" data-tab="history">היסטוריה</button>
      <button class="tabBtn" data-tab="docs">מסמכים</button>
      <button class="tabBtn" data-tab="sign">חתימות</button>
    </div>

    <div class="modalBody">
      <div id="clientTab_details" class="clientSection show"></div>
      <div id="clientTab_tasks" class="clientSection"></div>
      <div id="clientTab_history" class="clientSection"></div>
      <div id="clientTab_docs" class="clientSection"></div>
      <div id="clientTab_sign" class="clientSection"></div>
    </div>
  </div>
</div>


<script>
(function(){
  if(!btn) return;

  function applyTheme(theme){
    try{
      document.documentElement.setAttribute("data-theme", theme);
      localStorage.setItem("leadup_theme", theme);
    }catch(e){
      document.documentElement.setAttribute("data-theme", theme);
    }
    // nice micro-feedback
    btn.classList.toggle("goldSoft", theme === "light");
    btn.classList.toggle("gold", theme === "dark");
    btn.textContent = (theme === "dark") ? "🌙 מצב כהה" : "☀️ מצב בהיר";
  }

  // set initial button label based on current attribute
  const current = document.documentElement.getAttribute("data-theme") || "light";
  applyTheme(current);

  btn.addEventListener("click", ()=>{
    const now = document.documentElement.getAttribute("data-theme") || "light";
    applyTheme(now === "dark" ? "light" : "dark");
  });
})();
</script>


<script>
/* ===== Simple Login Gate Logic =====
   Default password: 1234
   You can change it in localStorage key: leadup_password
*/
(function(){
  const DEFAULT_PASSWORD = "2002";   // <-- change here if you want
  const PASS_KEY = "leadup_password";
  const AUTH_KEY = "leadup_authed_session";

  if(!localStorage.getItem(PASS_KEY)){
    localStorage.setItem(PASS_KEY, DEFAULT_PASSWORD);
  }

  const gate  = document.getElementById("loginGate");
  const input = document.getElementById("loginPassword");
  const btn   = document.getElementById("loginBtn");
  const err   = document.getElementById("loginError");
  const tog   = document.getElementById("loginToggle");

  // toggle password visibility
  if(tog){
    tog.addEventListener("click", ()=>{
      input.type = (input.type === "password") ? "text" : "password";
      tog.textContent = (input.type === "password") ? "👁️" : "🙈";
      input.focus();
    });
  }

  function unlock(){
    sessionStorage.setItem(AUTH_KEY, "1");
    gate.style.display = "none";
    document.documentElement.classList.remove("authPending");
  }

  function lock(){
    sessionStorage.removeItem(AUTH_KEY);
    gate.style.display = "flex";
    document.documentElement.classList.add("authPending");
    input.value = "";
  }

  if(sessionStorage.getItem(AUTH_KEY) === "1"){
    unlock();
  }

  function tryLogin(){
    const pass = input.value || "";
    const real = localStorage.getItem(PASS_KEY);
    if(pass === real){
      err.textContent = "";
      unlock();
    }else{
      err.textContent = "❌ סיסמה שגויה";
    }
  }

  btn.addEventListener("click", tryLogin);
  input.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") tryLogin();
  });

  window.lockSystem = lock;
})();
</script>

<script>
/* ===== Auto Lock (Idle Timeout) =====
   Locks the system after X minutes of inactivity.
   Uses window.lockSystem() that already exists in your code.
*/
(function(){
  const IDLE_MINUTES = 1440; // ⬅️ שנה כאן את הזמן (בדקות)
  const IDLE_MS = IDLE_MINUTES * 60 * 1000;

  let t = null;

  function resetTimer(){
    if(t) clearTimeout(t);
    t = setTimeout(()=>{
      try{
        if(sessionStorage.getItem("leadup_authed_session") === "1"){
          window.lockSystem && window.lockSystem();
          window.toast && window.toast("המערכת ננעלה עקב חוסר פעילות", "warn");
        }
      }catch(e){}
    }, IDLE_MS);
  }

  ["mousemove","mousedown","keydown","touchstart","scroll"].forEach(ev=>{
    document.addEventListener(ev, resetTimer, {passive:true});
  });

  document.addEventListener("visibilitychange", ()=>{
    if(!document.hidden) resetTimer();
  });

  resetTimer();
})();
</script>




<script>
/* ===== Mirror Find Lead (Hotfix Re-bind) =====
   Fixes frozen TZ/Phone/Name buttons by (re)binding listeners safely
   even if an earlier script block threw an error.
*/
(function(){
  function onReady(fn){
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }

  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function digits(s){ return String(s||"").replace(/\D/g,""); }

  function getLeads(){
    try{
      if(window.appState && Array.isArray(window.appState.leads)) return window.appState.leads;
    }catch(e){}
    try{
      const raw = localStorage.getItem("leadup_v1");
      const parsed = raw ? JSON.parse(raw) : null;
      if(parsed && Array.isArray(parsed.leads)) return parsed.leads;
    }catch(e){}
    return [];
  }

  function toast(msg, type){
    try{ window.toast && window.toast(msg, type||"warn"); return; }catch(e){}
    try{ alert(msg); }catch(e){}
  }

  function scoreLead(lead, q, type){
    const qq = norm(q);
    const qd = digits(q);
    if(!qq) return 0;

    if(type === "tz"){
      const v = digits(lead.tz || lead.idNumber || lead.tzNumber || lead.idnum || lead.idNum || "");
      if(!qd) return 0;
      if(v === qd) return 100;
      if(v.endsWith(qd) || v.includes(qd)) return 70;
      return 0;
    }

    if(type === "phone"){
      const vRaw = digits(lead.phone || lead.phoneNumber || lead.mobile || lead.tel || "");
      if(!qd) return 0;

      const variants = new Set([qd]);
      if(qd.startsWith("0") && qd.length >= 9){
        variants.add(qd.slice(1));
        variants.add("972"+qd.slice(1));
      }
      if(qd.startsWith("972") && qd.length >= 11){
        variants.add("0"+qd.slice(3));
      }

      const vVariants = new Set([vRaw]);
      if(vRaw.startsWith("972") && vRaw.length >= 11){
        vVariants.add("0"+vRaw.slice(3));
      }
      if(vRaw.startsWith("0") && vRaw.length >= 9){
        vVariants.add("972"+vRaw.slice(1));
        vVariants.add(vRaw.slice(1));
      }

      for(const vv of vVariants){
        for(const qx of variants){
          if(vv === qx) return 100;
        }
      }
      for(const vv of vVariants){
        for(const qx of variants){
          if(vv.endsWith(qx) || vv.includes(qx)) return 70;
        }
      }
      return 0;
    }

    // name
    const v = norm(lead.name || "");
    if(v === qq) return 100;
    if(v.startsWith(qq)) return 80;
    if(v.includes(qq)) return 60;
    return 0;
  }

  function findLead(q, type){
    const leads = getLeads();
    let best=null, bestScore=0;
    for(const l of leads){
      const s = scoreLead(l, q, type);
      if(s > bestScore){ bestScore = s; best = l; }
    }
    return (bestScore > 0) ? best : null;
  }

  onReady(function(){
    const wrap = document.getElementById("mirrorModal");
    const findTypeWrap = document.getElementById("mirrorFindType");
    const findQ = document.getElementById("mirrorFindQ");
    const findBtn = document.getElementById("mirrorFindBtn");
    const sel = document.getElementById("mirrorLeadSelect");

    if(!findTypeWrap || !findQ || !findBtn) return;

    let mirrorFindType = (findTypeWrap.querySelector(".segBtn.active")?.dataset?.type) || "tz";

    function setPlaceholder(){
      findQ.placeholder = mirrorFindType==="tz" ? "הקלד ת.ז…" :
                          (mirrorFindType==="phone" ? "הקלד טלפון…" : "הקלד שם…");
    }
    setPlaceholder();

    // Re-bind type buttons (capture phase to win over any broken listeners)
    findTypeWrap.addEventListener("click", function(e){
      const b = e.target.closest(".segBtn");
      if(!b) return;
      e.preventDefault();
      e.stopPropagation();

      findTypeWrap.querySelectorAll(".segBtn").forEach(x=>x.classList.remove("active"));
      b.classList.add("active");
      mirrorFindType = b.dataset.type || "tz";
      setPlaceholder();
      findQ.focus();
    }, true);

    function applySelection(lead){
      if(!lead) return false;
      if(sel){
        const id = lead.id || lead._id || lead.uuid || lead.key || "";
        if(id){
          if(!sel.querySelector('option[value="'+String(id).replace(/"/g,'&quot;')+'"]')){
            const opt = document.createElement("option");
            opt.value = id;
            opt.textContent = lead.name || "לקוח";
            sel.appendChild(opt);
          }
          sel.value = id;
          sel.dispatchEvent(new Event("change", {bubbles:true}));
        }
      }
      // advance wizard step if present
      const pill2 = document.getElementById("mwPill2");
      const step2 = document.getElementById("mwStep2");
      const step1 = document.getElementById("mwStep1");
      if(pill2 && step2 && step1){
        try{
          step1.classList.remove("show");
          step2.classList.add("show");
          document.querySelectorAll("#mirrorModal .stepItem").forEach(x=>x.classList.remove("active"));
          pill2.classList.add("active");
        }catch(e){}
      }
      return true;
    }

    function doFind(){
      const q = findQ.value || "";
      const lead = findLead(q, mirrorFindType);
      if(!lead){
        toast("לא נמצא לקוח מתאים. נסה שוב.", "warn");
        return;
      }
      try{
        if(typeof window.applyLeadSelection === "function"){
          window.applyLeadSelection(lead);
        }else{
          applySelection(lead);
        }
      }catch(e){
        applySelection(lead);
      }
      toast("נטען לקוח: " + (lead.name||"—"), "ok");
    }

    findBtn.addEventListener("click", function(e){ e.preventDefault(); doFind(); });
    findQ.addEventListener("keydown", function(e){
      if(e.key === "Enter"){ e.preventDefault(); doFind(); }
    });

    if(wrap){
      const obs = new MutationObserver(()=>setPlaceholder());
      obs.observe(wrap, {attributes:true, attributeFilter:["class"]});
    }
  });
})();
</script>



<script>
/* ===== Mirror Step 2: Document Preview Fix =====
   - Fixes frozen "הצג מסמך" by binding listeners in a clean standalone script.
   - Loads the selected company's associated PDF (from local browser library or URL field)
   - Renders the PDF fully inside the left/right preview iframe (#mirrorFrame) within the system.
*/
(function(){
  function onReady(fn){
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }

  const PDF_LIB_KEY = "leadup_pdf_library_v1";

  function loadLib(){
    try{ return JSON.parse(localStorage.getItem(PDF_LIB_KEY) || "{}") || {}; }
    catch(e){ return {}; }
  }
  function saveLib(lib){
    try{ localStorage.setItem(PDF_LIB_KEY, JSON.stringify(lib)); }catch(e){}
  }
  function toast(msg, type){
    try{ window.toast && window.toast(msg, type||"warn"); return; }catch(e){}
    try{ alert(msg); }catch(e){}
  }
  function normName(s){
    return (s||"").toString().trim()
      .replace(/\.(pdf)$/i,"")
      .replace(/[\s_]+/g," ")
      .replace(/[–—]/g,"-")
      .trim();
  }
  function matchOptionKey(companySel, baseName){
    const base = normName(baseName);
    const opts = Array.from(companySel.options).map(o=>o.value).filter(Boolean);
    for(const v of opts){
      const nv = normName(v);
      if(!nv) continue;
      if(base.includes(nv) || nv.includes(base)) return v;
    }
    return "";
  }

  onReady(function(){
    const modal = document.getElementById("mirrorModal");
    if(!modal) return;

    const companySel = document.getElementById("mirrorCompanySelect");
    const pdfUpload  = document.getElementById("mirrorPdfUpload");
    const offerName  = document.getElementById("mirrorOfferName");
    const pdfUrl     = document.getElementById("mirrorPdfUrl");

    const btnApply   = document.getElementById("mirrorApply");
    const btnCopy    = document.getElementById("mirrorCopyLink");
    const btnOpen    = document.getElementById("mirrorOpenLink");
    const openExtA   = document.getElementById("mirrorOpenExternal");

    const frame      = document.getElementById("mirrorFrame");
    const prevTitle  = document.getElementById("mirrorPrevTitle");
    const prevMeta   = document.getElementById("mirrorPrevMeta");

    if(!companySel || !pdfUrl || !btnApply || !frame) return;

    let lib = loadLib();

    function setFrame(url){
      const clean = (url||"").trim();
      if(!clean){
        frame.src = "about:blank";
        if(prevMeta) prevMeta.textContent = "בחר מסמך להצגה";
        if(openExtA){ openExtA.style.display = "none"; openExtA.href = "#"; }
        return;
      }

      // Prefer embedding as-is; if browser blocks, user can open externally.
      frame.src = clean;

      if(openExtA){
        openExtA.href = clean;
        openExtA.style.display = "inline-flex";
      }
    }

    function applyFromUI(){
      const key = (companySel.value || "").trim();
      const name = (offerName?.value || key || "מסמך").trim();
      const url = (pdfUrl.value || "").trim();

      if(prevTitle) prevTitle.textContent = name || "מסמך";
      if(prevMeta)  prevMeta.textContent  = key ? ("חברה/מסמך: " + key) : "מסמך";

      if(!url || url.length < 7){
        toast("צריך להדביק קישור PDF/מסמך או לבחור מסמך שיש לו שיוך.", "warn");
        return;
      }

      setFrame(url);
      toast("המסמך נטען בתצוגה ✅", "ok");
    }

    // Bind: show document
    btnApply.addEventListener("click", function(e){
      e.preventDefault();
      e.stopPropagation();
      applyFromUI();
    });

    // Bind: copy/open
    if(btnCopy){
      btnCopy.addEventListener("click", async function(e){
        e.preventDefault();
        const url = (pdfUrl.value || "").trim();
        if(!url){ toast("אין קישור להעתקה", "warn"); return; }
        try{
          await navigator.clipboard.writeText(url);
          toast("הקישור הועתק 📋", "ok");
        }catch(err){
          try{ prompt("העתק קישור:", url); }catch(e2){}
        }
      });
    }
    if(btnOpen){
      btnOpen.addEventListener("click", function(e){
        e.preventDefault();
        const url = (pdfUrl.value || "").trim();
        if(!url){ toast("אין קישור לפתיחה", "warn"); return; }
        window.open(url, "_blank", "noopener");
      });
    }

    // Auto-fill from library on company change
    companySel.addEventListener("change", function(){
      const key = (companySel.value || "").trim();
      if(!key) return;

      if(offerName) offerName.value = key;

      lib = loadLib();
      const libUrl = lib[key] || "";
      if(libUrl){
        pdfUrl.value = libUrl;
      }
      // Auto-preview immediately to match your request
      if((pdfUrl.value || "").trim()){
        applyFromUI();
      }else{
        // still update title/meta
        if(prevTitle) prevTitle.textContent = key;
        if(prevMeta)  prevMeta.textContent  = "חברה/מסמך: " + key;
      }
    });

    // Upload PDFs and bind to selected option (or match by filename)
    if(pdfUpload){
      pdfUpload.addEventListener("change", function(){
        const files = Array.from(pdfUpload.files || []);
        if(!files.length) return;

        files.forEach(function(file){
          const maxBytes = 8 * 1024 * 1024; // safer limit (still may fail in some browsers)
          if(file.size > maxBytes){
            toast('הקובץ "'+file.name+'" גדול מדי לשמירה מקומית. מומלץ להעלות לריפו ולהדביק URL במקום.', "warn");
            return;
          }
          const reader = new FileReader();
          reader.onload = function(){
            lib = loadLib();
            const base = normName(file.name);
            const matched = matchOptionKey(companySel, base);
            const key = matched || (companySel.value || base) || base;
            lib[key] = reader.result;
            saveLib(lib);

            toast("ה‑PDF נשמר ושויך ל: " + key + " ✅", "ok");

            // If currently selected, load it now
            if((companySel.value || "").trim() === key){
              if(offerName) offerName.value = key;
              pdfUrl.value = reader.result;
              applyFromUI();
            }
          };
          reader.readAsDataURL(file);
        });
      });
    }

    // Make sure iframe shows full page
    try{
      const wrap = frame.closest(".frameWrap");
      if(wrap){
        wrap.style.height = "calc(100vh - 260px)";
      }
      frame.style.width = "100%";
      frame.style.height = "100%";
    }catch(e){}
  });
})();
</script>



<script>
/* ===== Mirror Apply Button (Capture Hotfix) =====
   Ensures "הצג מסמך" always responds even if other handlers interfere.
*/
(function(){
  function onReady(fn){
    if(document.readyState === "loading") document.addEventListener("DOMContentLoaded", fn);
    else fn();
  }
  function toast(msg, type){
    try{ window.toast && window.toast(msg, type||"warn"); return; }catch(e){}
    try{ alert(msg); }catch(e){}
  }
  onReady(function(){
    const btn = document.getElementById("mirrorApply");
    const pdfUrl = document.getElementById("mirrorPdfUrl");
    const frame = document.getElementById("mirrorFrame");
    const openExtA = document.getElementById("mirrorOpenExternal");
    if(btn){
      btn.style.cursor = "pointer";
      btn.style.pointerEvents = "auto";
    }
    function doApply(){
      const url = (pdfUrl?.value || "").trim();
      if(!url){
        toast("אין קישור/מסמך להצגה. בחר מסמך או העלה PDF.", "warn");
        return;
      }
      if(frame) frame.src = url;
      if(openExtA){
        openExtA.href = url;
        openExtA.style.display = "inline-flex";
      }
      toast("המסמך נטען ✅", "ok");
    }

    // Capture-phase global click handler to bypass interference
    document.addEventListener("click", function(e){
      const t = e.target && (e.target.closest ? e.target.closest("#mirrorApply") : null);
      if(!t) return;
      e.preventDefault();
      e.stopPropagation();
      doApply();
    }, true);
  });
})();
</script>

</body>
</html>
