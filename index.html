<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>××¢×¨×›×ª CRM ×¤× ×™××™×ª â€“ ×¡×•×›× ×•×ª ×‘×™×˜×•×—</title>

<style>
:root{
  --bg:#0b0b0b;
  --panel:#111;
  --gold:#d4af37;
  --gold2:#f3e7b7;
  --line:rgba(255,255,255,.14);
  --radius:16px;
  --red:#ff4d4d;
  --green:#2ecc71;
  --text:#fff;
  --muted:rgba(255,255,255,.72);
  --shadow:0 18px 50px rgba(0,0,0,.55);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    radial-gradient(900px 600px at 20% -10%, rgba(212,175,55,.18), transparent 60%),
    radial-gradient(700px 500px at 100% 0%, rgba(255,255,255,.06), transparent 55%),
    var(--bg);
  color:var(--text);
  overflow-x:hidden;
}
.hidden{display:none !important}

/* Buttons / Inputs */
.btn{
  border:none;border-radius:12px;
  padding:10px 14px;font-weight:800;cursor:pointer;
  transition:transform .06s ease, filter .15s ease, opacity .15s ease;
}
.btn:active{transform:scale(.98)}
.btnGold{background:linear-gradient(180deg,var(--gold2),var(--gold));color:#111}
.btnDark{background:rgba(255,255,255,.10);color:#fff;border:1px solid var(--line)}
.btnGhost{background:transparent;color:#fff;border:1px dashed rgba(255,255,255,.22)}
.btn[disabled]{opacity:.55;cursor:not-allowed}
.input,select,textarea{
  width:100%;
  border-radius:12px;
  padding:10px 12px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  color:#fff;
  outline:none;
}
.input::placeholder{color:rgba(255,255,255,.55)}
select,textarea{color:#fff}
textarea{min-height:78px;resize:vertical}

/* Layout */
.wrap{
  display:grid;
  grid-template-columns:260px 1fr 420px;
  gap:12px;
  padding:12px;
  min-height:100vh;
  align-items:start;
}
.card,.sidebar,.right{
  background:rgba(255,255,255,.06);
  border:1px solid var(--line);
  border-radius:var(--radius);
  padding:12px;
  box-shadow:var(--shadow);
  backdrop-filter: blur(8px);
}
.sidebar button{width:100%;margin-bottom:8px;text-align:right}
.small{font-size:12px;color:var(--muted)}
hr{border:none;height:1px;background:rgba(255,255,255,.15);margin:10px 0}

/* Leads table */
.tableHead,.row{
  display:grid;
  grid-template-columns:1fr 1fr .8fr .8fr;
  gap:10px;
  padding:10px 8px;
  border-bottom:1px dashed rgba(255,255,255,.12);
}
.tableHead{font-weight:800;opacity:.75}
.row{cursor:pointer}
.row:hover{background:rgba(212,175,55,.12)}
.row.overdue{background:rgba(255,0,0,.15)}
.badge{padding:2px 8px;border-radius:999px;font-size:12px;display:inline-block}
.badge.red{background:rgba(255,77,77,.22)}
.badge.gold{background:rgba(212,175,55,.25)}

/* Right panels (white cards inside) */
.whiteCard{
  background:rgba(255,255,255,.95);
  color:#111;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.08);
  padding:12px;
  box-shadow:0 10px 26px rgba(0,0,0,.25);
}
.whiteCard .input, .whiteCard select, .whiteCard textarea{
  background:#fff;
  color:#111;
  border:1px solid rgba(0,0,0,.15);
}
.whiteCard .input::placeholder{color:rgba(0,0,0,.45)}

.noteList{
  max-height:220px;
  overflow:auto;
  border:1px solid rgba(0,0,0,.14);
  border-radius:12px;
  padding:8px;
  background:#fff;
  color:#111;
}
.noteItem{border-bottom:1px dashed #ccc;padding:8px 0}
.noteItem:last-child{border-bottom:none}

/* Login view */
.loginWrap{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}
.loginCard{
  width:min(460px, calc(100vw - 28px));
  padding:16px;
}
.loginTitle{
  display:flex;align-items:center;justify-content:space-between;
  margin:0 0 12px 0;
}
.pill{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.06);
  font-weight:800;
}

/* Mobile */
@media (max-width: 1100px){
  .wrap{grid-template-columns:1fr; padding:10px}
  .sidebar{position:sticky; top:10px}
}
</style>
</head>

<body>

<!-- LOGIN (× ×©××¨ ×‘×§×•×“, ××‘×œ ××¤×©×¨ ×œ×¢×§×•×£ ×¢× BYPASS_LOGIN=true) -->
<div id="loginView" class="loginWrap">
  <div class="card loginCard">
    <div class="loginTitle">
      <h3 style="margin:0">ğŸ” ×›× ×™×¡×” ×œ××¢×¨×›×ª</h3>
      <span class="pill">LeadUp â€¢ CRM</span>
    </div>

    <input id="inUser" class="input" placeholder="×©× ××©×ª××©" autocomplete="username"><br><br>
    <input id="inPin" type="password" class="input" placeholder="×§×•×“" autocomplete="current-password"><br><br>

    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn btnGold" id="btnLogin">×”×ª×—×‘×¨</button>
      <button class="btn btnDark" id="btnAuto" title="×›× ×™×¡×” ××•×˜×•××˜×™×ª (×‘×™× ×ª×™×™× ×‘×œ×™ ×¡×™×¡××”)">×›× ×™×¡×” ××•×˜×•××˜×™×ª</button>
    </div>

    <div class="small" style="margin-top:10px;line-height:1.35">
      ×× ××ª×” ×¨×•××” ×”×•×“×¢×ª doGet â€” ×–×” ×ª×§×™×Ÿ. ×”××¢×¨×›×ª ×¢×•×‘×“×ª ×“×¨×š POST ×œ-Apps Script.
    </div>

    <div class="small" id="connHint" style="margin-top:8px;opacity:.85"></div>
  </div>
</div>

<!-- APP -->
<div id="appView" class="wrap hidden">

  <!-- SIDEBAR -->
  <div class="sidebar">
    <h3 style="margin:0 0 10px 0">ğŸ“Š ×ª×¤×¨×™×˜</h3>
    <button class="btn btnGold" id="btnTakeNext">âš¡ ×§×— ××ª ×”×‘×</button>
    <button class="btn btnDark" id="btnRefresh">ğŸ”„ ×¨×¢× ×Ÿ</button>
    <button class="btn btnDark" id="btnLogout">ğŸšª ×™×¦×™××”</button>
    <hr>
    <div class="small">×”×ª×¨××•×ª / SLA / ×ª×–××•× ×™× ×¢×•×‘×“×™× ××•×˜×•××˜×™×ª</div>
  </div>

  <!-- MAIN -->
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <h3 style="margin:0">ğŸ“‹ ×œ×™×“×™×</h3>
      <span class="small" id="statusPill">××•×›×Ÿ</span>
    </div>

    <div style="display:flex;gap:10px;align-items:center;margin-top:10px">
      <input id="q" class="input" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©× / ×˜×œ×¤×•×Ÿ" style="flex:1">
      <button class="btn btnDark" id="btnSearch">×—×¤×©</button>
    </div>

    <div class="tableHead" style="margin-top:10px">
      <div>×©×</div><div>×˜×œ×¤×•×Ÿ</div><div>×¡×˜×˜×•×¡</div><div>×“×—×™×¤×•×ª</div>
    </div>

    <div id="leadRows"></div>
  </div>

  <!-- RIGHT -->
  <div class="right">
    <div id="noFocus" class="small" style="padding:10px">×‘×—×¨ ×œ×™×“</div>

    <div id="focusBox" class="hidden">

      <div class="whiteCard">
        <b id="fName"></b><br>
        ğŸ“ <span id="fPhone"></span><br>
        ××•×¦×¨: <span id="fProd"></span>

        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn btnGold" id="btnCall">×—×™×™×’</button>
          <button class="btn btnDark" id="btnCopyPhone">×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
        </div>
      </div>

      <div class="whiteCard" style="margin-top:12px">
        <label><b>×¡×˜×˜×•×¡</b></label>
        <select id="fStatus" class="input" style="margin-top:6px">
          <option>NEW</option>
          <option>CONTACTING</option>
          <option>SOLD</option>
          <option>LOST</option>
        </select>

        <label style="margin-top:10px;display:block"><b>×ª×™×¢×•×“ ×—×•×‘×”</b></label>
        <textarea id="actionNote" class="input" placeholder="××” ×‘×•×¦×¢? ××” × ×××¨? ××” ×”×¦×¢×“ ×”×‘×?" style="margin-top:6px"></textarea>

        <button class="btn btnGold" style="margin-top:10px;width:100%" id="btnSave">ğŸ’¾ ×©××•×¨</button>
      </div>

      <div class="whiteCard" style="margin-top:12px">
        <h4 style="margin:0 0 10px 0">â±ï¸ ×ª×–××•×Ÿ</h4>
        <input id="schAt" type="datetime-local" class="input">
        <select id="schType" class="input" style="margin-top:8px">
          <option value="call">ğŸ“ ×©×™×—×”</option>
          <option value="whatsapp">ğŸ’¬ ×•×•××˜×¡××¤</option>
          <option value="docs">ğŸ“„ ××¡××›×™×</option>
          <option value="renewal">â™»ï¸ ×—×™×“×•×©</option>
        </select>
        <input id="schNote" class="input" placeholder="×”×¢×¨×”" style="margin-top:8px">
        <button class="btn btnGold" style="margin-top:10px;width:100%" id="btnAddSchedule">â• ×”×•×¡×£ ×ª×–××•×Ÿ</button>
      </div>

      <div class="whiteCard" style="margin-top:12px">
        <b>ğŸ“… ×ª×–××•× ×™×</b>
        <div id="schList" class="noteList" style="margin-top:8px">â€”</div>
      </div>

      <div class="whiteCard" style="margin-top:12px">
        <b>ğŸ“ ×ª×™×¢×•×“</b>
        <div id="notesBox" class="noteList" style="margin-top:8px">â€”</div>
      </div>

    </div>
  </div>

</div>

<script>
/* =========================
   CONFIG (×—×•×‘×” ×œ××œ×!)
   ========================= */
const SCRIPT_URL = "PASTE_SCRIPT_URL_HERE"; // ×—×™×™×‘ ×œ×”×¡×ª×™×™× ×‘ /exec
const API_KEY    = "PASTE_API_KEY_HERE";    // ×—×™×™×‘ ×œ×”×™×•×ª ×–×”×” ×œ××” ×©×©××ª ×‘-Apps Script

/* =========================
   BYPASS LOGIN (×œ×œ× ×¡×™×¡××” ×–×× ×™×ª)
   ========================= */
const BYPASS_LOGIN = true;            // âœ… true = ×‘×œ×™ ×¡×™×¡××” (×›× ×™×¡×” ××•×˜×•××˜×™×ª)
const AUTO_USER = "admin";            // ×”××©×ª××© ×©×§×™×™× ×‘-Users sheet
const AUTO_PIN  = "1234";             // ×”×¡×™×¡××” ×©×œ ××•×ª×• ××©×ª××© (×‘×™× ×ª×™×™×)

/* ========================= */

const $ = (id)=>document.getElementById(id);
let token = localStorage.getItem("crm_token") || "";
let leads = [], focused = null;

function setStatus(t){ $("statusPill").textContent = t; }

/* ---------- API ---------- */
async function api(action, payload = {}){
  const body = { action, apiKey: API_KEY, token, ...payload };

  const r = await fetch(SCRIPT_URL, {
    method: "POST",
    headers: { "Content-Type":"text/plain;charset=utf-8" }, // GAS ××•×”×‘ text/plain
    body: JSON.stringify(body),
  });

  // ×× ××©×”×• × ×›×©×œ (404/500) × × ×¡×” ×œ×§×¨×•× ×˜×§×¡×˜
  let data = null;
  try { data = await r.json(); }
  catch(e){
    const txt = await r.text().catch(()=> "");
    throw new Error("×ª×’×•×‘×” ×œ× ×ª×§×™× ×” ××”×©×¨×ª. ×‘×“×•×§ SCRIPT_URL (/exec) ×•×¤×¨×™×¡×”. " + (txt ? (" " + txt.slice(0,140)) : ""));
  }
  return data;
}

/* ---------- AUTH ---------- */
async function doLogin(){
  const u = $("inUser").value.trim();
  const p = $("inPin").value.trim();
  if(!u || !p) return alert("×—×¡×¨ ×©× ××©×ª××© ××• ×§×•×“");

  try{
    const r = await api("login", { username: u, pin: p });
    if(!r.ok) return alert(r.message || "×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª");
    token = r.token;
    localStorage.setItem("crm_token", token);
    showApp();
  }catch(err){
    alert("×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª: " + err.message);
  }
}

async function ensureAutoToken(){
  if(token) return true;
  try{
    const r = await api("login", { username: AUTO_USER, pin: AUTO_PIN });
    if(!r.ok) return false;
    token = r.token;
    localStorage.setItem("crm_token", token);
    return true;
  }catch(e){
    return false;
  }
}

function doLogout(){
  localStorage.removeItem("crm_token");
  location.reload();
}

/* ---------- UI ---------- */
function showApp(){
  $("loginView").classList.add("hidden");
  $("appView").classList.remove("hidden");
  refreshLeads();
}

function renderLeads(){
  const box = $("leadRows");
  box.innerHTML = "";

  if(!leads.length){
    box.innerHTML = `<div class="small" style="padding:10px">××™×Ÿ ×ª×•×¦××•×ª</div>`;
    return;
  }

  leads.forEach(l=>{
    const overdue = l.followUpAt && new Date(l.followUpAt) < new Date();
    const d = document.createElement("div");
    d.className = "row" + (overdue ? " overdue" : "");
    d.innerHTML = `
      <div>${escapeHtml(l.name || "")}</div>
      <div>${escapeHtml(l.phone || "")}</div>
      <div>${escapeHtml(l.status || "")}</div>
      <div>${overdue ? '<span class="badge red">××™×—×•×¨</span>' : '<span class="badge gold">×ª×§×™×Ÿ</span>'}</div>
    `;
    d.onclick = ()=> setFocus(l);
    box.appendChild(d);
  });
}

async function setFocus(l){
  focused = l;
  $("noFocus").classList.add("hidden");
  $("focusBox").classList.remove("hidden");

  $("fName").textContent  = l.name || "";
  $("fPhone").textContent = l.phone || "";
  $("fProd").textContent  = l.productType || "";
  $("fStatus").value      = l.status || "NEW";

  $("actionNote").value = "";
  $("schNote").value = "";

  await loadNotes();
  await loadSchedules();
}

/* ---------- LOADERS ---------- */
async function refreshLeads(){
  setStatus("×˜×•×¢×Ÿâ€¦");
  try{
    const r = await api("listleads", { q: $("q").value });
    if(r.ok){
      leads = r.leads || [];
      renderLeads();
      setStatus("×¢×•×“×›×Ÿ");
    }else{
      setStatus("×©×’×™××”");
      alert(r.message || "×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×™×“×™×");
    }
  }catch(err){
    setStatus("×©×’×™××”");
    alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×œ×™×“×™×: " + err.message);
  }
}

async function loadNotes(){
  if(!focused) return;
  try{
    const r = await api("readlead", { leadId: focused.id });
    if(!r.ok) return;

    const notes = (r.lead && r.lead.notes) ? r.lead.notes : [];
    $("notesBox").innerHTML = notes.length
      ? notes.map(n=>`<div class="noteItem">${escapeHtml(n.ts)} â€¢ ${escapeHtml(n.by)}<br>${escapeHtml(n.text)}</div>`).join("")
      : "××™×Ÿ ×ª×™×¢×•×“";
  }catch(e){
    $("notesBox").innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×™×¢×•×“";
  }
}

async function loadSchedules(){
  if(!focused) return;
  try{
    const r = await api("listschedules", { leadId: focused.id });
    if(!r.ok) return;

    const arr = r.schedules || [];
    $("schList").innerHTML = arr.length
      ? arr.map(s=>`<div class="noteItem">â° ${escapeHtml(s.at)}<br>${escapeHtml(s.type)} â€” ${escapeHtml(s.note||"")}</div>`).join("")
      : "××™×Ÿ ×ª×–××•× ×™×";
  }catch(e){
    $("schList").innerHTML = "×©×’×™××” ×‘×˜×¢×™× ×ª ×ª×–××•× ×™×";
  }
}

/* ---------- ACTIONS ---------- */
async function saveLead(){
  if(!focused) return alert("×‘×—×¨ ×œ×™×“");
  if(!$("actionNote").value.trim()) return alert("×—×•×‘×” ×ª×™×¢×•×“");

  try{
    const r = await api("updatelead",{
      leadId: focused.id,
      patch:{
        status: $("fStatus").value,
        actionNote: $("actionNote").value
      }
    });
    if(r.ok){
      $("actionNote").value = "";
      await refreshLeads();
      await loadNotes();
    }else{
      alert(r.message || "×©×’×™××” ×‘×©××™×¨×”");
    }
  }catch(err){
    alert("×©×’×™××” ×‘×©××™×¨×”: " + err.message);
  }
}

async function addSchedule(){
  if(!focused) return alert("×‘×—×¨ ×œ×™×“");
  if(!$("actionNote").value.trim()) return alert("×—×•×‘×” ×ª×™×¢×•×“ ×œ×¤× ×™ ×ª×–××•×Ÿ");
  if(!$("schAt").value) return alert("×‘×—×¨ ×ª××¨×™×š ×•×©×¢×”");

  const iso = new Date($("schAt").value).toISOString();

  try{
    const r = await api("addschedule",{
      leadId: focused.id,
      at: iso,
      type: $("schType").value,
      note: $("schNote").value,
      actionNote: $("actionNote").value
    });
    if(r.ok){
      $("schNote").value = "";
      $("actionNote").value = "";
      await loadSchedules();
      await loadNotes();
      await refreshLeads();
    }else{
      alert(r.message || "×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×–××•×Ÿ");
    }
  }catch(err){
    alert("×©×’×™××” ×‘×”×•×¡×¤×ª ×ª×–××•×Ÿ: " + err.message);
  }
}

function callLead(){
  if(!focused?.phone) return;
  window.location.href = "tel:" + String(focused.phone).replace(/\D/g,"");
}

async function copyPhone(){
  const p = focused?.phone || "";
  if(!p) return;
  try{
    await navigator.clipboard.writeText(p);
    alert("×”×•×¢×ª×§: " + p);
  }catch(e){
    alert("×œ× ×”×¦×œ×—×ª×™ ×œ×”×¢×ª×™×§ (×ª× ×¡×” ×™×“× ×™×ª): " + p);
  }
}

/* ---------- EVENTS ---------- */
$("btnLogin").onclick = doLogin;
$("btnAuto").onclick = async ()=>{
  $("inUser").value = AUTO_USER;
  $("inPin").value  = AUTO_PIN;
  await doLogin();
};
$("btnLogout").onclick = doLogout;
$("btnRefresh").onclick = refreshLeads;
$("btnSave").onclick = saveLead;
$("btnAddSchedule").onclick = addSchedule;
$("btnCall").onclick = callLead;
$("btnCopyPhone").onclick = copyPhone;
$("btnSearch").onclick = refreshLeads;
$("q").addEventListener("keydown",(e)=>{ if(e.key==="Enter") refreshLeads(); });

$("btnTakeNext").onclick = async ()=>{
  try{
    const r = await api("takenext",{});
    if(r?.leadId) refreshLeads();
  }catch(err){
    alert("×©×’×™××”: " + err.message);
  }
};

/* ---------- UTIL ---------- */
function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* ---------- BOOT ---------- */
(function showConnHint(){
  const hint = [];
  hint.push("SCRIPT_URL ×¦×¨×™×š ×œ×”×™×•×ª ×›×ª×•×‘×ª ×”-Web App ×©××¡×ª×™×™××ª ×‘ /exec");
  hint.push("API_KEY ×—×™×™×‘ ×œ×”×™×•×ª ×‘×“×™×•×§ ×›××• ×‘×§×•×‘×¥ Apps Script (CFG.API_KEY)");
  $("connHint").textContent = hint.join(" â€¢ ");
})();

(async ()=>{
  // ×× ×‘×•×—×¨×™× ×œ×¢×§×•×£ ×¡×™×¡××”: × ×›× ×¡×™× ××•×˜×•××˜×™×ª
  if(BYPASS_LOGIN){
    const ok = await ensureAutoToken();
    if(ok) showApp();
    // ×× × ×›×©×œ, × ×©××™×¨ ××¡×š ×”×ª×—×‘×¨×•×ª ×¨×’×™×œ
  }else{
    if(token) showApp();
  }
})();
</script>

</body>
</html>
