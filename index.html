<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LEADUP â€¢ ××¢×¨×›×ª × ×™×”×•×œ ×œ×™×“×™×</title>
  <meta name="theme-color" content="#0b0b0f"/>
  <style>
    :root{
      --bg:#07070a;
      --panel:#0c0c12;
      --panel2:#10101a;
      --line:rgba(255,255,255,.10);
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --gold:#d6b25e;
      --gold2:#f2d27c;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --shadow2:0 12px 30px rgba(0,0,0,.40);
      --r:18px;
      --r2:22px;
      --focus: 0 0 0 3px rgba(214,178,94,.22);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans Hebrew", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.10), transparent 55%),
        radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.06), transparent 60%),
        linear-gradient(180deg, #06060a, #050509);
      color:var(--text);
      font-family:var(--font);
      overflow:hidden;
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      height:100vh;
    }

    /* Sidebar */
    .side{
      border-left:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:18px 16px;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 16px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(242,210,124,.45), transparent 55%),
        linear-gradient(145deg, rgba(214,178,94,.50), rgba(214,178,94,.08));
      box-shadow:0 12px 30px rgba(214,178,94,.12);
      border:1px solid rgba(214,178,94,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.6px;
    }
    .brand .sub{
      margin-top:2px;
      color:var(--muted2);
      font-size:12px;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:right;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:.18s ease;
    }
    .nav button:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .nav button.active{
      background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.04));
      border-color:rgba(214,178,94,.35);
      box-shadow:0 14px 32px rgba(214,178,94,.08);
    }
    .nav .k{
      display:flex;align-items:center;gap:10px;
      font-weight:650;
    }
    .pill{
      font-size:12px;
      color:rgba(255,255,255,.85);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
    }
    .pill.gold{border-color:rgba(214,178,94,.35); color:rgba(242,210,124,.95)}
    .sideFooter{
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--line);
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .sideFooter .hint{
      margin-top:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,94,.18);
      border-radius:14px;
      background:rgba(214,178,94,.06);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(214,178,94,.30);
      background:rgba(214,178,94,.10);
      color:rgba(242,210,124,.95);
      font-size:12px;
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--gold2);box-shadow:0 0 0 4px rgba(242,210,124,.18)}
    .topbar .title{
      display:flex; flex-direction:column;
    }
    .topbar .title b{font-size:16px}
    .topbar .title span{color:var(--muted2);font-size:12px;margin-top:2px}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:650;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(214,178,94,.25)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.gold{
      background:linear-gradient(180deg, rgba(214,178,94,.26), rgba(255,255,255,.05));
      border-color:rgba(214,178,94,.35);
      color:rgba(242,210,124,.98);
    }
    .btn.danger{
      border-color:rgba(255,107,107,.28);
      background:rgba(255,107,107,.08);
    }
    .search{
      position:relative;
      min-width:320px;
      max-width:520px;
      width:38vw;
    }
    .search input{
      width:100%;
      padding:12px 40px 12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
    }
    .search input:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .search .icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:rgba(255,255,255,.55);
      font-size:14px;
      pointer-events:none;
    }
    .content{
      padding:16px 18px 22px;
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1060px){
      .app{grid-template-columns: 1fr}
      .side{display:none}
      .grid{grid-template-columns: 1fr}
      body{overflow:auto}
      .main{height:auto}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .card .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.09);
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .card .body{padding:12px 14px 14px}
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset:-80px -60px auto auto;
      width:160px;height:160px;border-radius:50%;
      background:rgba(214,178,94,.10);
      filter:blur(2px);
    }
    .stat .k{color:var(--muted2); font-size:12px}
    .stat .v{margin-top:6px; font-size:20px; font-weight:800}
    .stat .mini{margin-top:3px; font-size:12px; color:rgba(242,210,124,.86)}
    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width:920px;
    }
    thead th{
      text-align:right;
      padding:12px 10px;
      color:rgba(255,255,255,.72);
      font-weight:700;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align:middle;
      color:rgba(255,255,255,.92);
    }
    tbody tr:hover td{background:rgba(214,178,94,.05)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.hot{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.08); color:rgba(255,204,102,.95)}
    .tag.ok{border-color:rgba(46,229,157,.30); background:rgba(46,229,157,.08); color:rgba(46,229,157,.95)}
    .tag.cold{border-color:rgba(255,255,255,.14); background:rgba(255,255,255,.03); color:rgba(255,255,255,.78)}
    .score{
      display:flex; align-items:center; gap:10px;
    }
    .bar{
      width:120px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      background:linear-gradient(90deg, rgba(214,178,94,.25), rgba(242,210,124,.65));
      width:50%;
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-start;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:.16s ease;
    }
    .iconBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .iconBtn.gold{border-color:rgba(214,178,94,.30); background:rgba(214,178,94,.10)}
    .muted{color:var(--muted2)}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){ .row{grid-template-columns:1fr} table{min-width:800px} }
    label{display:block; font-size:12px; color:rgba(255,255,255,.70); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
      font-family:inherit;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .help{
      margin-top:8px;
      color:rgba(255,255,255,.62);
      font-size:12px;
      line-height:1.4;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
       width:min(980px, 100%);
  max-height:min(86vh, 900px);
  overflow:auto;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.14);
      background:
     radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.10), transparent 55%),
    linear-gradient(180deg, rgba(10,10,18,.98), rgba(6,6,12,.96));
      box-shadow:0 30px 90px rgba(0,0,0,.85);
      position:relative;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:2;
    }
    .modalHeader b{font-size:14px}
    .modalBody{padding:14px 16px 16px}
    .closeX{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      color:var(--text);
    }
    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(520px, calc(100vw - 36px));
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }
    .miniCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:18px;
      padding:12px;
    }
    .miniCard h3{margin:0 0 10px 0; font-size:13px}
    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height:500px; overflow:auto; padding-left:4px;
    }
    .event{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px 10px;
    }
    .event .t{font-size:12px; color:rgba(255,255,255,.75)}
    .event .d{margin-top:4px; font-size:13px}
    .kbd{
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      border-bottom-color:rgba(255,255,255,.24);
      padding:2px 8px;
      border-radius:10px;
      color:rgba(255,255,255,.85);
    }
    .small{font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.10); margin:12px 0}

    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){ .twoCols{grid-template-columns:1fr} }

    .frame{
      width:100%;
      height:460px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .frame iframe{width:100%;height:100%;border:0}
  </style>
</head>

<body>
<div class="app">
  <aside class="side">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>LEADUP</h1>
        <div class="sub">CRM ×™×•×§×¨×ª×™ ×œ×œ×™×“×™× â€¢ ×¡×•×›× ×•×ª ×‘×™×˜×•×—</div>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-view="leads">
        <span class="k">ğŸ“Œ ×œ×™×“×™×</span>
        <span class="pill gold" id="navCount">0</span>
      </button>
      <button data-view="tasks">
        <span class="k">â° ××©×™××•×ª</span>
        <span class="pill" id="navTasks">0</span>
      </button>
      <button data-view="timeline">
        <span class="k">ğŸ§¾ ×”×™×¡×˜×•×¨×™×”</span>
        <span class="pill" id="navEvents">0</span>
      </button>
      <button data-view="settings">
        <span class="k">âš™ï¸ ×”×’×“×¨×•×ª</span>
        <span class="pill">Local</span>
      </button>
    </div>

    <div class="sideFooter">
      <div><b>×˜×™×¤:</b> ×›×œ ×¤×¢×•×œ×” × ×¤×ª×—×ª ×‘×ª×•×š ×—×œ×•×Ÿ ×‘××¢×¨×›×ª (××•×“××œ) â€” ×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×™×¦×•× ×™.</div>
      <div class="hint">
        ×‘×§×¨×•×‘ × ×—×‘×¨ ×œ-Google Sheets ×“×¨×š Apps Script (×¨×§ ×ª×ª×Ÿ ×œ×™ ××ª ×›×ª×•×‘×ª ×”-URL ×•××–×”×” ×”×¤×¨×™×¡×”).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <span class="badge"><span class="dot"></span> ××¦×‘ ××¢×¨×›×ª: ×¤×¢×™×œ</span>
        <div class="title">
          <b id="viewTitle">×œ×™×“×™×</b>
          <span id="viewSub">× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘</span>
        </div>
      </div>

      <div class="search">
        <span class="icon">âŒ•</span>
        <input id="q" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×/×˜×œ×¤×•×Ÿ/××™××™×™×œ/×”×¢×¨×”â€¦" autocomplete="off"/>
      </div>

      <div class="right">
        <button class="btn gold" id="btnAddLead">â• ×œ×™×“ ×—×“×©</button>
        <button class="btn" id="btnQuickTask">â±ï¸ ××©×™××” ××”×™×¨×”</button>
        <button class="btn" id="btnExport">â¬‡ï¸ ×™×™×¦×•×</button>
        <button class="btn" id="btnImport">â¬†ï¸ ×™×™×‘×•×</button>
      </div>
    </div>

    <div class="content">
      <div class="card" style="margin-bottom:14px">
        <div class="head">
          <h2>×“×©×‘×•×¨×“</h2>
          <div class="muted small">×§×™×¦×•×¨×™ ××§×œ×“×ª: <span class="kbd">N</span> ×œ×™×“ ×—×“×© â€¢ <span class="kbd">/</span> ×—×™×¤×•×©</div>
        </div>
        <div class="body">
          <div class="stats">
            <div class="stat">
              <div class="k">×¡×”×´×› ×œ×™×“×™×</div>
              <div class="v" id="stTotal">0</div>
              <div class="mini">×‘×××’×¨</div>
            </div>
            <div class="stat">
              <div class="k">×—××™×</div>
              <div class="v" id="stHot">0</div>
              <div class="mini">Lead Score ×’×‘×•×”</div>
            </div>
            <div class="stat">
              <div class="k">××¢×§×‘ ×”×™×•×</div>
              <div class="v" id="stToday">0</div>
              <div class="mini">Next Follow-up</div>
            </div>
            <div class="stat">
              <div class="k">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
              <div class="v" id="stTasks">0</div>
              <div class="mini">×ª×–×›×•×¨×•×ª</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card" id="viewLeads">
          <div class="head">
            <h2>×¨×©×™××ª ×œ×™×“×™×</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <select id="fStatus" title="×¤×™×œ×˜×¨ ×¡×˜×˜×•×¡" style="width:170px">
                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                <option>×—×“×©</option>
                <option>× ×•×¦×¨ ×§×©×¨</option>
                <option>××ª×¢× ×™×™×Ÿ</option>
                <option>×”×¦×¢×ª ××—×™×¨</option>
                <option>× ×¡×’×¨</option>
                <option>×œ× ×¨×œ×•×•× ×˜×™</option>
              </select>
              <select id="fSource" title="×¤×™×œ×˜×¨ ××§×•×¨" style="width:170px">
                <option value="">×›×œ ×”××§×•×¨×•×ª</option>
                <option>×¤×™×™×¡×‘×•×§</option>
                <option>×’×•×’×œ</option>
                <option>×”×¤× ×™×”</option>
                <option>×˜×œ×¤×•×Ÿ</option>
                <option>××ª×¨</option>
                <option>××—×¨</option>
              </select>
              <select id="sortBy" title="××™×•×Ÿ" style="width:170px">
                <option value="hot">××™×•×Ÿ: ×”×›×™ ×—×</option>
                <option value="next">××™×•×Ÿ: ×ª××¨×™×š ××¢×§×‘ ×”×‘×</option>
                <option value="newest">××™×•×Ÿ: ×”×›×™ ×—×“×©</option>
                <option value="oldest">××™×•×Ÿ: ×”×›×™ ×™×©×Ÿ</option>
              </select>
            </div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>×©×</th>
                    <th>×˜×œ×¤×•×Ÿ</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>××§×•×¨</th>
                    <th>×—×•× (Score)</th>
                    <th>××¢×§×‘ ×”×‘×</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="leadsTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyLeads" style="display:none">
              ××™×Ÿ ×¢×“×™×™×Ÿ ×œ×™×“×™×. ×œ×—×¥ ×¢×œ <b>â€œ×œ×™×“ ×—×“×©â€</b> ×›×“×™ ×œ×”×ª×—×™×œ.
            </div>
          </div>
        </section>

        <aside class="card" id="viewRight">
          <div class="head">
            <h2>××¨×›×– ×©×œ×™×˜×”</h2>
            <div class="pill gold">LEADUP</div>
          </div>
          <div class="body">
            <div class="miniCard" style="margin-bottom:10px">
              <h3>××” ×™×© ×‘××¢×¨×›×ª</h3>
              <div class="small muted">
                â€¢ ×œ×™×“×™× + ×¡×˜×˜×•×¡×™× + ×”×¢×¨×•×ª<br/>
                â€¢ ××©×™××•×ª ×•×ª×–×›×•×¨×•×ª ×œ×›×œ ×œ×™×“<br/>
                â€¢ ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª (Timeline)<br/>
                â€¢ ×—×™×¤×•×©/×¤×™×œ×˜×¨×™×/××™×•×Ÿ<br/>
                â€¢ Lead Score (1â€“100)<br/>
                â€¢ ×•×•××˜×¡××¤ / ×”×ª×§×©×¨×•×ª / ××™×™×œ (×‘××•×“××œ)
              </div>
            </div>

            <div class="miniCard">
              <h3>×¤×¢×•×œ×” ××”×™×¨×”</h3>
              <button class="btn gold" style="width:100%" id="btnOpenInsights">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
              <div class="sep"></div>
              <button class="btn" style="width:100%" id="btnSeed">âœ¨ ×¦×•×¨ ×“×•×’×××•×ª ×œ×™×“×™×</button>
              <div class="help">×”×›×œ × ×©××¨ ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (LocalStorage) ×¢×“ ×©× ×—×‘×¨ ×œ-Google Sheets.</div>
            </div>
          </div>
        </aside>

        <!-- Tasks view -->
        <section class="card" id="viewTasks" style="display:none">
          <div class="head">
            <h2>××©×™××•×ª</h2>
            <div class="muted small">×ª×–×›×•×¨×•×ª + ×¢×“×™×¤×•×ª + ×©×™×™×›×•×ª ×œ×œ×™×“</div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table style="min-width:860px">
                <thead>
                  <tr>
                    <th>××ª×™</th>
                    <th>×¢×“×™×¤×•×ª</th>
                    <th>×œ×™×“</th>
                    <th>×ª×™××•×¨</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="tasksTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyTasks" style="display:none">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª.</div>
          </div>
        </section>

        <!-- Timeline view -->
        <section class="card" id="viewTimeline" style="display:none">
          <div class="head">
            <h2>×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª</h2>
            <div class="muted small">×›×œ ×©×™× ×•×™ × ×©××¨: ××™/××ª×™/××” ×”×©×ª× ×”</div>
          </div>
          <div class="body">
            <div class="timeline" id="timelineList"></div>
            <div class="help" id="emptyTimeline" style="display:none">××™×Ÿ ×¢×“×™×™×Ÿ ××™×¨×•×¢×™×.</div>
          </div>
        </section>

        <!-- Settings view -->
        <section class="card" id="viewSettings" style="display:none">
          <div class="head">
            <h2>×”×’×“×¨×•×ª</h2>
            <div class="muted small">×—×™×‘×•×¨ Google Sheets ×™×™×›× ×¡ ×›××Ÿ</div>
          </div>
          <div class="body">
            <div class="miniCard">
              <h3>×©××™×¨×”/××™×¤×•×¡</h3>
              <div class="row">
                <button class="btn" id="btnBackup" type="button">ğŸ’¾ ×™×¦× ×’×™×‘×•×™ JSON</button>
                <button class="btn danger" id="btnReset" type="button">ğŸ§¨ ××™×¤×•×¡ ×›×œ ×”× ×ª×•× ×™×</button>
              </div>
              <div class="sep"></div>
              <h3>Google Sheets (×‘×§×¨×•×‘)</h3>
              <div class="small muted">
                ×›×“×™ ×œ×—×‘×¨ ×œ×¡× ×›×¨×•×Ÿ, × ×¦×˜×¨×š:
                <ul>
                  <li>URL ×©×œ ×”-Web App</li>
                  <li>ID ×©×œ ×”×¤×¨×™×¡×” (Deployment)</li>
                  <li>×©× ×’×™×œ×™×•×Ÿ / ×˜××‘</li>
                </ul>
                ×‘×¨×’×¢ ×©×ª×©×œ×— ×œ×™ â€” ××•×¡×™×£ ×œ×š ×‘×§×•×“ ××ª ×”×—×™×‘×•×¨, ×¢× Fetch, ×•×”×›×œ ×™×¢×‘×•×“ ×“×¨×š ×”×©×™×˜.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">×›×•×ª×¨×ª</b>
      <button class="closeX" id="modalClose" title="×¡×’×•×¨">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   LEADUP â€¢ Local CRM
   ======================= */

const LS_KEY = "leadup_v1";
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyNdbO9dbvKkvWu6mG_jQx0vnzk3HDACRB4FhYkiNQTN_tKEZet-nNaZ7unKGgPGcDMFA/exec";

// Sync settings
const SYNC = {
  enabled: true,
  debounceMs: 700,
  showToasts: false
};

// Apps Script WebApp: ×©×•×œ×—×™× text/plain ×›×“×™ ×œ×”×™×× ×¢ ××‘×¢×™×•×ª CORS/Preflight
async function api(action, payload = {}){
  const res = await fetch(WEBAPP_URL, {
    method: "POST",
    headers: { "Content-Type": "text/plain;charset=utf-8" },
    body: JSON.stringify({ action, payload })
  });
  const data = await res.json().catch(()=>null);
  if(!data || data.ok !== true) throw new Error((data && data.error) ? data.error : "API error");
  return data;
}

const el = (id)=>document.getElementById(id);
const nowISO = () => new Date().toISOString();
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDT(iso){
  if(!iso) return "â€”";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "â€”";
  return d.toLocaleString("he-IL", { dateStyle:"medium", timeStyle:"short" });
}
function todayKey(){
  return new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
}
function toLocalDT(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const pad = (x)=>String(x).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromLocalDT(local){
  if(!local) return "";
  const d = new Date(local);
  if(Number.isNaN(d.getTime())) return "";
  return d.toISOString();
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultState(){
  return {
    user: { name: "×× ×”×œ", role: "Admin" },
    leads: [],
    tasks: [],
    events: []
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return { ...defaultState(), ...parsed };
  }catch(e){
    return defaultState();
  }
}
const appState = loadState();

let syncTimer = null;

function saveState(){
  // ×©××™×¨×” ××§×•××™×ª (×›×’×™×‘×•×™ ×•××”×™×¨×•×ª)
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
  renderAll();

  // ×¡× ×›×¨×•×Ÿ ×œ-Google Sheets (×¢× ×”×©×”×™×™×” ×§×˜× ×” ×œ×× ×™×¢×ª ×”×¦×¤×•×ª)
  if(!SYNC.enabled) return;

  clearTimeout(syncTimer);
  syncTimer = setTimeout(async ()=>{
    try{
      await api("state_push", { state: appState });
      if(SYNC.showToasts) toast("×¡×•× ×›×¨×Ÿ ×œ×’×•×’×œ ×©×™×˜ â˜ï¸");
    }catch(err){
      console.error("Sync error:", err);
      toast("âš ï¸ ×©×’×™××ª ×¡× ×›×¨×•×Ÿ ×œ×’×•×’×œ ×©×™×˜");
    }
  }, SYNC.debounceMs);




/* ===== Activity Timeline ===== */
function addEvent(type, text, meta={}){
  appState.events.unshift({
    id: uid("ev"),
    at: nowISO(),
    who: appState.user?.name || "××©×ª××©",
    type, text, meta
  });
  appState.events = appState.events.slice(0, 800);
}

/* ===== Lead Score ===== */
function sourceWeight(source){
  const s = (source||"").toLowerCase();
  if(["×”×¤× ×™×”","ref","referral"].some(x=>s.includes(x))) return 22;
  if(s.includes("×˜×œ×¤×•×Ÿ")) return 18;
  if(s.includes("×’×•×’×œ")) return 16;
  if(s.includes("××ª×¨")) return 14;
  if(s.includes("×¤×™×™×¡×‘×•×§")) return 12;
  return 10;
}
function statusWeight(status){
  switch(status){
    case "×—×“×©": return 10;
    case "× ×•×¦×¨ ×§×©×¨": return 18;
    case "××ª×¢× ×™×™×Ÿ": return 26;
    case "×”×¦×¢×ª ××—×™×¨": return 34;
    case "× ×¡×’×¨": return 40;
    case "×œ× ×¨×œ×•×•× ×˜×™": return 2;
    default: return 10;
  }
}
function computeScore(lead){
  const talks = clamp(Number(lead.contactCount||0), 0, 20);
  const talkScore = talks * 2.2; // max 44

  const base = 18;
  const src = sourceWeight(lead.source);
  const st = statusWeight(lead.status);

  const refDate = lead.lastContactAt || lead.createdAt || nowISO();
  const days = Math.floor((Date.now() - new Date(refDate).getTime()) / (1000*60*60*24));
  const recencyPenalty = clamp(days * 1.6, 0, 40);

  let score = base + src + st + talkScore - recencyPenalty;

  if(lead.status === "× ×¡×’×¨") score += 10;
  if(lead.status === "×œ× ×¨×œ×•×•× ×˜×™") score = Math.min(score, 15);

  return clamp(Math.round(score), 1, 100);
}
function heatTag(score){
  if(score >= 75) return { cls:"hot", label:"×—×" };
  if(score >= 45) return { cls:"ok", label:"×‘×™× ×•× ×™" };
  return { cls:"cold", label:"×§×¨" };
}

/* ===== Views ===== */
const nav = el("nav");
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  setView(btn.dataset.view);
});
function setView(view){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b.dataset.view===view));

  el("viewLeads").style.display = (view==="leads") ? "" : "none";
  el("viewRight").style.display = (view==="leads") ? "" : "none";
  el("viewTasks").style.display = (view==="tasks") ? "" : "none";
  el("viewTimeline").style.display = (view==="timeline") ? "" : "none";
  el("viewSettings").style.display = (view==="settings") ? "" : "none";

  const titles = {
    leads: ["×œ×™×“×™×", "× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘"],
    tasks: ["××©×™××•×ª", "×ª×–×›×•×¨×•×ª ×¢× ×ª××¨×™×š/×©×¢×” + ×¢×“×™×¤×•×ª + ×©×™×•×š ×œ×œ×™×“"],
    timeline: ["×”×™×¡×˜×•×¨×™×”", "Timeline ×©×œ ×›×œ ×¤×¢×•×œ×” ×•×©×™× ×•×™ ×‘××¢×¨×›×ª"],
    settings: ["×”×’×“×¨×•×ª", "×’×™×‘×•×™/××™×¤×•×¡ ×•×—×™×‘×•×¨ ×œ-Google Sheets"]
  };
  el("viewTitle").textContent = titles[view][0];
  el("viewSub").textContent = titles[view][1];

  renderAll();
}

/* ===== Modal ===== */
function openModal(title, html){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = html;
  el("modalBack").style.display = "flex";
}
function closeModal(){
  el("modalBack").style.display = "none";
  el("modalBody").innerHTML = "";
}
el("modalClose").addEventListener("click", closeModal);
el("modalBack").addEventListener("click", (e)=>{
  if(e.target === el("modalBack")) closeModal();
});

/* ===== Toast ===== */
let toastTimer=null;
function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.display="none", 2600);
}

/* ===== Filters/Search/Sort ===== */
el("q").addEventListener("input", renderLeads);
el("fStatus").addEventListener("change", renderLeads);
el("fSource").addEventListener("change", renderLeads);
el("sortBy").addEventListener("change", renderLeads);

/* ===== Buttons ===== */
el("btnAddLead").addEventListener("click", ()=>openLeadForm());
el("btnQuickTask").addEventListener("click", ()=> openTaskForm());
el("btnOpenInsights").addEventListener("click", ()=> openInsights());
el("btnSeed").addEventListener("click", seedSample);
el("btnExport").addEventListener("click", exportJSON);
el("btnImport").addEventListener("click", importJSON);
el("btnBackup").addEventListener("click", exportJSON);
el("btnReset").addEventListener("click", ()=>{
  if(confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.")){
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
});

/* ===== Shortcuts ===== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeModal();
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement?.tagName||"")){
    e.preventDefault();
    el("q").focus();
  }
  const modalOpen = (el("modalBack").style.display === "flex");
  if((e.key==="n" || e.key==="N") && !modalOpen){
    openLeadForm();
  }
});

function exportJSON(){
  const blob = new Blob([JSON.stringify(appState, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "leadup-backup.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("×’×™×‘×•×™ ×™×¨×“ ×œ××—×©×‘ âœ…");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const f = inp.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || typeof parsed !== "object") throw new Error("bad");
        appState.user = parsed.user || appState.user;
        appState.leads = Array.isArray(parsed.leads) ? parsed.leads : appState.leads;
        appState.tasks = Array.isArray(parsed.tasks) ? parsed.tasks : appState.tasks;
        appState.events = Array.isArray(parsed.events) ? parsed.events : appState.events;
        addEvent("import", "×™×™×‘×•× × ×ª×•× ×™× ×‘×•×¦×¢");
        saveState();
        toast("×™×™×‘×•× ×”×¦×œ×™×— âœ…");
      }catch(e){
        alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
      }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* =======================
   Leads CRUD
   ======================= */
function openLeadForm(leadId=null){
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;
  const isEdit = !!lead;

  const data = lead || {
    id: uid("lead"),
    name:"",
    phone:"",
    email:"",
    status:"×—×“×©",
    source:"××—×¨",
    owner:"×× ×”×œ",
    note:"",
    createdAt: nowISO(),
    lastContactAt:"",
    nextFollowUpAt:"",
    contactCount: 0
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ×œ×™×“" : "×œ×™×“ ×—×“×©", `
    <div class="split">
      <div>
        <form id="leadForm">
          <div class="row">
            <div>
              <label>×©× ××œ×</label>
              <input name="name" value="${escapeHTML(data.name)}" placeholder="×œ×“×•×’××”: ×™×©×¨××œ ×™×©×¨××œ×™" required/>
            </div>
            <div>
              <label>×˜×œ×¤×•×Ÿ</label>
              <input name="phone" value="${escapeHTML(data.phone)}" placeholder="05X-XXXXXXX" inputmode="tel"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××™××™×™×œ</label>
              <input name="email" value="${escapeHTML(data.email)}" placeholder="name@email.com" inputmode="email"/>
            </div>
            <div>
              <label>×‘×¢×œ×™× (× ×¦×™×’)</label>
              <input name="owner" value="${escapeHTML(data.owner||"×× ×”×œ")}" placeholder="×©× × ×¦×™×’"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>×¡×˜×˜×•×¡</label>
              <select name="status">
                ${["×—×“×©","× ×•×¦×¨ ×§×©×¨","××ª×¢× ×™×™×Ÿ","×”×¦×¢×ª ××—×™×¨","× ×¡×’×¨","×œ× ×¨×œ×•×•× ×˜×™"].map(s=>`
                  <option ${s===data.status?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
            <div>
              <label>××§×•×¨</label>
              <select name="source">
                ${["×¤×™×™×¡×‘×•×§","×’×•×’×œ","×”×¤× ×™×”","×˜×œ×¤×•×Ÿ","××ª×¨","××—×¨"].map(s=>`
                  <option ${s===data.source?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××¢×§×‘ ×”×‘× (×ª××¨×™×š/×©×¢×”)</label>
              <input name="nextFollowUpAt" value="${escapeHTML(toLocalDT(data.nextFollowUpAt))}" type="datetime-local"/>
            </div>
            <div>
              <label>×¢×“×›×•×Ÿ "×“×™×‘×¨× ×•" (××¢×œ×” score)</label>
              <button type="button" class="btn" id="btnTouch" style="width:100%">â˜ï¸ ×¡×™××•×Ÿ ×©×™×—×”/××¢× ×”</button>
              <div class="help">××¢×œ×” Contact Count + ××¢×“×›×Ÿ Last Contact.</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>×”×¢×¨×”</label>
            <textarea name="note" placeholder="×¨×©×•× ×¤×¨×˜×™× ×—×©×•×‘×™×â€¦">${escapeHTML(data.note||"")}</textarea>
          </div>

          <div class="sep"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            <button class="btn" type="button" id="btnCreateTask">â° ×¦×•×¨ ××©×™××” ×œ×œ×™×“</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteLead">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
            <button class="btn" type="button" id="btnOpenContact">ğŸ“² ×¤×¢×•×œ×•×ª ×§×©×¨</button>
          </div>

          <div class="help">
            Lead Score ××ª×—×©×‘ ×‘×¡×˜×˜×•×¡, ××§×•×¨, ×›××•×ª ×©×™×—×•×ª ×•×–××Ÿ ×©×¢×‘×¨.
          </div>
        </form>
      </div>

      <div>
        <div class="miniCard">
          <h3>×ª×¦×•×’×” ××”×™×¨×”</h3>
          <div class="small muted">× ×•×¦×¨: ${fmtDT(data.createdAt)}</div>
          <div class="small muted">×©×™×—×” ××—×¨×•× ×”: ${data.lastContactAt ? fmtDT(data.lastContactAt) : "â€”"}</div>
          <div class="small muted">×©×™×—×•×ª/××¢× ×™×: ${Number(data.contactCount||0)}</div>
          <div class="sep"></div>
          <div class="score">
            <div class="tag ${heatTag(computeScore(data)).cls}">ğŸ”¥ ${heatTag(computeScore(data)).label}</div>
            <div style="font-weight:800">${computeScore(data)}/100</div>
          </div>
          <div class="bar" style="margin-top:10px"><i style="width:${computeScore(data)}%"></i></div>
          <div class="help">×›×›×œ ×©×”×¦×™×•×Ÿ ×’×‘×•×” ×™×•×ª×¨â€”×”×œ×™×“ â€œ×—×â€ ×™×•×ª×¨.</div>
        </div>

        <div class="miniCard" style="margin-top:10px">
          <h3>×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h3>
          <div class="actions">
            <button type="button" class="iconBtn gold" title="×•×•××˜×¡××¤" id="qaWA">ğŸ’¬</button>
            <button type="button" class="iconBtn" title="×”×ª×§×©×¨" id="qaCall">ğŸ“</button>
            <button type="button" class="iconBtn" title="××™××™×™×œ" id="qaMail">âœ‰ï¸</button>
            <button type="button" class="iconBtn" title="×”×¢×ª×§ ×˜×œ×¤×•×Ÿ" id="qaCopy">ğŸ“‹</button>
          </div>
          <div class="help">×›××Ÿ ×”×›×œ ×‘×ª×•×š ××•×“××œ (×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×“×©).</div>
        </div>
      </div>
    </div>
  `);

  const form = document.getElementById("leadForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.nextFollowUpAt = fromLocalDT(updated.nextFollowUpAt);
    updated.createdAt = data.createdAt || nowISO();

    const idx = appState.leads.findIndex(l=>l.id===updated.id);
    if(idx>=0){
      appState.leads[idx] = updated;
      addEvent("lead_update", `×¢×•×“×›×Ÿ ×œ×™×“: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ ×¢×•×“×›×Ÿ âœ…");
    }else{
      appState.leads.unshift(updated);
      addEvent("lead_create", `× ×•×¦×¨ ×œ×™×“ ×—×“×©: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ × ×•×¡×£ âœ…");
    }
    saveState();
    closeModal();
  });

  document.getElementById("btnTouch").addEventListener("click", ()=>{
    data.contactCount = Number(data.contactCount||0) + 1;
    data.lastContactAt = nowISO();
    addEvent("contact", `×©×™×—×”/××¢× ×” ×¡×•××Ÿ ×œ×œ×™×“: ${data.name||"(×œ×œ× ×©×)"}`, {leadId:data.id});
    toast("×¡×•××Ÿ ×©×™×—×” âœ…");
    const idx = appState.leads.findIndex(l=>l.id===data.id);
    if(idx>=0) appState.leads[idx] = data;
    else appState.leads.unshift(data);
    saveState();
    openLeadForm(data.id);
  });

  if(isEdit){
    document.getElementById("btnDeleteLead").addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”×œ×™×“?")) return;
      appState.leads = appState.leads.filter(l=>l.id!==leadId);
      appState.tasks = appState.tasks.filter(t=>t.leadId!==leadId);
      addEvent("lead_delete", `× ××—×§ ×œ×™×“: ${lead.name}`, {leadId});
      saveState();
      closeModal();
      toast("×œ×™×“ × ××—×§ ğŸ—‘ï¸");
    });
  }

  document.getElementById("btnCreateTask").addEventListener("click", ()=>{
    openTaskForm({ leadId: data.id, leadName: data.name, presetDate: data.nextFollowUpAt });
  });

  document.getElementById("btnOpenContact").addEventListener("click", ()=>{
    openContactPanel(data);
  });

  document.getElementById("qaWA").addEventListener("click", ()=> openContactPanel(data, "wa"));
  document.getElementById("qaCall").addEventListener("click", ()=> openContactPanel(data, "call"));
  document.getElementById("qaMail").addEventListener("click", ()=> openContactPanel(data, "mail"));
  document.getElementById("qaCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(data.phone||"");
      toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹");
    }catch{
      toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×‘×“×¤×“×¤×Ÿ ×”×–×”");
    }
  });
}

/* ===== Contact panel (in-modal) ===== */
function normalizeILPhone(phone){
  const digits = String(phone||"").replace(/[^\d]/g,"");
  if(!digits) return "";
  // if starts with 0 -> IL
  if(digits.startsWith("0")) return "972" + digits.slice(1);
  // already includes country?
  if(digits.startsWith("972")) return digits;
  // fallback
  return digits;
}

function openContactPanel(lead, focus="wa"){
  const phoneIL = normalizeILPhone(lead.phone);
  const mail = (lead.email||"").trim();
  const waWeb = phoneIL ? `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}` : "";
  const tel = (lead.phone||"").trim();
  const mailto = mail ? `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent("LEADUP - ×¤× ×™×”")}` : "";

  openModal(`×¤×¢×•×œ×•×ª ×§×©×¨ â€¢ ${lead.name || "×œ×™×“"}`, `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¤×¨×˜×™ ×§×©×¨</h3>
        <div class="small muted">×˜×œ×¤×•×Ÿ: <b>${escapeHTML(lead.phone||"â€”")}</b></div>
        <div class="small muted" style="margin-top:6px">××™××™×™×œ: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cWA" ${waWeb? "":"disabled"}>ğŸ’¬ ×•×•××˜×¡××¤</button>
          <button class="btn" type="button" id="cCall" ${tel? "":"disabled"}>ğŸ“ ×”×ª×§×©×¨</button>
          <button class="btn" type="button" id="cMail" ${mailto? "":"disabled"}>âœ‰ï¸ ××™×™×œ</button>
          <button class="btn" type="button" id="cCopyPhone" ${tel? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
          <button class="btn" type="button" id="cCopyMail" ${mail? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
        </div>

        <div class="help">
          ×”×¢×¨×”: â€œ×”×ª×§×©×¨â€ / â€œ××™×™×œâ€ ×œ× × ×¤×ª×—×™× ×‘×ª×•×š iframe ×‘×’×œ×œ ××’×‘×œ×•×ª ×“×¤×“×¤×Ÿ,
          ××‘×œ × ×©××¨×™× ×‘×ª×•×š ×”××•×“××œ ×¢× ×›×¤×ª×•×¨×™ ×”×¢×ª×§×” + ×§×™×©×•×¨.
        </div>

        <div class="sep"></div>
        <div class="miniCard" style="margin:0; background:rgba(255,255,255,.02)">
          <h3 style="margin-bottom:8px">×”×•×“×¢×” ××”×™×¨×” ×œ×•×•××˜×¡××¤</h3>
          <label>×˜×§×¡×˜</label>
          <textarea id="waText" placeholder="×”×™×™ ${escapeHTML(lead.name||"")}, ××“×‘×¨/×ª ×-...">${escapeHTML(`×”×™×™ ${lead.name||""}, ××“×‘×¨/×ª ×-LEADUP. ××¤×©×¨ ×œ×¢×–×•×¨?`)}</textarea>
          <button class="btn gold" type="button" id="waOpenMsg" style="margin-top:10px" ${waWeb? "":"disabled"}>ğŸš€ ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×”×•×“×¢×”</button>
        </div>
      </div>

      <div class="miniCard">
        <h3>×ª×¦×•×’×” ×‘×ª×•×š ×”××¢×¨×›×ª</h3>
        ${waWeb ? `
          <div class="frame">
            <iframe id="waFrame" src="${escapeHTML(waWeb)}"></iframe>
          </div>
          <div class="help">×× ×œ× ×”×ª×—×‘×¨×ª ×œ-WhatsApp Web ×‘××—×©×‘, ×ª×¦×˜×¨×š ×œ×”×ª×—×‘×¨ ×¤×¢× ××—×ª.</div>
        ` : `
          <div class="help">××™×Ÿ ×˜×œ×¤×•×Ÿ ×œ×œ×™×“ â€” ×”×•×¡×£ ××¡×¤×¨ ×•××– ×ª×•×›×œ ×œ×¤×ª×•×— WhatsApp Web ×›××Ÿ.</div>
        `}
      </div>
    </div>
  `);

  // wire buttons
  const cWA = document.getElementById("cWA");
  const cCall = document.getElementById("cCall");
  const cMail = document.getElementById("cMail");
  const cCopyPhone = document.getElementById("cCopyPhone");
  const cCopyMail = document.getElementById("cCopyMail");

  if(cWA) cWA.addEventListener("click", ()=>{
    if(!waWeb) return;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = waWeb;
    addEvent("contact_open", `× ×¤×ª×— ×•×•××˜×¡××¤ ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  if(cCall) cCall.addEventListener("click", async ()=>{
    // keep inside modal: show link and copy
    addEvent("call_hint", `× ×™×¡×™×•×Ÿ ×”×ª×§×©×¨×•×ª (×§×™×©×•×¨ Tel) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    toast("×”×¢×ª×§× ×• ×œ×š/×¦×™×¨×¤× ×• ×§×™×©×•×¨ ×œ×”×ª×§×©×¨×•×ª ×‘×ª×•×š ×”××•×“××œ");
    openModal(`×”×ª×§×©×¨ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×”×ª×§×©×¨×•×ª</h3>
        <div class="small muted">××¡×¤×¨: <b>${escapeHTML(tel||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="ccCopy">ğŸ“‹ ×”×¢×ª×§ ××¡×¤×¨</button>
          <a class="btn" href="${escapeHTML(tel ? "tel:"+tel.replace(/[^\d+]/g,"") : "#")}" style="text-decoration:none; ${tel? "":"pointer-events:none;opacity:.6"}">ğŸ“ ×—×™×™×’ (×× ×”×“×¤×“×¤×Ÿ ×××¤×©×¨)</a>
        </div>
        <div class="help">×‘××—×©×‘ ×œ×¤×¢××™× Tel ×œ× ×¢×•×‘×“ â€” ××– ×”×›×™ ×˜×•×‘ ×œ×”×¢×ª×™×§ ×•×œ×”×ª×§×©×¨ ××”× ×™×™×“.</div>
      </div>
    `);
    document.getElementById("ccCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(tel||""); toast("×”××¡×¤×¨ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cMail) cMail.addEventListener("click", ()=>{
    addEvent("mail_hint", `× ×¤×ª×— ××™×™×œ (mailto) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    openModal(`××™×™×œ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×©×œ×™×—×ª ××™×™×œ</h3>
        <div class="small muted">×›×ª×•×‘×ª: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cmCopy">ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
          <a class="btn" href="${escapeHTML(mailto)}" style="text-decoration:none; ${mailto? "":"pointer-events:none;opacity:.6"}">âœ‰ï¸ ×¤×ª×— ×ª×•×›× ×ª ××™×™×œ</a>
        </div>
        <div class="help">mailto ×ª×œ×•×™ ×‘×”×’×“×¨×•×ª ×”××—×©×‘ ×©×œ×š (Gmail/Outlook ×•×›×•'). ×× ×œ× × ×¤×ª×—â€”×¤×©×•×˜ ×”×¢×ª×§.</div>
      </div>
    `);
    document.getElementById("cmCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cCopyPhone) cCopyPhone.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(tel||""); toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });
  if(cCopyMail) cCopyMail.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });

  document.getElementById("waOpenMsg")?.addEventListener("click", ()=>{
    if(!phoneIL) return;
    const txt = document.getElementById("waText")?.value || "";
    // WhatsApp web message param
    const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}&text=${encodeURIComponent(txt)}`;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = url;
    addEvent("wa_msg", `× ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×•×“×¢×” ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  // focus
  if(focus==="wa") cWA?.click();
}

/* =======================
   Tasks CRUD
   ======================= */
function openTaskForm(opts={}){
  // opts: { taskId, leadId, leadName, presetDate }
  const task = opts.taskId ? appState.tasks.find(t=>t.id===opts.taskId) : null;
  const isEdit = !!task;

  const leadId = opts.leadId || task?.leadId || "";
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;

  const data = task || {
    id: uid("task"),
    leadId: leadId || "",
    title: "",
    dueAt: opts.presetDate || "",
    priority: "×‘×™× ×•× ×™×ª",
    status: "×¤×ª×•×—×”",
    createdAt: nowISO()
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ××©×™××”" : "××©×™××” ×—×“×©×”", `
    <form id="taskForm">
      <div class="row">
        <div>
          <label>×©×™×™×š ×œ×œ×™×“</label>
          <select name="leadId">
            <option value="">×œ×œ× ×©×™×•×š</option>
            ${appState.leads.map(l=>`
              <option value="${escapeHTML(l.id)}" ${l.id===data.leadId?"selected":""}>${escapeHTML(l.name || "(×œ×œ× ×©×)")}</option>
            `).join("")}
          </select>
          <div class="help">${lead ? `× ×‘×—×¨: <b>${escapeHTML(lead.name)}</b>` : "××¤×©×¨ ×œ×‘×—×•×¨ ×œ×™×“ ××• ×œ×”×©××™×¨ ×œ×œ× ×©×™×•×š."}</div>
        </div>
        <div>
          <label>××ª×™ (×ª××¨×™×š/×©×¢×”)</label>
          <input name="dueAt" type="datetime-local" value="${escapeHTML(toLocalDT(data.dueAt))}"/>
          <div class="help">××¤×©×¨ ×’× â€œ×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×â€ ×œ××˜×”.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>×¢×“×™×¤×•×ª</label>
          <select name="priority">
            ${["×’×‘×•×”×”","×‘×™× ×•× ×™×ª","× ××•×›×”"].map(p=>`
              <option ${p===data.priority?"selected":""}>${p}</option>
            `).join("")}
          </select>
        </div>
        <div>
          <label>×¡×˜×˜×•×¡</label>
          <select name="status">
            ${["×¤×ª×•×—×”","×‘×•×¦×¢×”"].map(s=>`
              <option ${s===data.status?"selected":""}>${s}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>×ª×™××•×¨</label>
        <textarea name="title" placeholder="×œ×“×•×’××”: ×œ×—×–×•×¨ ×œ×œ×™×“ ×•×œ×ª×ª ×”×¦×¢×ª ××—×™×¨â€¦">${escapeHTML(data.title||"")}</textarea>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×</label>
          <div style="display:flex; gap:10px">
            <input id="xDays" type="number" min="0" placeholder="×œ×“×•×’××”: 3"/>
            <button type="button" class="btn" id="btnApplyX">ğŸ“… ×§×‘×¢ ×ª××¨×™×š</button>
          </div>
          <div class="help">×™×§×‘×¢ Due ×œ×¤×™ ×¢×›×©×™×• + X ×™××™×.</div>
        </div>
        <div>
          <label>×¤×¢×•×œ×•×ª</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteTask">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
          </div>
        </div>
      </div>
    </form>
  `);

  document.getElementById("btnApplyX")?.addEventListener("click", ()=>{
    const x = Number(document.getElementById("xDays")?.value || 0);
    const d = new Date();
    d.setDate(d.getDate() + (Number.isFinite(x)? x : 0));
    const local = toLocalDT(d.toISOString());
    const due = document.querySelector('#taskForm input[name="dueAt"]');
    if(due) due.value = local;
    toast("× ×§×‘×¢ ×ª××¨×™×š âœ…");
  });

  const form = document.getElementById("taskForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.dueAt = fromLocalDT(updated.dueAt);

    const idx = appState.tasks.findIndex(t=>t.id===updated.id);
    const leadName = updated.leadId ? (appState.leads.find(l=>l.id===updated.leadId)?.name || "×œ×™×“") : "×œ×œ× ×©×™×•×š";
    if(idx>=0){
      appState.tasks[idx] = updated;
      addEvent("task_update", `×¢×•×“×›× ×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” ×¢×•×“×›× ×” âœ…");
    }else{
      appState.tasks.unshift(updated);
      addEvent("task_create", `× ×•×¦×¨×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” × ×•×¡×¤×” âœ…");
    }
    saveState();
    closeModal();
  });

  if(isEdit){
    document.getElementById("btnDeleteTask")?.addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”××©×™××”?")) return;
      appState.tasks = appState.tasks.filter(t=>t.id!==data.id);
      addEvent("task_delete", `× ××—×§×” ××©×™××”`, {taskId: data.id, leadId: data.leadId||""});
      saveState();
      closeModal();
      toast("××©×™××” × ××—×§×” ğŸ—‘ï¸");
    });
  }
}

function toggleTaskDone(taskId){
  const t = appState.tasks.find(x=>x.id===taskId);
  if(!t) return;
  t.status = (t.status==="×‘×•×¦×¢×”") ? "×¤×ª×•×—×”" : "×‘×•×¦×¢×”";
  addEvent("task_toggle", `×¡×˜×˜×•×¡ ××©×™××”: ${t.status}`, {taskId: t.id, leadId: t.leadId||""});
  saveState();
}

/* =======================
   Rendering
   ======================= */
function renderAll(){
  renderStats();
  renderLeads();
  renderTasks();
  renderTimeline();
  renderNavCounts();
}

function renderNavCounts(){
  el("navCount").textContent = String(appState.leads.length);
  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;
  el("navTasks").textContent = String(openTasks);
  el("navEvents").textContent = String(appState.events.length);
}

function renderStats(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const hot = scores.filter(s=>s>=75).length;

  const today = todayKey();
  const todayFollow = appState.leads.filter(l=>{
    if(!l.nextFollowUpAt) return false;
    const d = new Date(l.nextFollowUpAt);
    if(Number.isNaN(d.getTime())) return false;
    const k = d.toLocaleDateString("sv-SE");
    return k === today;
  }).length;

  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;

  el("stTotal").textContent = String(total);
  el("stHot").textContent = String(hot);
  el("stToday").textContent = String(todayFollow);
  el("stTasks").textContent = String(openTasks);
}

function getFilteredSortedLeads(){
  const q = (el("q").value||"").trim().toLowerCase();
  const fStatus = el("fStatus").value;
  const fSource = el("fSource").value;
  const sortBy = el("sortBy").value;

  let arr = [...appState.leads];

  if(q){
    arr = arr.filter(l=>{
      const hay = [
        l.name, l.phone, l.email, l.status, l.source, l.owner, l.note
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  if(fStatus) arr = arr.filter(l=> (l.status||"")===fStatus);
  if(fSource) arr = arr.filter(l=> (l.source||"")===fSource);

  const scoreOf = (l)=>computeScore(l);
  const nextTime = (l)=> l.nextFollowUpAt ? new Date(l.nextFollowUpAt).getTime() : Infinity;
  const createdTime = (l)=> l.createdAt ? new Date(l.createdAt).getTime() : 0;

  if(sortBy==="hot"){
    arr.sort((a,b)=> scoreOf(b)-scoreOf(a));
  }else if(sortBy==="next"){
    arr.sort((a,b)=> nextTime(a)-nextTime(b));
  }else if(sortBy==="newest"){
    arr.sort((a,b)=> createdTime(b)-createdTime(a));
  }else if(sortBy==="oldest"){
    arr.sort((a,b)=> createdTime(a)-createdTime(b));
  }
  return arr;
}

function renderLeads(){
  const tbody = el("leadsTbody");
  const leads = getFilteredSortedLeads();

  el("emptyLeads").style.display = (appState.leads.length===0) ? "" : "none";

  tbody.innerHTML = leads.map(l=>{
    const score = computeScore(l);
    const ht = heatTag(score);
    return `
      <tr>
        <td><b>${escapeHTML(l.name||"â€”")}</b><div class="small muted">${escapeHTML(l.owner||"")}</div></td>
        <td>${escapeHTML(l.phone||"â€”")}</td>
        <td><span class="tag">${escapeHTML(l.status||"â€”")}</span></td>
        <td><span class="tag">${escapeHTML(l.source||"â€”")}</span></td>
        <td>
          <div class="score">
            <span class="tag ${ht.cls}">${ht.label}</span>
            <b>${score}</b>
          </div>
          <div class="bar" style="margin-top:8px"><i style="width:${score}%"></i></div>
        </td>
        <td>${l.nextFollowUpAt ? fmtDT(l.nextFollowUpAt) : "â€”"}</td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-act="edit" data-id="${escapeHTML(l.id)}">âœ</button>
            <button class="iconBtn" title="××©×™××”" data-act="task" data-id="${escapeHTML(l.id)}">â°</button>
            <button class="iconBtn" title="×§×©×¨" data-act="contact" data-id="${escapeHTML(l.id)}">ğŸ“²</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="edit") openLeadForm(id);
      if(act==="task"){
        const lead = appState.leads.find(l=>l.id===id);
        openTaskForm({ leadId:id, leadName: lead?.name || "" , presetDate: lead?.nextFollowUpAt || ""});
      }
      if(act==="contact"){
        const lead = appState.leads.find(l=>l.id===id);
        if(lead) openContactPanel(lead);
      }
    });
  });
}

function renderTasks(){
  const tbody = el("tasksTbody");
  const tasks = [...appState.tasks].sort((a,b)=>{
    const da = a.dueAt ? new Date(a.dueAt).getTime() : Infinity;
    const db = b.dueAt ? new Date(b.dueAt).getTime() : Infinity;
    return da-db;
  });

  const openTasks = tasks.filter(t=>t.status!=="×‘×•×¦×¢×”");
  el("emptyTasks").style.display = (openTasks.length===0) ? "" : "none";

  tbody.innerHTML = openTasks.map(t=>{
    const leadName = t.leadId ? (appState.leads.find(l=>l.id===t.leadId)?.name || "×œ×™×“") : "â€”";
    const priTag = t.priority==="×’×‘×•×”×”" ? "hot" : (t.priority==="×‘×™× ×•× ×™×ª" ? "ok" : "cold");
    return `
      <tr>
        <td>${t.dueAt ? fmtDT(t.dueAt) : "â€”"}</td>
        <td><span class="tag ${priTag}">${escapeHTML(t.priority||"")}</span></td>
        <td>${escapeHTML(leadName)}</td>
        <td>${escapeHTML(t.title||"")}</td>
        <td><span class="tag">${escapeHTML(t.status||"")}</span></td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-tact="edit" data-id="${escapeHTML(t.id)}">âœ</button>
            <button class="iconBtn" title="×‘×•×¦×¢×”/×¤×ª×•×—×”" data-tact="done" data-id="${escapeHTML(t.id)}">âœ“</button>
            <button class="iconBtn" title="××—×™×§×”" data-tact="del" data-id="${escapeHTML(t.id)}">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-tact]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-tact");
      if(act==="edit") openTaskForm({ taskId:id });
      if(act==="done") toggleTaskDone(id);
      if(act==="del"){
        if(!confirm("×œ××—×•×§ ××©×™××”?")) return;
        appState.tasks = appState.tasks.filter(t=>t.id!==id);
        addEvent("task_delete", "× ××—×§×” ××©×™××”", {taskId:id});
        saveState();
      }
    });
  });
}

function renderTimeline(){
  const list = el("timelineList");
  const events = appState.events.slice(0, 200);
  el("emptyTimeline").style.display = (events.length===0) ? "" : "none";

  list.innerHTML = events.map(ev=>{
    const who = ev.who || "××©×ª××©";
    return `
      <div class="event">
        <div class="t">${fmtDT(ev.at)} â€¢ ${escapeHTML(who)} â€¢ <span class="muted">${escapeHTML(ev.type||"")}</span></div>
        <div class="d">${escapeHTML(ev.text||"")}</div>
      </div>
    `;
  }).join("");
}

/* =======================
   Insights
   ======================= */
function openInsights(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

  const byStatus = {};
  for(const l of appState.leads){
    const k = l.status || "×œ× ××•×’×“×¨";
    byStatus[k] = (byStatus[k]||0)+1;
  }
  const bySource = {};
  for(const l of appState.leads){
    const k = l.source || "×œ× ××•×’×“×¨";
    bySource[k] = (bySource[k]||0)+1;
  }

  const topHot = [...appState.leads]
    .sort((a,b)=>computeScore(b)-computeScore(a))
    .slice(0, 5);

  openModal("×¡×˜×˜×™×¡×˜×™×§×•×ª â€¢ LEADUP", `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¡×™×›×•×</h3>
        <div class="small muted">×¡×”×´×› ×œ×™×“×™×: <b>${total}</b></div>
        <div class="small muted">×××•×¦×¢ Score: <b>${avg}</b></div>
        <div class="sep"></div>
        <h3>Top 5 ×—××™×</h3>
        ${topHot.length ? topHot.map(l=>`
          <div class="event">
            <div class="t">${escapeHTML(l.name||"â€”")} â€¢ ${escapeHTML(l.status||"")}</div>
            <div class="d"><b>${computeScore(l)}</b>/100 â€¢ ${l.nextFollowUpAt ? "××¢×§×‘: "+fmtDT(l.nextFollowUpAt) : "×œ×œ× ××¢×§×‘"}</div>
          </div>
        `).join("") : `<div class="help">××™×Ÿ ×œ×™×“×™×.</div>`}
      </div>

      <div class="miniCard">
        <h3>×”×ª×¤×œ×’×•×ª</h3>
        <div class="small muted"><b>×œ×¤×™ ×¡×˜×˜×•×¡</b></div>
        ${Object.keys(byStatus).length ? Object.entries(byStatus).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
        <div class="sep"></div>
        <div class="small muted"><b>×œ×¤×™ ××§×•×¨</b></div>
        ${Object.keys(bySource).length ? Object.entries(bySource).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
      </div>
    </div>
  `);
}

/* =======================
   Seed sample data
   ======================= */
function seedSample(){
  if(appState.leads.length && !confirm("×›×‘×¨ ×™×© ×œ×™×“×™×. ×œ×”×•×¡×™×£ ×¢×•×“ ×“×•×’×××•×ª?")) return;

  const mkLead = (name, phone, status, source, nextDays, talks=0)=>({
    id: uid("lead"),
    name, phone,
    email: "",
    status, source,
    owner: "×× ×”×œ",
    note: "×“×•×’××”",
    createdAt: new Date(Date.now() - (Math.random()*8+1)*86400000).toISOString(),
    lastContactAt: talks ? new Date(Date.now() - (Math.random()*4+1)*86400000).toISOString() : "",
    nextFollowUpAt: nextDays!=null ? new Date(Date.now()+nextDays*86400000).toISOString() : "",
    contactCount: talks
  });

  const demo = [
    mkLead("××™×ª×™ ×›×”×Ÿ","052-1234567","××ª×¢× ×™×™×Ÿ","×”×¤× ×™×”",1,3),
    mkLead("× ×•×¢×” ×œ×•×™","054-9876543","× ×•×¦×¨ ×§×©×¨","×¤×™×™×¡×‘×•×§",0,1),
    mkLead("×“× ×™××œ ××•×—× ×”","050-2223344","×”×¦×¢×ª ××—×™×¨","×’×•×’×œ",2,4),
    mkLead("×¨×•×¢×™ ×‘×™×˜×•×Ÿ","053-5556677","×—×“×©","××ª×¨",3,0),
    mkLead("×©×—×¨ ×××Ÿ","052-7654321","× ×¡×’×¨","×˜×œ×¤×•×Ÿ",null,6),
  ];

  appState.leads.unshift(...demo);
  addEvent("seed", "× ×•×¦×¨×• ×œ×™×“×™× ×œ×“×•×’××”");
  // ×’× ××©×™××•×ª ×œ×“×•×’××”
  appState.tasks.unshift(
    { id: uid("task"), leadId: demo[0].id, title:"×œ×—×–×•×¨ ×¢× ×”×¦×¢×ª ××—×™×¨", dueAt: new Date(Date.now()+86400000).toISOString(), priority:"×’×‘×•×”×”", status:"×¤×ª×•×—×”", createdAt: nowISO() },
    { id: uid("task"), leadId: demo[2].id, title:"×‘×“×™×§×ª ××¡××›×™×", dueAt: new Date(Date.now()+2*86400000).toISOString(), priority:"×‘×™× ×•× ×™×ª", status:"×¤×ª×•×—×”", createdAt: nowISO() }
  );
  addEvent("seed", "× ×•×¦×¨×• ××©×™××•×ª ×œ×“×•×’××”");
  saveState();
  toast("× ×•×¦×¨×• ×“×•×’×××•×ª âœ…");
}

/* =======================
   Init
   ======================= */
(function init(){
  if(!appState.events.length){
    addEvent("init", "×”××¢×¨×›×ª ×¢×œ×ª×” â€¢ ××¦×‘ LocalStorage");
    saveState();
  }else{
    renderAll();
  }
})();
</script>
</body>
</html>
