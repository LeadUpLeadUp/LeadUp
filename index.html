

<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LEADUP â€¢ ××¢×¨×›×ª × ×™×”×•×œ ×œ×™×“×™×</title>
  <meta name="theme-color" content="#0b0b0f"/>
  <style>
    :root{
      --bg:#07070a;
      --panel:#0c0c12;
      --panel2:#10101a;
      --line:rgba(255,255,255,.10);
      --text:#ffffff;
      --muted:rgba(255,255,255,.72);
      --muted2:rgba(255,255,255,.55);
      --gold:#d6b25e;
      --gold2:#f2d27c;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow:0 20px 60px rgba(0,0,0,.55);
      --shadow2:0 12px 30px rgba(0,0,0,.40);
      --r:18px;
      --r2:22px;
      --focus: 0 0 0 3px rgba(214,178,94,.22);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans Hebrew", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.10), transparent 55%),
        radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.06), transparent 60%),
        linear-gradient(180deg, #06060a, #050509);
      color:var(--text);
      font-family:var(--font);
      overflow:hidden;
    }
    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      height:100vh;
    }

    /* Sidebar */
    .side{
      border-left:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
      padding:18px 16px;
      overflow:auto;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 16px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 20%, rgba(242,210,124,.45), transparent 55%),
        linear-gradient(145deg, rgba(214,178,94,.50), rgba(214,178,94,.08));
      box-shadow:0 12px 30px rgba(214,178,94,.12);
      border:1px solid rgba(214,178,94,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px dashed rgba(255,255,255,.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.6px;
    }
    .brand .sub{
      margin-top:2px;
      color:var(--muted2);
      font-size:12px;
    }
    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:right;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:.18s ease;
    }
    .nav button:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .nav button.active{
      background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.04));
      border-color:rgba(214,178,94,.35);
      box-shadow:0 14px 32px rgba(214,178,94,.08);
    }
    .nav .k{
      display:flex;align-items:center;gap:10px;
      font-weight:650;
    }
    .pill{
      font-size:12px;
      color:rgba(255,255,255,.85);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
    }
    .pill.gold{border-color:rgba(214,178,94,.35); color:rgba(242,210,124,.95)}
    .sideFooter{
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--line);
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .sideFooter .hint{
      margin-top:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,94,.18);
      border-radius:14px;
      background:rgba(214,178,94,.06);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(214,178,94,.30);
      background:rgba(214,178,94,.10);
      color:rgba(242,210,124,.95);
      font-size:12px;
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--gold2);box-shadow:0 0 0 4px rgba(242,210,124,.18)}
    .topbar .title{
      display:flex; flex-direction:column;
    }
    .topbar .title b{font-size:16px}
    .topbar .title span{color:var(--muted2);font-size:12px;margin-top:2px}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:650;
    }
    /* Fix: keep '×œ×™×“ ×—×“×©' button on one line */
    #btnAddLead{white-space:nowrap; flex-shrink:0; min-width:120px; justify-content:center;}

    .btn:hover{transform:translateY(-1px); border-color:rgba(214,178,94,.25)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.gold{
      background:linear-gradient(180deg, rgba(214,178,94,.26), rgba(255,255,255,.05));
      border-color:rgba(214,178,94,.35);
      color:rgba(242,210,124,.98);
    }
    .btn.danger{
      border-color:rgba(255,107,107,.28);
      background:rgba(255,107,107,.08);
    }
    .search{
      position:relative;
      min-width:320px;
      max-width:520px;
      width:38vw;
    }
    .search input{
      width:100%;
      padding:12px 40px 12px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
    }
    .search input:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .search .icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:rgba(255,255,255,.55);
      font-size:14px;
      pointer-events:none;
    }
    .content{
      padding:16px 18px 22px;
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.55fr 0.45fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1060px){
      .app{grid-template-columns: 1fr}
      .side{display:none}
      .grid{grid-template-columns: 1fr}
      body{overflow:auto}
      .main{height:auto}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .card .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(255,255,255,.09);
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .card .body{padding:12px 14px 14px}
    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .stats{grid-template-columns: repeat(2, 1fr)} }
    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset:-80px -60px auto auto;
      width:160px;height:160px;border-radius:50%;
      background:rgba(214,178,94,.10);
      filter:blur(2px);
    }
    .stat .k{color:var(--muted2); font-size:12px}
    .stat .v{margin-top:6px; font-size:20px; font-weight:800}
    .stat .mini{margin-top:3px; font-size:12px; color:rgba(242,210,124,.86)}
    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width:920px;
    }
    thead th{
      text-align:right;
      padding:12px 10px;
      color:rgba(255,255,255,.72);
      font-weight:700;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(255,255,255,.07);
      vertical-align:middle;
      color:rgba(255,255,255,.92);
    }
    tbody tr:hover td{background:rgba(214,178,94,.05)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.hot{border-color:rgba(255,204,102,.35); background:rgba(255,204,102,.08); color:rgba(255,204,102,.95)}
    .tag.ok{border-color:rgba(46,229,157,.30); background:rgba(46,229,157,.08); color:rgba(46,229,157,.95)}
    .tag.cold{border-color:rgba(255,255,255,.14); background:rgba(255,255,255,.03); color:rgba(255,255,255,.78)}
    .score{
      display:flex; align-items:center; gap:10px;
    }
    .bar{
      width:120px; height:10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      background:linear-gradient(90deg, rgba(214,178,94,.25), rgba(242,210,124,.65));
      width:50%;
    }
    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-start;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:.16s ease;
    }
    .iconBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.25)}
    .iconBtn.gold{border-color:rgba(214,178,94,.30); background:rgba(214,178,94,.10)}
    .muted{color:var(--muted2)}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){ .row{grid-template-columns:1fr} table{min-width:800px} }
    label{display:block; font-size:12px; color:rgba(255,255,255,.70); margin-bottom:6px}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30);
      color:var(--text);
      outline:none;
      transition:.18s ease;
      font-family:inherit;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.25)}
    .help{
      margin-top:8px;
      color:rgba(255,255,255,.62);
      font-size:12px;
      line-height:1.4;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
  max-height:min(86vh, 900px);
  overflow:auto;
  border-radius:24px;
  border:1px solid rgba(255,255,255,.14);
      background:
     radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.10), transparent 55%),
    linear-gradient(180deg, rgba(10,10,18,.98), rgba(6,6,12,.96));
      box-shadow:0 30px 90px rgba(0,0,0,.85);
      position:relative;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.10);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(0,0,0,.18);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:2;
    }
    .modalHeader b{font-size:14px}
    .modalBody{padding:14px 16px 16px}
    .closeX{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      cursor:pointer;
      color:var(--text);
    }
    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      background:rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(520px, calc(100vw - 36px));
    }
    .split{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }
    .miniCard{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22);
      border-radius:18px;
      padding:12px;
    }
    .miniCard h3{margin:0 0 10px 0; font-size:13px}
    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height:500px; overflow:auto; padding-left:4px;
    }
    .event{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px 10px;
    }
    .event .t{font-size:12px; color:rgba(255,255,255,.75)}
    .event .d{margin-top:4px; font-size:13px}
    .kbd{
      font-size:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
      border-bottom-color:rgba(255,255,255,.24);
      padding:2px 8px;
      border-radius:10px;
      color:rgba(255,255,255,.85);
    }
    .small{font-size:12px}
    .sep{height:1px;background:rgba(255,255,255,.10); margin:12px 0}

    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){ .twoCols{grid-template-columns:1fr} }

    .frame{
      width:100%;
      height:460px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:hidden;
    }
    .frame iframe{width:100%;height:100%;border:0}
  
/* =======================
   Light Cream Theme (override)
   ======================= */
:root{
  --bg:#fbf7ef;
  --panel:#ffffff;
  --panel2:#f6f0e4;
  --line:rgba(20,20,30,.10);
  --text:#121218;
  --muted:rgba(18,18,24,.70);
  --muted2:rgba(18,18,24,.52);
  --shadow:0 20px 60px rgba(20,20,30,.14);
  --shadow2:0 12px 30px rgba(20,20,30,.12);
  --focus: 0 0 0 3px rgba(214,178,94,.28);
}
body{
  background:
    radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.14), transparent 55%),
    radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.10), transparent 60%),
    linear-gradient(180deg, #fffdf8, #f4efe4);
  color:var(--text);
}
/* Layout surfaces */
.side{
  border-left:1px solid var(--line);
  background:linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.55));
}
.topbar{
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.78);
  color:var(--text);
}
/* Cards */
.card{
  background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.78));
  border:1px solid var(--line);
  box-shadow:var(--shadow2);
}
.card .head{
  border-bottom:1px solid var(--line);
}
/* Inputs */
.search input,
input, select, textarea{
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.86);
  color:var(--text);
}
.search .icon{color:rgba(18,18,24,.45)}
/* Buttons */
.btn, .iconBtn, .closeX{
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.70);
  color:var(--text);
}
.btn:hover, .iconBtn:hover{border-color:rgba(214,178,94,.40)}
.btn.gold{
  background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.70));
  border-color:rgba(214,178,94,.45);
  color:#5b4514;
}
.btn.danger{
  border-color:rgba(255,107,107,.35);
  background:rgba(255,107,107,.10);
}
.badge{
  border:1px solid rgba(214,178,94,.45);
  background:rgba(214,178,94,.14);
  color:#5b4514;
}
/* Typography muted */
.muted{color:var(--muted2)!important}
.help, .brand .sub, .sideFooter{color:var(--muted2)!important}
.stat .k{color:var(--muted2)!important}
/* Tables */
thead th{
  color:rgba(18,18,24,.68)!important;
  border-bottom:1px solid var(--line)!important;
  background:rgba(255,255,255,.78)!important;
}
tbody td{
  color:rgba(18,18,24,.92)!important;
  border-bottom:1px solid rgba(20,20,30,.08)!important;
}
tbody tr:hover td{background:rgba(214,178,94,.10)!important}
/* Pills / tags */
.pill{
  border:1px solid rgba(20,20,30,.12);
  background:rgba(255,255,255,.72);
  color:rgba(18,18,24,.80);
}
.pill.gold{border-color:rgba(214,178,94,.45); color:#5b4514; background:rgba(214,178,94,.10)}
.tag{
  border:1px solid rgba(20,20,30,.12);
  background:rgba(255,255,255,.72);
  color:rgba(18,18,24,.85);
}
.tag.hot{border-color:rgba(255,204,102,.55); background:rgba(255,204,102,.18); color:#7a4f00}
.tag.ok{border-color:rgba(46,229,157,.45); background:rgba(46,229,157,.14); color:#0b5b3d}
.tag.cold{border-color:rgba(20,20,30,.14); background:rgba(255,255,255,.60); color:rgba(18,18,24,.70)}
/* Stat blocks / mini cards */
.stat, .miniCard, .event{
  border:1px solid rgba(20,20,30,.10);
  background:rgba(255,255,255,.72);
}
/* Modal + overlay */
.modalBack{background:rgba(20,20,30,.35)}
.modal{
  border:1px solid rgba(20,20,30,.14);
  background:
    radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.12), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.94), rgba(245,239,228,.94));
  box-shadow:0 30px 90px rgba(20,20,30,.25);
}
.modalHeader{
  border-bottom:1px solid var(--line);
  background:rgba(255,255,255,.80);
}
.toast{
  background:rgba(255,255,255,.92);
  border:1px solid rgba(20,20,30,.14);
  color:rgba(18,18,24,.92);
}


/* ===== Gold Boost ===== */
:root{
  --gold:#c9a441;
  --gold2:#f5d77a;
}

.btn.gold{
  background:linear-gradient(180deg, rgba(201,164,65,.38), rgba(255,255,255,.65));
  border-color:rgba(201,164,65,.65);
  color:#5a3f00;
  box-shadow:0 6px 18px rgba(201,164,65,.25);
}

.pill.gold{
  background:rgba(201,164,65,.22);
  border-color:rgba(201,164,65,.65);
  color:#5a3f00;
}

.badge{
  background:linear-gradient(180deg, rgba(201,164,65,.30), rgba(201,164,65,.12));
  border-color:rgba(201,164,65,.70);
  color:#5a3f00;
}

.tag.hot{
  background:rgba(245,215,122,.28);
  border-color:rgba(201,164,65,.75);
  color:#5a3f00;
}

.nav button.active{
  background:linear-gradient(180deg, rgba(201,164,65,.30), rgba(255,255,255,.55));
  border-color:rgba(201,164,65,.65);
  box-shadow:0 10px 26px rgba(201,164,65,.28);
}

.logo{
  box-shadow:0 14px 36px rgba(201,164,65,.35);
  border:1px solid rgba(201,164,65,.55);
}


/* =======================
   Premium Dark Gold + Glow
   ======================= */
:root{
  --gold:#9f7a19;        /* dark luxury gold */
  --gold2:#e6c15a;       /* highlight gold */
}

/* Premium buttons */
.btn.premium{
  background:linear-gradient(180deg, rgba(159,122,25,.55), rgba(120,90,10,.45));
  border-color:rgba(159,122,25,.85);
  color:#fff3c9;
  box-shadow:
    0 10px 26px rgba(159,122,25,.45),
    inset 0 1px 0 rgba(255,255,255,.25);
  letter-spacing:.3px;
}
.btn.premium:hover{
  transform:translateY(-2px) scale(1.01);
  box-shadow:
    0 14px 34px rgba(159,122,25,.60),
    inset 0 1px 0 rgba(255,255,255,.35);
}

/* Dark gold for standard gold buttons */
.btn.gold{
  background:linear-gradient(180deg, rgba(159,122,25,.40), rgba(255,255,255,.70));
  border-color:rgba(159,122,25,.70);
  color:#4b3600;
}

/* Glow animation on click */
.btn:active,
.iconBtn:active{
  animation: goldGlow .45s ease-out;
}

@keyframes goldGlow{
  0%{
    box-shadow:0 0 0 0 rgba(159,122,25,.0);
  }
  40%{
    box-shadow:0 0 18px 6px rgba(159,122,25,.55);
  }
  100%{
    box-shadow:0 0 0 0 rgba(159,122,25,.0);
  }
}

/* Premium navigation highlight */
.nav button.active{
  background:linear-gradient(180deg, rgba(159,122,25,.38), rgba(255,255,255,.60));
  border-color:rgba(159,122,25,.75);
  box-shadow:0 12px 28px rgba(159,122,25,.45);
}

/* Logo luxury glow */
.logo{
  box-shadow:
    0 18px 42px rgba(159,122,25,.55),
    inset 0 0 12px rgba(255,215,120,.25);
}

/* Premium badge */
.badge{
  background:linear-gradient(180deg, rgba(159,122,25,.35), rgba(159,122,25,.18));
  border-color:rgba(159,122,25,.85);
  color:#4b3600;
}


/* =======================
   Micro-interactions + Theme toggle + Premium loader
   ======================= */
body, .topbar, .side, .card, .miniCard, .stat, .event, thead th, tbody td,
.btn, .iconBtn, input, select, textarea, .pill, .tag{
  transition: background .25s ease, color .25s ease, border-color .25s ease, box-shadow .25s ease, transform .25s ease, opacity .25s ease;
}

/* Dynamic card hover */
.card:hover{
  transform: translateY(-2px);
  box-shadow: 0 16px 38px rgba(20,20,30,.16);
}
.card:has(.tableWrap):hover{ /* keep table cards calmer */
  transform:none;
}

/* Subtle screen transition */
.viewPanel{
  animation: viewIn .22s ease-out;
}
@keyframes viewIn{
  from{ opacity:0; transform:translateY(6px); }
  to{ opacity:1; transform:translateY(0); }
}

/* Premium loader overlay */
.loader{
  position:fixed; inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  background:rgba(20,20,30,.18);
  backdrop-filter: blur(4px);
  z-index:80;
}
.loader.show{ display:flex; }
.loaderCard{
  width:min(360px, calc(100vw - 36px));
  border-radius:18px;
  border:1px solid rgba(20,20,30,.14);
  background:rgba(255,255,255,.92);
  box-shadow: 0 20px 60px rgba(20,20,30,.18);
  padding:16px 16px 14px;
  display:flex;
  align-items:center;
  gap:12px;
}
.loaderRing{
  width:34px;height:34px;border-radius:50%;
  border:3px solid rgba(159,122,25,.22);
  border-top-color: rgba(159,122,25,.85);
  animation: spin .8s linear infinite;
}
@keyframes spin{ to{ transform:rotate(360deg);} }
.loaderText{
  font-weight:800;
  color:rgba(18,18,24,.86);
  white-space:nowrap;
}
.loaderBar{
  flex:1;
  height:10px;
  border-radius:999px;
  border:1px solid rgba(20,20,30,.12);
  background:rgba(245,239,228,.9);
  overflow:hidden;
}
.loaderBar i{
  display:block; height:100%;
  width:42%;
  background:linear-gradient(90deg, rgba(159,122,25,.20), rgba(230,193,90,.75), rgba(159,122,25,.25));
  animation: bar 1.05s ease-in-out infinite;
}
@keyframes bar{
  0%{ transform:translateX(-35%); }
  50%{ transform:translateX(85%); }
  100%{ transform:translateX(-35%); }
}

/* Dark mode */
html[data-theme="dark"]{
  color-scheme: dark;
}
html[data-theme="dark"] body{
  background:
    radial-gradient(1200px 700px at 80% 10%, rgba(159,122,25,.20), transparent 55%),
    radial-gradient(900px 600px at 10% 80%, rgba(230,193,90,.10), transparent 60%),
    linear-gradient(180deg, #0a0a10, #07070b);
  color:#ffffff;
}
html[data-theme="dark"] :root{
  /* variables are already set; we override via selectors below */
}
html[data-theme="dark"] .side{
  background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0));
  border-left:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] .topbar{
  background:rgba(0,0,0,.22);
  border-bottom:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] .card{
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.10);
}
html[data-theme="dark"] thead th{
  background:rgba(0,0,0,.22)!important;
  color:rgba(255,255,255,.72)!important;
  border-bottom:1px solid rgba(255,255,255,.10)!important;
}
html[data-theme="dark"] tbody td{
  color:rgba(255,255,255,.92)!important;
  border-bottom:1px solid rgba(255,255,255,.07)!important;
}
html[data-theme="dark"] .btn, 
html[data-theme="dark"] .iconBtn,
html[data-theme="dark"] .closeX{
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.12);
  color:#ffffff;
}
html[data-theme="dark"] .btn.gold{
  background:linear-gradient(180deg, rgba(159,122,25,.32), rgba(255,255,255,.05));
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .btn.premium{
  background:linear-gradient(180deg, rgba(159,122,25,.52), rgba(25,20,10,.70));
  border-color:rgba(159,122,25,.70);
  color:#fff3c9;
}
html[data-theme="dark"] input,
html[data-theme="dark"] select,
html[data-theme="dark"] textarea,
html[data-theme="dark"] .search input{
  background:rgba(0,0,0,.30);
  border:1px solid rgba(255,255,255,.10);
  color:#ffffff;
}
html[data-theme="dark"] .pill,
html[data-theme="dark"] .tag{
  background:rgba(0,0,0,.22);
  border:1px solid rgba(255,255,255,.12);
  color:rgba(255,255,255,.88);
}
html[data-theme="dark"] .pill.gold{
  background:rgba(159,122,25,.14);
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .badge{
  background:rgba(159,122,25,.12);
  border-color:rgba(159,122,25,.55);
  color:rgba(230,193,90,.98);
}
html[data-theme="dark"] .loaderCard{
  background:rgba(10,10,18,.95);
  border:1px solid rgba(255,255,255,.14);
}
html[data-theme="dark"] .loaderText{ color:rgba(255,255,255,.90); }
html[data-theme="dark"] .loaderBar{
  background:rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.12);
}


/* =======================
   Soft Gold+White smear button
   ======================= */
.btn.goldSoft{
  border-color:rgba(159,122,25,.55);
  color:#4b3600;
  background:
    radial-gradient(140px 70px at 20% 25%, rgba(230,193,90,.45), transparent 60%),
    radial-gradient(180px 90px at 85% 10%, rgba(255,255,255,.85), transparent 55%),
    linear-gradient(180deg, rgba(255,255,255,.78), rgba(245,239,228,.72));
  box-shadow:
    0 10px 22px rgba(159,122,25,.16),
    inset 0 1px 0 rgba(255,255,255,.45);
}
.btn.goldSoft:hover{
  border-color:rgba(159,122,25,.70);
  transform:translateY(-2px);
  box-shadow:
    0 14px 30px rgba(159,122,25,.22),
    inset 0 1px 0 rgba(255,255,255,.55);
}


/* =======================
   Premium polish pack (safe)
   ======================= */

/* (5) Live gold gradient shimmer (very subtle) */
@keyframes goldShimmer{
  0%{ background-position: 0% 50%; }
  100%{ background-position: 100% 50%; }
}
/* shimmer on accents */
.btn.goldSoft{ position:relative; overflow:hidden; }
.btn.goldSoft::after{
  content:"";
  position:absolute; inset:0;
  border-radius:inherit;
  background-image: linear-gradient(90deg,
    rgba(159,122,25,.20),
    rgba(230,193,90,.55),
    rgba(255,255,255,.55),
    rgba(159,122,25,.20)
  );
  background-size: 220% 100%;
  opacity:.38;
  mix-blend-mode: multiply;
  pointer-events:none;
  animation: goldShimmer 7.5s ease-in-out infinite;
}
html[data-theme="dark"] .btn.goldSoft::after{
  opacity:.30;
  mix-blend-mode: screen;
}
.logo, .pill.gold, .badge{
  background-size: 220% 100%;
  animation: goldShimmer 8.5s ease-in-out infinite;
}

/* (1) Active view highlight */
.activeView{
  position:relative;
  border-color: rgba(159,122,25,.38) !important;
  box-shadow:
    0 18px 44px rgba(159,122,25,.14),
    0 10px 30px rgba(20,20,30,.10) !important;
}
.activeView::before{
  content:"";
  position:absolute;
  inset:10px auto 10px 10px;
  width:3px;
  border-radius:999px;
  background: linear-gradient(180deg, rgba(159,122,25,.0), rgba(230,193,90,.95), rgba(159,122,25,.0));
  opacity:.75;
}
html[dir="rtl"] .activeView::before{
  inset:10px 10px 10px auto;
}

/* (7) Smart toast variants */
.toast{ display:none; }
.toast.show{ display:block; }
.toast.success{
  border-color: rgba(46,229,157,.30);
  background: rgba(46,229,157,.10);
}
.toast.warn{
  border-color: rgba(230,193,90,.40);
  background: rgba(230,193,90,.12);
}
.toast.error{
  border-color: rgba(255,107,107,.40);
  background: rgba(255,107,107,.12);
}

/* (4) Micro-interactions */
.btn, .iconBtn{ will-change: transform; }
.btn:active, .iconBtn:active{ transform: translateY(0) scale(.99); }
.iconBtn:focus-visible, .btn:focus-visible, input:focus-visible, select:focus-visible, textarea:focus-visible{
  outline:none;
  box-shadow:var(--focus);
}

/* tooltip for icon buttons */
[data-tip]{ position:relative; }
[data-tip]:hover::after{
  content: attr(data-tip);
  position:absolute;
  top:-38px;
  left:50%;
  transform:translateX(-50%);
  padding:6px 10px;
  border-radius:12px;
  background: rgba(20,20,30,.92);
  color: rgba(255,255,255,.92);
  font-size:12px;
  white-space:nowrap;
  border:1px solid rgba(255,255,255,.12);
  box-shadow: 0 12px 30px rgba(0,0,0,.25);
  z-index:30;
}
html[dir="rtl"] [data-tip]:hover::after{ left:auto; right:50%; transform: translateX(50%); }
html[data-theme="dark"] [data-tip]:hover::after{ background: rgba(0,0,0,.72); }


/* Hide topbar quick button (moved to sidebar) */
.hideTopQuick{ display:none !important; }


/* Nav micro-bounce for My Flows */
#navMyFlows:hover{ transform: translateY(-1px); }
#navMyFlows:active{ transform: translateY(0) scale(.99); }


/* =======================
   Premium Circle Logo
   ======================= */
.logo{
  width:44px;
  height:44px;
  border-radius:999px;
  display:grid;
  place-items:center;
  font-weight:900;
  letter-spacing:.6px;
  font-size:16px;
  color:#fff6dd;
  border:1px solid rgba(159,122,25,.75);
  background:
    radial-gradient(18px 18px at 30% 28%, rgba(255,255,255,.55), transparent 60%),
    radial-gradient(26px 26px at 70% 68%, rgba(230,193,90,.35), transparent 65%),
    linear-gradient(180deg, rgba(120,90,10,.95), rgba(159,122,25,.85), rgba(230,193,90,.55));
  box-shadow:
    0 18px 42px rgba(159,122,25,.45),
    inset 0 1px 0 rgba(255,255,255,.28);
  position:relative;
  overflow:hidden;
}
.logo::after{
  content:"";
  position:absolute; inset:-30%;
  background:linear-gradient(90deg, transparent, rgba(255,255,255,.28), transparent);
  transform: rotate(20deg);
  animation: logoSweep 6.8s ease-in-out infinite;
  opacity:.65;
}
@keyframes logoSweep{
  0%{ transform: translateX(-45%) rotate(20deg); }
  45%{ transform: translateX(45%) rotate(20deg); }
  100%{ transform: translateX(-45%) rotate(20deg); }
}
.brand .sub{
  margin-top:2px;
  font-size:11px;
  letter-spacing:.6px;
  text-transform:uppercase;
  color: rgba(159,122,25,.85);
}
html[data-theme="dark"] .brand .sub{
  color: rgba(230,193,90,.88);
}


/* ===== Proposal Builder Modal ===== */
.modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modalOverlay.show{display:flex}
.modalCard{width:min(1100px,92vw);height:min(78vh,760px);background:var(--panel);border:1px solid var(--line);border-radius:18px;box-shadow:0 22px 70px rgba(0,0,0,.35);display:flex;flex-direction:column;overflow:hidden}
.modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line);background:linear-gradient(180deg, rgba(0,0,0,.06), rgba(0,0,0,0))}
.modalHead .title{font-weight:800}
.modalHead .sub{color:var(--muted);font-size:12px;margin-top:2px}
.modalBody{display:flex;gap:14px;padding:14px 16px;flex:1;overflow:hidden}
.modalLeft{width:340px;max-width:40%;min-width:260px;display:flex;flex-direction:column;gap:10px}
.companyList{display:grid;grid-template-columns:1fr;gap:10px;overflow:auto;padding-right:2px}
.companyBtn{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 12px;border:1px solid var(--line);border-radius:14px;background:var(--panel2);cursor:pointer;transition:transform .12s ease, border-color .12s ease}
.companyBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.45)}
.companyBtn .name{font-weight:800}
.companyBtn .hint{font-size:12px;color:var(--muted)}
.modalRight{flex:1;min-width:0;display:flex;flex-direction:column;border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--panel2)}
.proposalTop{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
.proposalTop .crumb{font-size:12px;color:var(--muted)}
.proposalFrame{flex:1;min-height:0}
.proposalFrame iframe{width:100%;height:100%;border:0;background:#fff}
.modalFoot{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding:12px 16px;border-top:1px solid var(--line);background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.06))}
.btnGhost{background:transparent;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer}
.btnGold{background:linear-gradient(135deg, var(--gold), var(--gold2));color:#111;padding:10px 12px;border-radius:12px;border:0;cursor:pointer;font-weight:800}
@media (max-width: 820px){
  .modalBody{flex-direction:column}
  .modalLeft{width:100%;max-width:100%}
}


/* ===== Top Bar Cream Background ===== */
.topBar, header, .header, .appHeader {
  background: #fff7e6 !important;
}


/* ===== Top Controls Cream Background ===== */
.topControls, .top-actions, .toolbar, .headerBar, .controlsRow {
  background: #fff4dd !important;
}


/* ===== Top Bar Gold Divider + Depth ===== */
.topBar, header, .header, .appHeader,
.topControls, .top-actions, .toolbar, .headerBar, .controlsRow {
  border-bottom: 1.5px solid rgba(214,178,94,0.55) !important; /* gold line */
  box-shadow: 0 4px 14px rgba(0,0,0,0.08) !important;          /* subtle depth */
}


/* ===== Mirror Client (Real View) ===== */
.mirrorGrid{display:grid;grid-template-columns:360px 1fr;gap:14px;flex:1;min-height:0}
.mirrorPanel{border:1px solid var(--line);background:var(--panel2);border-radius:16px;padding:12px;overflow:auto}
.mirrorPanel h4{margin:0 0 10px;font-size:14px}
.mirrorField{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
.mirrorField label{font-size:12px;color:var(--muted)}
.mirrorField input,.mirrorField select{width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);background:var(--panel);color:var(--text);outline:none}
.mirrorCard{border:1px solid var(--line);border-radius:14px;padding:10px;background:var(--panel)}
.mirrorKV{display:grid;grid-template-columns:92px 1fr;gap:8px;font-size:13px}
.mirrorKV div:nth-child(odd){color:var(--muted)}
.mirrorKV div:nth-child(even){font-weight:700}
.mirrorActions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
.mirrorActions .btnGhost,.mirrorActions .btnGold{white-space:nowrap}
.mirrorPreview{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:var(--panel2);display:flex;flex-direction:column;min-height:0}
.mirrorPreviewHead{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line)}
.mirrorPreviewHead .ttl{font-weight:900}
.mirrorPreviewHead .meta{font-size:12px;color:var(--muted)}
.mirrorPreviewBody{flex:1;min-height:0}
.mirrorPreviewBody iframe{width:100%;height:100%;border:0;background:#fff}
.mirrorNotice{font-size:12px;color:var(--muted);line-height:1.6}
@media (max-width: 920px){
  .mirrorGrid{grid-template-columns:1fr}
}
.mirrorOnly body{overflow:hidden}
.mirrorStandalone{position:fixed;inset:0;background:#fff;z-index:100000;display:none}
.mirrorStandalone.show{display:block}
.mirrorStandaloneInner{position:absolute;inset:0;display:flex;flex-direction:column}
.mirrorStandaloneTop{padding:12px 16px;border-bottom:1px solid rgba(214,178,94,0.55);box-shadow:0 4px 14px rgba(0,0,0,0.08)}
.mirrorStandaloneTop .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
.mirrorStandaloneTop .row .title{font-weight:1000}
.mirrorStandaloneTop .row .sub{font-size:12px;color:#555}
.mirrorStandaloneMain{flex:1;min-height:0;padding:14px 16px;background:#fff7e6}
.mirrorStandaloneMain .wrap{height:100%;max-width:1200px;margin:0 auto}


/* ===== Fix: Modal labels contrast on Light/Cream UI ===== */
body[data-theme="light"] label{
  color: rgba(12,12,18,.82) !important;
}
body[data-theme="light"] .modalBody label{
  color: rgba(12,12,18,.90) !important;
  font-weight: 800 !important;
}
body[data-theme="light"] .modalBody .muted,
body[data-theme="light"] .modalBody .small,
body[data-theme="light"] .modalBody .hint{
  color: rgba(12,12,18,.62) !important;
}
body[data-theme="light"] .modalBody input::placeholder,
body[data-theme="light"] .modalBody textarea::placeholder{
  color: rgba(12,12,18,.45) !important;
  opacity: 1 !important;
}


/* ==== FIX: Lead form labels visibility (×œ×™×“ ×—×“×© / ×¢×¨×™×›×ª ×œ×™×“) ==== */
#modalBody #leadForm label{
  color: rgba(20,20,25,.72) !important;
  opacity: 1 !important;
}
#modalBody #leadForm .help,
#modalBody #leadForm .hint,
#modalBody #leadForm small{
  color: rgba(20,20,25,.58) !important;
  opacity: 1 !important;
}
#modalBody #leadForm input::placeholder,
#modalBody #leadForm textarea::placeholder{
  color: rgba(20,20,25,.45) !important;
  opacity: 1 !important;
}


/* ==== Mirror Client: wider modal + steps template ==== */
#mirrorModal .modalCard.wide{
  width:min(1320px, 98vw);
  height:min(88vh, 860px);
  display:flex;
  flex-direction:column;
}
#mirrorModal .modalBody{flex:1; min-height:0;}
#mirrorModal .modalCard.wide .mirrorGrid{grid-template-columns:420px 1fr;}
#mirrorModal .mirrorPanel{min-height:0;}
#mirrorModal .mirrorPreview{min-height:520px;}
#mirrorModal .mirrorPanel h4{margin:0 0 6px}

.mirrorSteps{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:14px;
  background: rgba(214,178,94,.06);
  padding:10px 10px;
}
.mirrorSteps > summary{
  cursor:pointer;
  font-weight:800;
  color: var(--text);
  list-style:none;
}
.mirrorSteps > summary::-webkit-details-marker{display:none;}
.mirrorStepsBody{margin-top:8px; display:flex; flex-direction:column; gap:10px;}
.mirrorStepsGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
}
@media (max-width: 880px){
  #mirrorModal .modalCard.wide .mirrorGrid{grid-template-columns:1fr;}
  .mirrorStepsGrid{grid-template-columns:1fr;}
}


/* ==== Layout tweak: widen leads list, slightly shrink control center ==== */
#viewRight{ min-width: 320px; }
#viewLeads{ min-width: 0; }
#viewLeads .tableWrap{ overflow:auto; }


/* ==== Leads table: more "air" without breaking layout ==== */
#viewLeads table{
  min-width: 1120px;
  border-spacing: 0 10px; /* vertical breathing room */
}
#viewLeads thead th{
  padding: 12px 14px;
  font-size: 13px;
}
#viewLeads tbody td{
  padding: 14px 14px;
  font-size: 13.5px;
}
#viewLeads tbody tr{
  height: 64px;
}
#viewLeads th:nth-child(1), #viewLeads td:nth-child(1){ min-width: 200px; } /* ×©× */
#viewLeads th:nth-child(2), #viewLeads td:nth-child(2){ min-width: 150px; } /* ×˜×œ×¤×•×Ÿ */
#viewLeads th:nth-child(3), #viewLeads td:nth-child(3){ min-width: 120px; } /* ×¡×˜×˜×•×¡ */
#viewLeads th:nth-child(4), #viewLeads td:nth-child(4){ min-width: 110px; } /* ××§×•×¨ */
#viewLeads th:nth-child(5), #viewLeads td:nth-child(5){ min-width: 150px; } /* ×—×•× */
#viewLeads th:nth-child(6), #viewLeads td:nth-child(6){ min-width: 170px; } /* ××¢×§×‘ ×”×‘× */
#viewLeads th:nth-child(7), #viewLeads td:nth-child(7){ min-width: 170px; } /* ×¤×¢×•×œ×•×ª */


/* ==== Leads table: pro alignment for actions column ==== */
#viewLeads td .actions{
  display:flex;
  align-items:center;
  justify-content:flex-start; /* RTL: start = right */
  gap:10px;
  flex-wrap:nowrap;
}
#viewLeads td:last-child{ white-space:nowrap; }
#viewLeads .iconBtn{
  width:36px;
  height:36px;
  border-radius:12px;
  font-size:16px;
  line-height:1;
}


/* ==== Ensure leads table fits viewport without horizontal scroll ==== */
#viewLeads{
  overflow-x: hidden;
}

#viewLeads .tableWrap{
  overflow-x: hidden;
}

#viewLeads table{
  width:100%;
  min-width:0; /* allow table to shrink to container */
  table-layout: fixed;
}

#viewLeads th, 
#viewLeads td{
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow: hidden;
}

/* rebalance column widths so everything fits */
#viewLeads th:nth-child(1), #viewLeads td:nth-child(1){ width: 22%; } /* ×©× */
#viewLeads th:nth-child(2), #viewLeads td:nth-child(2){ width: 18%; } /* ×˜×œ×¤×•×Ÿ */
#viewLeads th:nth-child(3), #viewLeads td:nth-child(3){ width: 14%; } /* ×¡×˜×˜×•×¡ */
#viewLeads th:nth-child(4), #viewLeads td:nth-child(4){ width: 14%; } /* ××§×•×¨ */
#viewLeads th:nth-child(5), #viewLeads td:nth-child(5){ width: 14%; } /* ×—×•× */
#viewLeads th:nth-child(6), #viewLeads td:nth-child(6){ width: 18%; } /* ×¤×¢×•×œ×•×ª */


/* ==== E-Sign: wide clean modal + options ==== */
#esignModal .modalCard.wide{
  width:min(1320px, 98vw);
  height:min(88vh, 860px);
  display:flex;
  flex-direction:column;
}
#esignModal .modalBody{flex:1;min-height:0;}
#esignModal .mirrorGrid{gap:14px;}
#esignModal .mirrorPanel, #esignModal .mirrorPreview{min-height:0;}
#esignModal .mirrorPreview{border:1px solid var(--line);border-radius:18px;background:rgba(214,178,94,.06);}
#esignModal .field .cap{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
#esignModal input, #esignModal textarea{
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--line);
  background: var(--panel);
  color: var(--text);
  outline:none;
}
#esignModal input:focus, #esignModal textarea:focus{
  border-color: rgba(214,178,94,.55);
  box-shadow: 0 0 0 3px rgba(214,178,94,.18);
}
.esignOptions{
  margin-top:10px;
  display:grid;
  grid-template-columns:1fr;
  gap:10px;
}
.esignOptionBtn{
  text-align:right;
  padding:12px 14px;
  border-radius:16px;
}
.esignOptionBtn.active{
  border-color: rgba(214,178,94,.75) !important;
  box-shadow: 0 0 0 3px rgba(214,178,94,.18);
  background: rgba(214,178,94,.10);
}
.esignMsg{
  width:100%;
  height:100%;
  min-height:180px;
  resize:none;
  line-height:1.65;
  font-size:14px;
}
@media (max-width: 920px){
  #esignModal .mirrorGrid{grid-template-columns:1fr !important;}
  #esignModal .modalCard.wide{height:min(92vh, 900px);}
}


/* ==== E-Sign: channel selector chips ==== */
#esignModal .chip{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:10px 12px;
  border:1px solid var(--line);
  border-radius:999px;
  background: var(--panel);
  color: var(--text);
  font-weight:700;
  user-select:none;
}
#esignModal .chip input{ accent-color: #d6b25e; }

</style>
</head>

<body>
<div class="app">
  <aside class="side">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>LEADUP</h1>
        <div class="sub">Premium CRM</div>
      </div>
    </div>

    <div class="nav" id="nav">
      <button class="active" data-view="leads">
        <span class="k">ğŸ“Œ ×œ×™×“×™×</span>
        <span class="pill gold" id="navCount">0</span>
      </button>

      <button type="button" id="navMyFlows" data-view="myflows">
        <span class="k">âš™ï¸ ×”×ª×”×œ×™×›×™× ×©×œ×™</span>
      </button>

      <button data-view="tasks">
        <span class="k">â° ××©×™××•×ª</span>
        <span class="pill" id="navTasks">0</span>
      </button>
      <button data-view="proposal">
        <span class="k">ğŸ§¾ ×™×¦×™×¨×ª ×”×¦×¢×”</span>
        <span class="pill" id="navEvents">0</span>
      </button>

      <button type="button" id="navESign" data-view="esign">
        <span class="k">âœï¸ ×©×œ×™×—×” ×œ×—×ª×™××ª ×œ×§×•×—</span>
      </button>

      <button type="button" id="navMirror" data-view="mirror">
        <span class="k">ğŸª ×©×™×§×•×£ ×œ×œ×§×•×—</span>
      </button>


      <button data-view="settings">
        <span class="k">âš™ï¸ ×”×’×“×¨×•×ª</span>
        <span class="pill">Local</span>
      </button>
    </div>

    <div class="sideFooter">
      <div><b>×˜×™×¤:</b> ×›×œ ×¤×¢×•×œ×” × ×¤×ª×—×ª ×‘×ª×•×š ×—×œ×•×Ÿ ×‘××¢×¨×›×ª (××•×“××œ) â€” ×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×™×¦×•× ×™.</div>
      <div class="hint">
        ×‘×§×¨×•×‘ × ×—×‘×¨ ×œ-Google Sheets ×“×¨×š Apps Script (×¨×§ ×ª×ª×Ÿ ×œ×™ ××ª ×›×ª×•×‘×ª ×”-URL ×•××–×”×” ×”×¤×¨×™×¡×”).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <span class="badge"><span class="dot"></span> ××¦×‘ ××¢×¨×›×ª: ×¤×¢×™×œ</span>
        <span class="badge" id="greetingBadge">×©×œ×•× ğŸ‘‹</span>
        <div class="title">
          <b id="viewTitle">×œ×™×“×™×</b>
          <span id="viewSub">× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘</span>
        </div>
      </div>

      <div class="search">
        <span class="icon">âŒ•</span>
        <input id="q" placeholder="×—×™×¤×•×© ×œ×¤×™ ×©×/×˜×œ×¤×•×Ÿ/××™××™×™×œ/×”×¢×¨×”â€¦" autocomplete="off"/>
      </div>

      <div class="right">
        <button class="btn goldSoft" id="btnAddLead">â• ×œ×™×“ ×—×“×©</button>
        <button class="btn goldSoft hideTopQuick" id="btnQuickTask">âš™ï¸ ×”×ª×”×œ×™×›×™× ×©×œ×™</button>
      </div>
    </div>

    <div class="content">
      <div class="card" style="margin-bottom:14px">
        <div class="head">
          <h2>×“×©×‘×•×¨×“</h2>
</div>
        <div class="body">
          <div class="stats">
            <div class="stat">
              <div class="k">×¡×”×´×› ×œ×™×“×™×</div>
              <div class="v" id="stTotal">0</div>
              <div class="mini">×‘×××’×¨</div>
            </div>
            <div class="stat">
              <div class="k">×—××™×</div>
              <div class="v" id="stHot">0</div>
              <div class="mini">Lead Score ×’×‘×•×”</div>
            </div>
            <div class="stat">
              <div class="k">××¢×§×‘ ×”×™×•×</div>
              <div class="v" id="stToday">0</div>
              <div class="mini">Next Follow-up</div>
            </div>
            <div class="stat">
              <div class="k">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
              <div class="v" id="stTasks">0</div>
              <div class="mini">×ª×–×›×•×¨×•×ª</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card" id="viewLeads">
          <div class="head">
            <h2>×¨×©×™××ª ×œ×™×“×™×</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <select id="fStatus" title="×¤×™×œ×˜×¨ ×¡×˜×˜×•×¡" style="width:170px">
                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                <option>×—×“×©</option>
                <option>× ×•×¦×¨ ×§×©×¨</option>
                <option>××ª×¢× ×™×™×Ÿ</option>
                <option>×”×¦×¢×ª ××—×™×¨</option>
                <option>× ×¡×’×¨</option>
                <option>×œ× ×¨×œ×•×•× ×˜×™</option>
              </select>
              <select id="fSource" title="×¤×™×œ×˜×¨ ××§×•×¨" style="width:170px">
                <option value="">×›×œ ×”××§×•×¨×•×ª</option>
                <option>×¤×™×™×¡×‘×•×§</option>
                <option>×’×•×’×œ</option>
                <option>×”×¤× ×™×”</option>
                <option>×˜×œ×¤×•×Ÿ</option>
                <option>××ª×¨</option>
                <option>××—×¨</option>
              </select>
              <select id="sortBy" title="××™×•×Ÿ" style="width:170px">
                <option value="hot">××™×•×Ÿ: ×”×›×™ ×—×</option>
                <option value="next">××™×•×Ÿ: ×ª××¨×™×š ××¢×§×‘ ×”×‘×</option>
                <option value="newest">××™×•×Ÿ: ×”×›×™ ×—×“×©</option>
                <option value="oldest">××™×•×Ÿ: ×”×›×™ ×™×©×Ÿ</option>
              </select>
            </div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>×©×</th>
                    <th>×˜×œ×¤×•×Ÿ</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>××§×•×¨</th>
                    <th>×—×•× (Score)</th>
                    <th>××¢×§×‘ ×”×‘×</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="leadsTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyLeads" style="display:none">
              ××™×Ÿ ×¢×“×™×™×Ÿ ×œ×™×“×™×. ×œ×—×¥ ×¢×œ <b>â€œ×œ×™×“ ×—×“×©â€</b> ×›×“×™ ×œ×”×ª×—×™×œ.
            </div>
          </div>
        </section>

        <aside class="card" id="viewRight">
          <div class="head">
            <h2>××¨×›×– ×©×œ×™×˜×”</h2>
            <div class="pill gold">LEADUP</div>
          </div>
          <div class="body">
            <div class="miniCard" style="margin-bottom:10px">
              <h3>××” ×™×© ×‘××¢×¨×›×ª</h3>
              <div class="small muted">
                â€¢ ×œ×™×“×™× + ×¡×˜×˜×•×¡×™× + ×”×¢×¨×•×ª<br/>
                â€¢ ××©×™××•×ª ×•×ª×–×›×•×¨×•×ª ×œ×›×œ ×œ×™×“<br/>
                â€¢ ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª (Timeline)<br/>
                â€¢ ×—×™×¤×•×©/×¤×™×œ×˜×¨×™×/××™×•×Ÿ<br/>
                â€¢ Lead Score (1â€“100)<br/>
                â€¢ ×•×•××˜×¡××¤ / ×”×ª×§×©×¨×•×ª / ××™×™×œ (×‘××•×“××œ)
              </div>
            </div>

            <div class="miniCard">
              <h3>×¤×¢×•×œ×” ××”×™×¨×”</h3>
              <button class="btn premium" style="width:100%" id="btnOpenInsights">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
              <div class="sep"></div>
              <button class="btn" style="width:100%" id="btnSeed">âœ¨ ×¦×•×¨ ×“×•×’×××•×ª ×œ×™×“×™×</button>
              <div class="help">×”×›×œ × ×©××¨ ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (LocalStorage) ×¢×“ ×©× ×—×‘×¨ ×œ-Google Sheets.</div>
            </div>
          </div>
        </aside>

        <!-- Tasks view -->
        <section class="card" id="viewTasks" style="display:none">
          <div class="head">
            <h2>××©×™××•×ª</h2>
            <div class="muted small">×ª×–×›×•×¨×•×ª + ×¢×“×™×¤×•×ª + ×©×™×™×›×•×ª ×œ×œ×™×“</div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table style="min-width:860px">
                <thead>
                  <tr>
                    <th>××ª×™</th>
                    <th>×¢×“×™×¤×•×ª</th>
                    <th>×œ×™×“</th>
                    <th>×ª×™××•×¨</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="tasksTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyTasks" style="display:none">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª.</div>
          </div>
        
        <!-- My Flows view -->
        <section class="card" id="viewMyFlows" style="display:none">
          <div class="head">
            <h2>×”×ª×”×œ×™×›×™× ×©×œ×™</h2>
            <div class="muted small">×ª×‘× ×™×•×ª ×˜×™×¤×•×œ ××”×™×¨×•×ª ×œ×œ×§×•×—: ×©×™×—×”, ×”×¦×¢×”, ××¡××›×™× ×•××¢×§×‘</div>
          </div>
          <div class="body">
            <div class="grid2" style="grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px">
              <div class="card mini" style="border:1px solid var(--line); border-radius:14px; padding:12px">
                <div class="muted small" style="margin-bottom:6px">×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px">
                  <button class="btn" id="flowCall">ğŸ“ ×©×™×—×”</button>
                  <button class="btn" id="flowWhatsApp">ğŸ’¬ ×•×•××˜×¡××¤</button>
                  <button class="btn" id="flowEmail">âœ‰ï¸ ××™×™×œ</button>
                  <button class="btn" id="flowNote">ğŸ“ ×”×¢×¨×”</button>
                </div>
                <div class="muted2 small" style="margin-top:10px">×”×¤×¢×•×œ×•×ª ××©×ª××©×•×ª ×‘×œ×§×•×— ×©× ×‘×—×¨ ×›×¨×’×¢ (×›××• ×©××¨ ×”××¢×¨×›×ª).</div>
              </div>

              <div class="card mini" style="border:1px solid var(--line); border-radius:14px; padding:12px">
                <div class="muted small" style="margin-bottom:6px">×ª×”×œ×™×š ×˜×™×¤×•×œ</div>
                <div class="muted2 small" style="margin-bottom:10px">×‘×—×¨ ×©×œ×‘ ×•×”××¢×¨×›×ª ×ª×¢×“×›×Ÿ ×¡×˜×˜×•×¡/×ª×™×¦×•×¨ ××©×™××”/×ª×•×¡×™×£ ××™×¨×•×¢ ×œ×™×¦×™×¨×ª ×”×¦×¢×”.</div>
                <div style="display:flex; flex-wrap:wrap; gap:8px">
                  <button class="btn ghost" data-flow-step="× ×•×¦×¨ ×§×©×¨">âœ… × ×•×¦×¨ ×§×©×¨</button>
                  <button class="btn ghost" data-flow-step="××ª×¢× ×™×™×Ÿ">ğŸ”¥ ××ª×¢× ×™×™×Ÿ</button>
                  <button class="btn ghost" data-flow-step="×”×¦×¢×ª ××—×™×¨">ğŸ’° ×”×¦×¢×ª ××—×™×¨</button>
                  <button class="btn ghost" data-flow-step="× ×¡×’×¨">ğŸ × ×¡×’×¨</button>
                </div>
              </div>
            </div>

            <div class="hr" style="margin:14px 0"></div>

            <div class="muted2 small">
              ×˜×™×¤: ×× ×ª×¨×¦×”, ××¤×©×¨ ×œ×—×‘×¨ ×›×œ ×›×¤×ª×•×¨ ×›××Ÿ ×œ×™×¦×™×¨×ª ××©×™××” ××•×˜×•××˜×™×ª (SLA), ×¤×ª×™×—×ª ××•×“××œ ××™×™×œ ×¤× ×™××™, ××• â€œ×ª×–×›×•×¨×ª ×¢×•×“ X ×™××™×â€.
            </div>
          </div>
        </section>

</section>

        <!-- Timeline view -->
        <section class="card" id="viewTimeline" style="display:none">
          <div class="head">
            <h2>×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª</h2>
            <div class="muted small">×›×œ ×©×™× ×•×™ × ×©××¨: ××™/××ª×™/××” ×”×©×ª× ×”</div>
          </div>
          <div class="body">
            <div class="timeline" id="timelineList"></div>
            <div class="help" id="emptyTimeline" style="display:none">××™×Ÿ ×¢×“×™×™×Ÿ ××™×¨×•×¢×™×.</div>
          </div>
        </section>

        <!-- Settings view -->
        <section class="card" id="viewSettings" style="display:none">
          <div class="head">
            <h2>×”×’×“×¨×•×ª</h2>
            <div class="muted small">×—×™×‘×•×¨ Google Sheets ×™×™×›× ×¡ ×›××Ÿ</div>
          </div>
          <div class="body">
            <div class="miniCard">
              <h3>×©××™×¨×”/××™×¤×•×¡</h3>
              <div class="row">
                <button class="btn" id="btnBackup" type="button">ğŸ’¾ ×™×¦× ×’×™×‘×•×™ JSON</button>
                <button class="btn danger" id="btnReset" type="button">ğŸ§¨ ××™×¤×•×¡ ×›×œ ×”× ×ª×•× ×™×</button>
              </div>
              <div class="sep"></div>
              <h3>Google Sheets (×‘×§×¨×•×‘)</h3>
              <div class="small muted">
                ×›×“×™ ×œ×—×‘×¨ ×œ×¡× ×›×¨×•×Ÿ, × ×¦×˜×¨×š:
                <ul>
                  <li>URL ×©×œ ×”-Web App</li>
                  <li>ID ×©×œ ×”×¤×¨×™×¡×” (Deployment)</li>
                  <li>×©× ×’×™×œ×™×•×Ÿ / ×˜××‘</li>
                </ul>
                ×‘×¨×’×¢ ×©×ª×©×œ×— ×œ×™ â€” ××•×¡×™×£ ×œ×š ×‘×§×•×“ ××ª ×”×—×™×‘×•×¨, ×¢× Fetch, ×•×”×›×œ ×™×¢×‘×•×“ ×“×¨×š ×”×©×™×˜.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">×›×•×ª×¨×ª</b>
      <button class="closeX" id="modalClose" title="×¡×’×•×¨">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>


<div class="loader" id="loader" aria-hidden="true">
  <div class="loaderCard">
    <div class="loaderRing"></div>
    <div class="loaderText">×˜×•×¢×Ÿâ€¦</div>
    <div class="loaderBar"><i></i></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   LEADUP â€¢ Local CRM
   ======================= */

const LS_KEY = "leadup_v1";

const el = (id)=>document.getElementById(id);
const nowISO = () => new Date().toISOString();
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDT(iso){
  if(!iso) return "â€”";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "â€”";
  return d.toLocaleString("he-IL", { dateStyle:"medium", timeStyle:"short" });
}
function todayKey(){
  return new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
}
function toLocalDT(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const pad = (x)=>String(x).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromLocalDT(local){
  if(!local) return "";
  const d = new Date(local);
  if(Number.isNaN(d.getTime())) return "";
  return d.toISOString();
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultState(){
  return {
    user: { name: "×× ×”×œ", role: "Admin" },
    leads: [],
    tasks: [],
    events: []
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return { ...defaultState(), ...parsed };
  }catch(e){
    return defaultState();
  }
}
const appState = loadState();

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
  showLoader(220);
  renderAll();
}

/* ===== Activity Timeline ===== */
function addEvent(type, text, meta={}){
  appState.events.unshift({
    id: uid("ev"),
    at: nowISO(),
    who: appState.user?.name || "××©×ª××©",
    type, text, meta
  });
  appState.events = appState.events.slice(0, 800);
}

/* ===== Lead Score ===== */
function sourceWeight(source){
  const s = (source||"").toLowerCase();
  if(["×”×¤× ×™×”","ref","referral"].some(x=>s.includes(x))) return 22;
  if(s.includes("×˜×œ×¤×•×Ÿ")) return 18;
  if(s.includes("×’×•×’×œ")) return 16;
  if(s.includes("××ª×¨")) return 14;
  if(s.includes("×¤×™×™×¡×‘×•×§")) return 12;
  return 10;
}
function statusWeight(status){
  switch(status){
    case "×—×“×©": return 10;
    case "× ×•×¦×¨ ×§×©×¨": return 18;
    case "××ª×¢× ×™×™×Ÿ": return 26;
    case "×”×¦×¢×ª ××—×™×¨": return 34;
    case "× ×¡×’×¨": return 40;
    case "×œ× ×¨×œ×•×•× ×˜×™": return 2;
    default: return 10;
  }
}
function computeScore(lead){
  const talks = clamp(Number(lead.contactCount||0), 0, 20);
  const talkScore = talks * 2.2; // max 44

  const base = 18;
  const src = sourceWeight(lead.source);
  const st = statusWeight(lead.status);

  const refDate = lead.lastContactAt || lead.createdAt || nowISO();
  const days = Math.floor((Date.now() - new Date(refDate).getTime()) / (1000*60*60*24));
  const recencyPenalty = clamp(days * 1.6, 0, 40);

  let score = base + src + st + talkScore - recencyPenalty;

  if(lead.status === "× ×¡×’×¨") score += 10;
  if(lead.status === "×œ× ×¨×œ×•×•× ×˜×™") score = Math.min(score, 15);

  return clamp(Math.round(score), 1, 100);
}
function heatTag(score){
  if(score >= 75) return { cls:"hot", label:"×—×" };
  if(score >= 45) return { cls:"ok", label:"×‘×™× ×•× ×™" };
  return { cls:"cold", label:"×§×¨" };
}

/* ===== Views ===== */
const nav = el("nav");
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  setView(btn.dataset.view);
});
function setView(view){
  if(!["leads","myflows","tasks","timeline","settings"].includes(view)) view="leads";
  document.querySelectorAll(".nav button[data-view]").forEach(b=>b.classList.toggle("active", b.dataset.view===view));

  el("viewLeads").style.display = (view==="leads") ? "" : "none";
  el("viewRight").style.display = (view==="leads") ? "" : "none";
  el("viewMyFlows").style.display = (view==="myflows") ? "" : "none";
  el("viewTasks").style.display = (view==="tasks") ? "" : "none";
  el("viewTimeline").style.display = (view==="timeline") ? "" : "none";
  el("viewSettings").style.display = (view==="settings") ? "" : "none";

  const titles = {
    leads: ["×œ×™×“×™×", "× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘"],
    myflows: ["×”×ª×”×œ×™×›×™× ×©×œ×™", "×¤×¢×•×œ×•×ª ×•×ª×”×œ×™×›×™ ×˜×™×¤×•×œ ××”×™×¨×™× ×œ×œ×§×•×— ×”× ×‘×—×¨"],
    tasks: ["××©×™××•×ª", "×ª×–×›×•×¨×•×ª ×¢× ×ª××¨×™×š/×©×¢×” + ×¢×“×™×¤×•×ª + ×©×™×•×š ×œ×œ×™×“"],
    timeline: ["×™×¦×™×¨×ª ×”×¦×¢×”", "Timeline ×©×œ ×›×œ ×¤×¢×•×œ×” ×•×©×™× ×•×™ ×‘××¢×¨×›×ª"],
    settings: ["×”×’×“×¨×•×ª", "×’×™×‘×•×™/××™×¤×•×¡ ×•×—×™×‘×•×¨ ×œ-Google Sheets"]
  };
  el("viewTitle").textContent = titles[view][0];
  el("viewSub").textContent = titles[view][1];

  // active view highlight (cards currently visible)
  ["viewLeads","viewRight","viewMyFlows","viewTasks","viewTimeline","viewSettings"].forEach(id=>{
    const node = el(id);
    if(!node) return;
    node.classList.remove("activeView");
  });
  if(view==="leads"){ el("viewLeads")?.classList.add("activeView"); el("viewRight")?.classList.add("activeView"); }
  if(view==="myflows") el("viewMyFlows")?.classList.add("activeView");
  if(view==="tasks") el("viewTasks")?.classList.add("activeView");
  if(view==="timeline") el("viewTimeline")?.classList.add("activeView");
  if(view==="settings") el("viewSettings")?.classList.add("activeView");



  showLoader(260);
  // add subtle entrance animation to visible panels
  ["viewLeads","viewRight","viewMyFlows","viewTasks","viewTimeline","viewSettings"].forEach(id=>{
    const node = el(id);
    if(!node) return;
    node.classList.remove("viewPanel");
    if(node.style.display !== "none"){
      // trigger reflow then add
      void node.offsetWidth;
      node.classList.add("viewPanel");
    }
  });

  renderAll();
}

/* ===== Modal ===== */
function openModal(title, html){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = html;
  el("modalBack").style.display = "flex";
}
function closeModal(){
  el("modalBack").style.display = "none";
  el("modalBody").innerHTML = "";
}
el("modalClose").addEventListener("click", closeModal);
el("modalBack").addEventListener("click", (e)=>{
  if(e.target === el("modalBack")) closeModal();
});


/* ===== Toast ===== */
let toastTimer=null;
function toast(msg, type){
  const t = el("toast");
  if(!t) return;
  const m = String(msg ?? "");
  const guess = (()=>{
    if(type) return type;
    const s = m.toLowerCase();
    if(s.includes("×©×’×™××”") || s.includes("×œ× × ×™×ª×Ÿ") || s.includes("×œ× ×ª×§×™×Ÿ") || s.includes("× ×›×©×œ")) return "error";
    if(s.includes("××–×”×¨×”") || s.includes("×©×™× ×œ×‘") || s.includes("âš ")) return "warn";
    return "success";
  })();
  t.classList.remove("success","warn","error","show");
  t.classList.add(guess);
  t.textContent = m;
  t.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.classList.remove("show"), 2600);
}


/* ===== Filters/Search/Sort ===== */
el("q").addEventListener("input", renderLeads);
el("fStatus").addEventListener("change", renderLeads);
el("fSource").addEventListener("change", renderLeads);
el("sortBy").addEventListener("change", renderLeads);

/* ===== Buttons ===== */
el("btnAddLead").addEventListener("click", ()=>openLeadForm());
const _btnQuickTask = el("btnQuickTask"); if(_btnQuickTask) _btnQuickTask.addEventListener("click", ()=> openTaskForm());
el("btnOpenInsights").addEventListener("click", ()=> openInsights());
el("btnSeed").addEventListener("click", seedSample);
const _btnExport = el("btnExport"); if(_btnExport) _btnExport.addEventListener("click", exportJSON);
const _btnImport = el("btnImport"); if(_btnImport) _btnImport.addEventListener("click", importJSON);
el("btnBackup").addEventListener("click", exportJSON);
el("btnReset").addEventListener("click", ()=>{
  if(confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.")){
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
});

/* ===== Shortcuts ===== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeModal();
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement?.tagName||"")){
    e.preventDefault();
    el("q").focus();
  }
  const modalOpen = (el("modalBack").style.display === "flex");
  if((e.key==="n" || e.key==="N") && !modalOpen){
    openLeadForm();
  }
});

function exportJSON(){
  const blob = new Blob([JSON.stringify(appState, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "leadup-backup.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("×’×™×‘×•×™ ×™×¨×“ ×œ××—×©×‘ âœ…");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const f = inp.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || typeof parsed !== "object") throw new Error("bad");
        appState.user = parsed.user || appState.user;
        appState.leads = Array.isArray(parsed.leads) ? parsed.leads : appState.leads;
        appState.tasks = Array.isArray(parsed.tasks) ? parsed.tasks : appState.tasks;
        appState.events = Array.isArray(parsed.events) ? parsed.events : appState.events;
        addEvent("import", "×™×™×‘×•× × ×ª×•× ×™× ×‘×•×¦×¢");
        saveState();
        toast("×™×™×‘×•× ×”×¦×œ×™×— âœ…");
      }catch(e){
        alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
      }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* =======================
   Leads CRUD
   ======================= */
function openLeadForm(leadId=null){
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;
  const isEdit = !!lead;

  const data = lead || {
    id: uid("lead"),
    name:"",
    phone:"",
    email:"",
    status:"×—×“×©",
    source:"××—×¨",
    owner:"×× ×”×œ",
    note:"",
    createdAt: nowISO(),
    lastContactAt:"",
    nextFollowUpAt:"",
    contactCount: 0
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ×œ×™×“" : "×œ×™×“ ×—×“×©", `
    <div class="split">
      <div>
        <form id="leadForm">
          <div class="row">
            <div>
              <label>×©× ××œ×</label>
              <input name="name" value="${escapeHTML(data.name)}" placeholder="×œ×“×•×’××”: ×™×©×¨××œ ×™×©×¨××œ×™" required/>
            </div>
            <div>
              <label>×˜×œ×¤×•×Ÿ</label>
              <input name="phone" value="${escapeHTML(data.phone)}" placeholder="05X-XXXXXXX" inputmode="tel"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××™××™×™×œ</label>
              <input name="email" value="${escapeHTML(data.email)}" placeholder="name@email.com" inputmode="email"/>
            </div>
            <div>
              <label>×‘×¢×œ×™× (× ×¦×™×’)</label>
              <input name="owner" value="${escapeHTML(data.owner||"×× ×”×œ")}" placeholder="×©× × ×¦×™×’"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>×¡×˜×˜×•×¡</label>
              <select name="status">
                ${["×—×“×©","× ×•×¦×¨ ×§×©×¨","××ª×¢× ×™×™×Ÿ","×”×¦×¢×ª ××—×™×¨","× ×¡×’×¨","×œ× ×¨×œ×•×•× ×˜×™"].map(s=>`
                  <option ${s===data.status?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
            <div>
              <label>××§×•×¨</label>
              <select name="source">
                ${["×¤×™×™×¡×‘×•×§","×’×•×’×œ","×”×¤× ×™×”","×˜×œ×¤×•×Ÿ","××ª×¨","××—×¨"].map(s=>`
                  <option ${s===data.source?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××¢×§×‘ ×”×‘× (×ª××¨×™×š/×©×¢×”)</label>
              <input name="nextFollowUpAt" value="${escapeHTML(toLocalDT(data.nextFollowUpAt))}" type="datetime-local"/>
            </div>
            <div>
              <label>×¢×“×›×•×Ÿ "×“×™×‘×¨× ×•" (××¢×œ×” score)</label>
              <button type="button" class="btn" id="btnTouch" style="width:100%">â˜ï¸ ×¡×™××•×Ÿ ×©×™×—×”/××¢× ×”</button>
              <div class="help">××¢×œ×” Contact Count + ××¢×“×›×Ÿ Last Contact.</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>×”×¢×¨×”</label>
            <textarea name="note" placeholder="×¨×©×•× ×¤×¨×˜×™× ×—×©×•×‘×™×â€¦">${escapeHTML(data.note||"")}</textarea>
          </div>

          <div class="sep"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            <button class="btn" type="button" id="btnCreateTask">â° ×¦×•×¨ ××©×™××” ×œ×œ×™×“</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteLead">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
            <button class="btn" type="button" id="btnOpenContact">ğŸ“² ×¤×¢×•×œ×•×ª ×§×©×¨</button>
          </div>

          <div class="help">
            Lead Score ××ª×—×©×‘ ×‘×¡×˜×˜×•×¡, ××§×•×¨, ×›××•×ª ×©×™×—×•×ª ×•×–××Ÿ ×©×¢×‘×¨.
          </div>
        </form>
      </div>

      <div>
        <div class="miniCard">
          <h3>×ª×¦×•×’×” ××”×™×¨×”</h3>
          <div class="small muted">× ×•×¦×¨: ${fmtDT(data.createdAt)}</div>
          <div class="small muted">×©×™×—×” ××—×¨×•× ×”: ${data.lastContactAt ? fmtDT(data.lastContactAt) : "â€”"}</div>
          <div class="small muted">×©×™×—×•×ª/××¢× ×™×: ${Number(data.contactCount||0)}</div>
          <div class="sep"></div>
          <div class="score">
            <div class="tag ${heatTag(computeScore(data)).cls}">ğŸ”¥ ${heatTag(computeScore(data)).label}</div>
            <div style="font-weight:800">${computeScore(data)}/100</div>
          </div>
          <div class="bar" style="margin-top:10px"><i style="width:${computeScore(data)}%"></i></div>
          <div class="help">×›×›×œ ×©×”×¦×™×•×Ÿ ×’×‘×•×” ×™×•×ª×¨â€”×”×œ×™×“ â€œ×—×â€ ×™×•×ª×¨.</div>
        </div>

        <div class="miniCard" style="margin-top:10px">
          <h3>×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h3>
          <div class="actions">
            <button type="button" class="iconBtn gold" title="×•×•××˜×¡××¤" id="qaWA">ğŸ’¬</button>
            <button type="button" class="iconBtn" title="×”×ª×§×©×¨" id="qaCall">ğŸ“</button>
            <button type="button" class="iconBtn" title="××™××™×™×œ" id="qaMail">âœ‰ï¸</button>
            <button type="button" class="iconBtn" title="×”×¢×ª×§ ×˜×œ×¤×•×Ÿ" id="qaCopy">ğŸ“‹</button>
          </div>
          <div class="help">×›××Ÿ ×”×›×œ ×‘×ª×•×š ××•×“××œ (×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×“×©).</div>
        </div>
      </div>
    </div>
  `);

  const form = document.getElementById("leadForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.nextFollowUpAt = fromLocalDT(updated.nextFollowUpAt);
    updated.createdAt = data.createdAt || nowISO();

    const idx = appState.leads.findIndex(l=>l.id===updated.id);
    if(idx>=0){
      appState.leads[idx] = updated;
      addEvent("lead_update", `×¢×•×“×›×Ÿ ×œ×™×“: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ ×¢×•×“×›×Ÿ âœ…");
    }else{
      appState.leads.unshift(updated);
      addEvent("lead_create", `× ×•×¦×¨ ×œ×™×“ ×—×“×©: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ × ×•×¡×£ âœ…");
    }
    saveState();
    closeModal();
  });

  document.getElementById("btnTouch").addEventListener("click", ()=>{
    data.contactCount = Number(data.contactCount||0) + 1;
    data.lastContactAt = nowISO();
    addEvent("contact", `×©×™×—×”/××¢× ×” ×¡×•××Ÿ ×œ×œ×™×“: ${data.name||"(×œ×œ× ×©×)"}`, {leadId:data.id});
    toast("×¡×•××Ÿ ×©×™×—×” âœ…");
    const idx = appState.leads.findIndex(l=>l.id===data.id);
    if(idx>=0) appState.leads[idx] = data;
    else appState.leads.unshift(data);
    saveState();
    openLeadForm(data.id);
  });

  if(isEdit){
    document.getElementById("btnDeleteLead").addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”×œ×™×“?")) return;
      appState.leads = appState.leads.filter(l=>l.id!==leadId);
      appState.tasks = appState.tasks.filter(t=>t.leadId!==leadId);
      addEvent("lead_delete", `× ××—×§ ×œ×™×“: ${lead.name}`, {leadId});
      saveState();
      closeModal();
      toast("×œ×™×“ × ××—×§ ğŸ—‘ï¸");
    });
  }

  document.getElementById("btnCreateTask").addEventListener("click", ()=>{
    openTaskForm({ leadId: data.id, leadName: data.name, presetDate: data.nextFollowUpAt });
  });

  document.getElementById("btnOpenContact").addEventListener("click", ()=>{
    openContactPanel(data);
  });

  document.getElementById("qaWA").addEventListener("click", ()=> openContactPanel(data, "wa"));
  document.getElementById("qaCall").addEventListener("click", ()=> openContactPanel(data, "call"));
  document.getElementById("qaMail").addEventListener("click", ()=> openContactPanel(data, "mail"));
  document.getElementById("qaCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(data.phone||"");
      toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹");
    }catch{
      toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×‘×“×¤×“×¤×Ÿ ×”×–×”");
    }
  });
}

/* ===== Contact panel (in-modal) ===== */
function normalizeILPhone(phone){
  const digits = String(phone||"").replace(/[^\d]/g,"");
  if(!digits) return "";
  // if starts with 0 -> IL
  if(digits.startsWith("0")) return "972" + digits.slice(1);
  // already includes country?
  if(digits.startsWith("972")) return digits;
  // fallback
  return digits;
}

function openContactPanel(lead, focus="wa"){
  const phoneIL = normalizeILPhone(lead.phone);
  const mail = (lead.email||"").trim();
  const waWeb = phoneIL ? `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}` : "";
  const tel = (lead.phone||"").trim();
  const mailto = mail ? `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent("LEADUP - ×¤× ×™×”")}` : "";

  openModal(`×¤×¢×•×œ×•×ª ×§×©×¨ â€¢ ${lead.name || "×œ×™×“"}`, `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¤×¨×˜×™ ×§×©×¨</h3>
        <div class="small muted">×˜×œ×¤×•×Ÿ: <b>${escapeHTML(lead.phone||"â€”")}</b></div>
        <div class="small muted" style="margin-top:6px">××™××™×™×œ: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cWA" ${waWeb? "":"disabled"}>ğŸ’¬ ×•×•××˜×¡××¤</button>
          <button class="btn" type="button" id="cCall" ${tel? "":"disabled"}>ğŸ“ ×”×ª×§×©×¨</button>
          <button class="btn" type="button" id="cMail" ${mailto? "":"disabled"}>âœ‰ï¸ ××™×™×œ</button>
          <button class="btn" type="button" id="cCopyPhone" ${tel? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
          <button class="btn" type="button" id="cCopyMail" ${mail? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
        </div>

        <div class="help">
          ×”×¢×¨×”: â€œ×”×ª×§×©×¨â€ / â€œ××™×™×œâ€ ×œ× × ×¤×ª×—×™× ×‘×ª×•×š iframe ×‘×’×œ×œ ××’×‘×œ×•×ª ×“×¤×“×¤×Ÿ,
          ××‘×œ × ×©××¨×™× ×‘×ª×•×š ×”××•×“××œ ×¢× ×›×¤×ª×•×¨×™ ×”×¢×ª×§×” + ×§×™×©×•×¨.
        </div>

        <div class="sep"></div>
        <div class="miniCard" style="margin:0; background:rgba(255,255,255,.02)">
          <h3 style="margin-bottom:8px">×”×•×“×¢×” ××”×™×¨×” ×œ×•×•××˜×¡××¤</h3>
          <label>×˜×§×¡×˜</label>
          <textarea id="waText" placeholder="×”×™×™ ${escapeHTML(lead.name||"")}, ××“×‘×¨/×ª ×-...">${escapeHTML(`×”×™×™ ${lead.name||""}, ××“×‘×¨/×ª ×-LEADUP. ××¤×©×¨ ×œ×¢×–×•×¨?`)}</textarea>
          <button class="btn gold" type="button" id="waOpenMsg" style="margin-top:10px" ${waWeb? "":"disabled"}>ğŸš€ ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×”×•×“×¢×”</button>
        </div>
      </div>

      <div class="miniCard">
        <h3>×ª×¦×•×’×” ×‘×ª×•×š ×”××¢×¨×›×ª</h3>
        ${waWeb ? `
          <div class="frame">
            <iframe id="waFrame" src="${escapeHTML(waWeb)}"></iframe>
          </div>
          <div class="help">×× ×œ× ×”×ª×—×‘×¨×ª ×œ-WhatsApp Web ×‘××—×©×‘, ×ª×¦×˜×¨×š ×œ×”×ª×—×‘×¨ ×¤×¢× ××—×ª.</div>
        ` : `
          <div class="help">××™×Ÿ ×˜×œ×¤×•×Ÿ ×œ×œ×™×“ â€” ×”×•×¡×£ ××¡×¤×¨ ×•××– ×ª×•×›×œ ×œ×¤×ª×•×— WhatsApp Web ×›××Ÿ.</div>
        `}
      </div>
    </div>
  `);

  // wire buttons
  const cWA = document.getElementById("cWA");
  const cCall = document.getElementById("cCall");
  const cMail = document.getElementById("cMail");
  const cCopyPhone = document.getElementById("cCopyPhone");
  const cCopyMail = document.getElementById("cCopyMail");

  if(cWA) cWA.addEventListener("click", ()=>{
    if(!waWeb) return;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = waWeb;
    addEvent("contact_open", `× ×¤×ª×— ×•×•××˜×¡××¤ ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  if(cCall) cCall.addEventListener("click", async ()=>{
    // keep inside modal: show link and copy
    addEvent("call_hint", `× ×™×¡×™×•×Ÿ ×”×ª×§×©×¨×•×ª (×§×™×©×•×¨ Tel) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    toast("×”×¢×ª×§× ×• ×œ×š/×¦×™×¨×¤× ×• ×§×™×©×•×¨ ×œ×”×ª×§×©×¨×•×ª ×‘×ª×•×š ×”××•×“××œ");
    openModal(`×”×ª×§×©×¨ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×”×ª×§×©×¨×•×ª</h3>
        <div class="small muted">××¡×¤×¨: <b>${escapeHTML(tel||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="ccCopy">ğŸ“‹ ×”×¢×ª×§ ××¡×¤×¨</button>
          <a class="btn" href="${escapeHTML(tel ? "tel:"+tel.replace(/[^\d+]/g,"") : "#")}" style="text-decoration:none; ${tel? "":"pointer-events:none;opacity:.6"}">ğŸ“ ×—×™×™×’ (×× ×”×“×¤×“×¤×Ÿ ×××¤×©×¨)</a>
        </div>
        <div class="help">×‘××—×©×‘ ×œ×¤×¢××™× Tel ×œ× ×¢×•×‘×“ â€” ××– ×”×›×™ ×˜×•×‘ ×œ×”×¢×ª×™×§ ×•×œ×”×ª×§×©×¨ ××”× ×™×™×“.</div>
      </div>
    `);
    document.getElementById("ccCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(tel||""); toast("×”××¡×¤×¨ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cMail) cMail.addEventListener("click", ()=>{
    addEvent("mail_hint", `× ×¤×ª×— ××™×™×œ (mailto) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    openModal(`××™×™×œ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×©×œ×™×—×ª ××™×™×œ</h3>
        <div class="small muted">×›×ª×•×‘×ª: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cmCopy">ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
          <a class="btn" href="${escapeHTML(mailto)}" style="text-decoration:none; ${mailto? "":"pointer-events:none;opacity:.6"}">âœ‰ï¸ ×¤×ª×— ×ª×•×›× ×ª ××™×™×œ</a>
        </div>
        <div class="help">mailto ×ª×œ×•×™ ×‘×”×’×“×¨×•×ª ×”××—×©×‘ ×©×œ×š (Gmail/Outlook ×•×›×•'). ×× ×œ× × ×¤×ª×—â€”×¤×©×•×˜ ×”×¢×ª×§.</div>
      </div>
    `);
    document.getElementById("cmCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cCopyPhone) cCopyPhone.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(tel||""); toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });
  if(cCopyMail) cCopyMail.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });

  document.getElementById("waOpenMsg")?.addEventListener("click", ()=>{
    if(!phoneIL) return;
    const txt = document.getElementById("waText")?.value || "";
    // WhatsApp web message param
    const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}&text=${encodeURIComponent(txt)}`;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = url;
    addEvent("wa_msg", `× ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×•×“×¢×” ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  // focus
  if(focus==="wa") cWA?.click();
}

/* =======================
   Tasks CRUD
   ======================= */
function openTaskForm(opts={}){
  // opts: { taskId, leadId, leadName, presetDate }
  const task = opts.taskId ? appState.tasks.find(t=>t.id===opts.taskId) : null;
  const isEdit = !!task;

  const leadId = opts.leadId || task?.leadId || "";
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;

  const data = task || {
    id: uid("task"),
    leadId: leadId || "",
    title: "",
    dueAt: opts.presetDate || "",
    priority: "×‘×™× ×•× ×™×ª",
    status: "×¤×ª×•×—×”",
    createdAt: nowISO()
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ××©×™××”" : "××©×™××” ×—×“×©×”", `
    <form id="taskForm">
      <div class="row">
        <div>
          <label>×©×™×™×š ×œ×œ×™×“</label>
          <select name="leadId">
            <option value="">×œ×œ× ×©×™×•×š</option>
            ${appState.leads.map(l=>`
              <option value="${escapeHTML(l.id)}" ${l.id===data.leadId?"selected":""}>${escapeHTML(l.name || "(×œ×œ× ×©×)")}</option>
            `).join("")}
          </select>
          <div class="help">${lead ? `× ×‘×—×¨: <b>${escapeHTML(lead.name)}</b>` : "××¤×©×¨ ×œ×‘×—×•×¨ ×œ×™×“ ××• ×œ×”×©××™×¨ ×œ×œ× ×©×™×•×š."}</div>
        </div>
        <div>
          <label>××ª×™ (×ª××¨×™×š/×©×¢×”)</label>
          <input name="dueAt" type="datetime-local" value="${escapeHTML(toLocalDT(data.dueAt))}"/>
          <div class="help">××¤×©×¨ ×’× â€œ×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×â€ ×œ××˜×”.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>×¢×“×™×¤×•×ª</label>
          <select name="priority">
            ${["×’×‘×•×”×”","×‘×™× ×•× ×™×ª","× ××•×›×”"].map(p=>`
              <option ${p===data.priority?"selected":""}>${p}</option>
            `).join("")}
          </select>
        </div>
        <div>
          <label>×¡×˜×˜×•×¡</label>
          <select name="status">
            ${["×¤×ª×•×—×”","×‘×•×¦×¢×”"].map(s=>`
              <option ${s===data.status?"selected":""}>${s}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>×ª×™××•×¨</label>
        <textarea name="title" placeholder="×œ×“×•×’××”: ×œ×—×–×•×¨ ×œ×œ×™×“ ×•×œ×ª×ª ×”×¦×¢×ª ××—×™×¨â€¦">${escapeHTML(data.title||"")}</textarea>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×</label>
          <div style="display:flex; gap:10px">
            <input id="xDays" type="number" min="0" placeholder="×œ×“×•×’××”: 3"/>
            <button type="button" class="btn" id="btnApplyX">ğŸ“… ×§×‘×¢ ×ª××¨×™×š</button>
          </div>
          <div class="help">×™×§×‘×¢ Due ×œ×¤×™ ×¢×›×©×™×• + X ×™××™×.</div>
        </div>
        <div>
          <label>×¤×¢×•×œ×•×ª</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteTask">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
          </div>
        </div>
      </div>
    </form>
  `);

  document.getElementById("btnApplyX")?.addEventListener("click", ()=>{
    const x = Number(document.getElementById("xDays")?.value || 0);
    const d = new Date();
    d.setDate(d.getDate() + (Number.isFinite(x)? x : 0));
    const local = toLocalDT(d.toISOString());
    const due = document.querySelector('#taskForm input[name="dueAt"]');
    if(due) due.value = local;
    toast("× ×§×‘×¢ ×ª××¨×™×š âœ…");
  });

  const form = document.getElementById("taskForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.dueAt = fromLocalDT(updated.dueAt);

    const idx = appState.tasks.findIndex(t=>t.id===updated.id);
    const leadName = updated.leadId ? (appState.leads.find(l=>l.id===updated.leadId)?.name || "×œ×™×“") : "×œ×œ× ×©×™×•×š";
    if(idx>=0){
      appState.tasks[idx] = updated;
      addEvent("task_update", `×¢×•×“×›× ×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” ×¢×•×“×›× ×” âœ…");
    }else{
      appState.tasks.unshift(updated);
      addEvent("task_create", `× ×•×¦×¨×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” × ×•×¡×¤×” âœ…");
    }
    saveState();
    closeModal();
  });

  if(isEdit){
    document.getElementById("btnDeleteTask")?.addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”××©×™××”?")) return;
      appState.tasks = appState.tasks.filter(t=>t.id!==data.id);
      addEvent("task_delete", `× ××—×§×” ××©×™××”`, {taskId: data.id, leadId: data.leadId||""});
      saveState();
      closeModal();
      toast("××©×™××” × ××—×§×” ğŸ—‘ï¸");
    });
  }
}

function toggleTaskDone(taskId){
  const t = appState.tasks.find(x=>x.id===taskId);
  if(!t) return;
  t.status = (t.status==="×‘×•×¦×¢×”") ? "×¤×ª×•×—×”" : "×‘×•×¦×¢×”";
  addEvent("task_toggle", `×¡×˜×˜×•×¡ ××©×™××”: ${t.status}`, {taskId: t.id, leadId: t.leadId||""});
  saveState();
}

/* =======================
   Rendering
   ======================= */

/* ===== Animated Counters (Dashboard) ===== */
function animateNumber(elm, to){
  if(!elm) return;
  const from = Number(String(elm.textContent||"0").replace(/[^\d.-]/g,"")) || 0;
  const target = Number(to) || 0;
  if(from === target){ elm.textContent = String(target); return; }
  const start = performance.now();
  const dur = 520;
  const step = (t)=>{
    const p = Math.min(1, (t-start)/dur);
    const eased = 1 - Math.pow(1-p, 3);
    const val = Math.round(from + (target-from)*eased);
    elm.textContent = String(val);
    if(p < 1) requestAnimationFrame(step);
  };
  requestAnimationFrame(step);
}

function renderAll(){
  renderStats();
  renderLeads();
  renderTasks();
  renderTimeline();
  renderNavCounts();
}

function renderNavCounts(){
  el("navCount").textContent = String(appState.leads.length);
  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;
  el("navTasks").textContent = String(openTasks);
  el("navEvents").textContent = String(appState.events.length);
}

function renderStats(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const hot = scores.filter(s=>s>=75).length;

  const today = todayKey();
  const todayFollow = appState.leads.filter(l=>{
    if(!l.nextFollowUpAt) return false;
    const d = new Date(l.nextFollowUpAt);
    if(Number.isNaN(d.getTime())) return false;
    const k = d.toLocaleDateString("sv-SE");
    return k === today;
  }).length;

  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;

  animateNumber(el("stTotal"), total);
  animateNumber(el("stHot"), hot);
  animateNumber(el("stToday"), todayFollow);
  animateNumber(el("stTasks"), openTasks);
}

function getFilteredSortedLeads(){
  const q = (el("q").value||"").trim().toLowerCase();
  const fStatus = el("fStatus").value;
  const fSource = el("fSource").value;
  const sortBy = el("sortBy").value;

  let arr = [...appState.leads];

  if(q){
    arr = arr.filter(l=>{
      const hay = [
        l.name, l.phone, l.email, l.status, l.source, l.owner, l.note
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  if(fStatus) arr = arr.filter(l=> (l.status||"")===fStatus);
  if(fSource) arr = arr.filter(l=> (l.source||"")===fSource);

  const scoreOf = (l)=>computeScore(l);
  const nextTime = (l)=> l.nextFollowUpAt ? new Date(l.nextFollowUpAt).getTime() : Infinity;
  const createdTime = (l)=> l.createdAt ? new Date(l.createdAt).getTime() : 0;

  if(sortBy==="hot"){
    arr.sort((a,b)=> scoreOf(b)-scoreOf(a));
  }else if(sortBy==="next"){
    arr.sort((a,b)=> nextTime(a)-nextTime(b));
  }else if(sortBy==="newest"){
    arr.sort((a,b)=> createdTime(b)-createdTime(a));
  }else if(sortBy==="oldest"){
    arr.sort((a,b)=> createdTime(a)-createdTime(b));
  }
  return arr;
}

function renderLeads(){
  const tbody = el("leadsTbody");
  const leads = getFilteredSortedLeads();

  el("emptyLeads").style.display = (appState.leads.length===0) ? "" : "none";

  tbody.innerHTML = leads.map(l=>{
    const score = computeScore(l);
    const ht = heatTag(score);
    return `
      <tr>
        <td><b>${escapeHTML(l.name||"â€”")}</b><div class="small muted">${escapeHTML(l.owner||"")}</div></td>
        <td>${escapeHTML(l.phone||"â€”")}</td>
        <td><span class="tag">${escapeHTML(l.status||"â€”")}</span></td>
        <td><span class="tag">${escapeHTML(l.source||"â€”")}</span></td>
        <td>
          <div class="score">
            <span class="tag ${ht.cls}">${ht.label}</span>
            <b>${score}</b>
          </div>
          <div class="bar" style="margin-top:8px"><i style="width:${score}%"></i></div>
        </td>
        <td>${l.nextFollowUpAt ? fmtDT(l.nextFollowUpAt) : "â€”"}</td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-tip="×¢×¨×•×š" data-act="edit" data-id="${escapeHTML(l.id)}">âœ</button>
            <button class="iconBtn" title="××©×™××”" data-tip="×¦×•×¨ ××©×™××”" data-act="task" data-id="${escapeHTML(l.id)}">â°</button>
            <button class="iconBtn" title="×§×©×¨" data-tip="×¤×¢×•×œ×•×ª ×§×©×¨" data-act="contact" data-id="${escapeHTML(l.id)}">ğŸ“²</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="edit") openLeadForm(id);
      if(act==="task"){
        const lead = appState.leads.find(l=>l.id===id);
        openTaskForm({ leadId:id, leadName: lead?.name || "" , presetDate: lead?.nextFollowUpAt || ""});
      }
      if(act==="contact"){
        const lead = appState.leads.find(l=>l.id===id);
        if(lead) openContactPanel(lead);
      }
    });
  });
}

function renderTasks(){
  const tbody = el("tasksTbody");
  const tasks = [...appState.tasks].sort((a,b)=>{
    const da = a.dueAt ? new Date(a.dueAt).getTime() : Infinity;
    const db = b.dueAt ? new Date(b.dueAt).getTime() : Infinity;
    return da-db;
  });

  const openTasks = tasks.filter(t=>t.status!=="×‘×•×¦×¢×”");
  el("emptyTasks").style.display = (openTasks.length===0) ? "" : "none";

  tbody.innerHTML = openTasks.map(t=>{
    const leadName = t.leadId ? (appState.leads.find(l=>l.id===t.leadId)?.name || "×œ×™×“") : "â€”";
    const priTag = t.priority==="×’×‘×•×”×”" ? "hot" : (t.priority==="×‘×™× ×•× ×™×ª" ? "ok" : "cold");
    return `
      <tr>
        <td>${t.dueAt ? fmtDT(t.dueAt) : "â€”"}</td>
        <td><span class="tag ${priTag}">${escapeHTML(t.priority||"")}</span></td>
        <td>${escapeHTML(leadName)}</td>
        <td>${escapeHTML(t.title||"")}</td>
        <td><span class="tag">${escapeHTML(t.status||"")}</span></td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-tip="×¢×¨×•×š" data-act="edit" data-id="${escapeHTML(t.id)}">âœ</button>
            <button class="iconBtn" title="×‘×•×¦×¢×”/×¤×ª×•×—×”" data-act="done" data-id="${escapeHTML(t.id)}">âœ“</button>
            <button class="iconBtn" title="××—×™×§×”" data-act="del" data-id="${escapeHTML(t.id)}">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="edit") openTaskForm({ taskId:id });
      if(act==="done") toggleTaskDone(id);
      if(act==="del"){
        if(!confirm("×œ××—×•×§ ××©×™××”?")) return;
        appState.tasks = appState.tasks.filter(t=>t.id!==id);
        addEvent("task_delete", "× ××—×§×” ××©×™××”", {taskId:id});
        saveState();
      }
    });
  });
}

function renderTimeline(){
  const list = el("timelineList");
  const events = appState.events.slice(0, 200);
  el("emptyTimeline").style.display = (events.length===0) ? "" : "none";

  list.innerHTML = events.map(ev=>{
    const who = ev.who || "××©×ª××©";
    return `
      <div class="event">
        <div class="t">${fmtDT(ev.at)} â€¢ ${escapeHTML(who)} â€¢ <span class="muted">${escapeHTML(ev.type||"")}</span></div>
        <div class="d">${escapeHTML(ev.text||"")}</div>
      </div>
    `;
  }).join("");
}

/* =======================
   Insights
   ======================= */
function openInsights(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

  const byStatus = {};
  for(const l of appState.leads){
    const k = l.status || "×œ× ××•×’×“×¨";
    byStatus[k] = (byStatus[k]||0)+1;
  }
  const bySource = {};
  for(const l of appState.leads){
    const k = l.source || "×œ× ××•×’×“×¨";
    bySource[k] = (bySource[k]||0)+1;
  }

  const topHot = [...appState.leads]
    .sort((a,b)=>computeScore(b)-computeScore(a))
    .slice(0, 5);

  openModal("×¡×˜×˜×™×¡×˜×™×§×•×ª â€¢ LEADUP", `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¡×™×›×•×</h3>
        <div class="small muted">×¡×”×´×› ×œ×™×“×™×: <b>${total}</b></div>
        <div class="small muted">×××•×¦×¢ Score: <b>${avg}</b></div>
        <div class="sep"></div>
        <h3>Top 5 ×—××™×</h3>
        ${topHot.length ? topHot.map(l=>`
          <div class="event">
            <div class="t">${escapeHTML(l.name||"â€”")} â€¢ ${escapeHTML(l.status||"")}</div>
            <div class="d"><b>${computeScore(l)}</b>/100 â€¢ ${l.nextFollowUpAt ? "××¢×§×‘: "+fmtDT(l.nextFollowUpAt) : "×œ×œ× ××¢×§×‘"}</div>
          </div>
        `).join("") : `<div class="help">××™×Ÿ ×œ×™×“×™×.</div>`}
      </div>

      <div class="miniCard">
        <h3>×”×ª×¤×œ×’×•×ª</h3>
        <div class="small muted"><b>×œ×¤×™ ×¡×˜×˜×•×¡</b></div>
        ${Object.keys(byStatus).length ? Object.entries(byStatus).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
        <div class="sep"></div>
        <div class="small muted"><b>×œ×¤×™ ××§×•×¨</b></div>
        ${Object.keys(bySource).length ? Object.entries(bySource).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
      </div>
    </div>
  `);
}

/* =======================
   Seed sample data
   ======================= */
function seedSample(){
  if(appState.leads.length && !confirm("×›×‘×¨ ×™×© ×œ×™×“×™×. ×œ×”×•×¡×™×£ ×¢×•×“ ×“×•×’×××•×ª?")) return;

  const mkLead = (name, phone, status, source, nextDays, talks=0)=>({
    id: uid("lead"),
    name, phone,
    email: "",
    status, source,
    owner: "×× ×”×œ",
    note: "×“×•×’××”",
    createdAt: new Date(Date.now() - (Math.random()*8+1)*86400000).toISOString(),
    lastContactAt: talks ? new Date(Date.now() - (Math.random()*4+1)*86400000).toISOString() : "",
    nextFollowUpAt: nextDays!=null ? new Date(Date.now()+nextDays*86400000).toISOString() : "",
    contactCount: talks
  });

  const demo = [
    mkLead("××™×ª×™ ×›×”×Ÿ","052-1234567","××ª×¢× ×™×™×Ÿ","×”×¤× ×™×”",1,3),
    mkLead("× ×•×¢×” ×œ×•×™","054-9876543","× ×•×¦×¨ ×§×©×¨","×¤×™×™×¡×‘×•×§",0,1),
    mkLead("×“× ×™××œ ××•×—× ×”","050-2223344","×”×¦×¢×ª ××—×™×¨","×’×•×’×œ",2,4),
    mkLead("×¨×•×¢×™ ×‘×™×˜×•×Ÿ","053-5556677","×—×“×©","××ª×¨",3,0),
    mkLead("×©×—×¨ ×××Ÿ","052-7654321","× ×¡×’×¨","×˜×œ×¤×•×Ÿ",null,6),
  ];

  appState.leads.unshift(...demo);
  addEvent("seed", "× ×•×¦×¨×• ×œ×™×“×™× ×œ×“×•×’××”");
  // ×’× ××©×™××•×ª ×œ×“×•×’××”
  appState.tasks.unshift(
    { id: uid("task"), leadId: demo[0].id, title:"×œ×—×–×•×¨ ×¢× ×”×¦×¢×ª ××—×™×¨", dueAt: new Date(Date.now()+86400000).toISOString(), priority:"×’×‘×•×”×”", status:"×¤×ª×•×—×”", createdAt: nowISO() },
    { id: uid("task"), leadId: demo[2].id, title:"×‘×“×™×§×ª ××¡××›×™×", dueAt: new Date(Date.now()+2*86400000).toISOString(), priority:"×‘×™× ×•× ×™×ª", status:"×¤×ª×•×—×”", createdAt: nowISO() }
  );
  addEvent("seed", "× ×•×¦×¨×• ××©×™××•×ª ×œ×“×•×’××”");
  saveState();
  toast("× ×•×¦×¨×• ×“×•×’×××•×ª âœ…");
}

/* =======================
   Init
   ======================= */
(function init(){
  if(!appState.events.length){
    addEvent("init", "×”××¢×¨×›×ª ×¢×œ×ª×” â€¢ ××¦×‘ LocalStorage");
    saveState();
  }else{
    renderAll();
  }
})();

/* =======================
   Transitions + Loader
   ======================= */


/* =======================
   Dynamic Greeting
   ======================= */
function updateGreeting(){
  const h = new Date().getHours();
  let txt = "×©×œ×•× ğŸ‘‹";
  if(h >= 5 && h < 12) txt = "â˜€ï¸ ×‘×•×§×¨ ×˜×•×‘";
  else if(h >= 12 && h < 17) txt = "ğŸŒ¤ï¸ ×¦×”×¨×™×™× ×˜×•×‘×™×";
  else if(h >= 17 && h < 21) txt = "ğŸŒ† ×¢×¨×‘ ×˜×•×‘";
  else txt = "ğŸŒ™ ×œ×™×œ×” ×˜×•×‘";
  const elG = document.getElementById("greetingBadge");
  if(elG) elG.textContent = txt;
}
updateGreeting();
setInterval(updateGreeting, 60 * 1000);


/* ===== Micro-interaction: subtle haptic on mobile taps ===== */
document.addEventListener("click", (e)=>{
  const b = e.target.closest(".btn, .iconBtn");
  if(!b) return;
  if(navigator.vibrate){
    try{ navigator.vibrate(8); }catch{}
  }
}, {passive:true});


/* ===== Sidebar: My Flows (replaces Quick Task button) ===== */

;

</script>

<!-- ===== Proposal Builder Modal ===== -->
<div id="proposalModal" class="modalOverlay" role="dialog" aria-modal="true" aria-labelledby="proposalModalTitle">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div id="proposalModalTitle" class="title">×™×¦×™×¨×ª ×”×¦×¢×”</div>
        <div class="sub">×‘×—×¨ ×—×‘×¨×ª ×‘×™×˜×•×— â€” ×•××– × ×˜×¢×Ÿ ××ª ×˜×•×¤×¡ ×”×”×¦×¢×” ×‘×ª×•×š ×—×œ×•×Ÿ ×¤× ×™××™</div>
      </div>
      <button class="btnGhost" id="proposalCloseBtn" aria-label="×¡×’×•×¨">âœ• ×¡×’×•×¨</button>
    </div>

    <div class="modalBody">
      <div class="modalLeft">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <div style="font-weight:800">×—×‘×¨×•×ª ×‘×™×˜×•×—</div>
          <button class="btnGhost" id="proposalBackBtn" style="display:none">â†© ×—×–×¨×” ×œ×¨×©×™××”</button>
        </div>

        <div class="companyList" id="companyList">
          <!-- ×©× ×” ×›××Ÿ ××ª ×”×©××•×ª ×•×”×§×™×©×•×¨×™× ×œ×˜×¤×¡×™× ×©×œ×š -->
          <button class="companyBtn" data-company="×”×¨××œ" data-url="https://example.com/harel-form">
            <div>
              <div class="name">×”×¨××œ</div>
              <div class="hint">×˜×•×¤×¡ ×”×¦×¢×”</div>
            </div>
            <div>â€º</div>
          </button>

          <button class="companyBtn" data-company="××’×“×œ" data-url="https://example.com/migdal-form">
            <div>
              <div class="name">××’×“×œ</div>
              <div class="hint">×˜×•×¤×¡ ×”×¦×¢×”</div>
            </div>
            <div>â€º</div>
          </button>

          <button class="companyBtn" data-company="×›×œ×œ" data-url="clal_offer.pdf">
            <div>
              <div class="name">×›×œ×œ</div>
              <div class="hint">×˜×•×¤×¡ ×”×¦×¢×” (PDF)</div>
            </div>
            <div>â€º</div>
          </button>

          <button class="companyBtn" data-company="×”×¤× ×™×§×¡" data-url="https://example.com/phoenix-form">
            <div>
              <div class="name">×”×¤× ×™×§×¡</div>
              <div class="hint">×˜×•×¤×¡ ×”×¦×¢×”</div>
            </div>
            <div>â€º</div>
          </button>

          <button class="companyBtn" data-company="×× ×•×¨×” ××‘×˜×—×™×" data-url="https://example.com/menora-form">
            <div>
              <div class="name">×× ×•×¨×” ××‘×˜×—×™×</div>
              <div class="hint">×˜×•×¤×¡ ×”×¦×¢×”</div>
            </div>
            <div>â€º</div>
          </button>
        </div>
      </div>

      <div class="modalRight">
        <div class="proposalTop">
          <div class="crumb" id="proposalCrumb">×œ× × ×‘×—×¨×” ×—×‘×¨×”</div>
          <div style="display:flex;gap:8px;align-items:center">
            <a id="proposalOpenExternal" href="#" target="_blank" rel="noopener" style="display:none;color:var(--gold2);font-weight:800;text-decoration:none">×¤×ª×— ×‘×˜××‘ ×—×“×©</a>
          </div>
        </div>

        <div class="proposalFrame">
          <iframe id="proposalFrame" title="×˜×•×¤×¡ ×”×¦×¢×”" src="about:blank"></iframe>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGhost" id="proposalClearBtn">× ×§×”</button>
      <button class="btnGold" id="proposalDoneBtn">×¡×’×•×¨</button>
    </div>
  </div>
</div>


<script>
/* ===== Proposal Builder Logic ===== */
(function(){
  const modal = document.getElementById('proposalModal');
  if(!modal) return;

  const frame = document.getElementById('proposalFrame');
  const crumb = document.getElementById('proposalCrumb');
  const openExternal = document.getElementById('proposalOpenExternal');
  const closeBtn = document.getElementById('proposalCloseBtn');
  const doneBtn = document.getElementById('proposalDoneBtn');
  const clearBtn = document.getElementById('proposalClearBtn');
  const backBtn = document.getElementById('proposalBackBtn');
  const companyList = document.getElementById('companyList');

  function showModal(){
    modal.classList.add('show');
    // focus close for accessibility
    setTimeout(()=> closeBtn?.focus(), 0);
  }
  function hideModal(){
    modal.classList.remove('show');
  }
  function clearFrame(){
    frame.src = 'about:blank';
    crumb.textContent = '×œ× × ×‘×—×¨×” ×—×‘×¨×”';
    openExternal.style.display = 'none';
    openExternal.href = '#';
    backBtn.style.display = 'none';
    companyList.scrollTop = 0;
  }
  function loadCompany(name, url){
    crumb.textContent = '× ×‘×—×¨: ' + name;
    frame.src = url;
    openExternal.href = url;
    openExternal.style.display = 'inline';
    backBtn.style.display = 'inline-flex';
  }

  // Close actions
  closeBtn?.addEventListener('click', hideModal);
  doneBtn?.addEventListener('click', hideModal);
  clearBtn?.addEventListener('click', clearFrame);

  // Back (go to list state)
  backBtn?.addEventListener('click', clearFrame);

  // Click outside card closes
  modal.addEventListener('click', (e)=>{
    if(e.target === modal) hideModal();
  });

  // Company selection
  modal.querySelectorAll('.companyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const name = btn.getAttribute('data-company') || '×—×‘×¨×”';
      const url = btn.getAttribute('data-url') || 'about:blank';
      loadCompany(name, url);
    });
  });

  // Hook into navigation:
  // If there is a nav button with data-view="proposal", open modal when user clicks it.
  const navProposal = document.querySelector('[data-view="proposal"]');
  navProposal?.addEventListener('click', (e)=>{
    // allow the normal tab behavior to mark active etc., but open our modal
    showModal();
  });

  // Also allow programmatic open if setView('proposal') is called somewhere.
  const _setView = window.setView;
  if(typeof _setView === 'function'){
    window.setView = function(view){
      const r = _setView.apply(this, arguments);
      if(view === 'proposal') showModal();
      return r;
    }
  }

  // ESC closes
  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) hideModal();
  });

})();
</script>



<!-- ===== E-Sign Modal ===== -->
<div id="esignModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide">
    <div class="modalHead">
      <div>
        <div class="title">×©×œ×™×—×” ×œ×—×ª×™××ª ×œ×§×•×—</div>
        <div class="sub">×‘×—×¨ ×¡×•×’ ××¡××š, ×”×•×¡×£ ×¤×¨×˜×™× ×•×©×œ×— ×œ×œ×§×•×— ×œ×—×ª×™××” (×“××•)</div>
      </div>
      <button class="btnGhost" id="esignClose">âœ• ×¡×’×•×¨</button>
    </div>

    <div class="modalBody" style="gap:14px">
      <div class="mirrorGrid" style="grid-template-columns:420px 1fr">
        <div class="mirrorPanel">
          <h4>×¡×•×’ ××¡××š</h4>
          <div class="help">×‘×—×¨ ×ª×‘× ×™×ª ××•×›× ×” (××¤×©×¨ ×œ×¢×¨×•×š ×˜×§×¡×˜ ×œ×¤× ×™ ×©×œ×™×—×”).</div>

          <div class="esignOptions">
            <button class="btnGhost esignOptionBtn" data-doc="health">ğŸ©º ×—×ª×™××” ×¢×œ ×”×¦×”×¨×ª ×‘×¨×™××•×ª</button>
            <button class="btnGhost esignOptionBtn" data-doc="cancel">ğŸ§¾ ×—×ª×™××” ×œ×‘×§×©×” ×œ×‘×™×˜×•×œ ×¤×•×œ×™×¡×”</button>
            <button class="btnGhost esignOptionBtn" data-doc="terms">âœ… ×—×ª×™××” ×œ××™×©×•×¨ ×ª× ××™×</button>
            <button class="btnGhost esignOptionBtn" data-doc="agent">ğŸ§‘â€ğŸ’¼ ×—×ª×™××” ×œ××™× ×•×™ ×¡×•×›×Ÿ ×‘×¤×•×œ×™×¡×”</button>
          </div>

          <div class="help" style="margin-top:10px">
            ×˜×™×¤: ××—×¨×™ ×‘×—×™×¨×” â€“ ×™×™×˜×¢×Ÿ ×˜×§×¡×˜ ×”×ª×‘× ×™×ª ×‘×¦×“ ×©×××œ/×”×•×“×¢×”, ×•×ª×•×›×œ ×œ×”×“×‘×™×§ ×§×™×©×•×¨ ×œ××¡××š ××• PDF.
          </div>
        </div>

        <div class="mirrorPreview" style="padding:16px;display:flex;flex-direction:column;gap:12px">
          <h4 style="margin:0">×¤×¨×˜×™ ×©×œ×™×—×”</h4>

          <label class="field">
            <span class="cap">×©× ×”××¡××š ×œ×”×¦×’×”</span>
            <input id="esignDocName" type="text" placeholder="×œ×“×•×’××”: ×”×¦×”×¨×ª ×‘×¨×™××•×ª / ××™×©×•×¨ ×ª× ××™×" style="width:100%">
          </label>

          <label class="field">
            <span class="cap">××™××™×™×œ ×”×œ×§×•×—</span>
            <input id="esignEmail" type="email" placeholder="client@email.com" style="width:100%">
          </label>

          
          <div class="row" style="gap:10px;flex-wrap:wrap;margin-top:-2px">
            <div class="badge" style="cursor:default">×¢×¨×•×¥ ×©×œ×™×—×”:</div>
            <label class="chip" style="cursor:pointer">
              <input type="radio" name="esignChannel" value="email" checked style="margin-left:8px">
              ××™××™×™×œ âœ‰ï¸
            </label>
            <label class="chip" style="cursor:pointer">
              <input type="radio" name="esignChannel" value="whatsapp" style="margin-left:8px">
              ×•×•××˜×¡××¤ ğŸ’¬
            </label>
          </div>

          <label class="field" id="esignPhoneWrap" style="display:none">
            <span class="cap">×˜×œ×¤×•×Ÿ ×•×•××˜×¡××¤ ×©×œ ×”×œ×§×•×—</span>
            <input id="esignPhone" type="tel" placeholder="05X-XXXXXXX" style="width:100%">
          </label>
<label class="field">
            <span class="cap">×§×™×©×•×¨ ×œ××¡××š / PDF ×œ×—×ª×™××”</span>
            <input id="esignLink" type="url" placeholder="https://...pdf ××• https://..." style="width:100%">
          </label>

          <label class="field" style="flex:1;min-height:0">
            <span class="cap">×”×•×“×¢×” ×œ×œ×§×•×— (×œ×”×“×‘×§×”/×©×œ×™×—×”)</span>
            <textarea id="esignMsg" class="esignMsg" placeholder="×˜×§×¡×˜ ×©×™×§×•×£/×”× ×—×™×” ×œ×œ×§×•×—â€¦" ></textarea>
          </label>

          <div style="color:var(--muted);font-size:13px">
            ×‘×”××©×š × ×•×›×œ ×œ×—×‘×¨ ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª ×××™×ª×™×ª (DocuSign / PandaDoc / Google Drive / ×˜×•×¤×¡ ×—×ª×™××”).
          </div>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGhost" id="esignCancel">×‘×™×˜×•×œ</button>
      <button class="btnGold" id="esignSend">×©×œ×— ×œ×—×ª×™××”</button>
    </div>
  </div>
</div>

<script>
/* ===== E-Sign Logic ===== */
(function(){
  const modal = document.getElementById('esignModal');
  if(!modal) return;

  const openBtn = document.getElementById('navESign') || document.querySelector('[data-view="esign"]');
  const closeBtn = document.getElementById('esignClose');
  const cancelBtn = document.getElementById('esignCancel');
  const sendBtn = document.getElementById('esignSend');

  const docName = document.getElementById('esignDocName');
  const emailEl = document.getElementById('esignEmail');
  const phoneEl = document.getElementById('esignPhone');
  const phoneWrap = document.getElementById('esignPhoneWrap');
  const linkEl  = document.getElementById('esignLink');
  const msgEl   = document.getElementById('esignMsg');
  const optionBtns = Array.from(document.querySelectorAll('.esignOptionBtn'));
  const channelRadios = Array.from(document.querySelectorAll('input[name="esignChannel"]'));

  const templates = {
    health: {
      name: "×”×¦×”×¨×ª ×‘×¨×™××•×ª",
      msg: (client="×”×œ×§×•×—") => `×©×œ×•× ${client},\n××¦×•×¨×¤×ª ×”×¦×”×¨×ª ×‘×¨×™××•×ª ×œ×—×ª×™××”.\n×× × ×§×¨×/×™ ×•××©×¨/×™ ×©×”×¤×¨×˜×™× × ×›×•× ×™×.\n×œ××—×¨ ×”×—×ª×™××” × ×—×–×•×¨ ××œ×™×š ×œ×”××©×š ×ª×”×œ×™×š.\n×ª×•×“×”!`
    },
    cancel: {
      name: "×‘×§×©×” ×œ×‘×™×˜×•×œ ×¤×•×œ×™×¡×”",
      msg: (client="×”×œ×§×•×—") => `×©×œ×•× ${client},\n××¦×•×¨×£ ××¡××š ×œ×‘×§×©×” ×œ×‘×™×˜×•×œ ×¤×•×œ×™×¡×” ×œ×—×ª×™××”.\n×œ××—×¨ ×”×—×ª×™××” × ×¢×“×›×Ÿ ××•×ª×š ×‘×¡×˜×˜×•×¡ ×•×‘××™×©×•×¨ ×”×‘×™×˜×•×œ.\n×ª×•×“×”!`
    },
    terms: {
      name: "××™×©×•×¨ ×ª× ××™×",
      msg: (client="×”×œ×§×•×—") => `×©×œ×•× ${client},\n××¦×•×¨×£ ××¡××š ××™×©×•×¨ ×ª× ××™× ×œ×—×ª×™××”.\n×× × ××©×¨/×™ ×©×§×¨××ª ×•×”×‘× ×ª ××ª ×”×ª× ××™×.\n×ª×•×“×”!`
    },
    agent: {
      name: "××™× ×•×™ ×¡×•×›×Ÿ ×‘×¤×•×œ×™×¡×”",
      msg: (client="×”×œ×§×•×—") => `×©×œ×•× ${client},\n××¦×•×¨×£ ××¡××š ××™× ×•×™ ×¡×•×›×Ÿ ×‘×¤×•×œ×™×¡×” ×œ×—×ª×™××”.\n×œ××—×¨ ×”×—×ª×™××” × ××©×™×š ×œ×¢×“×›×•×Ÿ ××•×œ ×”×—×‘×¨×”.\n×ª×•×“×”!`
    }
  };

  function getChannel(){
    return (channelRadios.find(r=>r.checked)?.value) || "email";
  }

  function openModal(){
    modal.classList.add('show');
    // default channel UI state
    syncChannelUI();
  }
  function closeModal(){
    modal.classList.remove('show');
  }

  function syncChannelUI(){
    const ch = getChannel();
    if(phoneWrap){
      phoneWrap.style.display = (ch === "whatsapp") ? "" : "none";
    }
    // small UX: focus proper field
    if(ch === "whatsapp"){
      phoneEl?.focus();
    }else{
      emailEl?.focus();
    }
  }

  channelRadios.forEach(r=> r.addEventListener('change', syncChannelUI));

  // Open from sidebar button, without changing other nav behavior
  openBtn?.addEventListener('click', (e)=>{
    e.preventDefault?.();
    e.stopPropagation?.();
    openModal();
  });

  closeBtn?.addEventListener('click', closeModal);
  cancelBtn?.addEventListener('click', closeModal);

  function setActive(btn){
    optionBtns.forEach(b=>b.classList.toggle('active', b===btn));
  }

  function currentClientName(){
    // try mirror lead select first if exists; otherwise default
    const sel = document.getElementById('mirrorLeadSelect');
    const leadId = sel?.value || "";
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId);
    return lead?.name || "×”×œ×§×•×—";
  }

  optionBtns.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.getAttribute('data-doc');
      const t = templates[key];
      setActive(btn);
      if(t){
        if(docName && !docName.value.trim()) docName.value = t.name;
        const client = currentClientName();
        if(msgEl && (!msgEl.value.trim() || msgEl.value.includes("××¦×•×¨×£"))){
          msgEl.value = t.msg(client);
        }
      }
    });
  });

  function normalizeILPhone(p){
    const digits = (p||"").replace(/[^\d]/g, "");
    if(!digits) return "";
    // 05xxxxxxxx -> 9725xxxxxxxx
    if(digits.startsWith("0")) return "972" + digits.slice(1);
    // already starts with 972
    if(digits.startsWith("972")) return digits;
    // fallback: return digits as-is
    return digits;
  }

  function buildMessage(name, link, msg){
    const parts = [];
    if(name) parts.push(`××¡××š ×œ×—×ª×™××”: ${name}`);
    if(msg) parts.push(msg);
    if(link) parts.push(`×§×™×©×•×¨ ×œ×—×ª×™××”: ${link}`);
    return parts.join("\n\n").trim();
  }

  sendBtn?.addEventListener('click', ()=>{
    const ch = getChannel();

    const email = (emailEl?.value || "").trim();
    const phone = (phoneEl?.value || "").trim();
    const link  = (linkEl?.value || "").trim();
    const name  = (docName?.value || "").trim();
    const msg   = (msgEl?.value || "").trim();

    if(!link){
      alert("× × ×œ×”×•×¡×™×£ ×§×™×©×•×¨ ×œ××¡××š / PDF ×œ×—×ª×™××”");
      linkEl?.focus();
      return;
    }

    const fullMsg = buildMessage(name, link, msg);
    const subject = name ? `LEADUP â€¢ ${name} ×œ×—×ª×™××”` : "LEADUP â€¢ ××¡××š ×œ×—×ª×™××”";

    if(ch === "email"){
      if(!email){
        alert("× × ×œ×”×–×™×Ÿ ××™××™×™×œ ×œ×§×•×—");
        emailEl?.focus();
        return;
      }
      const mailto = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(fullMsg)}`;
      window.open(mailto, "_blank", "noopener,noreferrer");
      closeModal();
      return;
    }

    // whatsapp
    const norm = normalizeILPhone(phone);
    if(!norm){
      alert("× × ×œ×”×–×™×Ÿ ×˜×œ×¤×•×Ÿ ×•×•××˜×¡××¤ ×©×œ ×”×œ×§×•×—");
      phoneEl?.focus();
      return;
    }
    const wa = `https://wa.me/${encodeURIComponent(norm)}?text=${encodeURIComponent(fullMsg)}`;
    window.open(wa, "_blank", "noopener,noreferrer");
    closeModal();
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) closeModal();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) closeModal();
  });
})();
</script>


<script>
/* ===== Views Patch (proposal + esign) ===== */
(function(){
  try{
    if(window.titles){
      if(!window.titles.proposal) window.titles.proposal = ["×™×¦×™×¨×ª ×”×¦×¢×”","×‘×—×™×¨×ª ×—×‘×¨×” ×•×˜×•×¤×¡ ×”×¦×¢×”"];
      if(!window.titles.esign) window.titles.esign = ["×©×œ×™×—×” ×œ×—×ª×™××ª ×œ×§×•×—","×©×œ×™×—×ª ××¡××š ×œ×—×ª×™××” ×“×™×’×™×˜×œ×™×ª"];
    }
  }catch(e){}
})();
</script>



<!-- ===== Mirror Client Modal (Real) ===== -->
<div id="mirrorModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide">
    <div class="modalHead">
      <div>
        <div class="title">×©×™×§×•×£ ×œ×œ×§×•×—</div>
        <div class="sub">××¦×™×’ ×œ×œ×§×•×— × ×ª×•× ×™ ×œ×™×“ + ×”×¦×¢×”/PDF ×‘×—×œ×•×Ÿ × ×§×™</div>
      </div>
      <button class="btnGhost" id="mirrorClose">âœ• ×¡×’×•×¨</button>
    </div>

    <div class="modalBody" style="padding:14px 16px">
      <div class="mirrorGrid">
        <div class="mirrorPanel">
          <h4>××¡××š ×œ×”×¦×’×”</h4>
          <div class="mirrorField">
            <label>×‘×—×¨ ××¡××š ×œ×”×¦×’×”</label>
            <select id="mirrorLeadSelect">
              <option value="">â€” ×œ×—×¥ ×œ×‘×—×™×¨×” â€”</option>
            </select>
          </div>

                    <div class="mirrorField">
            <label>×©× ×”×¦×¢×” / ××¡××š</label>
            <input id="mirrorOfferName" placeholder="×œ×“×•×’××”: ×”×¦×¢×ª ×‘×™×˜×•×— ×¨×›×‘ â€” ×”×¨××œ"/>
          </div>
          <div class="mirrorField">
            <label>×§×™×©×•×¨ ×œâ€‘PDF ××• ×“×£ ×”×¦×¢×”</label>
            <input id="mirrorPdfUrl" placeholder="https://...pdf ××• https://..."/>
          </div>

          <details class="mirrorSteps" open>
            <summary>×©×œ×‘×™ ×©×™×§×•×£ ×”×©×™×—×” (×ª×‘× ×™×ª ××•×›× ×”)</summary>
            <div class="mirrorStepsBody">
              <div class="help">×œ×—×¥ ×¢×œ ×©×œ×‘ ×›×“×™ ×œ×¤×ª×•×— ××ª â€œ×©×™×§×•×£ ×”×©×™×—×”â€ ×¢× ×ª×‘× ×™×ª ××•×›× ×”. ××¤×©×¨ ×’× ×œ×”×¢×ª×™×§/×œ×¢×¨×•×š.</div>
              <div class="mirrorStepsGrid">
                <button class="btnGhost mirrorStepBtn" data-step="open">1) ×¤×ª×™×—×” ×•×”×–×“×”×•×ª</button>
                <button class="btnGhost mirrorStepBtn" data-step="needs">2) ××™×¡×•×£ ×¦×¨×›×™× ×•××™××•×ª ×¤×¨×˜×™×</button>
                <button class="btnGhost mirrorStepBtn" data-step="offer">3) ×”×¦×’×ª ×”×”×¦×¢×” ×•××” ×”×™× ×›×•×œ×œ×ª</button>
                <button class="btnGhost mirrorStepBtn" data-step="price">4) ××—×™×¨, ×ª×©×œ×•× ×•×”×—×¨×’×•×ª</button>
                <button class="btnGhost mirrorStepBtn" data-step="confirm">5) ××™×©×•×¨ ×”×œ×§×•×— ×•×”××©×š ×ª×”×œ×™×š</button>
                <button class="btnGhost mirrorStepBtn" data-step="close">6) ×¡×™×›×•×, ×©××œ×•×ª ×•×”×•×“×¢×ª ×”××©×š</button>
              </div>
            </div>
          </details>


          <div class="mirrorNotice">
            ×˜×™×¤: ×× PDF ×—×•×¡× ×˜×¢×™× ×” ×‘×ª×•×š ×—×œ×•×Ÿ (iframe), ×¢×“×™×™×Ÿ ×ª×•×›×œ ×œ×¤×ª×•×— ××•×ª×• ×‘×˜××‘ ×—×“×© ××ª×•×š ×”×›×¤×ª×•×¨ ×œ××˜×”.
          </div>

          <div class="mirrorActions">
            <button class="btnGold" id="mirrorApply">×”×¦×’</button>
            <button class="btnGhost" id="mirrorCopyLink">×”×¢×ª×§ ×§×™×©×•×¨ ×¦×¤×™×™×”</button>
            <button class="btnGhost" id="mirrorOpenLink">×¤×ª×— ×§×™×©×•×¨ ×¦×¤×™×™×”</button>
            <button class="btnGhost" id="mirrorFull">××¡×š ××œ×</button>
            <button class="btnGold" id="mirrorScriptOpen">ğŸ—£ï¸ ×©×™×§×•×£ ×”×©×™×—×”</button>
          </div>

          <h4 style="margin-top:14px">× ×ª×•× ×™ ×œ×™×“</h4>
          <div class="mirrorCard" id="mirrorLeadCard">
            <div class="mirrorKV" id="mirrorKV">
              <div>×©×</div><div>â€”</div>
              <div>×˜×œ×¤×•×Ÿ</div><div>â€”</div>
              <div>××™××™×™×œ</div><div>â€”</div>
              <div>×¡×˜×˜×•×¡</div><div>â€”</div>
              <div>××§×•×¨</div><div>â€”</div>
              <div>×‘×¢×œ×™×</div><div>â€”</div>
            </div>
          </div>
        </div>

        <div class="mirrorPreview">
          <div class="mirrorPreviewHead">
            <div>
              <div class="ttl" id="mirrorPrevTitle">×œ× × ×‘×—×¨ ××¡××š</div>
              <div class="meta" id="mirrorPrevMeta">×‘×—×¨ ×œ×™×“ ×•××¡××š</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <a id="mirrorOpenExternal" href="#" target="_blank" rel="noopener" style="display:none;color:var(--gold2);font-weight:900;text-decoration:none">×¤×ª×— ××¡××š</a>
            </div>
          </div>
          <div class="mirrorPreviewBody">
            <iframe id="mirrorFrame" title="××¡××š ×œ×”×¦×’×”" src="about:blank"></iframe>
          </div>
        </div>
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGhost" id="mirrorClear">× ×§×”</button>
      <button class="btnGold" id="mirrorDone">×¡×’×•×¨</button>
    </div>
  </div>

<!-- ===== Mirror Talk Script Modal ===== -->
<div id="mirrorScriptModal" class="modalOverlay" role="dialog" aria-modal="true">
  <div class="modalCard wide">
    <div class="modalHead">
      <div>
        <div class="title">×©×™×§×•×£ ×”×©×™×—×”</div>
        <div class="sub">××¡×š ×¢×‘×•×“×” ×œ× ×¦×™×’ â€” ×˜×§×¡×˜ ×œ×”×§×¨××”/×©×™×§×•×£ ×œ×œ×§×•×—</div>
      </div>
      <button class="btnGhost" id="mirrorScriptClose">âœ• ×¡×’×•×¨</button>
    </div>

    <div class="modalBody" style="padding:14px 16px; display:flex; flex-direction:column; gap:10px;">
      <div class="row" style="justify-content:space-between;gap:10px;flex-wrap:wrap">
        <div class="badge" id="mirrorScriptLeadBadge">×œ×§×•×—: â€”</div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button class="btnGhost" id="mirrorScriptCopy">ğŸ“‹ ×”×¢×ª×§ ×˜×§×¡×˜</button>
          <button class="btnGhost" id="mirrorScriptClear">ğŸ§¹ × ×§×”</button>
          <button class="btnGhost" id="mirrorScriptFull">â›¶ ××¡×š ××œ×</button>
        </div>
      </div>

      <textarea id="mirrorScriptText" class="mirrorScriptArea"
        placeholder="×›××Ÿ ×”× ×¦×™×’ ×™×›×ª×•×‘ ××ª ×©×™×§×•×£ ×”×¢×¡×§×”/×”×¨×›×™×©×”, ×•×™×§×¨×™× ×œ×œ×§×•×—..."></textarea>

      <div class="help" style="margin-top:2px">
        × ×©××¨ ××•×˜×•××˜×™×ª ×œ×¤×™ ×”×œ×§×•×— ×©× ×‘×—×¨ (Local). ××¤×©×¨ ×œ×”×¢×ª×™×§ ×•×œ×”×“×‘×™×§ ××—×“×© ×‘×›×œ ×©×™×—×”.
      </div>
    </div>

    <div class="modalFoot">
      <button class="btnGold" id="mirrorScriptDone">×¡×’×•×¨</button>
    </div>
  </div>
</div>

</div>

<!-- ===== Mirror Standalone (Link View) ===== -->
<div id="mirrorStandalone" class="mirrorStandalone">
  <div class="mirrorStandaloneInner">
    <div class="mirrorStandaloneTop">
      <div class="row">
        <div>
          <div class="title" id="mirrorS_Title">×©×™×§×•×£ ×œ×œ×§×•×—</div>
          <div class="sub" id="mirrorS_Sub">×ª×¦×•×’×ª ×œ×§×•×—</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <button class="btnGhost" id="mirrorS_Full">××¡×š ××œ×</button>
          <a class="btnGold" id="mirrorS_Open" href="#" target="_blank" rel="noopener" style="text-decoration:none;display:none">×¤×ª×— ××¡××š</a>
        </div>
      </div>
    </div>
    <div class="mirrorStandaloneMain">
      <div class="wrap" style="height:100%">
        <div class="mirrorGrid" style="height:100%">
          <div class="mirrorPanel">
            <h4>×¤×¨×˜×™ ×œ×§×•×—</h4>
            <div class="mirrorCard">
              <div class="mirrorKV" id="mirrorS_KV"></div>
            </div>
          </div>
          <div class="mirrorPreview" style="height:100%">
            <div class="mirrorPreviewHead">
              <div>
                <div class="ttl" id="mirrorS_DocTitle">××¡××š</div>
                <div class="meta" id="mirrorS_DocMeta">â€”</div>
              </div>
            </div>
            <div class="mirrorPreviewBody">
              <iframe id="mirrorS_Frame" title="××¡××š" src="about:blank"></iframe>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>


<script>
/* ===== Mirror Client (Real) Logic ===== */
(function(){
  const modal = document.getElementById('mirrorModal');
  const openBtn = document.querySelector('[data-view="mirror"]');
  const closeBtn = document.getElementById('mirrorClose');
  const doneBtn  = document.getElementById('mirrorDone');
  const clearBtn = document.getElementById('mirrorClear');

  const sel = document.getElementById('mirrorLeadSelect');
  const offerName = document.getElementById('mirrorOfferName');
  const pdfUrl = document.getElementById('mirrorPdfUrl');

  const kv = document.getElementById('mirrorKV');
  const frame = document.getElementById('mirrorFrame');
  const prevTitle = document.getElementById('mirrorPrevTitle');
  const prevMeta = document.getElementById('mirrorPrevMeta');
  const openExternal = document.getElementById('mirrorOpenExternal');

  const btnApply = document.getElementById('mirrorApply');
  const btnCopy  = document.getElementById('mirrorCopyLink');
  const btnOpen  = document.getElementById('mirrorOpenLink');
  const btnFull  = document.getElementById('mirrorFull');

  function show(){ modal.classList.add('show'); refreshLeadSelect(); }
  function hide(){ modal.classList.remove('show'); }

  function esc(v){ return (window.escapeHTML ? window.escapeHTML(v||'') : (v||'')); }

  function refreshLeadSelect(){
    if(!window.appState || !Array.isArray(window.appState.leads)) return;
    const leads = window.appState.leads.slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    const current = sel.value;
    sel.innerHTML = '<option value="">â€” ×œ×—×¥ ×œ×‘×—×™×¨×” â€”</option>' + leads.map(l=>{
      const label = `${l.name||'â€”'} â€¢ ${l.phone||''}`.trim();
      return `<option value="${esc(l.id)}">${esc(label)}</option>`;
    }).join('');
    if(current) sel.value = current;
  }

  function setKV(lead){
    const pairs = [
      ['×©×', lead?.name || 'â€”'],
      ['×˜×œ×¤×•×Ÿ', lead?.phone || 'â€”'],
      ['××™××™×™×œ', lead?.email || 'â€”'],
      ['×¡×˜×˜×•×¡', lead?.status || 'â€”'],
      ['××§×•×¨', lead?.source || 'â€”'],
      ['×‘×¢×œ×™×', lead?.owner || 'â€”'],
    ];
    kv.innerHTML = pairs.map(([k,v])=> `<div>${esc(k)}</div><div>${esc(v)}</div>`).join('');
  }

  function applyPreview(){
    const leadId = sel.value;
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId);
    setKV(lead);

    const name = offerName.value.trim() || '××¡××š';
    const url  = pdfUrl.value.trim();

    prevTitle.textContent = name || '××¡××š';
    prevMeta.textContent = lead?.name ? ('×œ×§×•×—: ' + (lead.name||'')) : '×‘×—×¨ ×œ×™×“ ×œ×”×¦×’×”';

    if(url){
      frame.src = url;
      openExternal.href = url;
      openExternal.style.display = 'inline';
    }else{
      frame.src = 'about:blank';
      openExternal.href = '#';
      openExternal.style.display = 'none';
    }
  }

  function encodePayload(obj){
    const json = JSON.stringify(obj);
    return btoa(unescape(encodeURIComponent(json)));
  }
  function decodePayload(str){
    const json = decodeURIComponent(escape(atob(str)));
    return JSON.parse(json);
  }

  function buildMirrorLink(){
    const leadId = sel.value;
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId) || null;

    const payload = {
      v: 1,
      lead: lead ? {
        name: lead.name||'',
        phone: lead.phone||'',
        email: lead.email||'',
        status: lead.status||'',
        source: lead.source||'',
        owner: lead.owner||''
      } : null,
      offerName: offerName.value.trim() || '',
      pdfUrl: pdfUrl.value.trim() || ''
    };

    const data = encodePayload(payload);
    const base = location.origin + location.pathname;
    return base + '?mirror=1&data=' + encodeURIComponent(data);
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      if(window.toast) toast('×”×•×¢×ª×§ âœ…');
      else alert('×”×•×¢×ª×§ âœ…');
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      if(window.toast) toast('×”×•×¢×ª×§ âœ…');
      else alert('×”×•×¢×ª×§ âœ…');
    }
  }

  function requestFull(el){
    const target = el || document.documentElement;
    const rfs = target.requestFullscreen || target.webkitRequestFullscreen || target.msRequestFullscreen;
    if(rfs) rfs.call(target);
  }

  // Wire events
  openBtn?.addEventListener('click', ()=>{ show(); setTimeout(()=> sel.focus(), 0); });
  closeBtn?.addEventListener('click', hide);
  doneBtn?.addEventListener('click', hide);
  clearBtn?.addEventListener('click', ()=>{
    sel.value = '';
    offerName.value = '';
    pdfUrl.value = '';
    setKV(null);
    prevTitle.textContent = '×œ× × ×‘×—×¨ ××¡××š';
    prevMeta.textContent = '×‘×—×¨ ×œ×™×“ ×•××¡××š';
    frame.src = 'about:blank';
    openExternal.style.display = 'none';
  });

  modal?.addEventListener('click', (e)=>{ if(e.target===modal) hide(); });
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal?.classList.contains('show')) hide(); });

  sel?.addEventListener('change', ()=> applyPreview());
  btnApply?.addEventListener('click', ()=> applyPreview());
  btnCopy?.addEventListener('click', ()=> copyText(buildMirrorLink()));
  btnOpen?.addEventListener('click', ()=> window.open(buildMirrorLink(), '_blank', 'noopener'));
  btnFull?.addEventListener('click', ()=> requestFull(document.querySelector('#mirrorModal .modalCard')));

  // Hook into setView if exists
  const _setView = window.setView;
  if(typeof _setView === 'function'){
    window.setView = function(view){
      const r = _setView.apply(this, arguments);
      if(view === 'mirror') show();
      return r;
    }
  }

  // ===== Standalone Mode (link view) =====
  const params = new URLSearchParams(location.search);
  const isMirror = params.get('mirror') === '1';
  const dataParam = params.get('data');

  const standalone = document.getElementById('mirrorStandalone');
  if(isMirror && dataParam && standalone){
    let payload = null;
    try{ payload = decodePayload(decodeURIComponent(dataParam)); }catch(e){ payload = null; }

    // hide app shell for clean view
    try{
      document.querySelector('.app')?.setAttribute('style','display:none');
      document.body.style.background = '#fff7e6';
    }catch(e){}

    standalone.classList.add('show');

    const kvEl = document.getElementById('mirrorS_KV');
    const docTitle = document.getElementById('mirrorS_DocTitle');
    const docMeta = document.getElementById('mirrorS_DocMeta');
    const sFrame = document.getElementById('mirrorS_Frame');
    const sOpen = document.getElementById('mirrorS_Open');
    const sFull = document.getElementById('mirrorS_Full');

    const lead = payload?.lead || null;
    const pairs = [
      ['×©×', lead?.name || 'â€”'],
      ['×˜×œ×¤×•×Ÿ', lead?.phone || 'â€”'],
      ['××™××™×™×œ', lead?.email || 'â€”'],
      ['×¡×˜×˜×•×¡', lead?.status || 'â€”'],
      ['××§×•×¨', lead?.source || 'â€”'],
      ['×‘×¢×œ×™×', lead?.owner || 'â€”'],
    ];
    kvEl.innerHTML = pairs.map(([k,v])=> `<div>${esc(k)}</div><div>${esc(v)}</div>`).join('');

    docTitle.textContent = payload?.offerName || '××¡××š';
    docMeta.textContent = lead?.name ? ('×œ×§×•×—: ' + lead.name) : 'â€”';

    const url = payload?.pdfUrl || '';
    if(url){
      sFrame.src = url;
      sOpen.href = url;
      sOpen.style.display = 'inline-flex';
    }else{
      sFrame.src = 'about:blank';
      sOpen.style.display = 'none';
    }

    sFull?.addEventListener('click', ()=> requestFull(standalone));
  }

})();
</script>


<script>
/* ===== Mirror Talk Script Logic ===== */
(function(){
  const modal = document.getElementById('mirrorScriptModal');
  if(!modal) return;

  const openBtn = document.getElementById('mirrorScriptOpen');
  const closeBtn = document.getElementById('mirrorScriptClose');
  const doneBtn = document.getElementById('mirrorScriptDone');

  const badge = document.getElementById('mirrorScriptLeadBadge');
  const ta = document.getElementById('mirrorScriptText');

  const btnCopy = document.getElementById('mirrorScriptCopy');
  const btnClear = document.getElementById('mirrorScriptClear');
  const btnFull = document.getElementById('mirrorScriptFull');

  const mirrorLeadSelect = document.getElementById('mirrorLeadSelect');

  function getLead(){
    const leadId = mirrorLeadSelect?.value || "";
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId) || null;
    return { leadId, lead };
  }

  function keyForLead(leadId){
    return "LEADUP_MIRROR_SCRIPT_" + (leadId || "DEFAULT");
  }

  function show(){
    const { leadId, lead } = getLead();
    badge.textContent = "×œ×§×•×—: " + (lead?.name || "â€”");
    try{ ta.value = localStorage.getItem(keyForLead(leadId)) || ""; }catch(e){}
    modal.classList.add('show');
    setTimeout(()=> ta?.focus(), 0);
  }

  function hide(){
    modal.classList.remove('show');
  }

  function saveDraft(){
    const { leadId } = getLead();
    try{ localStorage.setItem(keyForLead(leadId), ta.value || ""); }catch(e){}
  }

  openBtn?.addEventListener('click', show);
  closeBtn?.addEventListener('click', hide);
  doneBtn?.addEventListener('click', hide);

  ta?.addEventListener('input', saveDraft);

  btnCopy?.addEventListener('click', async ()=>{
    try{
      await navigator.clipboard.writeText(ta.value || "");
      window.toast?.("×”×˜×§×¡×˜ ×”×•×¢×ª×§ ğŸ“‹");
    }catch(e){
      alert("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×‘×“×¤×“×¤×Ÿ ×”×–×”. × ×¡×” Ctrl+C");
    }
  });

  btnClear?.addEventListener('click', ()=>{
    ta.value = "";
    saveDraft();
    window.toast?.("× ×•×§×”");
  });

  btnFull?.addEventListener('click', ()=>{
    const card = modal.querySelector('.modalCard');
    if(window.requestFull && card) window.requestFull(card);
  });

  modal.addEventListener('click', (e)=>{
    if(e.target === modal) hide();
  });

  document.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape' && modal.classList.contains('show')) hide();
  });
})();
</script>



<script>
/* ===== Mirror Steps -> preload script templates ===== */
(function(){
  const wrap = document.getElementById('mirrorModal');
  if(!wrap) return;

  const openScriptBtn = document.getElementById('mirrorScriptOpen');
  const scriptModal = document.getElementById('mirrorScriptModal');
  const scriptText = document.getElementById('mirrorScriptText');

  function leadName(){
    const leadId = document.getElementById('mirrorLeadSelect')?.value || "";
    const lead = (window.appState?.leads || []).find(l=>l.id===leadId);
    return lead?.name || "×”×œ×§×•×—";
  }

  const templates = {
    open: (n)=>`×¤×ª×™×—×” ×•×”×–×“×”×•×ª\n- ×©×œ×•× ${n}, ××“×‘×¨/×ª ___ ×-LEADUP.\n- ×× ×™ ××‘×¦×¢/×ª ×¢×›×©×™×• ×©×™×§×•×£ ×§×¦×¨ ×›×“×™ ×œ×•×•×“× ×©×”×›×œ ×‘×¨×•×¨ ×œ×¤× ×™ ×©××ª×§×“××™×.\n`,
    needs:(n)=>`××™×¡×•×£ ×¦×¨×›×™× ×•××™××•×ª ×¤×¨×˜×™×\n- ×¨×§ ×××©×¨/×ª ×¤×¨×˜×™×: ×©×, ×˜×œ×¤×•×Ÿ, ××™××™×™×œ.\n- ×”×¦×•×¨×š ×©×œ×š ×”×•×: ___\n- ×™×© ×“×’×©×™×/××¦×‘×™× ××™×•×—×“×™× ×©×—×©×•×‘ ×œ×“×¢×ª? ___\n`,
    offer:(n)=>`×”×¦×’×ª ×”×”×¦×¢×” ×•××” ×”×™× ×›×•×œ×œ×ª\n- ${n}, ×”×”×¦×¢×” ×©×× ×—× ×• ××¦×™×’×™× ×›×•×œ×œ×ª: \n  1) ___\n  2) ___\n  3) ___\n- ×ª×§×•×¤×ª ×”×›×™×¡×•×™/×ª× ××™× ×¢×™×§×¨×™×™×: ___\n`,
    price:(n)=>`××—×™×¨, ×ª×©×œ×•× ×•×”×—×¨×’×•×ª\n- ×”××—×™×¨ ×”×•× ___ (×›×•×œ×œ/×œ× ×›×•×œ×œ ___).\n- ××•×¤×Ÿ ×ª×©×œ×•×: ___ (×ª×©×œ×•××™×/×—×™×•×‘ ×—×•×“×©×™/×©× ×ª×™).\n- ×”×—×¨×’×•×ª/×”×¡×ª×™×™×’×•×™×•×ª ×¢×™×§×¨×™×•×ª: ___\n`,
    confirm:(n)=>`××™×©×•×¨ ×”×œ×§×•×— ×•×”××©×š ×ª×”×œ×™×š\n- ×”×× ×”×›×œ ×‘×¨×•×¨? ×™×© ×©××œ×•×ª?\n- ×× ×××©×¨×™×, ×”×©×œ×‘ ×”×‘× ×”×•×: ___\n- ×× ×™ ×©×•×œ×—/×ª ×¢×›×©×™×• ×¡×™×›×•× ×‘××¡××š/×§×™×©×•×¨.\n`,
    close:(n)=>`×¡×™×›×•×, ×©××œ×•×ª ×•×”×•×“×¢×ª ×”××©×š\n- ×œ×¡×™×›×•×: ×”×¦×¢×” ___, ××—×™×¨ ___, ×ª×•×§×£ ×¢×“ ___.\n- ××©×œ×— ×œ×š ×¢×›×©×™×• ××ª ×”××¡××š ×œ×”×¦×’×”/×”×¦×¢×”, ×•×× ×ª×¨×¦×” × ×©×œ×™× ××ª ×”×ª×”×œ×™×š.\n- ×ª×•×“×” ${n}!\n`
  };

  function showScriptWith(text){
    // open modal
    if(scriptModal) scriptModal.classList.add('show');
    if(scriptText){
      scriptText.value = text;
      scriptText.dispatchEvent(new Event('input')); // trigger autosave
      setTimeout(()=> scriptText.focus(), 0);
    }
  }

  wrap.addEventListener('click', (e)=>{
    const btn = e.target.closest('.mirrorStepBtn');
    if(!btn) return;
    const step = btn.getAttribute('data-step');
    const n = leadName();
    const tmpl = templates[step] ? templates[step](n) : "";
    // if user wants to append instead of replace:
    if(scriptText && scriptText.value && scriptText.value.trim()){
      const add = "\n\n" + tmpl;
      showScriptWith(scriptText.value + add);
    }else{
      showScriptWith(tmpl);
    }
  });
})();
</script>

</body>
</html>
