<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>LEADUP â€¢ ××¢×¨×›×ª × ×™×”×•×œ ×œ×™×“×™×</title>

  <meta name="theme-color" content="#ffffff"/>

  <style>
    :root{
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#fbfbfd;
      --line:rgba(15, 15, 20, .10);
      --text:#0c0c12;
      --muted:rgba(12,12,18,.72);
      --muted2:rgba(12,12,18,.55);
      --gold:#d6b25e;
      --gold2:#f2d27c;
      --ok:#2ee59d;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow:0 20px 60px rgba(12,12,18,.10);
      --shadow2:0 12px 30px rgba(12,12,18,.10);
      --r:18px;
      --r2:22px;
      --focus: 0 0 0 3px rgba(214,178,94,.22);
      --font: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Arial, "Noto Sans Hebrew", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 80% 10%, rgba(214,178,94,.12), transparent 58%),
        radial-gradient(900px 600px at 10% 80%, rgba(242,210,124,.10), transparent 62%),
        linear-gradient(180deg, #ffffff, #f7f7fb);
      color:var(--text);
      font-family:var(--font);
      overflow:hidden;
    }

    a{color:inherit}
    .app{
      display:grid;
      grid-template-columns: 290px 1fr;
      height:100vh;
    }

    /* Sidebar */
    .side{
      border-left:1px solid var(--line);
      background:linear-gradient(180deg, rgba(12,12,18,.02), rgba(12,12,18,0));
      padding:18px 16px;
      overflow:auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 10px 16px 10px;
      border-bottom:1px solid var(--line);
      margin-bottom:14px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      /* ===== LEADUP: Soft Glow (CSS Only) ===== */
@keyframes leadupGlowOccasional {
  0%, 78% {
    transform: scale(1);
    filter: drop-shadow(0 0 0 rgba(214,178,94,0));
    box-shadow: 0 12px 30px rgba(214,178,94,.18);
  }
  84% {
    transform: scale(1.03);
    filter: drop-shadow(0 0 10px rgba(214,178,94,.55));
    box-shadow: 0 18px 44px rgba(214,178,94,.28);
  }
  88% {
    transform: scale(1.06);
    filter: drop-shadow(0 0 16px rgba(242,210,124,.65));
    box-shadow:
      0 22px 55px rgba(214,178,94,.34),
      0 0 0 6px rgba(242,210,124,.12);
  }
  94% {
    transform: scale(1.02);
    filter: drop-shadow(0 0 8px rgba(214,178,94,.35));
    box-shadow: 0 16px 38px rgba(214,178,94,.22);
  }
  100% {
    transform: scale(1);
    filter: drop-shadow(0 0 0 rgba(214,178,94,0));
    box-shadow: 0 12px 30px rgba(214,178,94,.18);
  }
}

/* ××¤×¢×™×œ ××ª ×–×” â€œ××“×™ ×¤×¢×â€ ×‘×œ×™ JS */
.logo{
  animation: leadupGlowOccasional 12s ease-in-out infinite;
}

      background:
        radial-gradient(circle at 30% 20%, rgba(242,210,124,.55), transparent 55%),
        linear-gradient(145deg, rgba(214,178,94,.55), rgba(214,178,94,.10));
      box-shadow:0 12px 30px rgba(214,178,94,.18);
      border:1px solid rgba(214,178,94,.35);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:10px;
      border-radius:12px;
      border:1px dashed rgba(12,12,18,.18);
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.6px;
    }
    .brand .sub{
      margin-top:2px;
      color:var(--muted2);
      font-size:12px;
    }

    .nav{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:10px;
    }
    .nav button{
      width:100%;
      text-align:right;
      background:rgba(12,12,18,.02);
      border:1px solid rgba(12,12,18,.08);
      color:var(--text);
      padding:12px 12px;
      border-radius:14px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      transition:.18s ease;
    }
    .nav button:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.30)}
    .nav button.active{
      background:linear-gradient(180deg, rgba(214,178,94,.18), rgba(12,12,18,.02));
      border-color:rgba(214,178,94,.45);
      box-shadow:0 14px 32px rgba(214,178,94,.12);
    }
    .nav .k{
      display:flex;align-items:center;gap:10px;
      font-weight:650;
    }

    .pill{
      font-size:12px;
      color:rgba(12,12,18,.85);
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.75);
    }
    .pill.gold{border-color:rgba(214,178,94,.40); color:rgba(120,90,20,.95)}

    .sideFooter{
      margin-top:16px;
      padding-top:14px;
      border-top:1px solid var(--line);
      color:var(--muted2);
      font-size:12px;
      line-height:1.5;
    }
    .sideFooter .hint{
      margin-top:8px;
      padding:10px 12px;
      border:1px solid rgba(214,178,94,.22);
      border-radius:14px;
      background:rgba(214,178,94,.08);
    }

    /* Main */
    .main{
      display:flex;
      flex-direction:column;
      height:100vh;
      overflow:hidden;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.72);
      backdrop-filter: blur(10px);
    }
    .topbar .left{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:260px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(214,178,94,.35);
      background:rgba(214,178,94,.12);
      color:rgba(120,90,20,.95);
      font-size:12px;
      white-space:nowrap;
    }
    .badge .dot{width:8px;height:8px;border-radius:50%;background:var(--gold2);box-shadow:0 0 0 4px rgba(242,210,124,.18)}
    .topbar .title{
      display:flex; flex-direction:column;
    }
    .topbar .title b{font-size:16px}
    .topbar .title span{color:var(--muted2);font-size:12px;margin-top:2px}
    .topbar .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .btn{
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.80);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:.18s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:650;
    }
    .btn:hover{transform:translateY(-1px); border-color:rgba(214,178,94,.30)}
    .btn:focus{outline:none; box-shadow:var(--focus)}
    .btn.gold{
      background:linear-gradient(180deg, rgba(214,178,94,.22), rgba(255,255,255,.90));
      border-color:rgba(214,178,94,.45);
      color:rgba(120,90,20,.98);
    }
    .btn.danger{
      border-color:rgba(255,107,107,.32);
      background:rgba(255,107,107,.10);
    }

    .search{
      position:relative;
      min-width:320px;
      max-width:520px;
      width:38vw;
    }
    .search input{
      width:100%;
      padding:12px 40px 12px 14px;
      border-radius:16px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.85);
      color:var(--text);
      outline:none;
      transition:.18s ease;
    }
    .search input:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.30)}
    .search .icon{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      color:rgba(12,12,18,.55);
      font-size:14px;
      pointer-events:none;
    }

    .content{
      padding:16px 18px 22px;
      overflow:auto;
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 1060px){
      .app{grid-template-columns: 1fr}
      .side{display:none}
      .grid{grid-template-columns: 1fr}
      body{overflow:auto}
      .main{height:auto}
    }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.80));
      border:1px solid rgba(12,12,18,.10);
      border-radius:var(--r2);
      box-shadow:var(--shadow2);
      overflow:hidden;
    }
    .card .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:14px 14px;
      border-bottom:1px solid rgba(12,12,18,.08);
      background:rgba(255,255,255,.75);
    }
    .card .head h2{
      margin:0;
      font-size:14px;
      letter-spacing:.3px;
    }
    .card .body{padding:12px 14px 14px}

    .stats{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width: 760px){ .stats{grid-template-columns: repeat(2, 1fr)} }

    .stat{
      padding:12px 12px;
      border-radius:18px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.82);
      position:relative;
      overflow:hidden;
    }
    .stat:before{
      content:"";
      position:absolute; inset:-80px -60px auto auto;
      width:160px;height:160px;border-radius:50%;
      background:rgba(214,178,94,.14);
      filter:blur(2px);
    }
    .stat .k{color:var(--muted2); font-size:12px}
    .stat .v{margin-top:6px; font-size:20px; font-weight:800}
    .stat .mini{margin-top:3px; font-size:12px; color:rgba(120,90,20,.86)}

    .tableWrap{overflow:auto}
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:13px;
      min-width:920px;
    }
    thead th{
      text-align:right;
      padding:12px 10px;
      color:rgba(12,12,18,.68);
      font-weight:700;
      border-bottom:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.85);
      position:sticky;
      top:0;
      z-index:2;
      backdrop-filter: blur(8px);
    }
    tbody td{
      padding:12px 10px;
      border-bottom:1px solid rgba(12,12,18,.08);
      vertical-align:middle;
      color:rgba(12,12,18,.92);
    }
    tbody tr:hover td{background:rgba(214,178,94,.08)}

    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(12,12,18,.12);
      background:rgba(255,255,255,.82);
      font-size:12px;
      white-space:nowrap;
    }
    .tag.hot{border-color:rgba(255,204,102,.45); background:rgba(255,204,102,.14); color:rgba(120,80,10,.95)}
    .tag.ok{border-color:rgba(46,229,157,.38); background:rgba(46,229,157,.12); color:rgba(0,120,80,.95)}
    .tag.cold{border-color:rgba(12,12,18,.14); background:rgba(12,12,18,.03); color:rgba(12,12,18,.70)}

    .score{
      display:flex; align-items:center; gap:10px;
    }
    .bar{
      width:120px; height:10px; border-radius:999px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(12,12,18,.05);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%;
      background:linear-gradient(90deg, rgba(214,178,94,.30), rgba(242,210,124,.70));
      width:50%;
    }

    .actions{
      display:flex; gap:8px; flex-wrap:wrap;
      justify-content:flex-start;
    }
    .iconBtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid rgba(12,12,18,.12);
      background:rgba(255,255,255,.85);
      cursor:pointer;
      display:inline-flex;align-items:center;justify-content:center;
      transition:.16s ease;
    }
    .iconBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.30)}
    .iconBtn.gold{border-color:rgba(214,178,94,.45); background:rgba(214,178,94,.14)}

    .muted{color:var(--muted2)}
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 760px){ .row{grid-template-columns:1fr} table{min-width:800px} }

    label{display:block; font-size:12px; color:rgba(12,12,18,.70); margin-bottom:6px}

    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.90);
      color:var(--text);
      outline:none;
      transition:.18s ease;
      font-family:inherit;
    }
    textarea{min-height:92px; resize:vertical}
    input:focus, select:focus, textarea:focus{box-shadow:var(--focus); border-color:rgba(214,178,94,.30)}

    .help{
      margin-top:8px;
      color:rgba(12,12,18,.62);
      font-size:12px;
      line-height:1.4;
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(12,12,18,.50);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(980px, 100%);
      max-height:min(86vh, 900px);
      overflow:auto;
      border-radius:24px;
      border:1px solid rgba(12,12,18,.12);
      background:
        radial-gradient(900px 600px at 85% 0%, rgba(214,178,94,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.98), rgba(250,250,252,.96));
      box-shadow:0 30px 90px rgba(12,12,18,.28);
      position:relative;
    }
    .modalHeader{
      padding:14px 16px;
      border-bottom:1px solid rgba(12,12,18,.10);
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background:rgba(255,255,255,.78);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      z-index:2;
    }
    .modalHeader b{font-size:14px}
    .modalBody{padding:14px 16px 16px}
    .closeX{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(12,12,18,.12);
      background:rgba(255,255,255,.85);
      cursor:pointer;
      color:var(--text);
    }

    .toast{
      position:fixed;
      left:18px;
      bottom:18px;
      background:rgba(255,255,255,.92);
      border:1px solid rgba(12,12,18,.12);
      color:rgba(12,12,18,.92);
      padding:10px 12px;
      border-radius:14px;
      box-shadow:var(--shadow2);
      display:none;
      z-index:60;
      max-width:min(520px, calc(100vw - 36px));
    }

    .split{
      display:grid;
      grid-template-columns: 1fr 340px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .split{grid-template-columns:1fr} }

    .miniCard{
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.85);
      border-radius:18px;
      padding:12px;
    }
    .miniCard h3{margin:0 0 10px 0; font-size:13px}

    .timeline{
      display:flex; flex-direction:column; gap:10px;
      max-height:500px; overflow:auto; padding-left:4px;
    }
    .event{
      border:1px solid rgba(12,12,18,.10);
      background:rgba(12,12,18,.02);
      border-radius:16px;
      padding:10px 10px;
    }
    .event .t{font-size:12px; color:rgba(12,12,18,.75)}
    .event .d{margin-top:4px; font-size:13px}

    .kbd{
      font-size:12px;
      border:1px solid rgba(12,12,18,.14);
      background:rgba(255,255,255,.90);
      border-bottom-color:rgba(12,12,18,.24);
      padding:2px 8px;
      border-radius:10px;
      color:rgba(12,12,18,.85);
    }
    .small{font-size:12px}
    .sep{height:1px;background:rgba(12,12,18,.10); margin:12px 0}

    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:900px){ .twoCols{grid-template-columns:1fr} }

    .frame{
      width:100%;
      height:460px;
      border-radius:16px;
      border:1px solid rgba(12,12,18,.10);
      background:rgba(12,12,18,.02);
      overflow:hidden;
    }
    .frame iframe{width:100%;height:100%;border:0}

    /* ===== NEW: Tabs (My Processes) ===== */
    .tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .tabBtn{
      border:1px solid rgba(12,12,18,.10);
      background:rgba(255,255,255,.80);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      transition:.16s ease;
      font-weight:700;
      font-size:12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .tabBtn:hover{transform:translateY(-1px);border-color:rgba(214,178,94,.30)}
    .tabBtn.active{
      background:linear-gradient(180deg, rgba(214,178,94,.20), rgba(255,255,255,.90));
      border-color:rgba(214,178,94,.45);
      color:rgba(120,90,20,.98);
      box-shadow:0 14px 30px rgba(214,178,94,.10);
    }
    .tabPane{display:none}
    .tabPane.active{display:block}
    .miniList{display:flex; flex-direction:column; gap:10px}
    /* ===== LEADUP: Soft Glow Logo ===== */
@keyframes leadupSoftGlow {
  0%, 100%{
    transform: translateZ(0) scale(1);
    filter: drop-shadow(0 0 0 rgba(214,178,94,0));
    box-shadow: 0 12px 30px rgba(214,178,94,.18);
  }
  45%{
    transform: translateZ(0) scale(1.05);
    filter: drop-shadow(0 0 14px rgba(214,178,94,.65));
    box-shadow:
      0 18px 44px rgba(214,178,94,.30),
      0 0 0 6px rgba(242,210,124,.12);
  }
  70%{
    transform: translateZ(0) scale(1.02);
    filter: drop-shadow(0 0 10px rgba(242,210,124,.55));
  }
}

.logo.is-glowing{
  animation: leadupSoftGlow 2200ms ease-in-out;
  will-change: transform, filter, box-shadow;
}
/* ===== LEADUP: Dashboard premium styling (only dashboard card) ===== */
.dashboardCard{
  position: relative;
  overflow: hidden;
  border-color: rgba(214,178,94,.22);
  background:
    radial-gradient(900px 420px at 90% 0%, rgba(214,178,94,.14), transparent 55%),
    radial-gradient(700px 360px at 0% 100%, rgba(242,210,124,.10), transparent 60%),
    linear-gradient(180deg, rgba(255,255,255,.95), rgba(255,255,255,.82));
  box-shadow:
    0 18px 55px rgba(12,12,18,.10),
    0 10px 24px rgba(214,178,94,.10);
}

.dashboardCard::before{
  content:"";
  position:absolute;
  left:12px; right:12px; top:10px;
  height:3px;
  border-radius:999px;
  background: linear-gradient(90deg,
    rgba(214,178,94,0),
    rgba(214,178,94,.85),
    rgba(242,210,124,.75),
    rgba(214,178,94,0)
  );
  opacity:.85;
}

.dashboardCard .head{
  background: rgba(255,255,255,.72);
}

.dashboardCard .head h2{
  font-size: 14px;
  letter-spacing: .4px;
}

.dashboardCard .stat{
  border-color: rgba(12,12,18,.09);
  background: rgba(255,255,255,.86);
  transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}

.dashboardCard .stat:hover{
  transform: translateY(-2px);
  border-color: rgba(214,178,94,.30);
  box-shadow: 0 14px 30px rgba(214,178,94,.12);
}
/* ===== LEADUP: Greeting near logo ===== */
.greet{
  margin-top:8px;
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(214,178,94,.22);
  background: rgba(214,178,94,.08);
  color: rgba(120,90,20,.92);
  font-size:12px;
  font-weight:750;
  line-height:1;
  white-space:nowrap;
}

.greet::before{
  content:"";
  width:8px;
  height:8px;
  border-radius:50%;
  background: var(--gold2);
  box-shadow: 0 0 0 4px rgba(242,210,124,.16);
}

  </style>
</head>

<body>
<div class="app">
  <aside class="side">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
  <h1>LEAD-UP</h1>
  <div class="sub">CRM ×™×•×§×¨×ª×™ ×œ×œ×™×“×™× â€¢ ×œ×™×“ ××¤</div>
  <div class="greet" id="greetText"></div>
</div>


    <div class="nav" id="nav">
      <button class="active" data-view="leads">
        <span class="k">ğŸ“Œ ×œ×™×“×™×</span>
        <span class="pill gold" id="navCount">0</span>
      </button>
      <button data-view="tasks">
        <span class="k">â° ××©×™××•×ª</span>
        <span class="pill" id="navTasks">0</span>
      </button>
      <button data-view="timeline">
        <span class="k">ğŸ§¾ ×”×™×¡×˜×•×¨×™×”</span>
        <span class="pill" id="navEvents">0</span>
      </button>
      <button data-view="settings">
        <span class="k">âš™ï¸ ×”×’×“×¨×•×ª</span>
        <span class="pill">Local</span>
      </button>
    </div>

    <div class="sideFooter">
      <div><b>×˜×™×¤:</b> ×›×œ ×¤×¢×•×œ×” × ×¤×ª×—×ª ×‘×ª×•×š ×—×œ×•×Ÿ ×‘××¢×¨×›×ª (××•×“××œ) â€” ×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×™×¦×•× ×™.</div>
      <div class="hint">
        ×‘×§×¨×•×‘ × ×—×‘×¨ ×œ-Google Sheets ×“×¨×š Apps Script (×¨×§ ×ª×ª×Ÿ ×œ×™ ××ª ×›×ª×•×‘×ª ×”-URL ×•××–×”×” ×”×¤×¨×™×¡×”).
      </div>
    </div>
  </aside>

  <main class="main">
    <div class="topbar">
      <div class="left">
        <span class="badge"><span class="dot"></span> ××¦×‘ ××¢×¨×›×ª: ×¤×¢×™×œ</span>
        <div class="title">
          <b id="viewTitle">×œ×™×“×™×</b>
          <span id="viewSub">× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘</span>
        </div>
      </div>

      <div class="search">
        <span class="icon">âŒ•</span>
        <input id="q" placeholder="×—×™×¤×•×© ×œ×§×•×— ×œ×¤×™ ×©×, ×ª.×– ××• ×˜×œ×¤×•×Ÿ" autocomplete="off"/>

      </div>

      <div class="right">
        <button class="btn gold" id="btnAddLead">â• ×œ×™×“ ×—×“×©</button>
        <button class="btn" id="btnQuickTask">ğŸ”„ ×”×ª×”×œ×™×›×™× ×©×œ×™</button>
      </div>
    </div>

    <div class="content">
      <div class="card dashboardCard" style="margin-bottom:14px">

        <div class="head">
          <h2>×“×©×‘×•×¨×“</h2>
          
        </div>
        <div class="body">
          <div class="stats">
            <div class="stat">
              <div class="k">×¡×”×´×› ×œ×™×“×™×</div>
              <div class="v" id="stTotal">0</div>
              <div class="mini">×‘×××’×¨</div>
            </div>
            <div class="stat">
              <div class="k">×—××™×</div>
              <div class="v" id="stHot">0</div>
              <div class="mini">Lead Score ×’×‘×•×”</div>
            </div>
            <div class="stat">
              <div class="k">××¢×§×‘ ×”×™×•×</div>
              <div class="v" id="stToday">0</div>
              <div class="mini">Next Follow-up</div>
            </div>
            <div class="stat">
              <div class="k">××©×™××•×ª ×¤×ª×•×—×•×ª</div>
              <div class="v" id="stTasks">0</div>
              <div class="mini">×ª×–×›×•×¨×•×ª</div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card" id="viewLeads">
          <div class="head">
            <h2>×¨×©×™××ª ×œ×™×“×™×</h2>
            <div style="display:flex; gap:8px; flex-wrap:wrap">
              <select id="fStatus" title="×¤×™×œ×˜×¨ ×¡×˜×˜×•×¡" style="width:170px">
                <option value="">×›×œ ×”×¡×˜×˜×•×¡×™×</option>
                <option>×—×“×©</option>
                <option>× ×•×¦×¨ ×§×©×¨</option>
                <option>××ª×¢× ×™×™×Ÿ</option>
                <option>×”×¦×¢×ª ××—×™×¨</option>
                <option>× ×¡×’×¨</option>
                <option>×œ× ×¨×œ×•×•× ×˜×™</option>
              </select>
              <select id="fSource" title="×¤×™×œ×˜×¨ ××§×•×¨" style="width:170px">
                <option value="">×›×œ ×”××§×•×¨×•×ª</option>
                <option>×¤×™×™×¡×‘×•×§</option>
                <option>×’×•×’×œ</option>
                <option>×”×¤× ×™×”</option>
                <option>×˜×œ×¤×•×Ÿ</option>
                <option>××ª×¨</option>
                <option>××—×¨</option>
              </select>
              <select id="sortBy" title="××™×•×Ÿ" style="width:170px">
                <option value="hot">××™×•×Ÿ: ×”×›×™ ×—×</option>
                <option value="next">××™×•×Ÿ: ×ª××¨×™×š ××¢×§×‘ ×”×‘×</option>
                <option value="newest">××™×•×Ÿ: ×”×›×™ ×—×“×©</option>
                <option value="oldest">××™×•×Ÿ: ×”×›×™ ×™×©×Ÿ</option>
              </select>
            </div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>×©×</th>
                    <th>×˜×œ×¤×•×Ÿ</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>××§×•×¨</th>
                    <th>×—×•× (Score)</th>
                    <th>××¢×§×‘ ×”×‘×</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="leadsTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyLeads" style="display:none">
              ××™×Ÿ ×¢×“×™×™×Ÿ ×œ×™×“×™×. ×œ×—×¥ ×¢×œ <b>â€œ×œ×™×“ ×—×“×©â€</b> ×›×“×™ ×œ×”×ª×—×™×œ.
            </div>
          </div>
        </section>

        <aside class="card" id="viewRight">
          <div class="head">
            <h2>××¨×›×– ×©×œ×™×˜×”</h2>
            <div class="pill gold">LEADUP</div>
          </div>
          <div class="body">
            <div class="miniCard" style="margin-bottom:10px">
              <h3>××” ×™×© ×‘××¢×¨×›×ª</h3>
              <div class="small muted">
                â€¢ ×œ×™×“×™× + ×¡×˜×˜×•×¡×™× + ×”×¢×¨×•×ª<br/>
                â€¢ ××©×™××•×ª ×•×ª×–×›×•×¨×•×ª ×œ×›×œ ×œ×™×“<br/>
                â€¢ ×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª (Timeline)<br/>
                â€¢ ×—×™×¤×•×©/×¤×™×œ×˜×¨×™×/××™×•×Ÿ<br/>
                â€¢ Lead Score (1â€“100)<br/>
                â€¢ ×•×•××˜×¡××¤ / ×”×ª×§×©×¨×•×ª / ××™×™×œ (×‘××•×“××œ)<br/>
                â€¢ <b>×”×ª×”×œ×™×›×™× ×©×œ×™</b> (×¡×˜×˜×•×¡ + ×ª×§×©×•×¨×ª + ××©×™××•×ª + ×”×™×¡×˜×•×¨×™×”)
              </div>
            </div>

            <div class="miniCard">
              <h3>×¤×¢×•×œ×” ××”×™×¨×”</h3>
              <button class="btn gold" style="width:100%" id="btnOpenInsights">ğŸ“Š ×¡×˜×˜×™×¡×˜×™×§×•×ª</button>
              <div class="sep"></div>
              <button class="btn" style="width:100%" id="btnSeed">âœ¨ ×¦×•×¨ ×“×•×’×××•×ª ×œ×™×“×™×</button>
              <div class="help">×”×›×œ × ×©××¨ ××§×•××™×ª ×‘×“×¤×“×¤×Ÿ (LocalStorage) ×¢×“ ×©× ×—×‘×¨ ×œ-Google Sheets.</div>
            </div>
          </div>
        </aside>

        <!-- Tasks view -->
        <section class="card" id="viewTasks" style="display:none">
          <div class="head">
            <h2>××©×™××•×ª</h2>
            <div class="muted small">×ª×–×›×•×¨×•×ª + ×¢×“×™×¤×•×ª + ×©×™×™×›×•×ª ×œ×œ×™×“</div>
          </div>
          <div class="body">
            <div class="tableWrap">
              <table style="min-width:860px">
                <thead>
                  <tr>
                    <th>××ª×™</th>
                    <th>×¢×“×™×¤×•×ª</th>
                    <th>×œ×™×“</th>
                    <th>×ª×™××•×¨</th>
                    <th>×¡×˜×˜×•×¡</th>
                    <th>×¤×¢×•×œ×•×ª</th>
                  </tr>
                </thead>
                <tbody id="tasksTbody"></tbody>
              </table>
            </div>
            <div class="help" id="emptyTasks" style="display:none">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª.</div>
          </div>
        </section>

        <!-- Timeline view -->
        <section class="card" id="viewTimeline" style="display:none">
          <div class="head">
            <h2>×”×™×¡×˜×•×¨×™×™×ª ×¤×¢×™×œ×•×ª</h2>
            <div class="muted small">×›×œ ×©×™× ×•×™ × ×©××¨: ××™/××ª×™/××” ×”×©×ª× ×”</div>
          </div>
          <div class="body">
            <div class="timeline" id="timelineList"></div>
            <div class="help" id="emptyTimeline" style="display:none">××™×Ÿ ×¢×“×™×™×Ÿ ××™×¨×•×¢×™×.</div>
          </div>
        </section>

        <!-- Settings view -->
        <section class="card" id="viewSettings" style="display:none">
          <div class="head">
            <h2>×”×’×“×¨×•×ª</h2>
            <div class="muted small">×—×™×‘×•×¨ Google Sheets ×™×™×›× ×¡ ×›××Ÿ</div>
          </div>
          <div class="body">
            <div class="miniCard">
              <h3>×©××™×¨×”/××™×¤×•×¡</h3>
              <div class="row">
                <button class="btn" id="btnBackup" type="button">ğŸ’¾ ×™×¦× ×’×™×‘×•×™ JSON</button>
                <button class="btn danger" id="btnReset" type="button">ğŸ§¨ ××™×¤×•×¡ ×›×œ ×”× ×ª×•× ×™×</button>
              </div>
              <div class="sep"></div>
              <h3>Google Sheets (×‘×§×¨×•×‘)</h3>
              <div class="small muted">
                ×›×“×™ ×œ×—×‘×¨ ×œ×¡× ×›×¨×•×Ÿ, × ×¦×˜×¨×š:
                <ul>
                  <li>URL ×©×œ ×”-Web App</li>
                  <li>ID ×©×œ ×”×¤×¨×™×¡×” (Deployment)</li>
                  <li>×©× ×’×™×œ×™×•×Ÿ / ×˜××‘</li>
                </ul>
                ×‘×¨×’×¢ ×©×ª×©×œ×— ×œ×™ â€” ××•×¡×™×£ ×œ×š ×‘×§×•×“ ××ª ×”×—×™×‘×•×¨, ×¢× Fetch, ×•×”×›×œ ×™×¢×‘×•×“ ×“×¨×š ×”×©×™×˜.
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>
  </main>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHeader">
      <b id="modalTitle">×›×•×ª×¨×ª</b>
      <button class="closeX" id="modalClose" title="×¡×’×•×¨">âœ•</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   LEADUP â€¢ Local CRM
   ======================= */

const LS_KEY = "leadup_v1";

const el = (id)=>document.getElementById(id);
const nowISO = () => new Date().toISOString();
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));

function escapeHTML(str){
  return String(str ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function fmtDT(iso){
  if(!iso) return "â€”";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "â€”";
  return d.toLocaleString("he-IL", { dateStyle:"medium", timeStyle:"short" });
}
function todayKey(){
  return new Date().toLocaleDateString("sv-SE"); // YYYY-MM-DD
}
function toLocalDT(iso){
  if(!iso) return "";
  const d = new Date(iso);
  if(Number.isNaN(d.getTime())) return "";
  const pad = (x)=>String(x).padStart(2,"0");
  const yyyy = d.getFullYear();
  const mm = pad(d.getMonth()+1);
  const dd = pad(d.getDate());
  const hh = pad(d.getHours());
  const mi = pad(d.getMinutes());
  return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
}
function fromLocalDT(local){
  if(!local) return "";
  const d = new Date(local);
  if(Number.isNaN(d.getTime())) return "";
  return d.toISOString();
}

function uid(prefix="id"){
  return prefix + "_" + Math.random().toString(16).slice(2) + Date.now().toString(16);
}

function defaultState(){
  return {
    user: { name: "×× ×”×œ", role: "Admin" },
    leads: [],
    tasks: [],
    events: []
  };
}
function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return defaultState();
    const parsed = JSON.parse(raw);
    return { ...defaultState(), ...parsed };
  }catch(e){
    return defaultState();
  }
}
const appState = loadState();

function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(appState));
  renderAll();
}

/* ===== Activity Timeline ===== */
function addEvent(type, text, meta={}){
  appState.events.unshift({
    id: uid("ev"),
    at: nowISO(),
    who: appState.user?.name || "××©×ª××©",
    type, text, meta
  });
  appState.events = appState.events.slice(0, 800);
}

/* ===== Lead Score ===== */
function sourceWeight(source){
  const s = (source||"").toLowerCase();
  if(["×”×¤× ×™×”","ref","referral"].some(x=>s.includes(x))) return 22;
  if(s.includes("×˜×œ×¤×•×Ÿ")) return 18;
  if(s.includes("×’×•×’×œ")) return 16;
  if(s.includes("××ª×¨")) return 14;
  if(s.includes("×¤×™×™×¡×‘×•×§")) return 12;
  return 10;
}
function statusWeight(status){
  switch(status){
    case "×—×“×©": return 10;
    case "× ×•×¦×¨ ×§×©×¨": return 18;
    case "××ª×¢× ×™×™×Ÿ": return 26;
    case "×”×¦×¢×ª ××—×™×¨": return 34;
    case "× ×¡×’×¨": return 40;
    case "×œ× ×¨×œ×•×•× ×˜×™": return 2;
    default: return 10;
  }
}
function computeScore(lead){
  const talks = clamp(Number(lead.contactCount||0), 0, 20);
  const talkScore = talks * 2.2; // max 44

  const base = 18;
  const src = sourceWeight(lead.source);
  const st = statusWeight(lead.status);

  const refDate = lead.lastContactAt || lead.createdAt || nowISO();
  const days = Math.floor((Date.now() - new Date(refDate).getTime()) / (1000*60*60*24));
  const recencyPenalty = clamp(days * 1.6, 0, 40);

  let score = base + src + st + talkScore - recencyPenalty;

  if(lead.status === "× ×¡×’×¨") score += 10;
  if(lead.status === "×œ× ×¨×œ×•×•× ×˜×™") score = Math.min(score, 15);

  return clamp(Math.round(score), 1, 100);
}
function heatTag(score){
  if(score >= 75) return { cls:"hot", label:"×—×" };
  if(score >= 45) return { cls:"ok", label:"×‘×™× ×•× ×™" };
  return { cls:"cold", label:"×§×¨" };
}

/* ===== Views ===== */
const nav = el("nav");
nav.addEventListener("click", (e)=>{
  const btn = e.target.closest("button[data-view]");
  if(!btn) return;
  setView(btn.dataset.view);
});
function setView(view){
  document.querySelectorAll(".nav button").forEach(b=>b.classList.toggle("active", b.dataset.view===view));

  el("viewLeads").style.display = (view==="leads") ? "" : "none";
  el("viewRight").style.display = (view==="leads") ? "" : "none";
  el("viewTasks").style.display = (view==="tasks") ? "" : "none";
  el("viewTimeline").style.display = (view==="timeline") ? "" : "none";
  el("viewSettings").style.display = (view==="settings") ? "" : "none";

  const titles = {
    leads: ["×œ×™×“×™×", "× ×™×”×•×œ ×œ×™×“×™×, ×¡×˜×˜×•×¡×™×, ×¤×¢×•×œ×•×ª ×•××¢×§×‘"],
    tasks: ["××©×™××•×ª", "×ª×–×›×•×¨×•×ª ×¢× ×ª××¨×™×š/×©×¢×” + ×¢×“×™×¤×•×ª + ×©×™×•×š ×œ×œ×™×“"],
    timeline: ["×”×™×¡×˜×•×¨×™×”", "Timeline ×©×œ ×›×œ ×¤×¢×•×œ×” ×•×©×™× ×•×™ ×‘××¢×¨×›×ª"],
    settings: ["×”×’×“×¨×•×ª", "×’×™×‘×•×™/××™×¤×•×¡ ×•×—×™×‘×•×¨ ×œ-Google Sheets"]
  };
  el("viewTitle").textContent = titles[view][0];
  el("viewSub").textContent = titles[view][1];

  renderAll();
}

/* ===== Modal ===== */
function openModal(title, html){
  el("modalTitle").textContent = title;
  el("modalBody").innerHTML = html;
  el("modalBack").style.display = "flex";
}
function closeModal(){
  el("modalBack").style.display = "none";
  el("modalBody").innerHTML = "";
}
el("modalClose").addEventListener("click", closeModal);
el("modalBack").addEventListener("click", (e)=>{
  if(e.target === el("modalBack")) closeModal();
});

/* ===== Toast ===== */
let toastTimer=null;
function toast(msg){
  const t = el("toast");
  t.textContent = msg;
  t.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=> t.style.display="none", 2600);
}

/* ===== Filters/Search/Sort ===== */
el("q").addEventListener("input", renderLeads);
el("fStatus").addEventListener("change", renderLeads);
el("fSource").addEventListener("change", renderLeads);
el("sortBy").addEventListener("change", renderLeads);

/* ===== Buttons ===== */
el("btnAddLead").addEventListener("click", ()=>openLeadForm());
el("btnQuickTask").addEventListener("click", ()=> openProcessesPanel()); // âœ… NEW
el("btnOpenInsights").addEventListener("click", ()=> openInsights());
el("btnSeed").addEventListener("click", seedSample);

// âœ… FIX: ×›×¤×ª×•×¨×™× ×©×œ× ×§×™×™××™× ×œ× ×™×¤×™×œ×• ××ª ×”××¢×¨×›×ª
if(el("btnExport")) el("btnExport").addEventListener("click", exportJSON);
if(el("btnImport")) el("btnImport").addEventListener("click", importJSON);

el("btnBackup").addEventListener("click", exportJSON);
el("btnReset").addEventListener("click", ()=>{
  if(confirm("×œ××¤×¡ ××ª ×›×œ ×”× ×ª×•× ×™×? ×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.")){
    localStorage.removeItem(LS_KEY);
    location.reload();
  }
});

/* ===== Shortcuts ===== */
document.addEventListener("keydown", (e)=>{
  if(e.key==="Escape") closeModal();
  if(e.key==="/" && !["INPUT","TEXTAREA"].includes(document.activeElement?.tagName||"")){
    e.preventDefault();
    el("q").focus();
  }
  const modalOpen = (el("modalBack").style.display === "flex");
  if((e.key==="n" || e.key==="N") && !modalOpen){
    openLeadForm();
  }
});

function exportJSON(){
  const blob = new Blob([JSON.stringify(appState, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "leadup-backup.json";
  a.click();
  URL.revokeObjectURL(url);
  toast("×’×™×‘×•×™ ×™×¨×“ ×œ××—×©×‘ âœ…");
}
function importJSON(){
  const inp = document.createElement("input");
  inp.type = "file";
  inp.accept = "application/json";
  inp.onchange = () => {
    const f = inp.files?.[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const parsed = JSON.parse(reader.result);
        if(!parsed || typeof parsed !== "object") throw new Error("bad");
        appState.user = parsed.user || appState.user;
        appState.leads = Array.isArray(parsed.leads) ? parsed.leads : appState.leads;
        appState.tasks = Array.isArray(parsed.tasks) ? parsed.tasks : appState.tasks;
        appState.events = Array.isArray(parsed.events) ? parsed.events : appState.events;
        addEvent("import", "×™×™×‘×•× × ×ª×•× ×™× ×‘×•×¦×¢");
        saveState();
        toast("×™×™×‘×•× ×”×¦×œ×™×— âœ…");
      }catch(e){
        alert("×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ");
      }
    };
    reader.readAsText(f);
  };
  inp.click();
}

/* =======================
   NEW: My Processes Panel
   ======================= */
function openProcessesPanel(presetLeadId=""){
  const leadOptions = appState.leads.map(l=>`<option value="${escapeHTML(l.id)}">${escapeHTML(l.name||"(×œ×œ× ×©×)")}</option>`).join("");

  openModal("×”×ª×”×œ×™×›×™× ×©×œ×™ â€¢ ×˜×™×¤×•×œ ×‘×œ×™×“/×œ×§×•×—", `
    <div class="miniCard">
      <h3 style="margin:0 0 10px 0">×‘×—×™×¨×ª ×œ×™×“</h3>
      <div class="row">
        <div>
          <label>×‘×—×¨ ×œ×™×“</label>
          <select id="procLeadSelect">
            <option value="">×‘×—×¨ ×œ×™×“â€¦</option>
            ${leadOptions}
          </select>
          <div class="help">×›××Ÿ ××ª×” ×× ×”×œ ××ª ×›×œ ×”×˜×™×¤×•×œ ×‘×œ×™×“: ×¡×˜×˜×•×¡, ×ª×§×©×•×¨×ª, ××©×™××•×ª ×•×”×™×¡×˜×•×¨×™×”.</div>
        </div>
        <div>
          <label>×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="button" id="procOpenLead">âœ ×¢×¨×•×š ×œ×™×“</button>
            <button class="btn" type="button" id="procAddTask">â° ×”×•×¡×£ ××©×™××”</button>
            <button class="btn" type="button" id="procMarkTalk">â˜ï¸ ×¡×™××•×Ÿ â€œ×“×™×‘×¨× ×•â€</button>
          </div>
        </div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <button class="tabBtn active" data-tab="status">ğŸŸ¡ ×¡×˜×˜×•×¡ ×˜×™×¤×•×œ</button>
        <button class="tabBtn" data-tab="comm">ğŸ“§ ×ª×§×©×•×¨×ª</button>
        <button class="tabBtn" data-tab="tasks">â° ××©×™××•×ª</button>
        <button class="tabBtn" data-tab="history">ğŸ§¾ ×”×™×¡×˜×•×¨×™×”</button>
        <button class="tabBtn" data-tab="smart">ğŸ§  ×—×›×</button>
      </div>
    </div>

    <div class="sep"></div>

    <div id="procEmpty" class="help">×‘×—×¨ ×œ×™×“ ×›×“×™ ×œ×¨××•×ª ××ª ×”×ª×”×œ×™×š.</div>

    <div class="tabPane active" id="tab_status"></div>
    <div class="tabPane" id="tab_comm"></div>
    <div class="tabPane" id="tab_tasks"></div>
    <div class="tabPane" id="tab_history"></div>
    <div class="tabPane" id="tab_smart"></div>
  `);

  const sel = document.getElementById("procLeadSelect");
  const btnOpenLead = document.getElementById("procOpenLead");
  const btnAddTask = document.getElementById("procAddTask");
  const btnMarkTalk = document.getElementById("procMarkTalk");

  // Tabs handlers
  document.querySelectorAll(".tabBtn").forEach(b=>{
    b.addEventListener("click", ()=>{
      document.querySelectorAll(".tabBtn").forEach(x=>x.classList.toggle("active", x===b));
      const tab = b.getAttribute("data-tab");
      ["status","comm","tasks","history","smart"].forEach(t=>{
        document.getElementById("tab_"+t).classList.toggle("active", t===tab);
      });
    });
  });

  function currentLead(){
    const id = sel.value || "";
    return id ? appState.leads.find(l=>l.id===id) : null;
  }

  function renderProcesses(){
    const lead = currentLead();
    document.getElementById("procEmpty").style.display = lead ? "none" : "";

    // Disable buttons if no lead
    [btnOpenLead, btnAddTask, btnMarkTalk].forEach(b=>{
      if(!b) return;
      b.disabled = !lead;
      b.style.opacity = lead ? "1" : ".6";
      b.style.pointerEvents = lead ? "" : "none";
    });

    if(!lead){
      ["status","comm","tasks","history","smart"].forEach(t=>{
        document.getElementById("tab_"+t).innerHTML = "";
      });
      return;
    }

    // STATUS TAB
    document.getElementById("tab_status").innerHTML = `
      <div class="miniCard">
        <h3>×¡×˜×˜×•×¡ ×˜×™×¤×•×œ</h3>
        <div class="row">
          <div>
            <label>×¡×˜×˜×•×¡</label>
            <select id="procStatus">
              ${["×—×“×©","× ×•×¦×¨ ×§×©×¨","××ª×¢× ×™×™×Ÿ","×”×¦×¢×ª ××—×™×¨","× ×¡×’×¨","×œ× ×¨×œ×•×•× ×˜×™"].map(s=>`
                <option ${s===lead.status?"selected":""}>${s}</option>
              `).join("")}
            </select>
          </div>
          <div>
            <label>××¢×§×‘ ×”×‘× (×ª××¨×™×š/×©×¢×”)</label>
            <input id="procNext" type="datetime-local" value="${escapeHTML(toLocalDT(lead.nextFollowUpAt))}"/>
          </div>
        </div>

        <div style="margin-top:10px">
          <label>×”×¢×¨×”/×¡×™×›×•× ×©×™×—×”</label>
          <textarea id="procNote" placeholder="×¢×“×›×Ÿ ××” × ×××¨, ××” × ×©××¨ ×œ×¢×©×•×ªâ€¦">${escapeHTML(lead.note||"")}</textarea>
        </div>

        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="procSaveStatus">ğŸ’¾ ×©××•×¨ ×©×™× ×•×™×™×</button>
          <button class="btn" type="button" id="procQuickQuote">ğŸ“„ ×¡×˜×˜×•×¡: â€œ× ×©×œ×—×” ×”×¦×¢×”â€</button>
          <button class="btn" type="button" id="procCloseWon">âœ… ×¡×˜×˜×•×¡: â€œ× ×¡×’×¨â€</button>
          <button class="btn danger" type="button" id="procCloseLost">âŒ ×¡×˜×˜×•×¡: â€œ×œ× ×¨×œ×•×•× ×˜×™â€</button>
        </div>

        <div class="help">
          × ×•×¦×¨: <b>${fmtDT(lead.createdAt)}</b> â€¢ ×©×™×—×” ××—×¨×•× ×”: <b>${lead.lastContactAt ? fmtDT(lead.lastContactAt) : "â€”"}</b> â€¢ ×©×™×—×•×ª: <b>${Number(lead.contactCount||0)}</b>
        </div>
      </div>
    `;

    // COMM TAB
    const phoneIL = normalizeILPhone(lead.phone);
    const mail = (lead.email||"").trim();
    const wa = phoneIL ? `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}` : "";
    const tel = (lead.phone||"").trim();
    const mailtoBase = mail ? `mailto:${encodeURIComponent(mail)}` : "";

    document.getElementById("tab_comm").innerHTML = `
      <div class="miniCard">
        <h3>×ª×§×©×•×¨×ª</h3>
        <div class="row">
          <div>
            <div class="small muted">×˜×œ×¤×•×Ÿ: <b>${escapeHTML(lead.phone||"â€”")}</b></div>
            <div class="small muted" style="margin-top:6px">××™××™×™×œ: <b>${escapeHTML(mail||"â€”")}</b></div>

            <div class="sep"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn gold" type="button" id="procWA" ${wa? "":"disabled"}>ğŸ’¬ ×•×•××˜×¡××¤</button>
              <button class="btn" type="button" id="procCALL" ${tel? "":"disabled"}>ğŸ“ ×”×ª×§×©×¨</button>
              <button class="btn" type="button" id="procMAIL" ${mailtoBase? "":"disabled"}>âœ‰ï¸ ××™×™×œ</button>
              <button class="btn" type="button" id="procCopyPhone" ${tel? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
              <button class="btn" type="button" id="procCopyMail" ${mail? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
            </div>

            <div class="sep"></div>

            <h3 style="margin:0 0 8px 0">××™×™×œ ××”×™×¨ (×ª×‘× ×™×•×ª)</h3>
            <div class="row">
              <div>
                <label>×ª×‘× ×™×ª</label>
                <select id="procMailTpl">
                  <option value="intro">×¤× ×™×™×” ×¨××©×•× ×™×ª</option>
                  <option value="follow">×ª×–×›×•×¨×ª / ×¤×•×œ×•××¤</option>
                  <option value="quote">×©×œ×™×—×ª ×”×¦×¢×”</option>
                  <option value="thanks">×ª×•×“×”</option>
                </select>
              </div>
              <div>
                <label>× ×•×©×</label>
                <input id="procMailSub" placeholder="× ×•×©× ×”××™×™×œâ€¦"/>
              </div>
            </div>
            <div style="margin-top:10px">
              <label>×ª×•×›×Ÿ</label>
              <textarea id="procMailBody" placeholder="×›×ª×•×‘ ×›××Ÿâ€¦"></textarea>
            </div>
            <button class="btn gold" type="button" id="procSendMail" style="margin-top:10px" ${mailtoBase? "":"disabled"}>ğŸš€ ×¤×ª×— ××™×™×œ ×¢× ×”×ª×•×›×Ÿ</button>
            <div class="help">×‘×©×œ×‘ ×”×–×” ×”××™×™×œ × ×¤×ª×— ×“×¨×š mailto (×ª×œ×•×™ ×‘×”×’×“×¨×•×ª ×”××—×©×‘). ×‘×”××©×š × ×—×‘×¨ Gmail API.</div>

            <div class="sep"></div>

            <h3 style="margin:0 0 8px 0">×”×•×“×¢×ª ×•×•××˜×¡××¤ ××•×›× ×”</h3>
            <textarea id="procWAText">${escapeHTML(`×”×™×™ ${lead.name||""}, ××“×‘×¨/×ª ×-LEADUP. ××©××— ×œ×¢×“×›×Ÿ ×œ×’×‘×™ ×”×‘×™×˜×•×— â€” ××ª×™ × ×•×— ×œ×“×‘×¨?`)}</textarea>
            <button class="btn" type="button" id="procOpenWAMsg" style="margin-top:10px" ${wa? "":"disabled"}>ğŸš€ ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×•×“×¢×”</button>
          </div>

          <div>
            ${wa ? `
              <div class="miniCard" style="margin:0">
                <h3>×ª×¦×•×’×” (WhatsApp Web)</h3>
                <div class="frame">
                  <iframe id="procWAFrame" src="${escapeHTML(wa)}"></iframe>
                </div>
                <div class="help">×× ×œ× ×”×ª×—×‘×¨×ª ×œ-WhatsApp Web, ×ª×¦×˜×¨×š ×œ×”×ª×—×‘×¨ ×¤×¢× ××—×ª.</div>
              </div>
            ` : `
              <div class="miniCard" style="margin:0">
                <h3>×ª×¦×•×’×”</h3>
                <div class="help">××™×Ÿ ×˜×œ×¤×•×Ÿ ×œ×œ×™×“ â€” ×”×•×¡×£ ××¡×¤×¨ ×›×“×™ ×œ×¤×ª×•×— WhatsApp Web ×›××Ÿ.</div>
              </div>
            `}
          </div>
        </div>
      </div>
    `;

    // TASKS TAB
    const leadTasks = appState.tasks
      .filter(t=>t.leadId===lead.id && t.status!=="×‘×•×¦×¢×”")
      .sort((a,b)=>{
        const da = a.dueAt ? new Date(a.dueAt).getTime() : Infinity;
        const db = b.dueAt ? new Date(b.dueAt).getTime() : Infinity;
        return da-db;
      });

    document.getElementById("tab_tasks").innerHTML = `
      <div class="miniCard">
        <h3>××©×™××•×ª ×œ×œ×™×“</h3>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="procNewTask">â° ×¦×•×¨ ××©×™××”</button>
          <button class="btn" type="button" id="procJumpTasks">ğŸ“Œ ×¢×‘×•×¨ ×œ××¡×š ××©×™××•×ª</button>
        </div>

        <div class="sep"></div>

        <div class="miniList">
          ${leadTasks.length ? leadTasks.map(t=>`
            <div class="event">
              <div class="t">${t.dueAt ? fmtDT(t.dueAt) : "×œ×œ× ×ª××¨×™×š"} â€¢ ${escapeHTML(t.priority||"")}</div>
              <div class="d">${escapeHTML(t.title||"")}</div>
              <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
                <button class="btn" type="button" data-proc="task_done" data-id="${escapeHTML(t.id)}">âœ“ ×¡××Ÿ ×‘×•×¦×¢×”</button>
                <button class="btn" type="button" data-proc="task_edit" data-id="${escapeHTML(t.id)}">âœ ×¢×¨×•×š</button>
                <button class="btn danger" type="button" data-proc="task_del" data-id="${escapeHTML(t.id)}">ğŸ—‘ï¸ ××—×§</button>
              </div>
            </div>
          `).join("") : `<div class="help">××™×Ÿ ××©×™××•×ª ×¤×ª×•×—×•×ª ×œ×œ×™×“ ×”×–×”.</div>`}
        </div>
      </div>
    `;

    // HISTORY TAB (only this lead)
    const leadEvents = appState.events
      .filter(ev=> (ev.meta && ev.meta.leadId===lead.id))
      .slice(0, 200);

    document.getElementById("tab_history").innerHTML = `
      <div class="miniCard">
        <h3>×”×™×¡×˜×•×¨×™×” ×œ×œ×™×“</h3>
        <div class="timeline" style="max-height:520px">
          ${leadEvents.length ? leadEvents.map(ev=>`
            <div class="event">
              <div class="t">${fmtDT(ev.at)} â€¢ ${escapeHTML(ev.who||"××©×ª××©")} â€¢ <span class="muted">${escapeHTML(ev.type||"")}</span></div>
              <div class="d">${escapeHTML(ev.text||"")}</div>
            </div>
          `).join("") : `<div class="help">××™×Ÿ ×¢×“×™×™×Ÿ ××™×¨×•×¢×™× ×œ×œ×™×“ ×”×–×”.</div>`}
        </div>
      </div>
    `;

    // SMART TAB
    const score = computeScore(lead);
    const ht = heatTag(score);
    const rec = getSmartRecommendation(lead, score);

    document.getElementById("tab_smart").innerHTML = `
      <div class="miniCard">
        <h3>×—×›×</h3>

        <div class="score">
          <div class="tag ${ht.cls}">ğŸ”¥ ${ht.label}</div>
          <div style="font-weight:900; font-size:16px">${score}/100</div>
          <div class="muted small">Lead Score</div>
        </div>
        <div class="bar" style="margin-top:10px"><i style="width:${score}%"></i></div>

        <div class="sep"></div>

        <div class="event">
          <div class="t">×”××œ×¦×ª ×¤×¢×•×œ×”</div>
          <div class="d"><b>${escapeHTML(rec.title)}</b><div class="small muted" style="margin-top:6px">${escapeHTML(rec.note)}</div></div>
        </div>

        <div class="sep"></div>

        <div class="row">
          <div>
            <label>×ª×–×›×•×¨×ª ××•××œ×¦×ª</label>
            <div class="small muted">${escapeHTML(rec.followText)}</div>
          </div>
          <div>
            <label>×‘×™×¦×•×¢ ××”×™×¨</label>
            <div style="display:flex; gap:10px; flex-wrap:wrap">
              <button class="btn gold" type="button" id="smartCreateTask">â° ×¦×•×¨ ××©×™××ª ×¤×•×œ×•××¤</button>
              <button class="btn" type="button" id="smartContact">ğŸ“² ×¤×ª×— ×ª×§×©×•×¨×ª</button>
            </div>
          </div>
        </div>

      </div>
    `;

    // Wire events inside tabs
    // Status save
    document.getElementById("procSaveStatus")?.addEventListener("click", ()=>{
      const beforeStatus = lead.status;
      const newStatus = document.getElementById("procStatus").value;
      const newNext = fromLocalDT(document.getElementById("procNext").value);
      const newNote = document.getElementById("procNote").value;

      lead.status = newStatus;
      lead.nextFollowUpAt = newNext;
      lead.note = newNote;

      if(beforeStatus !== newStatus){
        addEvent("status_change", `×¡×˜×˜×•×¡ ×¢×•×“×›×Ÿ ×œ-â€œ${newStatus}â€ ×¢×‘×•×¨ ${lead.name||"×œ×™×“"}`, {leadId: lead.id});
      }else{
        addEvent("lead_update", `×¢×•×“×›× ×• ×¤×¨×˜×™× ×‘×ª×”×œ×™×š ×¢×‘×•×¨ ${lead.name||"×œ×™×“"}`, {leadId: lead.id});
      }

      saveState();
      toast("×¢×•×“×›×Ÿ ×‘×ª×”×œ×™×š âœ…");
      renderProcesses();
    });

    document.getElementById("procQuickQuote")?.addEventListener("click", ()=>{
      document.getElementById("procStatus").value = "×”×¦×¢×ª ××—×™×¨";
      toast("×”×•×—×œ ×¡×˜×˜×•×¡ ×”×¦×¢×ª ××—×™×¨");
    });
    document.getElementById("procCloseWon")?.addEventListener("click", ()=>{
      document.getElementById("procStatus").value = "× ×¡×’×¨";
      toast("×”×•×—×œ ×¡×˜×˜×•×¡ × ×¡×’×¨");
    });
    document.getElementById("procCloseLost")?.addEventListener("click", ()=>{
      document.getElementById("procStatus").value = "×œ× ×¨×œ×•×•× ×˜×™";
      toast("×”×•×—×œ ×¡×˜×˜×•×¡ ×œ× ×¨×œ×•×•× ×˜×™");
    });

    // Comm wiring
    document.getElementById("procCopyPhone")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(tel||""); toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§"); }
    });
    document.getElementById("procCopyMail")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§"); }
    });

    document.getElementById("procWA")?.addEventListener("click", ()=>{
      if(!wa) return;
      const frame = document.getElementById("procWAFrame");
      if(frame) frame.src = wa;
      addEvent("contact_open", `× ×¤×ª×— ×•×•××˜×¡××¤ ××ª×•×š ×ª×”×œ×™×š â€¢ ${lead.name||"â€”"}`, {leadId: lead.id});
      saveState();
    });

    document.getElementById("procCALL")?.addEventListener("click", ()=>{
      addEvent("call_hint", `× ×™×¡×™×•×Ÿ ×”×ª×§×©×¨×•×ª ××ª×•×š ×ª×”×œ×™×š â€¢ ${lead.name||"â€”"}`, {leadId: lead.id});
      saveState();
      openModal(`×”×ª×§×©×¨ â€¢ ${lead.name||"×œ×™×“"}`, `
        <div class="miniCard">
          <h3>×”×ª×§×©×¨×•×ª</h3>
          <div class="small muted">××¡×¤×¨: <b>${escapeHTML(tel||"â€”")}</b></div>
          <div class="sep"></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="button" id="ccCopy">ğŸ“‹ ×”×¢×ª×§ ××¡×¤×¨</button>
            <a class="btn" href="${escapeHTML(tel ? "tel:"+tel.replace(/[^\d+]/g,"") : "#")}" style="text-decoration:none; ${tel? "":"pointer-events:none;opacity:.6"}">ğŸ“ ×—×™×™×’ (×× ×”×“×¤×“×¤×Ÿ ×××¤×©×¨)</a>
          </div>
          <div class="help">×‘××—×©×‘ ×œ×¤×¢××™× Tel ×œ× ×¢×•×‘×“ â€” ××– ×”×›×™ ×˜×•×‘ ×œ×”×¢×ª×™×§ ×•×œ×”×ª×§×©×¨ ××”× ×™×™×“.</div>
        </div>
      `);
      document.getElementById("ccCopy")?.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(tel||""); toast("×”××¡×¤×¨ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
      });
    });

    function buildMailTemplate(tpl){
      const name = lead.name || "";
      if(tpl==="intro"){
        return {
          sub: `×¤× ×™×™×” ×‘× ×•×©× ×‘×™×˜×•×— â€¢ ${name}`,
          body: `×”×™×™ ${name},\n\n××“×‘×¨/×ª ×-LEADUP.\n××©××— ×œ×¢×–×•×¨ ×•×œ×‘×“×•×§ ×¢×‘×•×¨×š ×”×¦×¢×ª ×‘×™×˜×•×— ××©×ª×œ××ª.\n××ª×™ × ×•×— ×œ×“×‘×¨?\n\n×ª×•×“×”!`
        };
      }
      if(tpl==="follow"){
        return {
          sub: `×ª×–×›×•×¨×ª ×§×¦×¨×” â€¢ ${name}`,
          body: `×”×™×™ ${name},\n\n×¨×§ ××–×›×™×¨/×” ×œ×’×‘×™ ×”×¤× ×™×™×” ×©×œ× ×•.\n××©××— ×œ×¢×“×›×•×Ÿ ×§×¦×¨ ××ª×™ × ×•×— ×œ×”××©×™×š.\n\n×ª×•×“×”!`
        };
      }
      if(tpl==="quote"){
        return {
          sub: `×”×¦×¢×ª ××—×™×¨ â€¢ ${name}`,
          body: `×”×™×™ ${name},\n\n××¦×•×¨×¤×ª/××•×›× ×” ×”×¦×¢×ª ×”××—×™×¨.\n××¤×©×¨ ×œ×ª×× ×©×™×—×” ×§×¦×¨×” ×œ×”×¡×‘×¨ ×•×œ×¡×’×™×¨×”?\n\n×ª×•×“×”!`
        };
      }
      return {
        sub: `×ª×•×“×” â€¢ ${name}`,
        body: `×”×™×™ ${name},\n\n×ª×•×“×” ×¢×œ ×”×–××Ÿ!\n×× ×™ ×›××Ÿ ×œ×›×œ ×©××œ×”.\n\n×™×•× ××¦×•×™×Ÿ ğŸ™`
      };
    }

    const tplSel = document.getElementById("procMailTpl");
    const subInp = document.getElementById("procMailSub");
    const bodyTa = document.getElementById("procMailBody");

    function applyTpl(){
      const tpl = tplSel.value;
      const {sub, body} = buildMailTemplate(tpl);
      subInp.value = sub;
      bodyTa.value = body;
    }
    tplSel?.addEventListener("change", applyTpl);
    applyTpl();

    document.getElementById("procSendMail")?.addEventListener("click", ()=>{
      if(!mailtoBase) return;
      const subject = subInp.value || "LEADUP";
      const body = bodyTa.value || "";
      const mailto = `${mailtoBase}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      addEvent("mail_hint", `× ×¤×ª×— ××™×™×œ ××ª×•×š ×ª×”×œ×™×š â€¢ ${lead.name||"â€”"}`, {leadId: lead.id});
      saveState();
      window.location.href = mailto;
    });

    document.getElementById("procMAIL")?.addEventListener("click", ()=>{
      if(!mailtoBase) return;
      // ×¤×•×ª×— ××™×™×œ ×¢× ×”×ª×‘× ×™×ª ×”×§×™×™××ª
      document.getElementById("procSendMail")?.click();
    });

    document.getElementById("procOpenWAMsg")?.addEventListener("click", ()=>{
      if(!phoneIL) return;
      const txt = document.getElementById("procWAText").value || "";
      const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}&text=${encodeURIComponent(txt)}`;
      const frame = document.getElementById("procWAFrame");
      if(frame) frame.src = url;
      addEvent("wa_msg", `× ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×•×“×¢×” ××ª×•×š ×ª×”×œ×™×š â€¢ ${lead.name||"â€”"}`, {leadId: lead.id});
      saveState();
    });

    // Tasks actions
    document.getElementById("procNewTask")?.addEventListener("click", ()=>{
      openTaskForm({ leadId: lead.id, leadName: lead.name||"", presetDate: lead.nextFollowUpAt || "" });
    });
    document.getElementById("procJumpTasks")?.addEventListener("click", ()=>{
      closeModal();
      setView("tasks");
    });

    document.querySelectorAll('[data-proc="task_done"]').forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-id");
        toggleTaskDone(id);
        renderProcesses();
      });
    });
    document.querySelectorAll('[data-proc="task_edit"]').forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-id");
        openTaskForm({ taskId:id });
      });
    });
    document.querySelectorAll('[data-proc="task_del"]').forEach(b=>{
      b.addEventListener("click", ()=>{
        const id = b.getAttribute("data-id");
        if(!confirm("×œ××—×•×§ ××©×™××”?")) return;
        appState.tasks = appState.tasks.filter(t=>t.id!==id);
        addEvent("task_delete", "× ××—×§×” ××©×™××”", {taskId:id, leadId: lead.id});
        saveState();
        renderProcesses();
      });
    });

    // Smart quick
    document.getElementById("smartCreateTask")?.addEventListener("click", ()=>{
      openTaskForm({ leadId: lead.id, leadName: lead.name||"", presetDate: lead.nextFollowUpAt || "" });
    });
    document.getElementById("smartContact")?.addEventListener("click", ()=>{
      // ×§×•×¤×¥ ×œ×˜××‘ ×ª×§×©×•×¨×ª
      document.querySelector('.tabBtn[data-tab="comm"]')?.click();
    });

    // Persist
    // (No-op here; saveState is called on actions)
  }

  sel.addEventListener("change", ()=>{
    renderProcesses();
  });

  btnOpenLead.addEventListener("click", ()=>{
    const lead = currentLead();
    if(!lead) return;
    openLeadForm(lead.id);
  });

  btnAddTask.addEventListener("click", ()=>{
    const lead = currentLead();
    if(!lead) return;
    openTaskForm({ leadId: lead.id, leadName: lead.name||"", presetDate: lead.nextFollowUpAt || "" });
  });

  btnMarkTalk.addEventListener("click", ()=>{
    const lead = currentLead();
    if(!lead) return;
    lead.contactCount = Number(lead.contactCount||0) + 1;
    lead.lastContactAt = nowISO();
    addEvent("contact", `×©×™×—×”/××¢× ×” ×¡×•××Ÿ ××ª×•×š ×ª×”×œ×™×š â€¢ ${lead.name||"(×œ×œ× ×©×)"}`, {leadId: lead.id});
    saveState();
    toast("×¡×•××Ÿ ×©×™×—×” âœ…");
    renderProcesses();
  });

  // Preselect
  if(presetLeadId){
    sel.value = presetLeadId;
  }else if(appState.leads.length===1){
    sel.value = appState.leads[0].id;
  }
  renderProcesses();
}

function getSmartRecommendation(lead, score){
  const hasNext = !!lead.nextFollowUpAt;
  const daysFromLast = lead.lastContactAt ? Math.floor((Date.now() - new Date(lead.lastContactAt).getTime())/(86400000)) : null;

  if(lead.status==="× ×¡×’×¨"){
    return { title:"×¡×’×™×¨×”! ğŸ‰", note:"×”×œ×™×“ × ×¡×’×¨. ××•××œ×¥ ×œ×”×•×¡×™×£ ××©×™××ª ×©×™×¨×•×ª/×©×™××•×¨ ×‘×¢×•×“ ×—×•×“×©.", followText:"×”×’×“×¨ ×ª×–×›×•×¨×ª ×©×™××•×¨: ×¢×•×“ 30 ×™××™×." };
  }
  if(lead.status==="×œ× ×¨×œ×•×•× ×˜×™"){
    return { title:"×¡×’×™×¨×” ×›×œ× ×¨×œ×•×•× ×˜×™", note:"××•××œ×¥ ×œ×”×©××™×¨ ×”×¢×¨×” ×§×¦×¨×” ×œ××” ×•×œ×¡×’×•×¨ ××©×™××•×ª ×¤×ª×•×—×•×ª.", followText:"××™×Ÿ ×¦×•×¨×š ×‘×¤×•×œ×•××¤." };
  }
  if(score>=75){
    return { title:"×”×œ×™×“ ×—× ğŸ”¥", note: hasNext ? "×™×© ××¢×§×‘ ××•×’×“×¨ â€” ×ª×•×•×“× ×©××ª×” ××ª×§×©×¨ ×‘×–××Ÿ." : "××•××œ×¥ ×œ×§×‘×•×¢ ××¢×§×‘ ×œ×©×¢×” ×”×§×¨×•×‘×”/×”×™×•×.", followText:"×¤×•×œ×•××¤ ××•××œ×¥: ×”×™×•× / ×ª×•×š 24 ×©×¢×•×ª." };
  }
  if(daysFromLast!=null && daysFromLast>=4){
    return { title:"×¢×‘×¨ ×–××Ÿ ×××– ×¤× ×™×™×”", note:"×›×“××™ ×œ×‘×¦×¢ ×¤×•×œ×•××¤ (×©×™×—×”/×•×•××˜×¡××¤) ×›×“×™ ×œ×”×—×–×™×¨ ××ª ×”×œ×™×“ ×œ×—×™×™×.", followText:"×¤×•×œ×•××¤ ××•××œ×¥: ×”×™×•×." };
  }
  return { title:"×œ×”××©×™×š ×˜×™×¤×•×—", note:"×©××•×¨ ×¢×œ ×¨×¦×£: ×©×™×—×” â†’ ×”×¢×¨×” â†’ ××¢×§×‘ â†’ ××©×™××”.", followText:"×¤×•×œ×•××¤ ××•××œ×¥: ×‘×¢×•×“ 2â€“3 ×™××™×." };
}

/* =======================
   Leads CRUD
   ======================= */
function openLeadForm(leadId=null){
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;
  const isEdit = !!lead;

  const data = lead || {
    id: uid("lead"),
    name:"",
    phone:"",
    email:"",
    status:"×—×“×©",
    source:"",
    owner:"",
    note:"",
    createdAt: nowISO(),
    lastContactAt:"",
    nextFollowUpAt:"",
    contactCount: 0
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ×œ×™×“" : "×œ×™×“ ×—×“×©", `
    <div class="split">
      <div>
        <form id="leadForm">
          <div class="row">
            <div>
              <label>×©× ××œ×</label>
              <input name="name" value="${escapeHTML(data.name)}" required/>
            </div>
            <div>
              <label>×˜×œ×¤×•×Ÿ</label>
              <input name="phone" value="${escapeHTML(data.phone)}" inputmode="tel"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××™××™×™×œ</label>
              <input name="email" value="${escapeHTML(data.email)}" placeholder="name@email.com" inputmode="email"/>
            </div>
            <div>
              <label>(× ×¦×™×’)</label>
              <input name="owner" value="${escapeHTML(data.owner||"×× ×”×œ")}" placeholder="×©× × ×¦×™×’"/>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>×¡×˜×˜×•×¡</label>
              <select name="status">
                ${["×—×“×©","× ×•×¦×¨ ×§×©×¨","××ª×¢× ×™×™×Ÿ","×”×¦×¢×ª ××—×™×¨","× ×¡×’×¨","×œ× ×¨×œ×•×•× ×˜×™"].map(s=>`
                  <option ${s===data.status?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
            <div>
              <label>××§×•×¨</label>
              <select name="source">
                <option value="" ${!data.source ? "selected" : ""}>×‘×—×™×¨×”</option>
                ${["×¤×™×™×¡×‘×•×§","×’×•×’×œ","×”×¤× ×™×”","×˜×œ×¤×•×Ÿ","××ª×¨","××—×¨"].map(s=>`
                  <option ${s===data.source?"selected":""}>${s}</option>
                `).join("")}
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div>
              <label>××¢×§×‘ ×”×‘× (×ª××¨×™×š/×©×¢×”)</label>
              <input name="nextFollowUpAt" value="${escapeHTML(toLocalDT(data.nextFollowUpAt))}" type="datetime-local"/>
            </div>
            <div>
              <label>×¢×“×›×•×Ÿ "×“×™×‘×¨× ×•" (××¢×œ×” score)</label>
              <button type="button" class="btn" id="btnTouch" style="width:100%">â˜ï¸ ×¡×™××•×Ÿ ×©×™×—×”/××¢× ×”</button>
              <div class="help">××¢×œ×” Contact Count + ××¢×“×›×Ÿ Last Contact.</div>
            </div>
          </div>

          <div style="margin-top:10px">
            <label>×”×¢×¨×”</label>
            <textarea name="note" placeholder="×¨×©×•× ×¤×¨×˜×™× ×—×©×•×‘×™×â€¦">${escapeHTML(data.note||"")}</textarea>
          </div>

          <div class="sep"></div>

          <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-start">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            <button class="btn" type="button" id="btnCreateTask">â° ×¦×•×¨ ××©×™××” ×œ×œ×™×“</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteLead">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
            <button class="btn" type="button" id="btnOpenContact">ğŸ“² ×¤×¢×•×œ×•×ª ×§×©×¨</button>
            <button class="btn" type="button" id="btnMyProcess">ğŸ”„ ×”×ª×”×œ×™×›×™× ×©×œ×™</button>
          </div>

          <div class="help">
            Lead Score ××ª×—×©×‘ ×‘×¡×˜×˜×•×¡, ××§×•×¨, ×›××•×ª ×©×™×—×•×ª ×•×–××Ÿ ×©×¢×‘×¨.
          </div>
        </form>
      </div>

      <div>
        <div class="miniCard">
          <h3>×ª×¦×•×’×” ××”×™×¨×”</h3>
          <div class="small muted">× ×•×¦×¨: ${fmtDT(data.createdAt)}</div>
          <div class="small muted">×©×™×—×” ××—×¨×•× ×”: ${data.lastContactAt ? fmtDT(data.lastContactAt) : "â€”"}</div>
          <div class="small muted">×©×™×—×•×ª/××¢× ×™×: ${Number(data.contactCount||0)}</div>
          <div class="sep"></div>
          <div class="score">
            <div class="tag ${heatTag(computeScore(data)).cls}">ğŸ”¥ ${heatTag(computeScore(data)).label}</div>
            <div style="font-weight:800">${computeScore(data)}/100</div>
          </div>
          <div class="bar" style="margin-top:10px"><i style="width:${computeScore(data)}%"></i></div>
          <div class="help">×›×›×œ ×©×”×¦×™×•×Ÿ ×’×‘×•×” ×™×•×ª×¨â€”×”×œ×™×“ â€œ×—×â€ ×™×•×ª×¨.</div>
        </div>

        <div class="miniCard" style="margin-top:10px">
          <h3>×¤×¢×•×œ×•×ª ××”×™×¨×•×ª</h3>
          <div class="actions">
            <button type="button" class="iconBtn gold" title="×•×•××˜×¡××¤" id="qaWA">ğŸ’¬</button>
            <button type="button" class="iconBtn" title="×”×ª×§×©×¨" id="qaCall">ğŸ“</button>
            <button type="button" class="iconBtn" title="××™××™×™×œ" id="qaMail">âœ‰ï¸</button>
            <button type="button" class="iconBtn" title="×”×¢×ª×§ ×˜×œ×¤×•×Ÿ" id="qaCopy">ğŸ“‹</button>
          </div>
          <div class="help">×›××Ÿ ×”×›×œ ×‘×ª×•×š ××•×“××œ (×œ× × ×¤×ª×— ×—×œ×•×Ÿ ×—×“×©).</div>
        </div>
      </div>
    </div>
  `);

  const form = document.getElementById("leadForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.nextFollowUpAt = fromLocalDT(updated.nextFollowUpAt);
    updated.createdAt = data.createdAt || nowISO();

    const idx = appState.leads.findIndex(l=>l.id===updated.id);
    if(idx>=0){
      appState.leads[idx] = updated;
      addEvent("lead_update", `×¢×•×“×›×Ÿ ×œ×™×“: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ ×¢×•×“×›×Ÿ âœ…");
    }else{
      appState.leads.unshift(updated);
      addEvent("lead_create", `× ×•×¦×¨ ×œ×™×“ ×—×“×©: ${updated.name}`, {leadId: updated.id});
      toast("×œ×™×“ × ×•×¡×£ âœ…");
    }
    saveState();
    closeModal();
  });

  document.getElementById("btnTouch").addEventListener("click", ()=>{
    data.contactCount = Number(data.contactCount||0) + 1;
    data.lastContactAt = nowISO();
    addEvent("contact", `×©×™×—×”/××¢× ×” ×¡×•××Ÿ ×œ×œ×™×“: ${data.name||"(×œ×œ× ×©×)"}`, {leadId:data.id});
    toast("×¡×•××Ÿ ×©×™×—×” âœ…");
    const idx = appState.leads.findIndex(l=>l.id===data.id);
    if(idx>=0) appState.leads[idx] = data;
    else appState.leads.unshift(data);
    saveState();
    openLeadForm(data.id);
  });

  if(isEdit){
    document.getElementById("btnDeleteLead").addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”×œ×™×“?")) return;
      appState.leads = appState.leads.filter(l=>l.id!==leadId);
      appState.tasks = appState.tasks.filter(t=>t.leadId!==leadId);
      addEvent("lead_delete", `× ××—×§ ×œ×™×“: ${lead.name}`, {leadId});
      saveState();
      closeModal();
      toast("×œ×™×“ × ××—×§ ğŸ—‘ï¸");
    });
  }

  document.getElementById("btnCreateTask").addEventListener("click", ()=>{
    openTaskForm({ leadId: data.id, leadName: data.name, presetDate: data.nextFollowUpAt });
  });

  document.getElementById("btnOpenContact").addEventListener("click", ()=>{
    openContactPanel(data);
  });

  document.getElementById("btnMyProcess").addEventListener("click", ()=>{
    closeModal();
    openProcessesPanel(data.id);
  });

  document.getElementById("qaWA").addEventListener("click", ()=> openContactPanel(data, "wa"));
  document.getElementById("qaCall").addEventListener("click", ()=> openContactPanel(data, "call"));
  document.getElementById("qaMail").addEventListener("click", ()=> openContactPanel(data, "mail"));
  document.getElementById("qaCopy").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(data.phone||"");
      toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹");
    }catch{
      toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§ ×‘×“×¤×“×¤×Ÿ ×”×–×”");
    }
  });
}

/* ===== Contact panel (in-modal) ===== */
function normalizeILPhone(phone){
  const digits = String(phone||"").replace(/[^\d]/g,"");
  if(!digits) return "";
  if(digits.startsWith("0")) return "972" + digits.slice(1);
  if(digits.startsWith("972")) return digits;
  return digits;
}

function openContactPanel(lead, focus="wa"){
  const phoneIL = normalizeILPhone(lead.phone);
  const mail = (lead.email||"").trim();
  const waWeb = phoneIL ? `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}` : "";
  const tel = (lead.phone||"").trim();
  const mailto = mail ? `mailto:${encodeURIComponent(mail)}?subject=${encodeURIComponent("LEADUP - ×¤× ×™×”")}` : "";

  openModal(`×¤×¢×•×œ×•×ª ×§×©×¨ â€¢ ${lead.name || "×œ×™×“"}`, `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¤×¨×˜×™ ×§×©×¨</h3>
        <div class="small muted">×˜×œ×¤×•×Ÿ: <b>${escapeHTML(lead.phone||"â€”")}</b></div>
        <div class="small muted" style="margin-top:6px">××™××™×™×œ: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cWA" ${waWeb? "":"disabled"}>ğŸ’¬ ×•×•××˜×¡××¤</button>
          <button class="btn" type="button" id="cCall" ${tel? "":"disabled"}>ğŸ“ ×”×ª×§×©×¨</button>
          <button class="btn" type="button" id="cMail" ${mailto? "":"disabled"}>âœ‰ï¸ ××™×™×œ</button>
          <button class="btn" type="button" id="cCopyPhone" ${tel? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ×˜×œ×¤×•×Ÿ</button>
          <button class="btn" type="button" id="cCopyMail" ${mail? "":"disabled"}>ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
        </div>

        <div class="help">
          ×”×¢×¨×”: â€œ×”×ª×§×©×¨â€ / â€œ××™×™×œâ€ ×œ× × ×¤×ª×—×™× ×‘×ª×•×š iframe ×‘×’×œ×œ ××’×‘×œ×•×ª ×“×¤×“×¤×Ÿ,
          ××‘×œ × ×©××¨×™× ×‘×ª×•×š ×”××•×“××œ ×¢× ×›×¤×ª×•×¨×™ ×”×¢×ª×§×” + ×§×™×©×•×¨.
        </div>

        <div class="sep"></div>
        <div class="miniCard" style="margin:0; background:rgba(12,12,18,.02)">
          <h3 style="margin-bottom:8px">×”×•×“×¢×” ××”×™×¨×” ×œ×•×•××˜×¡××¤</h3>
          <label>×˜×§×¡×˜</label>
          <textarea id="waText" placeholder="×”×™×™ ${escapeHTML(lead.name||"")}, ××“×‘×¨/×ª ×-...">${escapeHTML(`×”×™×™ ${lead.name||""}, ××“×‘×¨/×ª ×-LEADUP. ××¤×©×¨ ×œ×¢×–×•×¨?`)}</textarea>
          <button class="btn gold" type="button" id="waOpenMsg" style="margin-top:10px" ${waWeb? "":"disabled"}>ğŸš€ ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×”×•×“×¢×”</button>
        </div>
      </div>

      <div class="miniCard">
        <h3>×ª×¦×•×’×” ×‘×ª×•×š ×”××¢×¨×›×ª</h3>
        ${waWeb ? `
          <div class="frame">
            <iframe id="waFrame" src="${escapeHTML(waWeb)}"></iframe>
          </div>
          <div class="help">×× ×œ× ×”×ª×—×‘×¨×ª ×œ-WhatsApp Web ×‘××—×©×‘, ×ª×¦×˜×¨×š ×œ×”×ª×—×‘×¨ ×¤×¢× ××—×ª.</div>
        ` : `
          <div class="help">××™×Ÿ ×˜×œ×¤×•×Ÿ ×œ×œ×™×“ â€” ×”×•×¡×£ ××¡×¤×¨ ×•××– ×ª×•×›×œ ×œ×¤×ª×•×— WhatsApp Web ×›××Ÿ.</div>
        `}
      </div>
    </div>
  `);

  const cWA = document.getElementById("cWA");
  const cCall = document.getElementById("cCall");
  const cMail = document.getElementById("cMail");
  const cCopyPhone = document.getElementById("cCopyPhone");
  const cCopyMail = document.getElementById("cCopyMail");

  if(cWA) cWA.addEventListener("click", ()=>{
    if(!waWeb) return;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = waWeb;
    addEvent("contact_open", `× ×¤×ª×— ×•×•××˜×¡××¤ ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  if(cCall) cCall.addEventListener("click", async ()=>{
    addEvent("call_hint", `× ×™×¡×™×•×Ÿ ×”×ª×§×©×¨×•×ª (×§×™×©×•×¨ Tel) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    toast("×”×¢×ª×§× ×• ×œ×š/×¦×™×¨×¤× ×• ×§×™×©×•×¨ ×œ×”×ª×§×©×¨×•×ª ×‘×ª×•×š ×”××•×“××œ");
    openModal(`×”×ª×§×©×¨ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×”×ª×§×©×¨×•×ª</h3>
        <div class="small muted">××¡×¤×¨: <b>${escapeHTML(tel||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="ccCopy">ğŸ“‹ ×”×¢×ª×§ ××¡×¤×¨</button>
          <a class="btn" href="${escapeHTML(tel ? "tel:"+tel.replace(/[^\d+]/g,"") : "#")}" style="text-decoration:none; ${tel? "":"pointer-events:none;opacity:.6"}">ğŸ“ ×—×™×™×’ (×× ×”×“×¤×“×¤×Ÿ ×××¤×©×¨)</a>
        </div>
        <div class="help">×‘××—×©×‘ ×œ×¤×¢××™× Tel ×œ× ×¢×•×‘×“ â€” ××– ×”×›×™ ×˜×•×‘ ×œ×”×¢×ª×™×§ ×•×œ×”×ª×§×©×¨ ××”× ×™×™×“.</div>
      </div>
    `);
    document.getElementById("ccCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(tel||""); toast("×”××¡×¤×¨ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cMail) cMail.addEventListener("click", ()=>{
    addEvent("mail_hint", `× ×¤×ª×— ××™×™×œ (mailto) ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
    openModal(`××™×™×œ â€¢ ${lead.name||"×œ×™×“"}`, `
      <div class="miniCard">
        <h3>×©×œ×™×—×ª ××™×™×œ</h3>
        <div class="small muted">×›×ª×•×‘×ª: <b>${escapeHTML(mail||"â€”")}</b></div>
        <div class="sep"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn gold" type="button" id="cmCopy">ğŸ“‹ ×”×¢×ª×§ ××™×™×œ</button>
          <a class="btn" href="${escapeHTML(mailto)}" style="text-decoration:none; ${mailto? "":"pointer-events:none;opacity:.6"}">âœ‰ï¸ ×¤×ª×— ×ª×•×›× ×ª ××™×™×œ</a>
        </div>
        <div class="help">mailto ×ª×œ×•×™ ×‘×”×’×“×¨×•×ª ×”××—×©×‘ ×©×œ×š (Gmail/Outlook ×•×›×•'). ×× ×œ× × ×¤×ª×—â€”×¤×©×•×˜ ×”×¢×ª×§.</div>
      </div>
    `);
    document.getElementById("cmCopy")?.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{}
    });
  });

  if(cCopyPhone) cCopyPhone.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(tel||""); toast("×”×˜×œ×¤×•×Ÿ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });
  if(cCopyMail) cCopyMail.addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(mail||""); toast("×”××™×™×œ ×”×•×¢×ª×§ ğŸ“‹"); }catch{ toast("×œ× × ×™×ª×Ÿ ×œ×”×¢×ª×™×§");}
  });

  document.getElementById("waOpenMsg")?.addEventListener("click", ()=>{
    if(!phoneIL) return;
    const txt = document.getElementById("waText")?.value || "";
    const url = `https://web.whatsapp.com/send?phone=${encodeURIComponent(phoneIL)}&text=${encodeURIComponent(txt)}`;
    const frame = document.getElementById("waFrame");
    if(frame) frame.src = url;
    addEvent("wa_msg", `× ×¤×ª×— ×•×•××˜×¡××¤ ×¢× ×”×•×“×¢×” ×œ×œ×™×“: ${lead.name||"â€”"}`, {leadId: lead.id});
    saveState();
  });

  if(focus==="wa") cWA?.click();
}

/* =======================
   Tasks CRUD
   ======================= */
function openTaskForm(opts={}){
  const task = opts.taskId ? appState.tasks.find(t=>t.id===opts.taskId) : null;
  const isEdit = !!task;

  const leadId = opts.leadId || task?.leadId || "";
  const lead = leadId ? appState.leads.find(l=>l.id===leadId) : null;

  const data = task || {
    id: uid("task"),
    leadId: leadId || "",
    title: "",
    dueAt: opts.presetDate || "",
    priority: "×‘×™× ×•× ×™×ª",
    status: "×¤×ª×•×—×”",
    createdAt: nowISO()
  };

  openModal(isEdit ? "×¢×¨×™×›×ª ××©×™××”" : "××©×™××” ×—×“×©×”", `
    <form id="taskForm">
      <div class="row">
        <div>
          <label>×©×™×™×š ×œ×œ×™×“</label>
          <select name="leadId">
            <option value="">×œ×œ× ×©×™×•×š</option>
            ${appState.leads.map(l=>`
              <option value="${escapeHTML(l.id)}" ${l.id===data.leadId?"selected":""}>${escapeHTML(l.name || "(×œ×œ× ×©×)")}</option>
            `).join("")}
          </select>
          <div class="help">${lead ? `× ×‘×—×¨: <b>${escapeHTML(lead.name)}</b>` : "××¤×©×¨ ×œ×‘×—×•×¨ ×œ×™×“ ××• ×œ×”×©××™×¨ ×œ×œ× ×©×™×•×š."}</div>
        </div>
        <div>
          <label>××ª×™ (×ª××¨×™×š/×©×¢×”)</label>
          <input name="dueAt" type="datetime-local" value="${escapeHTML(toLocalDT(data.dueAt))}"/>
          <div class="help">××¤×©×¨ ×’× â€œ×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×â€ ×œ××˜×”.</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>×¢×“×™×¤×•×ª</label>
          <select name="priority">
            ${["×’×‘×•×”×”","×‘×™× ×•× ×™×ª","× ××•×›×”"].map(p=>`
              <option ${p===data.priority?"selected":""}>${p}</option>
            `).join("")}
          </select>
        </div>
        <div>
          <label>×¡×˜×˜×•×¡</label>
          <select name="status">
            ${["×¤×ª×•×—×”","×‘×•×¦×¢×”"].map(s=>`
              <option ${s===data.status?"selected":""}>${s}</option>
            `).join("")}
          </select>
        </div>
      </div>

      <div style="margin-top:10px">
        <label>×ª×™××•×¨</label>
        <textarea name="title" placeholder="×œ×“×•×’××”: ×œ×—×–×•×¨ ×œ×œ×™×“ ×•×œ×ª×ª ×”×¦×¢×ª ××—×™×¨â€¦">${escapeHTML(data.title||"")}</textarea>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <label>×œ×—×–×•×¨ ××œ×™×• ×¢×•×“ X ×™××™×</label>
          <div style="display:flex; gap:10px">
            <input id="xDays" type="number" min="0" placeholder="×œ×“×•×’××”: 3"/>
            <button type="button" class="btn" id="btnApplyX">ğŸ“… ×§×‘×¢ ×ª××¨×™×š</button>
          </div>
          <div class="help">×™×§×‘×¢ Due ×œ×¤×™ ×¢×›×©×™×• + X ×™××™×.</div>
        </div>
        <div>
          <label>×¤×¢×•×œ×•×ª</label>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" type="submit">ğŸ’¾ ×©××™×¨×”</button>
            ${isEdit ? `<button class="btn danger" type="button" id="btnDeleteTask">ğŸ—‘ï¸ ××—×™×§×”</button>` : ""}
          </div>
        </div>
      </div>
    </form>
  `);

  document.getElementById("btnApplyX")?.addEventListener("click", ()=>{
    const x = Number(document.getElementById("xDays")?.value || 0);
    const d = new Date();
    d.setDate(d.getDate() + (Number.isFinite(x)? x : 0));
    const local = toLocalDT(d.toISOString());
    const due = document.querySelector('#taskForm input[name="dueAt"]');
    if(due) due.value = local;
    toast("× ×§×‘×¢ ×ª××¨×™×š âœ…");
  });

  const form = document.getElementById("taskForm");
  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(form);
    const updated = { ...data };
    for(const [k,v] of fd.entries()){
      updated[k] = v;
    }
    updated.dueAt = fromLocalDT(updated.dueAt);

    const idx = appState.tasks.findIndex(t=>t.id===updated.id);
    const leadName = updated.leadId ? (appState.leads.find(l=>l.id===updated.leadId)?.name || "×œ×™×“") : "×œ×œ× ×©×™×•×š";
    if(idx>=0){
      appState.tasks[idx] = updated;
      addEvent("task_update", `×¢×•×“×›× ×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” ×¢×•×“×›× ×” âœ…");
    }else{
      appState.tasks.unshift(updated);
      addEvent("task_create", `× ×•×¦×¨×” ××©×™××” (${updated.priority}) â€¢ ${leadName}`, {taskId: updated.id, leadId: updated.leadId||""});
      toast("××©×™××” × ×•×¡×¤×” âœ…");
    }
    saveState();
    closeModal();
  });

  if(isEdit){
    document.getElementById("btnDeleteTask")?.addEventListener("click", ()=>{
      if(!confirm("×œ××—×•×§ ××ª ×”××©×™××”?")) return;
      appState.tasks = appState.tasks.filter(t=>t.id!==data.id);
      addEvent("task_delete", `× ××—×§×” ××©×™××”`, {taskId: data.id, leadId: data.leadId||""});
      saveState();
      closeModal();
      toast("××©×™××” × ××—×§×” ğŸ—‘ï¸");
    });
  }
}

function toggleTaskDone(taskId){
  const t = appState.tasks.find(x=>x.id===taskId);
  if(!t) return;
  t.status = (t.status==="×‘×•×¦×¢×”") ? "×¤×ª×•×—×”" : "×‘×•×¦×¢×”";
  addEvent("task_toggle", `×¡×˜×˜×•×¡ ××©×™××”: ${t.status}`, {taskId: t.id, leadId: t.leadId||""});
  saveState();
}

/* =======================
   Rendering
   ======================= */
function renderAll(){
  renderStats();
  renderLeads();
  renderTasks();
  renderTimeline();
  renderNavCounts();
}

function renderNavCounts(){
  el("navCount").textContent = String(appState.leads.length);
  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;
  el("navTasks").textContent = String(openTasks);
  el("navEvents").textContent = String(appState.events.length);
}

function renderStats(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const hot = scores.filter(s=>s>=75).length;

  const today = todayKey();
  const todayFollow = appState.leads.filter(l=>{
    if(!l.nextFollowUpAt) return false;
    const d = new Date(l.nextFollowUpAt);
    if(Number.isNaN(d.getTime())) return false;
    const k = d.toLocaleDateString("sv-SE");
    return k === today;
  }).length;

  const openTasks = appState.tasks.filter(t=>t.status!=="×‘×•×¦×¢×”").length;

  el("stTotal").textContent = String(total);
  el("stHot").textContent = String(hot);
  el("stToday").textContent = String(todayFollow);
  el("stTasks").textContent = String(openTasks);
}

function getFilteredSortedLeads(){
  const q = (el("q").value||"").trim().toLowerCase();
  const fStatus = el("fStatus").value;
  const fSource = el("fSource").value;
  const sortBy = el("sortBy").value;

  let arr = [...appState.leads];

  if(q){
    arr = arr.filter(l=>{
      const hay = [
        l.name, l.phone, l.email, l.status, l.source, l.owner, l.note
      ].join(" ").toLowerCase();
      return hay.includes(q);
    });
  }
  if(fStatus) arr = arr.filter(l=> (l.status||"")===fStatus);
  if(fSource) arr = arr.filter(l=> (l.source||"")===fSource);

  const scoreOf = (l)=>computeScore(l);
  const nextTime = (l)=> l.nextFollowUpAt ? new Date(l.nextFollowUpAt).getTime() : Infinity;
  const createdTime = (l)=> l.createdAt ? new Date(l.createdAt).getTime() : 0;

  if(sortBy==="hot"){
    arr.sort((a,b)=> scoreOf(b)-scoreOf(a));
  }else if(sortBy==="next"){
    arr.sort((a,b)=> nextTime(a)-nextTime(b));
  }else if(sortBy==="newest"){
    arr.sort((a,b)=> createdTime(b)-createdTime(a));
  }else if(sortBy==="oldest"){
    arr.sort((a,b)=> createdTime(a)-createdTime(b));
  }
  return arr;
}

function renderLeads(){
  const tbody = el("leadsTbody");
  const leads = getFilteredSortedLeads();

  el("emptyLeads").style.display = (appState.leads.length===0) ? "" : "none";

  tbody.innerHTML = leads.map(l=>{
    const score = computeScore(l);
    const ht = heatTag(score);
    return `
      <tr>
        <td><b>${escapeHTML(l.name||"â€”")}</b><div class="small muted">${escapeHTML(l.owner||"")}</div></td>
        <td>${escapeHTML(l.phone||"â€”")}</td>
        <td><span class="tag">${escapeHTML(l.status||"â€”")}</span></td>
        <td><span class="tag">${escapeHTML(l.source||"â€”")}</span></td>
        <td>
          <div class="score">
            <span class="tag ${ht.cls}">${ht.label}</span>
            <b>${score}</b>
          </div>
          <div class="bar" style="margin-top:8px"><i style="width:${score}%"></i></div>
        </td>
        <td>${l.nextFollowUpAt ? fmtDT(l.nextFollowUpAt) : "â€”"}</td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-act="edit" data-id="${escapeHTML(l.id)}">âœ</button>
            <button class="iconBtn" title="××©×™××”" data-act="task" data-id="${escapeHTML(l.id)}">â°</button>
            <button class="iconBtn" title="×§×©×¨" data-act="contact" data-id="${escapeHTML(l.id)}">ğŸ“²</button>
            <button class="iconBtn" title="×”×ª×”×œ×™×›×™× ×©×œ×™" data-act="proc" data-id="${escapeHTML(l.id)}">ğŸ”„</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-act");
      if(act==="edit") openLeadForm(id);
      if(act==="task"){
        const lead = appState.leads.find(l=>l.id===id);
        openTaskForm({ leadId:id, leadName: lead?.name || "" , presetDate: lead?.nextFollowUpAt || ""});
      }
      if(act==="contact"){
        const lead = appState.leads.find(l=>l.id===id);
        if(lead) openContactPanel(lead);
      }
      if(act==="proc"){
        openProcessesPanel(id);
      }
    });
  });
}

function renderTasks(){
  const tbody = el("tasksTbody");
  const tasks = [...appState.tasks].sort((a,b)=>{
    const da = a.dueAt ? new Date(a.dueAt).getTime() : Infinity;
    const db = b.dueAt ? new Date(b.dueAt).getTime() : Infinity;
    return da-db;
  });

  const openTasks = tasks.filter(t=>t.status!=="×‘×•×¦×¢×”");
  el("emptyTasks").style.display = (openTasks.length===0) ? "" : "none";

  tbody.innerHTML = openTasks.map(t=>{
    const leadName = t.leadId ? (appState.leads.find(l=>l.id===t.leadId)?.name || "×œ×™×“") : "â€”";
    const priTag = t.priority==="×’×‘×•×”×”" ? "hot" : (t.priority==="×‘×™× ×•× ×™×ª" ? "ok" : "cold");
    return `
      <tr>
        <td>${t.dueAt ? fmtDT(t.dueAt) : "â€”"}</td>
        <td><span class="tag ${priTag}">${escapeHTML(t.priority||"")}</span></td>
        <td>${escapeHTML(leadName)}</td>
        <td>${escapeHTML(t.title||"")}</td>
        <td><span class="tag">${escapeHTML(t.status||"")}</span></td>
        <td>
          <div class="actions">
            <button class="iconBtn gold" title="×¢×¨×•×š" data-tact="edit" data-id="${escapeHTML(t.id)}">âœ</button>
            <button class="iconBtn" title="×‘×•×¦×¢×”/×¤×ª×•×—×”" data-tact="done" data-id="${escapeHTML(t.id)}">âœ“</button>
            <button class="iconBtn" title="××—×™×§×”" data-tact="del" data-id="${escapeHTML(t.id)}">ğŸ—‘ï¸</button>
          </div>
        </td>
      </tr>
    `;
  }).join("");

  tbody.querySelectorAll("button[data-tact]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.getAttribute("data-id");
      const act = btn.getAttribute("data-tact");
      if(act==="edit") openTaskForm({ taskId:id });
      if(act==="done") toggleTaskDone(id);
      if(act==="del"){
        if(!confirm("×œ××—×•×§ ××©×™××”?")) return;
        appState.tasks = appState.tasks.filter(t=>t.id!==id);
        addEvent("task_delete", "× ××—×§×” ××©×™××”", {taskId:id});
        saveState();
      }
    });
  });
}

function renderTimeline(){
  const list = el("timelineList");
  const events = appState.events.slice(0, 200);
  el("emptyTimeline").style.display = (events.length===0) ? "" : "none";

  list.innerHTML = events.map(ev=>{
    const who = ev.who || "××©×ª××©";
    return `
      <div class="event">
        <div class="t">${fmtDT(ev.at)} â€¢ ${escapeHTML(who)} â€¢ <span class="muted">${escapeHTML(ev.type||"")}</span></div>
        <div class="d">${escapeHTML(ev.text||"")}</div>
      </div>
    `;
  }).join("");
}

/* =======================
   Insights
   ======================= */
function openInsights(){
  const total = appState.leads.length;
  const scores = appState.leads.map(l=>computeScore(l));
  const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

  const byStatus = {};
  for(const l of appState.leads){
    const k = l.status || "×œ× ××•×’×“×¨";
    byStatus[k] = (byStatus[k]||0)+1;
  }
  const bySource = {};
  for(const l of appState.leads){
    const k = l.source || "×œ× ××•×’×“×¨";
    bySource[k] = (bySource[k]||0)+1;
  }

  const topHot = [...appState.leads]
    .sort((a,b)=>computeScore(b)-computeScore(a))
    .slice(0, 5);

  openModal("×¡×˜×˜×™×¡×˜×™×§×•×ª â€¢ LEADUP", `
    <div class="twoCols">
      <div class="miniCard">
        <h3>×¡×™×›×•×</h3>
        <div class="small muted">×¡×”×´×› ×œ×™×“×™×: <b>${total}</b></div>
        <div class="small muted">×××•×¦×¢ Score: <b>${avg}</b></div>
        <div class="sep"></div>
        <h3>Top 5 ×—××™×</h3>
        ${topHot.length ? topHot.map(l=>`
          <div class="event">
            <div class="t">${escapeHTML(l.name||"â€”")} â€¢ ${escapeHTML(l.status||"")}</div>
            <div class="d"><b>${computeScore(l)}</b>/100 â€¢ ${l.nextFollowUpAt ? "××¢×§×‘: "+fmtDT(l.nextFollowUpAt) : "×œ×œ× ××¢×§×‘"}</div>
          </div>
        `).join("") : `<div class="help">××™×Ÿ ×œ×™×“×™×.</div>`}
      </div>

      <div class="miniCard">
        <h3>×”×ª×¤×œ×’×•×ª</h3>
        <div class="small muted"><b>×œ×¤×™ ×¡×˜×˜×•×¡</b></div>
        ${Object.keys(byStatus).length ? Object.entries(byStatus).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
        <div class="sep"></div>
        <div class="small muted"><b>×œ×¤×™ ××§×•×¨</b></div>
        ${Object.keys(bySource).length ? Object.entries(bySource).map(([k,v])=>`
          <div class="event"><div class="t">${escapeHTML(k)}</div><div class="d">${v}</div></div>
        `).join("") : `<div class="help">××™×Ÿ × ×ª×•× ×™×.</div>`}
      </div>
    </div>
  `);
}

/* =======================
   Seed sample data
   ======================= */
function seedSample(){
  if(appState.leads.length && !confirm("×›×‘×¨ ×™×© ×œ×™×“×™×. ×œ×”×•×¡×™×£ ×¢×•×“ ×“×•×’×××•×ª?")) return;

  const mkLead = (name, phone, status, source, nextDays, talks=0)=>({
    id: uid("lead"),
    name, phone,
    email: "",
    status, source,
    owner: "×× ×”×œ",
    note: "×“×•×’××”",
    createdAt: new Date(Date.now() - (Math.random()*8+1)*86400000).toISOString(),
    lastContactAt: talks ? new Date(Date.now() - (Math.random()*4+1)*86400000).toISOString() : "",
    nextFollowUpAt: nextDays!=null ? new Date(Date.now()+nextDays*86400000).toISOString() : "",
    contactCount: talks
  });

  const demo = [
    mkLead("××™×ª×™ ×›×”×Ÿ","052-1234567","××ª×¢× ×™×™×Ÿ","×”×¤× ×™×”",1,3),
    mkLead("× ×•×¢×” ×œ×•×™","054-9876543","× ×•×¦×¨ ×§×©×¨","×¤×™×™×¡×‘×•×§",0,1),
    mkLead("×“× ×™××œ ××•×—× ×”","050-2223344","×”×¦×¢×ª ××—×™×¨","×’×•×’×œ",2,4),
    mkLead("×¨×•×¢×™ ×‘×™×˜×•×Ÿ","053-5556677","×—×“×©","××ª×¨",3,0),
    mkLead("×©×—×¨ ×××Ÿ","052-7654321","× ×¡×’×¨","×˜×œ×¤×•×Ÿ",null,6),
  ];

  appState.leads.unshift(...demo);
  addEvent("seed", "× ×•×¦×¨×• ×œ×™×“×™× ×œ×“×•×’××”");
  appState.tasks.unshift(
    { id: uid("task"), leadId: demo[0].id, title:"×œ×—×–×•×¨ ×¢× ×”×¦×¢×ª ××—×™×¨", dueAt: new Date(Date.now()+86400000).toISOString(), priority:"×’×‘×•×”×”", status:"×¤×ª×•×—×”", createdAt: nowISO() },
    { id: uid("task"), leadId: demo[2].id, title:"×‘×“×™×§×ª ××¡××›×™×", dueAt: new Date(Date.now()+2*86400000).toISOString(), priority:"×‘×™× ×•× ×™×ª", status:"×¤×ª×•×—×”", createdAt: nowISO() }
  );
  addEvent("seed", "× ×•×¦×¨×• ××©×™××•×ª ×œ×“×•×’××”");
  saveState();
  toast("× ×•×¦×¨×• ×“×•×’×××•×ª âœ…");
}

/* =======================
   Init
   ======================= */
(function init(){
  if(!appState.events.length){
    addEvent("init", "×”××¢×¨×›×ª ×¢×œ×ª×” â€¢ ××¦×‘ LocalStorage");
    saveState();
  }else{
    renderAll();
  }
})();
  /* ===== LEADUP: Soft Glow Logo Trigger ===== */
(function setupLogoGlow(){
  const logo = document.querySelector(".logo");
  if(!logo) return;

  const INTERVAL_MS = 11000;   // ×›×œ 11 ×©× ×™×•×ª
  const DURATION_MS = 2200;    // ×—×™×™×‘ ×œ×”×ª××™× ×œ-CSS (2200ms)

  let timer = null;

  function triggerGlow(){
    if (window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

    logo.classList.remove("is-glowing");
    void logo.offsetWidth; // reflow ×§×˜×Ÿ ×›×“×™ ×œ××¤×©×¨ ×˜×¨×™×’×¨ ×—×•×–×¨
    logo.classList.add("is-glowing");

    setTimeout(()=> logo.classList.remove("is-glowing"), DURATION_MS + 50);
  }

  setTimeout(triggerGlow, 1200);
  timer = setInterval(triggerGlow, INTERVAL_MS);

  document.addEventListener("visibilitychange", ()=>{
    if(document.hidden){
      clearInterval(timer);
      timer = null;
    }else{
      if(!timer) timer = setInterval(triggerGlow, INTERVAL_MS);
      setTimeout(triggerGlow, 600);
    }
  });
})();
/* ===== LEADUP: Greeting by time ===== */
(function greetByTime(){
  const elGreet = document.getElementById("greetText");
  if(!elGreet) return;

  function getGreeting(){
    const h = new Date().getHours();
    if(h >= 5 && h < 12) return "×‘×•×§×¨ ×˜×•×‘ â˜€ï¸";
    if(h >= 12 && h < 17) return "×¦×”×¨×™×™× ×˜×•×‘×™× ğŸŒ¤ï¸";
    if(h >= 17 && h < 21) return "×¢×¨×‘ ×˜×•×‘ ğŸŒ™";
    return "×œ×™×œ×” ×˜×•×‘ ğŸŒ™";
  }

  function render(){
    elGreet.textContent = getGreeting();
  }

  render();
  // ××ª×¢×“×›×Ÿ ×›×œ ×“×§×” (×›××¢×˜ ×œ× ××•×¨×’×© ×‘×‘×™×¦×•×¢×™×)
  setInterval(render, 60 * 1000);
})();

</script>
</body>
</html>
