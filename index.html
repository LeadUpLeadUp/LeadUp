<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>LEADUP â€¢ CRM</title>

  <style>
    :root{
      --bg:#0b0b0f;
      --panel:#111118;
      --panel2:#151520;
      --line:rgba(255,255,255,.10);
      --soft:rgba(255,255,255,.06);

      --paper:#f6f4ef;          /* ×”××–×•×¨ ×”×‘×”×™×¨ (×›××• ×‘×ª××•× ×”) */
      --paper2:#ffffff;
      --paperLine: rgba(10,10,10,.10);
      --paperSoft: rgba(10,10,10,.06);

      --text:#ffffff;
      --muted:rgba(255,255,255,.70);
      --dark:#111114;
      --dark2:#1a1a22;

      --gold:#d6b25e;
      --gold2:#f0d183;
      --goldSoft: rgba(214,178,94,.20);

      --ok:#2ef2a2;
      --bad:#ff5c7a;

      --radius:18px;
      --radius2:14px;

      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 10px 28px rgba(0,0,0,.28);

      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans Hebrew", sans-serif;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background:
        radial-gradient(900px 520px at 20% -10%, rgba(214,178,94,.12), transparent 60%),
        radial-gradient(900px 520px at 90% 120%, rgba(240,209,131,.08), transparent 55%),
        linear-gradient(180deg, #0a0a10, #08080c);
      color:var(--text);
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Layout */
    .app{
      max-width: 1240px;
      margin: 28px auto;
      padding: 0 18px;
    }
    .frame{
      display:grid;
      grid-template-columns: 240px 1fr;
      gap: 18px;
      align-items: stretch;
    }

    /* Sidebar */
    .sidebar{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow2);
      overflow:hidden;
      position: sticky;
      top: 18px;
      height: calc(100vh - 36px);
      min-height: 560px;
      display:flex;
      flex-direction:column;
    }

    .sbTop{
      padding: 16px 16px 14px;
      display:flex; align-items:center; gap:10px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
    }
    .shield{
      width:36px; height:36px; border-radius: 12px;
      background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.35), transparent 60%),
                  linear-gradient(135deg, rgba(214,178,94,.95), rgba(240,209,131,.65));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 16px 30px rgba(214,178,94,.18);
    }
    .brand{
      display:flex; flex-direction:column;
      line-height:1.1;
    }
    .brand b{font-size:14px; letter-spacing:.3px}
    .brand span{font-size:12px; color:var(--muted)}

    .nav{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .nav a{
      text-decoration:none;
      color: rgba(255,255,255,.88);
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid transparent;
      background: transparent;
      transition:.18s;
      font-size:13px;
    }
    .nav a:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
    }
    .nav a.active{
      background: linear-gradient(90deg, rgba(214,178,94,.18), rgba(255,255,255,.04));
      border-color: rgba(214,178,94,.25);
      box-shadow: 0 10px 24px rgba(214,178,94,.10);
    }
    .ico{
      width:18px; height:18px; border-radius: 6px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.10);
      display:inline-flex; align-items:center; justify-content:center;
      font-size:11px;
      color: rgba(255,255,255,.85);
    }

    .sbBottom{
      margin-top:auto;
      padding: 14px 14px 16px;
      border-top:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      background: rgba(255,255,255,.02);
    }
    .avatarSmall{
      width:38px; height:38px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
    }
    .sbUser b{display:block; font-size:13px}
    .sbUser span{display:block; font-size:12px; color:var(--muted)}

    /* Main */
    .main{
      background: transparent;
      border-radius: 20px;
      min-height: 560px;
    }

    .paper{
      background: linear-gradient(180deg, var(--paper2), var(--paper));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 22px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--paperLine);
      background: rgba(255,255,255,.65);
      backdrop-filter: blur(10px);
    }
    .search{
      display:flex;
      align-items:center;
      gap:10px;
      flex:1;
    }
    .search input{
      width: min(520px, 100%);
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid var(--paperLine);
      background: rgba(255,255,255,.70);
      outline:none;
      font-size: 13px;
      color: #1a1a1a;
    }
    .search input:focus{
      border-color: rgba(214,178,94,.55);
      box-shadow: 0 0 0 4px rgba(214,178,94,.18);
      background: rgba(255,255,255,.92);
    }
    .topIcons{
      display:flex; align-items:center; gap:10px;
    }
    .iconBtn{
      width:36px; height:36px;
      border-radius: 14px;
      border:1px solid var(--paperLine);
      background: rgba(255,255,255,.65);
      display:inline-flex; align-items:center; justify-content:center;
      cursor:pointer;
      transition:.15s;
      color:#222;
    }
    .iconBtn:hover{transform: translateY(-1px); border-color: rgba(214,178,94,.40)}
    .profile{
      display:flex; align-items:center; gap:10px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid var(--paperLine);
      background: rgba(255,255,255,.65);
    }
    .profile .face{
      width:28px; height:28px; border-radius: 50%;
      background: linear-gradient(135deg, rgba(214,178,94,.35), rgba(0,0,0,.08));
      border:1px solid rgba(10,10,10,.10);
    }
    .profile b{font-size:13px; color:#111}

    .content{
      padding: 16px;
    }

    /* KPI row */
    .kpis{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 12px;
      margin-bottom: 14px;
    }
    @media (max-width: 1100px){ .kpis{grid-template-columns: repeat(2, minmax(0,1fr));} }
    @media (max-width: 640px){ .kpis{grid-template-columns: 1fr;} .frame{grid-template-columns:1fr} .sidebar{position:relative; height:auto} }

    .kpi{
      background: rgba(255,255,255,.75);
      border:1px solid var(--paperLine);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      position:relative;
      overflow:hidden;
    }
    .kpi:before{
      content:"";
      position:absolute; inset:auto -30px -55px auto;
      width:140px; height:140px; border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(214,178,94,.35), transparent 62%);
      filter: blur(2px);
      pointer-events:none;
    }
    .kpi .label{font-size:12px; color:#555}
    .kpi .value{font-size:22px; font-weight:800; color:#111; margin-top:4px}
    .kpi .miniLine{
      height:3px; width: 44%;
      margin-top: 10px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(214,178,94,.95), rgba(214,178,94,.18));
    }

    /* Main grid inside paper */
    .grid2{
      display:grid;
      grid-template-columns: 1fr 340px; /* ×›××• ×‘×ª××•× ×”: ×˜×‘×œ×” + ×¤×¨×˜×™× */
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr} }

    /* Panels */
    .panel{
      background: rgba(255,255,255,.78);
      border:1px solid var(--paperLine);
      border-radius: 18px;
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      overflow:hidden;
    }
    .panelHd{
      padding: 12px 12px;
      border-bottom:1px solid var(--paperLine);
      display:flex; align-items:center; justify-content:space-between;
      color:#111;
      background: rgba(255,255,255,.55);
    }
    .panelHd b{font-size:13px}
    .panelHd .more{color:#777; font-size:18px; line-height:1}
    .panelBd{padding: 10px 12px}

    /* Table */
    table{width:100%; border-collapse: separate; border-spacing: 0}
    thead th{
      text-align:right;
      font-size:12px;
      color:#666;
      padding: 10px 10px;
      border-bottom: 1px solid var(--paperLine);
      background: rgba(10,10,10,.02);
      position:sticky; top:0;
      z-index: 1;
    }
    tbody td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--paperSoft);
      font-size: 13px;
      color:#222;
      vertical-align: middle;
    }
    tbody tr{
      cursor:pointer;
      transition:.12s;
    }
    tbody tr:hover{
      background: rgba(214,178,94,.10);
    }

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(10,10,10,.10);
      background: rgba(255,255,255,.80);
      font-size: 12px;
      color:#333;
      white-space:nowrap;
    }
    .pill.gold{border-color: rgba(214,178,94,.35); background: rgba(214,178,94,.16)}
    .pill.ok{border-color: rgba(46,242,162,.35); background: rgba(46,242,162,.12)}
    .pill.bad{border-color: rgba(255,92,122,.35); background: rgba(255,92,122,.10)}
    .dot{
      width:8px; height:8px; border-radius: 50%;
      background:#bbb;
    }
    .dot.gold{background: var(--gold)}
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .sub{
      font-size:12px; color:#666;
      margin-top:2px;
    }

    /* Lead details */
    .leadHeader{
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-bottom:1px solid var(--paperLine);
      background: rgba(10,10,10,.02);
    }
    .avatar{
      width:42px; height:42px; border-radius: 16px;
      background: linear-gradient(135deg, rgba(214,178,94,.30), rgba(10,10,10,.06));
      border:1px solid rgba(10,10,10,.10);
    }
    .leadHeader b{display:block; color:#111; font-size:14px}
    .leadHeader span{display:block; color:#666; font-size:12px}

    .formRow{display:grid; grid-template-columns: 1fr; gap:10px; padding: 12px}
    label{display:block; font-size:12px; color:#666; margin: 0 0 6px}
    input, select, textarea{
      width:100%;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(10,10,10,.14);
      background: rgba(255,255,255,.88);
      outline:none;
      font-size: 13px;
      color:#111;
    }
    textarea{min-height: 90px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(214,178,94,.55);
      box-shadow: 0 0 0 4px rgba(214,178,94,.18);
      background: rgba(255,255,255,.96);
    }

    .quickActions{
      display:flex; gap:10px; flex-wrap:wrap;
      padding: 0 12px 12px;
    }
    .btn{
      border:0;
      cursor:pointer;
      padding: 10px 12px;
      border-radius: 14px;
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px;
      font-weight: 700;
      font-size: 13px;
      transition:.15s;
      user-select:none;
    }
    .btn.gold{
      background: linear-gradient(135deg, rgba(214,178,94,.95), rgba(240,209,131,.70));
      color:#111;
      box-shadow: 0 14px 26px rgba(214,178,94,.20);
    }
    .btn.gold:hover{transform: translateY(-1px)}
    .btn.soft{
      background: rgba(10,10,10,.05);
      border:1px solid rgba(10,10,10,.12);
      color:#222;
    }
    .btn.soft:hover{border-color: rgba(214,178,94,.35)}
    .btn.danger{
      background: rgba(255,92,122,.10);
      border:1px solid rgba(255,92,122,.25);
      color:#7a2032;
      font-weight:800;
    }
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none}

    /* Modal */
    .modalWrap{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 999;
      padding: 18px;
    }
    .modalWrap.show{display:flex}
    .modal{
      width: min(560px, 96vw);
      border-radius: 20px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(246,244,239,.96));
    }
    .modalHd{
      display:flex; align-items:center; justify-content:space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--paperLine);
      color:#111;
      background: rgba(255,255,255,.60);
    }
    .modalHd b{font-size:14px}
    .x{
      width:36px; height:36px; border-radius: 14px;
      border:1px solid var(--paperLine);
      background: rgba(255,255,255,.65);
      cursor:pointer;
    }
    .modalBd{padding: 14px}

    /* Toast */
    .toast{
      position: fixed;
      left: 14px;
      bottom: 14px;
      background: rgba(12,12,16,.92);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow2);
      display:none;
      max-width: 92vw;
      z-index: 1000;
    }
    .toast.show{display:block}
    .toast b{color: var(--gold2)}
    .conn{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; color:#444;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--paperLine);
      background: rgba(255,255,255,.70);
      margin-right: 10px;
    }
    .conn .cDot{width:8px; height:8px; border-radius:50%; background: var(--bad)}
    .conn.ok .cDot{background: var(--ok)}
  </style>
</head>

<body>
  <div class="app">
    <div class="frame">

      <!-- Sidebar -->
      <aside class="sidebar">
        <div class="sbTop">
          <div class="shield"></div>
          <div class="brand">
            <b>LEADUP</b>
            <span>CRM â€¢ ×¡×•×›× ×•×ª ×‘×™×˜×•×—</span>
          </div>
        </div>

        <nav class="nav">
          <a class="active" href="#"><span class="ico">â–¦</span> Dashboard</a>
          <a href="#"><span class="ico">â—</span> Leads</a>
          <a href="#"><span class="ico">ğŸ‘¤</span> Customers</a>
          <a href="#"><span class="ico">âœ“</span> Tasks</a>
          <a href="#"><span class="ico">â–¤</span> Reports</a>
          <a href="#"><span class="ico">âš™</span> Settings</a>
        </nav>

        <div class="sbBottom">
          <div class="avatarSmall"></div>
          <div class="sbUser">
            <b>Agent</b>
            <span>LEADUP Team</span>
          </div>
        </div>
      </aside>

      <!-- Main -->
      <main class="main">
        <section class="paper">

          <!-- Topbar -->
          <div class="topbar">
            <div class="search">
              <span class="conn" id="connPill"><span class="cDot" id="connDot"></span><span id="connText">×œ× ××—×•×‘×¨</span></span>
              <input id="q" placeholder="×—×™×¤×•×© ×œ×™×“×™×: ×©× / ×˜×œ×¤×•×Ÿ / ××™××™×™×œ / ××•×¦×¨..." />
            </div>

            <div class="topIcons">
              <button class="iconBtn" id="refreshBtn" title="×¨×¢× ×Ÿ">âŸ³</button>
              <button class="iconBtn" id="newBtn" title="×œ×™×“ ×—×“×©">ï¼‹</button>
              <div class="profile" title="×¤×¨×•×¤×™×œ">
                <div class="face"></div>
                <b>LEADUP</b>
              </div>
            </div>
          </div>

          <div class="content">

            <!-- KPIs -->
            <div class="kpis">
              <div class="kpi"><div class="label">New Leads</div><div class="value" id="kNew">0</div><div class="miniLine"></div></div>
              <div class="kpi"><div class="label">Past Follow-Ups</div><div class="value" id="kFollow">0</div><div class="miniLine"></div></div>
              <div class="kpi"><div class="label">SLA Breaches</div><div class="value" id="kSla">0</div><div class="miniLine"></div></div>
              <div class="kpi"><div class="label">My Tasks</div><div class="value" id="kTasks">0</div><div class="miniLine"></div></div>
            </div>

            <div class="grid2">

              <!-- Lead List -->
              <div class="panel">
                <div class="panelHd">
                  <b>Lead List</b>
                  <span class="more">â‹¯</span>
                </div>
                <div class="panelBd" style="padding:0">
                  <div style="max-height: 420px; overflow:auto">
                    <table>
                      <thead>
                        <tr>
                          <th style="min-width:160px">Name</th>
                          <th style="min-width:120px">Status</th>
                          <th style="min-width:130px">Product</th>
                          <th style="min-width:120px">Follow-up</th>
                          <th style="min-width:110px">Priority</th>
                        </tr>
                      </thead>
                      <tbody id="tbody">
                        <tr><td colspan="5" style="padding:14px; color:#666">×˜×•×¢×Ÿ × ×ª×•× ×™×â€¦</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Lead Details -->
              <div class="panel">
                <div class="panelHd">
                  <b>Lead Details</b>
                  <span class="more">â‹¯</span>
                </div>

                <div class="leadHeader">
                  <div class="avatar"></div>
                  <div>
                    <b id="d_name">×‘×—×¨ ×œ×™×“</b>
                    <span id="d_contact">â€”</span>
                  </div>
                </div>

                <div class="formRow">
                  <input type="hidden" id="d_id" />

                  <div>
                    <label>Status</label>
                    <select id="d_status">
                      <option value="×—×“×©">NEW</option>
                      <option value="×‘×˜×™×¤×•×œ">CONTACTING</option>
                      <option value="×”×¦×¢×” × ×©×œ×—×”">QUOTE SENT</option>
                      <option value="×—×–×¨×• ××œ×™×™">FOLLOW-UP</option>
                      <option value="× ×¡×’×¨">CLOSED</option>
                      <option value="×œ× ×¨×œ×•×•× ×˜×™">NOT RELEVANT</option>
                    </select>
                  </div>

                  <div>
                    <label>Follow-up date</label>
                    <input id="d_follow" type="date"/>
                  </div>

                  <div>
                    <label>Priority</label>
                    <select id="d_priority">
                      <option value="LOW">LOW</option>
                      <option value="NORMAL" selected>NORMAL</option>
                      <option value="HIGH">HIGH</option>
                    </select>
                  </div>

                  <div>
                    <label>Product</label>
                    <input id="d_product" placeholder="×¨×›×‘ / ×“×™×¨×” / ×—×™×™× / ×‘×¨×™××•×ª..."/>
                  </div>

                  <div>
                    <label>Notes</label>
                    <textarea id="d_notes" placeholder="×¡×™×›×•× ×©×™×—×” / ××” ×”×œ×§×•×— ×¦×¨×™×š / ×”××©×š ×˜×™×¤×•×œâ€¦"></textarea>
                  </div>
                </div>

                <div class="quickActions">
                  <button class="btn soft" id="callBtn" type="button">ğŸ“ Call</button>
                  <button class="btn soft" id="mailBtn" type="button">âœ‰ Email</button>
                  <button class="btn danger" id="delBtn" type="button" disabled>Delete</button>
                  <button class="btn gold" id="saveBtn" type="button" disabled>Save Changes</button>
                </div>
              </div>

            </div>

          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Call Modal -->
  <div class="modalWrap" id="callModal">
    <div class="modal">
      <div class="modalHd">
        <b>×©×™×—×” ×œ×œ×§×•×—</b>
        <button class="x" data-close="callModal">âœ•</button>
      </div>
      <div class="modalBd">
        <div style="display:grid; gap:10px">
          <div style="color:#111; font-weight:800" id="callName">â€”</div>
          <div style="color:#333" id="callPhone">â€”</div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" id="copyPhoneBtn" type="button">×”×¢×ª×§ ××¡×¤×¨</button>
            <button class="btn soft" id="markCalledBtn" type="button">×ª×™×¢×•×“: ×“×™×‘×¨×ª×™ ××™×ª×•</button>
          </div>
          <div style="font-size:12px; color:#555; line-height:1.6">
            ×”×¢×¨×”: ×“×¤×“×¤×Ÿ ×œ× ××‘×¦×¢ â€œ×©×™×—×” ×××™×ª×™×ªâ€ ×‘×ª×•×š ×—×œ×•×Ÿ. ×¤×” ×¢×•×©×™× UX ××§×¦×•×¢×™ + ×ª×™×¢×•×“.  
            ×× ×ª×¨×¦×” ×’× ×—×™×•×’ ×××™×ª×™ ××ª×•×š ××—×©×‘ â€” ××¤×©×¨ ×œ×—×‘×¨ ×©×™×¨×•×ª ×˜×œ×¤×•× ×™×” (Twilio/VoIP) ×‘×’×¨×¡×” ××ª×§×“××ª.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Email Modal -->
  <div class="modalWrap" id="mailModal">
    <div class="modal">
      <div class="modalHd">
        <b>×©×œ×™×—×ª ××™×™×œ</b>
        <button class="x" data-close="mailModal">âœ•</button>
      </div>
      <div class="modalBd">
        <div style="display:grid; gap:10px">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px">
            <div>
              <label>To</label>
              <input id="m_to" placeholder="client@email.com"/>
            </div>
            <div>
              <label>Subject</label>
              <input id="m_sub" placeholder="LEADUP | ×”×¦×¢×ª ×‘×™×˜×•×—"/>
            </div>
          </div>
          <div>
            <label>Message</label>
            <textarea id="m_body" placeholder="×©×œ×•× â€¦"></textarea>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap">
            <button class="btn gold" id="sendMailBtn" type="button">Send</button>
            <button class="btn soft" data-close="mailModal" type="button">Cancel</button>
          </div>
          <div style="font-size:12px; color:#555; line-height:1.6">
            ×©×œ×™×—×” ×××™×ª×™×ª ××ª×•×š ×”××¢×¨×›×ª ×“×•×¨×©×ª ×¤×¢×•×œ×” ×‘-Apps Script (action: <b>sendEmail</b>).  
            ×›×¨×’×¢ ×–×” ××•×›×Ÿ â€” ×‘×©×œ×‘ ×”×—×™×‘×•×¨ × ×™×¦×•×¨ ××ª ×”×¤×¢×•×œ×” ×”×–×• ×‘×¡×§×¨×™×¤×˜ ×©×œ×š.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /**************
     * ×—×™×‘×•×¨ Google Sheets (Apps Script Web App)
     **************/
    const APPS_SCRIPT_WEBAPP_URL = "PASTE_YOUR_WEB_APP_URL_HERE";
    const API_KEY = ""; // ×× ×™×© ×œ×š ××¤×ª×— ×‘-Apps Script

    let leads = [];
    let selectedId = "";

    const el = (id)=>document.getElementById(id);
    const toastEl = el("toast");

    function toast(msg){
      toastEl.innerHTML = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 3200);
    }

    function setConnected(ok){
      const pill = el("connPill");
      const dot  = el("connDot");
      const text = el("connText");
      pill.classList.toggle("ok", ok);
      dot.style.background = ok ? "var(--ok)" : "var(--bad)";
      text.textContent = ok ? "××—×•×‘×¨" : "×œ× ××—×•×‘×¨";
    }

    function esc(s){
      return (s ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function statusPill(status){
      const st = (status||"").trim();
      if(st === "× ×¡×’×¨") return "ok";
      if(st === "×œ× ×¨×œ×•×•× ×˜×™") return "bad";
      if(st === "×—×“×©") return "gold";
      return "";
    }

    function calcKpis(list){
      const kNew = list.filter(x => (x.status||"") === "×—×“×©").length;
      // ×× ××™×Ÿ ×œ×š followup/SLA ×‘× ×ª×•× ×™× ×›×¨×’×¢ â€“ ×–×” ×—×™×©×•×‘ ×‘×¡×™×¡×™, ×•× ×©×“×¨×’ ×‘×©×œ×‘ ×”×—×™×‘×•×¨
      const kFollow = list.filter(x => (x.followup||"") && new Date(x.followup) < new Date()).length;
      const kSla = list.filter(x => (x.sla_breach||"") === true).length;
      const kTasks = list.filter(x => (x.task||"") === true).length;

      el("kNew").textContent = kNew;
      el("kFollow").textContent = kFollow;
      el("kSla").textContent = kSla;
      el("kTasks").textContent = kTasks;
    }

    function renderTable(list){
      const tb = el("tbody");
      if(!list.length){
        tb.innerHTML = `<tr><td colspan="5" style="padding:14px; color:#666">××™×Ÿ × ×ª×•× ×™×.</td></tr>`;
        return;
      }

      tb.innerHTML = list.map(l=>{
        const pillClass = statusPill(l.status);
        const statusLabel =
          (l.status==="×—×“×©") ? "NEW" :
          (l.status==="×‘×˜×™×¤×•×œ") ? "CONTACTING" :
          (l.status==="×”×¦×¢×” × ×©×œ×—×”") ? "QUOTE SENT" :
          (l.status==="×—×–×¨×• ××œ×™×™") ? "FOLLOW-UP" :
          (l.status==="× ×¡×’×¨") ? "CLOSED" :
          (l.status==="×œ× ×¨×œ×•×•× ×˜×™") ? "NOT RELEVANT" :
          (l.status||"");

        const priority = (l.priority || "NORMAL").toUpperCase();
        const follow = l.followup ? esc(l.followup) : "â€”";

        return `
          <tr data-id="${esc(l.id)}">
            <td>
              <div style="font-weight:800; color:#111">${esc(l.name||"â€”")}</div>
              <div class="sub">${esc(l.phone||"")} ${l.email ? "â€¢ "+esc(l.email) : ""}</div>
            </td>
            <td><span class="pill ${pillClass}"><span class="dot ${pillClass}"></span>${esc(statusLabel)}</span></td>
            <td>${esc(l.product||"â€”")}</td>
            <td>${follow}</td>
            <td><span class="pill">${esc(priority)}</span></td>
          </tr>
        `;
      }).join("");
    }

    function applyFilter(){
      const q = (el("q").value||"").trim().toLowerCase();
      const list = !q ? leads : leads.filter(l=>{
        const blob = [l.name,l.phone,l.email,l.product,l.status,l.notes].join(" ").toLowerCase();
        return blob.includes(q);
      });
      renderTable(list);
      calcKpis(list);
    }

    function setSelected(lead){
      selectedId = lead?.id || "";
      el("d_id").value = selectedId;

      el("d_name").textContent = lead?.name || "×‘×—×¨ ×œ×™×“";
      el("d_contact").textContent = [lead?.phone, lead?.email].filter(Boolean).join(" â€¢ ") || "â€”";

      el("d_status").value = lead?.status || "×—×“×©";
      el("d_follow").value = lead?.followup || "";
      el("d_priority").value = (lead?.priority || "NORMAL").toUpperCase();
      el("d_product").value = lead?.product || "";
      el("d_notes").value = lead?.notes || "";

      el("saveBtn").disabled = !selectedId;
      el("delBtn").disabled = !selectedId;

      // ×¤×¢×•×œ×•×ª ××•×“××œ
      el("callBtn").disabled = !selectedId;
      el("mailBtn").disabled = !selectedId;
    }

    function openModal(id){ el(id).classList.add("show"); }
    function closeModal(id){ el(id).classList.remove("show"); }

    document.addEventListener("click", (e)=>{
      const btn = e.target.closest("[data-close]");
      if(btn) closeModal(btn.getAttribute("data-close"));
      if(e.target.classList.contains("modalWrap")) e.target.classList.remove("show");
    });

    /**************
     * API ××•×œ Apps Script
     **************/
    async function apiList(){
      const url = new URL(APPS_SCRIPT_WEBAPP_URL);
      url.searchParams.set("action","list");
      if(API_KEY) url.searchParams.set("key", API_KEY);
      const res = await fetch(url.toString(), {method:"GET"});
      if(!res.ok) throw new Error("list failed");
      return res.json();
    }

    async function apiUpsert(lead){
      const res = await fetch(APPS_SCRIPT_WEBAPP_URL, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({action:"upsert", key: API_KEY, lead})
      });
      if(!res.ok) throw new Error("upsert failed");
      return res.json();
    }

    async function apiDelete(id){
      const res = await fetch(APPS_SCRIPT_WEBAPP_URL, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({action:"delete", key: API_KEY, id})
      });
      if(!res.ok) throw new Error("delete failed");
      return res.json();
    }

    // × ×©×ª××© ×‘×–×” ×‘×©×œ×‘ ×”×—×™×‘×•×¨ ×›×“×™ ×œ×©×œ×•×— ××™×™×œ ×××™×ª×™ ××ª×•×š ×”××¢×¨×›×ª
    async function apiSendEmail(to, subject, body){
      const res = await fetch(APPS_SCRIPT_WEBAPP_URL, {
        method:"POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({action:"sendEmail", key: API_KEY, to, subject, body})
      });
      if(!res.ok) throw new Error("sendEmail failed");
      return res.json();
    }

    async function loadAll(){
      if(APPS_SCRIPT_WEBAPP_URL.includes("PASTE_YOUR_WEB_APP_URL_HERE")){
        setConnected(false);
        el("tbody").innerHTML = `<tr><td colspan="5" style="padding:14px; color:#666"><b>×©×™× ××ª ×”-Web App URL</b> ×‘×§×•×“ ×›×“×™ ×œ×”×ª×—×‘×¨ ×œ×’×™×œ×™×•×Ÿ.</td></tr>`;
        return;
      }
      try{
        const out = await apiList();
        if(!out || out.ok !== true) throw new Error(out?.error || "
